---
uid: aspnet/overview/owin-and-katana/owin-oauth-20-authorization-server
title: Autorizační Server OWIN OAuth 2.0 | Dokumentace Microsoftu
author: hongyes
description: Tento kurz vám pomůže o tom, jak implementovat serveru autorizace OAuth 2.0 pomocí middlewaru OWIN OAuth. To je pokročilá kurzu této pouze Nastav...
ms.author: riande
ms.date: 01/28/2019
ms.assetid: 20acee16-c70c-41e9-b38f-92bfcf9a4c1c
msc.legacyurl: /aspnet/overview/owin-and-katana/owin-oauth-20-authorization-server
msc.type: authoredcontent
ms.openlocfilehash: b8451d2d9e346bd5e2f51ba45e48030a5221b549
ms.sourcegitcommit: 24b1f6decbb17bb22a45166e5fdb0845c65af498
ms.translationtype: MT
ms.contentlocale: cs-CZ
ms.lasthandoff: 03/01/2019
ms.locfileid: "57076585"
---
# <a name="owin-oauth-20-authorization-server"></a><span data-ttu-id="a29e4-104">Autorizační server OWIN OAuth 2.0</span><span class="sxs-lookup"><span data-stu-id="a29e4-104">OWIN OAuth 2.0 Authorization Server</span></span>

> <span data-ttu-id="a29e4-105">Tento kurz vám pomůže o tom, jak implementovat serveru autorizace OAuth 2.0 pomocí middlewaru OWIN OAuth.</span><span class="sxs-lookup"><span data-stu-id="a29e4-105">This tutorial will guide you on how to implement an OAuth 2.0 Authorization Server using OWIN OAuth middleware.</span></span> <span data-ttu-id="a29e4-106">Toto je rozšířený výukový program, který popisuje pouze kroky pro vytvoření autorizační Server OWIN OAuth 2.0.</span><span class="sxs-lookup"><span data-stu-id="a29e4-106">This is an advanced tutorial that only outlines the steps to create an OWIN OAuth 2.0 Authorization Server.</span></span> <span data-ttu-id="a29e4-107">Toto není podrobný kurz.</span><span class="sxs-lookup"><span data-stu-id="a29e4-107">This is not a step by step tutorial.</span></span> <span data-ttu-id="a29e4-108">[Stáhněte si ukázkový kód](https://code.msdn.microsoft.com/OWIN-OAuth-20-Authorization-ba2b8783/file/114932/1/AuthorizationServer.zip).</span><span class="sxs-lookup"><span data-stu-id="a29e4-108">[Download the sample code](https://code.msdn.microsoft.com/OWIN-OAuth-20-Authorization-ba2b8783/file/114932/1/AuthorizationServer.zip).</span></span>
>
> > [!NOTE]
> > <span data-ttu-id="a29e4-109">Tato osnovy by neměl určena pro použití pro vytvoření aplikace pro zabezpečené produkční.</span><span class="sxs-lookup"><span data-stu-id="a29e4-109">This outline should not be intended to be used for creating a secure production app.</span></span> <span data-ttu-id="a29e4-110">Tento kurz je určen k poskytování pouze přehledu o tom, jak implementovat serveru autorizace OAuth 2.0 pomocí middlewaru OWIN OAuth.</span><span class="sxs-lookup"><span data-stu-id="a29e4-110">This tutorial is intended to provide only an outline on how to implement an OAuth 2.0 Authorization Server using OWIN OAuth middleware.</span></span>
>
>
> ## <a name="software-versions"></a><span data-ttu-id="a29e4-111">Verze softwaru</span><span class="sxs-lookup"><span data-stu-id="a29e4-111">Software versions</span></span>
>
> | <span data-ttu-id="a29e4-112">**Uvedené v tomto kurzu**</span><span class="sxs-lookup"><span data-stu-id="a29e4-112">**Shown in the tutorial**</span></span> | <span data-ttu-id="a29e4-113">**Funguje taky s**</span><span class="sxs-lookup"><span data-stu-id="a29e4-113">**Also works with**</span></span> |
> | --- | --- |
> | <span data-ttu-id="a29e4-114">Windows 8.1</span><span class="sxs-lookup"><span data-stu-id="a29e4-114">Windows 8.1</span></span> | <span data-ttu-id="a29e4-115">Windows 10, Windows 8, Windows 7</span><span class="sxs-lookup"><span data-stu-id="a29e4-115">Windows 10, Windows 8, Windows 7</span></span> |
> | [<span data-ttu-id="a29e4-116">Visual Studio 2017</span><span class="sxs-lookup"><span data-stu-id="a29e4-116">Visual Studio 2017</span></span>](https://visualstudio.microsoft.com/downloads/)
> | <span data-ttu-id="a29e4-117">.NET 4.7.2</span><span class="sxs-lookup"><span data-stu-id="a29e4-117">.NET 4.7.2</span></span> |  |
>
> ## <a name="questions-and-comments"></a><span data-ttu-id="a29e4-118">Otázky a komentáře</span><span class="sxs-lookup"><span data-stu-id="a29e4-118">Questions and comments</span></span>
>
> <span data-ttu-id="a29e4-119">Pokud máte otázky, které přímo nesouvisejí, najdete v tomto kurzu, můžete je uvést v [Katana projektu na Githubu](https://github.com/aspnet/AspNetKatana/).</span><span class="sxs-lookup"><span data-stu-id="a29e4-119">If you have questions that are not directly related to the tutorial, you can post them at [Katana Project on GitHub](https://github.com/aspnet/AspNetKatana/).</span></span> <span data-ttu-id="a29e4-120">Pro dotazy a připomínky týkající se tohoto kurzu, samotný naleznete v části poznámky v dolní části stránky.</span><span class="sxs-lookup"><span data-stu-id="a29e4-120">For questions and comments regarding the tutorial itself, see the comments section at the bottom of the page.</span></span>


<span data-ttu-id="a29e4-121">[OAuth 2.0 framework](http://tools.ietf.org/html/rfc6749) umožňuje aplikaci třetí strany k získání omezený přístup ke službě HTTP.</span><span class="sxs-lookup"><span data-stu-id="a29e4-121">The [OAuth 2.0 framework](http://tools.ietf.org/html/rfc6749) enables a third-party app to obtain limited access to an HTTP service.</span></span> <span data-ttu-id="a29e4-122">Nemusíte používat přihlašovací údaje vlastníka prostředku pro přístup k chráněnému prostředku, klient získá přístupový token (což je řetězec představující konkrétní obor, dobu života a dalších atributů přístup).</span><span class="sxs-lookup"><span data-stu-id="a29e4-122">Instead of using the resource owner's credentials to access a protected resource, the client obtains an access token (which is a string denoting a specific scope, lifetime, and other access attributes).</span></span> <span data-ttu-id="a29e4-123">Přístupové tokeny jsou vystavené klientům třetích stran autorizačního serveru se souhlasem vlastníka prostředku.</span><span class="sxs-lookup"><span data-stu-id="a29e4-123">Access tokens are issued to third-party clients by an authorization server with the approval of the resource owner.</span></span>

<span data-ttu-id="a29e4-124">V tomto kurzu budou zahrnovat:</span><span class="sxs-lookup"><span data-stu-id="a29e4-124">This tutorial will cover:</span></span>

- <span data-ttu-id="a29e4-125">Jak vytvořit autorizační server pro podporu ověřování čtyři typy udělení a obnovovacích tokenů:</span><span class="sxs-lookup"><span data-stu-id="a29e4-125">How to create an authorization server to support four authorization grant types and refresh tokens:</span></span>
    - <span data-ttu-id="a29e4-126">Udělení autorizačního kódu</span><span class="sxs-lookup"><span data-stu-id="a29e4-126">Authorization code grant</span></span>
    - <span data-ttu-id="a29e4-127">Implicitní Grant</span><span class="sxs-lookup"><span data-stu-id="a29e4-127">Implicit Grant</span></span>
    - <span data-ttu-id="a29e4-128">Udělení pověření heslo vlastníka prostředku</span><span class="sxs-lookup"><span data-stu-id="a29e4-128">Resource Owner Password Credentials Grant</span></span>
    - <span data-ttu-id="a29e4-129">Udělení pověření klienta</span><span class="sxs-lookup"><span data-stu-id="a29e4-129">Client Credentials Grant</span></span>
- <span data-ttu-id="a29e4-130">Vytváří se prostředek serveru, který je chráněn přístupový token.</span><span class="sxs-lookup"><span data-stu-id="a29e4-130">Creating a resource server which is protected by an access token.</span></span>
- <span data-ttu-id="a29e4-131">Vytvoření klientů OAuth 2.0.</span><span class="sxs-lookup"><span data-stu-id="a29e4-131">Creating OAuth 2.0 clients.</span></span>

<a id="prerequisites"></a>
## <a name="prerequisites"></a><span data-ttu-id="a29e4-132">Požadavky</span><span class="sxs-lookup"><span data-stu-id="a29e4-132">Prerequisites</span></span>

- <span data-ttu-id="a29e4-133">[Visual Studio 2017](https://visualstudio.microsoft.com/downloads/) jak je uvedeno v **verze softwaru** v horní části stránky.</span><span class="sxs-lookup"><span data-stu-id="a29e4-133">[Visual Studio 2017](https://visualstudio.microsoft.com/downloads/) as indicated in **Software Versions** at the top of the page.</span></span>
- <span data-ttu-id="a29e4-134">Znalost OWIN.</span><span class="sxs-lookup"><span data-stu-id="a29e4-134">Familiarity with OWIN.</span></span> <span data-ttu-id="a29e4-135">Zobrazit [Začínáme se službou projektu Katana](https://msdn.microsoft.com/magazine/dn451439.aspx) a [co je nového v OWIN a Katana](index.md).</span><span class="sxs-lookup"><span data-stu-id="a29e4-135">See [Getting Started with the Katana Project](https://msdn.microsoft.com/magazine/dn451439.aspx) and [What's new in OWIN and Katana](index.md).</span></span>
- <span data-ttu-id="a29e4-136">Znalost [OAuth](http://tools.ietf.org/html/rfc6749) terminologii, včetně [role](http://tools.ietf.org/html/rfc6749#section-1.1), [Protocol Flow](http://tools.ietf.org/html/rfc6749#section-1.2), a [udělení autorizace](http://tools.ietf.org/html/rfc6749#section-1.3).</span><span class="sxs-lookup"><span data-stu-id="a29e4-136">Familiarity with [OAuth](http://tools.ietf.org/html/rfc6749) terminology, including [Roles](http://tools.ietf.org/html/rfc6749#section-1.1), [Protocol Flow](http://tools.ietf.org/html/rfc6749#section-1.2), and [Authorization Grant](http://tools.ietf.org/html/rfc6749#section-1.3).</span></span> <span data-ttu-id="a29e4-137">[OAuth 2.0 ÚVOD](http://tools.ietf.org/html/rfc6749#section-1) poskytuje vhodným úvodem.</span><span class="sxs-lookup"><span data-stu-id="a29e4-137">[OAuth 2.0 introduction](http://tools.ietf.org/html/rfc6749#section-1) provides a good introduction.</span></span>

## <a name="create-an-authorization-server"></a><span data-ttu-id="a29e4-138">Vytvoření autorizačního serveru</span><span class="sxs-lookup"><span data-stu-id="a29e4-138">Create an Authorization Server</span></span>

<span data-ttu-id="a29e4-139">V tomto kurzu jsme se zhruba načrtnout použití [OWIN](https://msdn.microsoft.com/magazine/dn451439.aspx) a architektura ASP.NET MVC Vytvoření autorizačního serveru.</span><span class="sxs-lookup"><span data-stu-id="a29e4-139">In this tutorial, we will roughly sketch out how to use [OWIN](https://msdn.microsoft.com/magazine/dn451439.aspx) and ASP.NET MVC to create an authorization server.</span></span> <span data-ttu-id="a29e4-140">Věříme, že brzy zajištění stahování pro úplnou vzorovou jako tento kurz neobsahuje každého kroku.</span><span class="sxs-lookup"><span data-stu-id="a29e4-140">We hope to soon provide a download for the completed sample, as this tutorial does not include each step.</span></span> <span data-ttu-id="a29e4-141">Nejprve vytvořte prázdnou webovou aplikaci s názvem *AuthorizationServer* a nainstalujte následující balíčky:</span><span class="sxs-lookup"><span data-stu-id="a29e4-141">First, create an empty web app named *AuthorizationServer* and install the following packages:</span></span>

- <span data-ttu-id="a29e4-142">Microsoft.AspNet.Mvc</span><span class="sxs-lookup"><span data-stu-id="a29e4-142">Microsoft.AspNet.Mvc</span></span>
- <span data-ttu-id="a29e4-143">Microsoft.Owin.Host.SystemWeb</span><span class="sxs-lookup"><span data-stu-id="a29e4-143">Microsoft.Owin.Host.SystemWeb</span></span>
- <span data-ttu-id="a29e4-144">Microsoft.Owin.Security.OAuth</span><span class="sxs-lookup"><span data-stu-id="a29e4-144">Microsoft.Owin.Security.OAuth</span></span>
- <span data-ttu-id="a29e4-145">Microsoft.Owin.Security.Cookies</span><span class="sxs-lookup"><span data-stu-id="a29e4-145">Microsoft.Owin.Security.Cookies</span></span>
- <span data-ttu-id="a29e4-146">Microsoft.Owin.Security.Google (nebo jakékoli jiné přihlášení prostřednictvím sociální sítě balíček například Microsoft.Owin.Security.Facebook)</span><span class="sxs-lookup"><span data-stu-id="a29e4-146">Microsoft.Owin.Security.Google (Or any other social login package such as Microsoft.Owin.Security.Facebook)</span></span>

<span data-ttu-id="a29e4-147">Přidat [třída OWIN Startup](owin-startup-class-detection.md) v kořenové složce projektu s názvem *spuštění*.</span><span class="sxs-lookup"><span data-stu-id="a29e4-147">Add an [OWIN Startup class](owin-startup-class-detection.md) under the project root folder named *Startup*.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample1.cs?highlight=8)]

<span data-ttu-id="a29e4-148">Vytvoření *aplikace\_Start* složky.</span><span class="sxs-lookup"><span data-stu-id="a29e4-148">Create an *App\_Start* folder.</span></span> <span data-ttu-id="a29e4-149">Vyberte *aplikace\_Start* složky a použijte klávesu Shift + Alt + A přidání stažené verze *AuthorizationServer\App\_Start\Startup.Auth.cs* souboru.</span><span class="sxs-lookup"><span data-stu-id="a29e4-149">Select the *App\_Start* folder and use Shift+Alt+A to add the downloaded version of the *AuthorizationServer\App\_Start\Startup.Auth.cs* file.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample2.cs)]

<span data-ttu-id="a29e4-150">Výše uvedený kód umožňuje přihlášení aplikace/externí soubory cookie a ověřování Google, které jsou používány samotný autorizační server pro správu účtů.</span><span class="sxs-lookup"><span data-stu-id="a29e4-150">The code above enables application/external sign in cookies and Google authentication, which are used by authorization server itself to manage accounts.</span></span>

<span data-ttu-id="a29e4-151">`UseOAuthAuthorizationServer` – Metoda rozšíření je pro nastavení serveru ověřování.</span><span class="sxs-lookup"><span data-stu-id="a29e4-151">The `UseOAuthAuthorizationServer` extension method is to setup the authorization server.</span></span> <span data-ttu-id="a29e4-152">Možnosti instalace jsou:</span><span class="sxs-lookup"><span data-stu-id="a29e4-152">The setup options are:</span></span>

- <span data-ttu-id="a29e4-153">`AuthorizeEndpointPath`: Cesta požadavku, kam klientské aplikace přesměrují uživatelského agenta aby bylo možné získat uživatele souhlas k vydání tokenu nebo kódu.</span><span class="sxs-lookup"><span data-stu-id="a29e4-153">`AuthorizeEndpointPath`: The request path where client applications will redirect the user-agent in order to obtain the users consent to issue a token or code.</span></span> <span data-ttu-id="a29e4-154">Musí začínat úvodním lomítkem, například "`/Authorize`".</span><span class="sxs-lookup"><span data-stu-id="a29e4-154">It must begin with a leading slash, for example, "`/Authorize`".</span></span>
- <span data-ttu-id="a29e4-155">`TokenEndpointPath`: Klientské aplikace cestu požadavku se získat přístupový token přímo komunikovat.</span><span class="sxs-lookup"><span data-stu-id="a29e4-155">`TokenEndpointPath`: The request path client applications directly communicate to obtain the access token.</span></span> <span data-ttu-id="a29e4-156">Musí začínat úvodním lomítkem, jako je "/ Token".</span><span class="sxs-lookup"><span data-stu-id="a29e4-156">It must begin with a leading slash, like "/Token".</span></span> <span data-ttu-id="a29e4-157">Pokud klient je vystaven [klienta\_tajný kód](http://tools.ietf.org/html/rfc6749#appendix-A.2), musí být poskytnut do tohoto koncového bodu.</span><span class="sxs-lookup"><span data-stu-id="a29e4-157">If the client is issued a [client\_secret](http://tools.ietf.org/html/rfc6749#appendix-A.2), it must be provided to this endpoint.</span></span>
- <span data-ttu-id="a29e4-158">`ApplicationCanDisplayErrors`: Nastavte na `true` Pokud webová aplikace chce generovat vlastní chybové stránky pro chyby ověření klienta `/Authorize` koncového bodu.</span><span class="sxs-lookup"><span data-stu-id="a29e4-158">`ApplicationCanDisplayErrors`: Set to `true` if the web application wants to generate a custom error page for the client validation errors on `/Authorize` endpoint.</span></span> <span data-ttu-id="a29e4-159">Je to potřeba jenom pro případy, kdy prohlížeč není přesměrován zpět do klientské aplikace, třeba když `client_id` nebo `redirect_uri` , nejsou správné.</span><span class="sxs-lookup"><span data-stu-id="a29e4-159">This is only needed for cases where the browser is not redirected back to the client application, for example, when the `client_id` or `redirect_uri` are incorrect.</span></span> <span data-ttu-id="a29e4-160">`/Authorize` Koncový bod by měl očekávat "oauth. Chyba","oauth. Popis chyby"a"oauth. Vlastnosti ErrorUri"jsou přidány do prostředí OWIN.</span><span class="sxs-lookup"><span data-stu-id="a29e4-160">The `/Authorize` endpoint should expect to see the "oauth.Error", "oauth.ErrorDescription", and "oauth.ErrorUri" properties are added to the OWIN environment.</span></span>

    > [!NOTE]
    > <span data-ttu-id="a29e4-161">Pokud není true, bude autorizační server vrátit výchozí chybovou stránku s podrobnostmi o chybě.</span><span class="sxs-lookup"><span data-stu-id="a29e4-161">If not true, the authorization server will return a default error page with the error details.</span></span>
- <span data-ttu-id="a29e4-162">`AllowInsecureHttp`: True pro povolení požadavků ověřování a tokenů doručení na adresy HTTP URI a povolit příchozí `redirect_uri` povolit parametry požadavku a adresy HTTP URI.</span><span class="sxs-lookup"><span data-stu-id="a29e4-162">`AllowInsecureHttp`: True to allow authorize and token requests to arrive on HTTP URI addresses, and to allow incoming `redirect_uri` authorize request parameters to have HTTP URI addresses.</span></span>

    > [!WARNING]
    > <span data-ttu-id="a29e4-163">Zabezpečení – Toto je pouze pro vývoj.</span><span class="sxs-lookup"><span data-stu-id="a29e4-163">Security - This is for development only.</span></span>
- <span data-ttu-id="a29e4-164">`Provider`: Objekt Poskytnutý aplikací ke zpracování událostí vyvolaných middlewarem serveru ověřování.</span><span class="sxs-lookup"><span data-stu-id="a29e4-164">`Provider`: The object provided by the application to process events raised by the Authorization Server middleware.</span></span> <span data-ttu-id="a29e4-165">Aplikace může toto rozhraní implementovat plně nebo může vytvořit instanci `OAuthAuthorizationServerProvider` a přiřadit delegáty, které jsou nezbytné pro toky OAuth. Tento server podporuje.</span><span class="sxs-lookup"><span data-stu-id="a29e4-165">The application may implement the interface fully, or it may create an instance of `OAuthAuthorizationServerProvider` and assign delegates necessary for the OAuth flows this server supports.</span></span>
- <span data-ttu-id="a29e4-166">`AuthorizationCodeProvider`: Vytvoří jednorázový autorizační kód, který vrátí do klientské aplikace.</span><span class="sxs-lookup"><span data-stu-id="a29e4-166">`AuthorizationCodeProvider`: Produces a single-use authorization code to return to the client application.</span></span> <span data-ttu-id="a29e4-167">OAuth server zabezpečit aplikace **musí** zadat instanci pro `AuthorizationCodeProvider` kde token vytvořený `OnCreate/OnCreateAsync` je událost považována za platný pouze pro jedno volání do `OnReceive/OnReceiveAsync`.</span><span class="sxs-lookup"><span data-stu-id="a29e4-167">For the OAuth server to be secure the application **MUST** provide an instance for `AuthorizationCodeProvider` where the token produced by the `OnCreate/OnCreateAsync` event is considered valid for only one call to `OnReceive/OnReceiveAsync`.</span></span>
- <span data-ttu-id="a29e4-168">`RefreshTokenProvider`: Vytvoří token obnovení, který může být použit k vytvoření nového tokenu přístupu v případě potřeby.</span><span class="sxs-lookup"><span data-stu-id="a29e4-168">`RefreshTokenProvider`: Produces a refresh token which may be used to produce a new access token when needed.</span></span> <span data-ttu-id="a29e4-169">Pokud není k dispozici server ověřování nevrátí tokeny obnovení z `/Token` koncového bodu.</span><span class="sxs-lookup"><span data-stu-id="a29e4-169">If not provided the authorization server will not return refresh tokens from the `/Token` endpoint.</span></span>

## <a name="account-management"></a><span data-ttu-id="a29e4-170">Správa účtů</span><span class="sxs-lookup"><span data-stu-id="a29e4-170">Account Management</span></span>

<span data-ttu-id="a29e4-171">OAuth nemá péče, kdy nebo jak spravovat vaše informace o uživatelském účtu.</span><span class="sxs-lookup"><span data-stu-id="a29e4-171">OAuth doesn't care where or how you manage your user account information.</span></span> <span data-ttu-id="a29e4-172">Má [ASP.NET Identity](../../../identity/index.md) tedy za jejich vývoj odpovídá.</span><span class="sxs-lookup"><span data-stu-id="a29e4-172">It's [ASP.NET Identity](../../../identity/index.md) which is responsible for it.</span></span> <span data-ttu-id="a29e4-173">V tomto kurzu budeme zjednodušit správu kód účtu a ujistěte se, že tento uživatel se může přihlásit pomocí souboru cookie middleware OWIN.</span><span class="sxs-lookup"><span data-stu-id="a29e4-173">In this tutorial, we will simplify the account management code and just make sure that user can login using OWIN cookie middleware.</span></span> <span data-ttu-id="a29e4-174">Tady je zjednodušené ukázkový kód pro `AccountController`:</span><span class="sxs-lookup"><span data-stu-id="a29e4-174">Here is the simplified sample code for the `AccountController`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample3.cs)]

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample4.cs?highlight=1)]

<span data-ttu-id="a29e4-175">`ValidateClientRedirectUri` slouží k ověření klienta se její adresa URL pro přesměrování registrovaný.</span><span class="sxs-lookup"><span data-stu-id="a29e4-175">`ValidateClientRedirectUri` is used to validate the client with its registered redirect URL.</span></span> <span data-ttu-id="a29e4-176">`ValidateClientAuthentication` zkontroluje základní schéma záhlaví a text formuláře k získání přihlašovacích údajů klienta.</span><span class="sxs-lookup"><span data-stu-id="a29e4-176">`ValidateClientAuthentication` checks the basic scheme header and form body to get the client's credentials.</span></span>

<span data-ttu-id="a29e4-177">Přihlašovací stránka je zobrazena níže:</span><span class="sxs-lookup"><span data-stu-id="a29e4-177">The login page is shown below:</span></span>

![](owin-oauth-20-authorization-server/_static/image1.png)

<span data-ttu-id="a29e4-178">Projděte si IETF OAuth 2 [udělení autorizačního kódu](http://tools.ietf.org/html/rfc6749#section-4.1) části nyní.</span><span class="sxs-lookup"><span data-stu-id="a29e4-178">Review the IETF's OAuth 2 [Authorization Code Grant](http://tools.ietf.org/html/rfc6749#section-4.1) section now.</span></span>

<span data-ttu-id="a29e4-179">**Zprostředkovatel** (v následující tabulce) je [OAuthAuthorizationServerOptions](https://msdn.microsoft.com/library/microsoft.owin.security.oauth.oauthauthorizationserveroptions(v=vs.111).aspx). Zprostředkovatel, který je typu `OAuthAuthorizationServerProvider`, která obsahuje všechny události serveru OAuth.</span><span class="sxs-lookup"><span data-stu-id="a29e4-179">**Provider** (in the table below) is [OAuthAuthorizationServerOptions](https://msdn.microsoft.com/library/microsoft.owin.security.oauth.oauthauthorizationserveroptions(v=vs.111).aspx).Provider, which is of type `OAuthAuthorizationServerProvider`, which contains all OAuth server events.</span></span>

| <span data-ttu-id="a29e4-180">Kroky toku z část udělení autorizačního kódu</span><span class="sxs-lookup"><span data-stu-id="a29e4-180">Flow steps from Authorization Code Grant section</span></span> | <span data-ttu-id="a29e4-181">Stažení ukázkové provádí tyto kroky:</span><span class="sxs-lookup"><span data-stu-id="a29e4-181">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="a29e4-182">(A) klienta spouští tok přesměrováním vlastník prostředku uživatelského agenta pro koncový bod autorizace.</span><span class="sxs-lookup"><span data-stu-id="a29e4-182">(A) The client initiates the flow by directing the resource owner's user-agent to the authorization endpoint.</span></span> <span data-ttu-id="a29e4-183">Klient zahrne identifikátoru klienta, požadovaný obor, místní a identifikátor URI přesměrování, na které pošle autorizační server uživatelského agenta, zpět po přístup je udělen (nebo byl odepřen).</span><span class="sxs-lookup"><span data-stu-id="a29e4-183">The client includes its client identifier, requested scope, local state, and a redirection URI to which the authorization server will send the user-agent back once access is granted (or denied).</span></span> | <span data-ttu-id="a29e4-184">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span><span class="sxs-lookup"><span data-stu-id="a29e4-184">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span></span> |
|  |  |
| <span data-ttu-id="a29e4-185">(B) autorizační server ověří vlastníka prostředku (prostřednictvím uživatelského agenta) a zjistí, zda vlastník prostředku udělí nebo zamítne žádost o přístup klienta.</span><span class="sxs-lookup"><span data-stu-id="a29e4-185">(B) The authorization server authenticates the resource owner (via the user-agent) and establishes whether the resource owner grants or denies the client's access request.</span></span> | <span data-ttu-id="a29e4-186">**&lt;If user grants access&gt;** Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="a29e4-186">**&lt;If user grants access&gt;** Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="a29e4-187">(C) za předpokladu, že vlastník prostředku udělí přístup, přesměruje autorizační server uživatelského agenta zpět na klienta pomocí přesměrovacího identifikátoru URI zadaný starší (v žádosti nebo při registraci klienta).</span><span class="sxs-lookup"><span data-stu-id="a29e4-187">(C) Assuming the resource owner grants access, the authorization server redirects the user-agent back to the client using the redirection URI provided earlier (in the request or during client registration).</span></span> <span data-ttu-id="a29e4-188">...</span><span class="sxs-lookup"><span data-stu-id="a29e4-188">...</span></span> |  |
|  |  |
| <span data-ttu-id="a29e4-189">(D) si klient vyžádá přístupový token z koncového bodu tokenu autorizačního serveru zahrnutím autorizační kód přijatý v předchozím kroku.</span><span class="sxs-lookup"><span data-stu-id="a29e4-189">(D) The client requests an access token from the authorization server's token endpoint by including the authorization code received in the previous step.</span></span> <span data-ttu-id="a29e4-190">Když se odešle požadavek, klient se ověří pomocí autorizačního serveru.</span><span class="sxs-lookup"><span data-stu-id="a29e4-190">When making the request, the client authenticates with the authorization server.</span></span> <span data-ttu-id="a29e4-191">Klient obsahuje přesměrovací identifikátor URI používá k získání autorizačního kódu pro ověřování.</span><span class="sxs-lookup"><span data-stu-id="a29e4-191">The client includes the redirection URI used to obtain the authorization code for verification.</span></span> | <span data-ttu-id="a29e4-192">Provider.MatchEndpoint Provider.ValidateClientAuthentication AuthorizationCodeProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantAuthorizationCode Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="a29e4-192">Provider.MatchEndpoint Provider.ValidateClientAuthentication AuthorizationCodeProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantAuthorizationCode Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |

<span data-ttu-id="a29e4-193">Ukázková implementace pro `AuthorizationCodeProvider.CreateAsync` a `ReceiveAsync` řídit vytvoření a ověření autorizační kód je uveden níže.</span><span class="sxs-lookup"><span data-stu-id="a29e4-193">A sample implementation for `AuthorizationCodeProvider.CreateAsync` and `ReceiveAsync` to control the creation and validation of authorization code is shown below.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample5.cs)]

<span data-ttu-id="a29e4-194">Výše uvedený kód používá k ukládání-the-ticket kódu a identity a obnovit identitu po obdržení kódu ConcurrentDictionary v paměti.</span><span class="sxs-lookup"><span data-stu-id="a29e4-194">The code above uses an in-memory concurrent dictionary to store the code and identity ticket and restore the identity after receiving the code.</span></span> <span data-ttu-id="a29e4-195">V reálné aplikaci byste nahradit odpovídajícími do trvalého úložiště dat.</span><span class="sxs-lookup"><span data-stu-id="a29e4-195">In a real application, it would be replaced by a persistent data store.</span></span> <span data-ttu-id="a29e4-196">Koncový bod autorizace je vlastník prostředku udělit přístup ke klientovi.</span><span class="sxs-lookup"><span data-stu-id="a29e4-196">The authorization endpoint is for the resource owner to grant access to the client.</span></span> <span data-ttu-id="a29e4-197">Obvykle musí uživatelské rozhraní, aby uživatel mohl klikněte na tlačítko a ověřte oprávnění.</span><span class="sxs-lookup"><span data-stu-id="a29e4-197">Usually, it needs a user interface to allow the user to click a button and confirm the grant.</span></span> <span data-ttu-id="a29e4-198">Middleware OWIN OAuth umožňuje kódu aplikace ke zpracování koncový bod autorizace.</span><span class="sxs-lookup"><span data-stu-id="a29e4-198">OWIN OAuth middleware allows application code to handle the authorization endpoint.</span></span> <span data-ttu-id="a29e4-199">V naší ukázkové aplikaci používáme kontroler MVC volá `OAuthController` aby to zvládnul.</span><span class="sxs-lookup"><span data-stu-id="a29e4-199">In our sample app, we use an MVC controller called `OAuthController` to handle it.</span></span> <span data-ttu-id="a29e4-200">Tady je ukázková implementace:</span><span class="sxs-lookup"><span data-stu-id="a29e4-200">Here is the sample implementation:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample6.cs?highlight=15)]

<span data-ttu-id="a29e4-201">`Authorize` Akce nejprve zkontroluje, pokud je uživatel přihlášen k autorizačnímu serveru.</span><span class="sxs-lookup"><span data-stu-id="a29e4-201">The `Authorize` action will first check if the user has logged in to the authorization server.</span></span> <span data-ttu-id="a29e4-202">Pokud ne, že ověřovací middleware vyzve volajícího k ověření pomocí souboru cookie "Aplikace" a přesměruje na přihlašovací stránku.</span><span class="sxs-lookup"><span data-stu-id="a29e4-202">If not, the authentication middleware challenges the caller to authenticate using the "Application" cookie and redirects to the login page.</span></span> <span data-ttu-id="a29e4-203">(Viz výše uvedený zvýrazněný kód.) Pokud má uživatel přihlášen, zobrazí se pak ověřit zobrazení, jak je znázorněno níže:</span><span class="sxs-lookup"><span data-stu-id="a29e4-203">(See highlighted code above.) If user has logged in, it will render the Authorize view, as shown below:</span></span>

![](owin-oauth-20-authorization-server/_static/image2.png)

<span data-ttu-id="a29e4-204">Pokud **udělení** výběru tlačítka `Authorize` akce vytvoří nové identity "Nosiče" a přihlaste se.</span><span class="sxs-lookup"><span data-stu-id="a29e4-204">If the **Grant** button is selected, the `Authorize` action will create a new "Bearer" identity and sign in with it.</span></span> <span data-ttu-id="a29e4-205">Aktivuje autorizační server pro generování nosný token a jejich odesílání zpět do klienta s datovou část JSON.</span><span class="sxs-lookup"><span data-stu-id="a29e4-205">It will trigger the authorization server to generate a bearer token and send it back to the client with JSON payload.</span></span>

### <a name="implicit-grant"></a><span data-ttu-id="a29e4-206">Implicitní Grant</span><span class="sxs-lookup"><span data-stu-id="a29e4-206">Implicit Grant</span></span>

<span data-ttu-id="a29e4-207">Najdete IETF OAuth 2 [implicitní Grant](http://tools.ietf.org/html/rfc6749#section-4.2) části nyní.</span><span class="sxs-lookup"><span data-stu-id="a29e4-207">Refer to the IETF's OAuth 2 [Implicit Grant](http://tools.ietf.org/html/rfc6749#section-4.2) section now.</span></span>

 <span data-ttu-id="a29e4-208">[Implicitní Grant](http://tools.ietf.org/html/rfc6749#section-4.2) tok je znázorněno na obrázku 4 je tok a které mapování OWIN OAuth následuje middlewaru.</span><span class="sxs-lookup"><span data-stu-id="a29e4-208">The [Implicit Grant](http://tools.ietf.org/html/rfc6749#section-4.2) flow shown in Figure 4 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="a29e4-209">Kroky toku z část implicitní udělení</span><span class="sxs-lookup"><span data-stu-id="a29e4-209">Flow steps from Implicit Grant section</span></span> | <span data-ttu-id="a29e4-210">Stažení ukázkové provádí tyto kroky:</span><span class="sxs-lookup"><span data-stu-id="a29e4-210">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="a29e4-211">(A) klienta spouští tok přesměrováním vlastník prostředku uživatelského agenta pro koncový bod autorizace.</span><span class="sxs-lookup"><span data-stu-id="a29e4-211">(A) The client initiates the flow by directing the resource owner's user-agent to the authorization endpoint.</span></span> <span data-ttu-id="a29e4-212">Klient zahrne identifikátoru klienta, požadovaný obor, místní a identifikátor URI přesměrování, na které pošle autorizační server uživatelského agenta, zpět po přístup je udělen (nebo byl odepřen).</span><span class="sxs-lookup"><span data-stu-id="a29e4-212">The client includes its client identifier, requested scope, local state, and a redirection URI to which the authorization server will send the user-agent back once access is granted (or denied).</span></span> | <span data-ttu-id="a29e4-213">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span><span class="sxs-lookup"><span data-stu-id="a29e4-213">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span></span> |
|  |  |
| <span data-ttu-id="a29e4-214">(B) autorizační server ověří vlastníka prostředku (prostřednictvím uživatelského agenta) a zjistí, zda vlastník prostředku udělí nebo zamítne žádost o přístup klienta.</span><span class="sxs-lookup"><span data-stu-id="a29e4-214">(B) The authorization server authenticates the resource owner (via the user-agent) and establishes whether the resource owner grants or denies the client's access request.</span></span> | <span data-ttu-id="a29e4-215">**&lt;If user grants access&gt;** Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="a29e4-215">**&lt;If user grants access&gt;** Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="a29e4-216">(C) za předpokladu, že vlastník prostředku udělí přístup, přesměruje autorizační server uživatelského agenta zpět na klienta pomocí přesměrovacího identifikátoru URI zadaný starší (v žádosti nebo při registraci klienta).</span><span class="sxs-lookup"><span data-stu-id="a29e4-216">(C) Assuming the resource owner grants access, the authorization server redirects the user-agent back to the client using the redirection URI provided earlier (in the request or during client registration).</span></span> <span data-ttu-id="a29e4-217">...</span><span class="sxs-lookup"><span data-stu-id="a29e4-217">...</span></span> |  |
|  |  |
| <span data-ttu-id="a29e4-218">(D) si klient vyžádá přístupový token z koncového bodu tokenu autorizačního serveru zahrnutím autorizační kód přijatý v předchozím kroku.</span><span class="sxs-lookup"><span data-stu-id="a29e4-218">(D) The client requests an access token from the authorization server's token endpoint by including the authorization code received in the previous step.</span></span> <span data-ttu-id="a29e4-219">Když se odešle požadavek, klient se ověří pomocí autorizačního serveru.</span><span class="sxs-lookup"><span data-stu-id="a29e4-219">When making the request, the client authenticates with the authorization server.</span></span> <span data-ttu-id="a29e4-220">Klient obsahuje přesměrovací identifikátor URI používá k získání autorizačního kódu pro ověřování.</span><span class="sxs-lookup"><span data-stu-id="a29e4-220">The client includes the redirection URI used to obtain the authorization code for verification.</span></span> |  |

<span data-ttu-id="a29e4-221">Protože jsme již implementováno koncový bod autorizace (`OAuthController.Authorize` akce) pro udělení autorizačního kódu umožňuje automaticky také implicitní tok.</span><span class="sxs-lookup"><span data-stu-id="a29e4-221">Since we already implemented the authorization endpoint (`OAuthController.Authorize` action) for authorization code grant, it automatically enables implicit flow as well.</span></span> <span data-ttu-id="a29e4-222">Poznámka: `Provider.ValidateClientRedirectUri` slouží k ověření ID klienta s její adresu URL přesměrování, které chrání implicitní grant tok v odesílání přístup token škodlivý klientů ([útoku Man-in-the-middle](https://www.owasp.org/index.php/Man-in-the-middle_attack)).</span><span class="sxs-lookup"><span data-stu-id="a29e4-222">Note: `Provider.ValidateClientRedirectUri` is used to validate the client ID with its redirection URL, which protects the implicit grant flow from sending the access token to malicious clients ([Man-in-the-middle attack](https://www.owasp.org/index.php/Man-in-the-middle_attack)).</span></span>

### <a name="resource-owner-password-credentials-grant"></a><span data-ttu-id="a29e4-223">Udělení pověření heslo vlastníka prostředku</span><span class="sxs-lookup"><span data-stu-id="a29e4-223">Resource Owner Password Credentials Grant</span></span>

<span data-ttu-id="a29e4-224">Najdete IETF OAuth 2 [udělení přihlašovacích údajů heslo vlastníka prostředku](http://tools.ietf.org/html/rfc6749#section-4.3) části nyní.</span><span class="sxs-lookup"><span data-stu-id="a29e4-224">Refer to the IETF's OAuth 2 [Resource Owner Password Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.3) section now.</span></span>

 <span data-ttu-id="a29e4-225">[Udělení přihlašovacích údajů heslo vlastníka prostředku](http://tools.ietf.org/html/rfc6749#section-4.3) tok z obrázku 5 je tok a řídí se middleware mapování, která OWIN OAuth.</span><span class="sxs-lookup"><span data-stu-id="a29e4-225">The [Resource Owner Password Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.3) flow shown in Figure 5 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="a29e4-226">Kroky toku z část udělení přihlašovacích údajů heslo vlastníka prostředku</span><span class="sxs-lookup"><span data-stu-id="a29e4-226">Flow steps from Resource Owner Password Credentials Grant section</span></span> | <span data-ttu-id="a29e4-227">Stažení ukázkové provádí tyto kroky:</span><span class="sxs-lookup"><span data-stu-id="a29e4-227">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="a29e4-228">(A) vlastník prostředku poskytne klientovi své uživatelské jméno a heslo.</span><span class="sxs-lookup"><span data-stu-id="a29e4-228">(A) The resource owner provides the client with its username and password.</span></span> |  |
|  |  |
| <span data-ttu-id="a29e4-229">(B) si klient vyžádá přístupový token z koncového bodu tokenu autorizačního serveru zahrnutím přihlašovacích údajů přijatých od vlastníka prostředku.</span><span class="sxs-lookup"><span data-stu-id="a29e4-229">(B) The client requests an access token from the authorization server's token endpoint by including the credentials received from the resource owner.</span></span> <span data-ttu-id="a29e4-230">Když se odešle požadavek, klient se ověří pomocí autorizačního serveru.</span><span class="sxs-lookup"><span data-stu-id="a29e4-230">When making the request, the client authenticates with the authorization server.</span></span> | <span data-ttu-id="a29e4-231">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantResourceOwnerCredentials Provider.TokenEndpoint AccessToken Provider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="a29e4-231">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantResourceOwnerCredentials Provider.TokenEndpoint AccessToken Provider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="a29e4-232">(C) autorizační server ověří klienta a ověří přihlašovací údaje vlastníka prostředku a pokud je platný, vystaví přístupový token.</span><span class="sxs-lookup"><span data-stu-id="a29e4-232">(C) The authorization server authenticates the client and validates the resource owner credentials, and if valid, issues an access token.</span></span> |  |

<span data-ttu-id="a29e4-233">Tady je ukázková implementace pro `Provider.GrantResourceOwnerCredentials`:</span><span class="sxs-lookup"><span data-stu-id="a29e4-233">Here is the sample implementation for `Provider.GrantResourceOwnerCredentials`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample7.cs)]

> [!NOTE]
> <span data-ttu-id="a29e4-234">Výše uvedený kód je určený k objasnění v této části kurzu a nesmí být použita v zabezpečení nebo produkční aplikace.</span><span class="sxs-lookup"><span data-stu-id="a29e4-234">The code above is intended to explain this section of the tutorial and should not be used in secure or production apps.</span></span> <span data-ttu-id="a29e4-235">Nekontroluje pověření vlastníky prostředků.</span><span class="sxs-lookup"><span data-stu-id="a29e4-235">It does not check the resource owners credentials.</span></span> <span data-ttu-id="a29e4-236">Předpokládá, že se každý přihlašovacích údajů je platný a vytvoří novou identitu pro něj.</span><span class="sxs-lookup"><span data-stu-id="a29e4-236">It assumes every credential is valid and creates a new identity for it.</span></span> <span data-ttu-id="a29e4-237">Nové identity se použije k vygenerování přístupového tokenu a obnovovací token.</span><span class="sxs-lookup"><span data-stu-id="a29e4-237">The new identity will be used to generate the access token and refresh token.</span></span> <span data-ttu-id="a29e4-238">Nahraďte kód vlastní kód pro správu zabezpečení účtu.</span><span class="sxs-lookup"><span data-stu-id="a29e4-238">Please replace the code with your own secure account management code.</span></span>


### <a name="client-credentials-grant"></a><span data-ttu-id="a29e4-239">Udělení pověření klienta</span><span class="sxs-lookup"><span data-stu-id="a29e4-239">Client Credentials Grant</span></span>

<span data-ttu-id="a29e4-240">Najdete IETF OAuth 2 [udělení klientských přihlašovacích údajů](http://tools.ietf.org/html/rfc6749#section-4.4) části nyní.</span><span class="sxs-lookup"><span data-stu-id="a29e4-240">Refer to the IETF's OAuth 2 [Client Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.4) section now.</span></span>

 <span data-ttu-id="a29e4-241">[Udělení klientských přihlašovacích údajů](http://tools.ietf.org/html/rfc6749#section-4.4) tok je znázorněno na obrázku 6 je tok a řídí se middleware mapování, která OWIN OAuth.</span><span class="sxs-lookup"><span data-stu-id="a29e4-241">The [Client Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.4) flow shown in Figure 6 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="a29e4-242">Kroky toku z část udělování přihlašovacích údajů klienta</span><span class="sxs-lookup"><span data-stu-id="a29e4-242">Flow steps from Client Credentials Grant section</span></span> | <span data-ttu-id="a29e4-243">Stažení ukázkové provádí tyto kroky:</span><span class="sxs-lookup"><span data-stu-id="a29e4-243">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="a29e4-244">(A) klient ověřuje pomocí autorizačního serveru a vyžádá přístupový token z koncového bodu tokenu.</span><span class="sxs-lookup"><span data-stu-id="a29e4-244">(A) The client authenticates with the authorization server and requests an access token from the token endpoint.</span></span> | <span data-ttu-id="a29e4-245">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantClientCredentials Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="a29e4-245">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantClientCredentials Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="a29e4-246">(B) autorizační server ověří klienta a pokud je platný, vystaví přístupový token.</span><span class="sxs-lookup"><span data-stu-id="a29e4-246">(B) The authorization server authenticates the client, and if valid, issues an access token.</span></span> |  |

<span data-ttu-id="a29e4-247">Tady je ukázková implementace pro `Provider.GrantClientCredentials`:</span><span class="sxs-lookup"><span data-stu-id="a29e4-247">Here is the sample implementation for `Provider.GrantClientCredentials`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample8.cs)]

> [!NOTE]
> <span data-ttu-id="a29e4-248">Výše uvedený kód je určený k objasnění v této části kurzu a nesmí být použita v zabezpečení nebo produkční aplikace.</span><span class="sxs-lookup"><span data-stu-id="a29e4-248">The code above is intended to explain this section of the tutorial and should not be used in secure or production apps.</span></span> <span data-ttu-id="a29e4-249">Nahraďte kód vlastní kód pro správu klientů.</span><span class="sxs-lookup"><span data-stu-id="a29e4-249">Please replace the code with your own secure client management code.</span></span>


### <a name="refresh-token"></a><span data-ttu-id="a29e4-250">Aktualizovat Token</span><span class="sxs-lookup"><span data-stu-id="a29e4-250">Refresh Token</span></span>

<span data-ttu-id="a29e4-251">Najdete IETF OAuth 2 [aktualizovat Token](http://tools.ietf.org/html/rfc6749#section-1.5) části nyní.</span><span class="sxs-lookup"><span data-stu-id="a29e4-251">Refer to the IETF's OAuth 2 [Refresh Token](http://tools.ietf.org/html/rfc6749#section-1.5) section now.</span></span>

 <span data-ttu-id="a29e4-252">[Aktualizovat Token](http://tools.ietf.org/html/rfc6749#section-1.5) tok je znázorněno na obrázku 2 je tok a které mapování OWIN OAuth následuje middlewaru.</span><span class="sxs-lookup"><span data-stu-id="a29e4-252">The [Refresh Token](http://tools.ietf.org/html/rfc6749#section-1.5) flow shown in Figure 2 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="a29e4-253">Kroky toku z část udělování přihlašovacích údajů klienta</span><span class="sxs-lookup"><span data-stu-id="a29e4-253">Flow steps from Client Credentials Grant section</span></span> | <span data-ttu-id="a29e4-254">Stažení ukázkové provádí tyto kroky:</span><span class="sxs-lookup"><span data-stu-id="a29e4-254">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="a29e4-255">(G) si klient vyžádá nový přístupový token díky ověřování pomocí autorizačního serveru a nabízí ten samý token obnovení.</span><span class="sxs-lookup"><span data-stu-id="a29e4-255">(G) The client requests a new access token by authenticating with the authorization server and presenting the refresh token.</span></span> <span data-ttu-id="a29e4-256">Požadavky na ověřování klienta jsou založeny na typu klienta a server zásad autorizace.</span><span class="sxs-lookup"><span data-stu-id="a29e4-256">The client authentication requirements are based on the client type and on the authorization server policies.</span></span> | <span data-ttu-id="a29e4-257">Provider.MatchEndpoint Provider.ValidateClientAuthentication RefreshTokenProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantRefreshToken Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="a29e4-257">Provider.MatchEndpoint Provider.ValidateClientAuthentication RefreshTokenProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantRefreshToken Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="a29e4-258">(H) autorizační server ověří klienta a ověří obnovovací token a pokud je platný, vystaví nový přístupový token (a volitelně nového tokenu obnovení).</span><span class="sxs-lookup"><span data-stu-id="a29e4-258">(H) The authorization server authenticates the client and validates the refresh token, and if valid, issues a new access token (and, optionally, a new refresh token).</span></span> |  |

<span data-ttu-id="a29e4-259">Tady je ukázková implementace pro `Provider.GrantRefreshToken`:</span><span class="sxs-lookup"><span data-stu-id="a29e4-259">Here is the sample implementation for `Provider.GrantRefreshToken`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample9.cs)]

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample10.cs)]

## <a name="create-a-resource-server-which-is-protected-by-access-token"></a><span data-ttu-id="a29e4-260">Vytvoření prostředků serveru, který je chráněn přístupový Token</span><span class="sxs-lookup"><span data-stu-id="a29e4-260">Create a Resource Server which is protected by Access Token</span></span>

<span data-ttu-id="a29e4-261">Vytvoření projektu prázdnou webovou aplikaci a nainstalujte následující balíčky v projektu:</span><span class="sxs-lookup"><span data-stu-id="a29e4-261">Create an empty web app project and install following packages in the project:</span></span>

- <span data-ttu-id="a29e4-262">Microsoft.AspNet.WebApi.Owin</span><span class="sxs-lookup"><span data-stu-id="a29e4-262">Microsoft.AspNet.WebApi.Owin</span></span>
- <span data-ttu-id="a29e4-263">Microsoft.Owin.Host.SystemWeb</span><span class="sxs-lookup"><span data-stu-id="a29e4-263">Microsoft.Owin.Host.SystemWeb</span></span>
- <span data-ttu-id="a29e4-264">Microsoft.Owin.Security.OAuth</span><span class="sxs-lookup"><span data-stu-id="a29e4-264">Microsoft.Owin.Security.OAuth</span></span>

<span data-ttu-id="a29e4-265">Vytvořte třídu, spuštění a konfigurovat ověřování a webové rozhraní API.</span><span class="sxs-lookup"><span data-stu-id="a29e4-265">Create a startup class and configure authentication and Web API.</span></span> <span data-ttu-id="a29e4-266">Zobrazit *AuthorizationServer\ResourceServer\Startup.cs* ve vzorku ke stažení.</span><span class="sxs-lookup"><span data-stu-id="a29e4-266">See *AuthorizationServer\ResourceServer\Startup.cs* in the sample download.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample11.cs)]

<span data-ttu-id="a29e4-267">Zobrazit *AuthorizationServer\ResourceServer\App\_Start\Startup.Auth.cs* ve vzorku ke stažení.</span><span class="sxs-lookup"><span data-stu-id="a29e4-267">See *AuthorizationServer\ResourceServer\App\_Start\Startup.Auth.cs* in the sample download.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample12.cs)]

<span data-ttu-id="a29e4-268">Zobrazit *AuthorizationServer\ResourceServer\App\_Start\Startup.WebApi.cs* ve vzorku ke stažení.</span><span class="sxs-lookup"><span data-stu-id="a29e4-268">See *AuthorizationServer\ResourceServer\App\_Start\Startup.WebApi.cs* in the sample download.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample13.cs)]

- <span data-ttu-id="a29e4-269">`UseCors` metoda umožňuje CORS pro všechny domény.</span><span class="sxs-lookup"><span data-stu-id="a29e4-269">`UseCors` method allows CORS for all domains.</span></span>
- <span data-ttu-id="a29e4-270">`UseOAuthBearerAuthentication` metoda umožňuje middlewaru ověřování pomocí tokenu nosiče OAuth, který bude přijímat a ověřovat nosný token z autorizační hlavičky v požadavku.</span><span class="sxs-lookup"><span data-stu-id="a29e4-270">`UseOAuthBearerAuthentication` method enables OAuth bearer token authentication middleware which will receive and validate bearer token from authorization header in the request.</span></span>
- <span data-ttu-id="a29e4-271">`Config.SuppressDefaultHostAuthenticaiton` potlačí výchozí hostiteli ověřený objekt zabezpečení z aplikace, proto všechny požadavky budou anonymní po tomto volání.</span><span class="sxs-lookup"><span data-stu-id="a29e4-271">`Config.SuppressDefaultHostAuthenticaiton` suppresses default host authenticated principal from the app, therefore all requests will be anonymous after this call.</span></span>
- <span data-ttu-id="a29e4-272">`HostAuthenticationFilter` Umožňuje ověřování jenom pro zadaný typ ověřování.</span><span class="sxs-lookup"><span data-stu-id="a29e4-272">`HostAuthenticationFilter` enables authentication just for the specified authentication type.</span></span> <span data-ttu-id="a29e4-273">V takovém případě je typ ověřování nosného tokenu.</span><span class="sxs-lookup"><span data-stu-id="a29e4-273">In this case, it's bearer authentication type.</span></span>

<span data-ttu-id="a29e4-274">Aby bylo možné předvést ověřenou identitu, vytvoříme objektu ApiController výstup deklarací identity aktuálního uživatele.</span><span class="sxs-lookup"><span data-stu-id="a29e4-274">In order to demonstrate the authenticated identity, we create an ApiController to output current user's claims.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample14.cs)]

<span data-ttu-id="a29e4-275">Pokud autorizační server a server prostředků nejsou ve stejném počítači, OAuth middleware použije jiný počítač klíče k šifrování a dešifrování nosný token přístupu.</span><span class="sxs-lookup"><span data-stu-id="a29e4-275">If the authorization server and the resource server are not on the same computer, the OAuth middleware will use the different machine keys to encrypt and decrypt bearer access token.</span></span> <span data-ttu-id="a29e4-276">Aby bylo možné sdílet stejný soukromý klíč mezi oba projekty, můžeme přidat stejnou `machinekey` nastavení v obou *web.config* soubory.</span><span class="sxs-lookup"><span data-stu-id="a29e4-276">In order to share the same private key between both projects, we add the same `machinekey` setting in both *web.config* files.</span></span>

[!code-xml[Main](owin-oauth-20-authorization-server/samples/sample15.xml?highlight=8-10)]

## <a name="create-oauth-20-clients"></a><span data-ttu-id="a29e4-277">Vytvoření klientů OAuth 2.0</span><span class="sxs-lookup"><span data-stu-id="a29e4-277">Create OAuth 2.0 Clients</span></span>

 <span data-ttu-id="a29e4-278">Používáme [DotNetOpenAuth.OAuth2.Client](http://www.nuget.org/packages/DotNetOpenAuth.OAuth2.Client) balíček NuGet pro zjednodušení kódu klienta.</span><span class="sxs-lookup"><span data-stu-id="a29e4-278">We use the [DotNetOpenAuth.OAuth2.Client](http://www.nuget.org/packages/DotNetOpenAuth.OAuth2.Client) NuGet package to simplify the client code.</span></span>

### <a name="authorization-code-grant-client"></a><span data-ttu-id="a29e4-279">Autorizační kód udělení klienta</span><span class="sxs-lookup"><span data-stu-id="a29e4-279">Authorization Code Grant Client</span></span>

 <span data-ttu-id="a29e4-280">Tento klient je aplikace MVC.</span><span class="sxs-lookup"><span data-stu-id="a29e4-280">This client is an MVC application.</span></span> <span data-ttu-id="a29e4-281">Aktivuje toku přidělení kódu autorizace k získání tokenu přístupu z back-endu.</span><span class="sxs-lookup"><span data-stu-id="a29e4-281">It will trigger an authorization code grant flow to get the access token from backend.</span></span> <span data-ttu-id="a29e4-282">Má jednu stránku, jak je znázorněno níže:</span><span class="sxs-lookup"><span data-stu-id="a29e4-282">It has a single page as shown below:</span></span>

![](owin-oauth-20-authorization-server/_static/image3.png)

- <span data-ttu-id="a29e4-283">**Authorize** tlačítko přesměruje autorizační server na upozornění pro vlastníka prostředku k udělení přístupu pro tohoto klienta prohlížeče.</span><span class="sxs-lookup"><span data-stu-id="a29e4-283">The **Authorize** button will redirect browser to the authorization server to notify the resource owner to grant access to this client.</span></span>
- <span data-ttu-id="a29e4-284">**Aktualizovat** tlačítko bude získat nový přístupový token a aktualizaci tokenu pomocí aktuální obnovovací token.</span><span class="sxs-lookup"><span data-stu-id="a29e4-284">The **Refresh** button will get a new access token and refresh token using the current refresh token.</span></span>
- <span data-ttu-id="a29e4-285">**Rozhraní API prostředku s ochranou přístupu** tlačítko bude volat server prostředků k získání aktuálního uživatele deklarace dat a zobrazit na stránce.</span><span class="sxs-lookup"><span data-stu-id="a29e4-285">The **Access Protected Resource API** button will call the resource server to get current user's claims data and show them on the page.</span></span>

<span data-ttu-id="a29e4-286">Tady je ukázkový kód `HomeController` klienta.</span><span class="sxs-lookup"><span data-stu-id="a29e4-286">Here is the sample code of the `HomeController` of the client.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample16.cs)]

<span data-ttu-id="a29e4-287">`DotNetOpenAuth` ve výchozím nastavení vyžaduje protokol SSL.</span><span class="sxs-lookup"><span data-stu-id="a29e4-287">`DotNetOpenAuth` requires SSL by default.</span></span> <span data-ttu-id="a29e4-288">Vzhledem k tomu, že naše Ukázka používá HTTP, budete muset přidat následující nastavení v konfiguračním souboru:</span><span class="sxs-lookup"><span data-stu-id="a29e4-288">Since our demo is using HTTP, you need to add following setting in the config file:</span></span>

[!code-xml[Main](owin-oauth-20-authorization-server/samples/sample17.xml?highlight=4-6)]

> [!WARNING]
> <span data-ttu-id="a29e4-289">Zabezpečení – nikdy zakázat SSL v produkční aplikace.</span><span class="sxs-lookup"><span data-stu-id="a29e4-289">Security - Never disable SSL in a production app.</span></span> <span data-ttu-id="a29e4-290">Přihlašovací údaje jsou nyní sítí odesílány ve formátu prostého textu.</span><span class="sxs-lookup"><span data-stu-id="a29e4-290">Your login credentials are now being sent in clear-text across the wire.</span></span> <span data-ttu-id="a29e4-291">Výše uvedený kód je jenom pro místní ukázky ladění a prozkoumávání.</span><span class="sxs-lookup"><span data-stu-id="a29e4-291">The code above is just for local sample debugging and exploration.</span></span>


### <a name="implicit-grant-client"></a><span data-ttu-id="a29e4-292">Implicitní Grant klienta</span><span class="sxs-lookup"><span data-stu-id="a29e4-292">Implicit Grant Client</span></span>

<span data-ttu-id="a29e4-293">Tento klient je pomocí kódu jazyka JavaScript:</span><span class="sxs-lookup"><span data-stu-id="a29e4-293">This client is using JavaScript to:</span></span>

1. <span data-ttu-id="a29e4-294">Otevřete nové okno a přesměrovat na koncový bod authorize serveru ověřování.</span><span class="sxs-lookup"><span data-stu-id="a29e4-294">Open a new window and redirect to the authorize endpoint of the Authorization Server.</span></span>
2. <span data-ttu-id="a29e4-295">Získání tokenu přístupu z adresy URL fragmenty při přesměrování zpět.</span><span class="sxs-lookup"><span data-stu-id="a29e4-295">Get the access token from URL fragments when it redirects back.</span></span>

<span data-ttu-id="a29e4-296">Tento proces je znázorněn na následujícím obrázku:</span><span class="sxs-lookup"><span data-stu-id="a29e4-296">The following image shows this process:</span></span>

![](owin-oauth-20-authorization-server/_static/image4.png)

<span data-ttu-id="a29e4-297">Klient by měl mít dvě stránky: jeden pro domovskou stránku a druhou pro zpětné volání. Toto je ukázka součástí kódu jazyka JavaScript *Index.cshtml* souboru:</span><span class="sxs-lookup"><span data-stu-id="a29e4-297">The client should have two pages: one for home page and the other for callback.Here is the sample JavaScript code found in the *Index.cshtml* file:</span></span>

[!code-cshtml[Main](owin-oauth-20-authorization-server/samples/sample18.cshtml)]

<span data-ttu-id="a29e4-298">Tady je funkce zpětného volání v kódu pro zpracování *SignIn.cshtml* souboru:</span><span class="sxs-lookup"><span data-stu-id="a29e4-298">Here is the callback handling code in *SignIn.cshtml* file:</span></span>

[!code-cshtml[Main](owin-oauth-20-authorization-server/samples/sample19.cshtml)]

> [!NOTE]
> <span data-ttu-id="a29e4-299">Osvědčeným postupem je přesunout na externí soubor jazyka JavaScript a Nevkládat se značkami Razor.</span><span class="sxs-lookup"><span data-stu-id="a29e4-299">A best practice is to move the JavaScript to an external file and not embed it with the Razor markup.</span></span> <span data-ttu-id="a29e4-300">Pro zjednodušení této ukázku je kombinovat.</span><span class="sxs-lookup"><span data-stu-id="a29e4-300">To keep this sample simple, they have been combined.</span></span>


### <a name="resource-owner-password-credentials-grant-client"></a><span data-ttu-id="a29e4-301">Heslo vlastníka prostředku přihlašovacích údajů klienta udělení</span><span class="sxs-lookup"><span data-stu-id="a29e4-301">Resource Owner Password Credentials Grant Client</span></span>

<span data-ttu-id="a29e4-302">Ukázka tohoto klienta jsme pomocí konzolové aplikace.</span><span class="sxs-lookup"><span data-stu-id="a29e4-302">We uses a console app to demo this client.</span></span> <span data-ttu-id="a29e4-303">Zde je kód:</span><span class="sxs-lookup"><span data-stu-id="a29e4-303">Here is the code:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample20.cs)]

### <a name="client-credentials-grant-client"></a><span data-ttu-id="a29e4-304">Klient udělení přihlašovacích údajů klienta</span><span class="sxs-lookup"><span data-stu-id="a29e4-304">Client Credentials Grant Client</span></span>

<span data-ttu-id="a29e4-305">Podobně jako u udělení přihlašovacích údajů heslo vlastníka prostředku, tady je kód aplikace konzoly:</span><span class="sxs-lookup"><span data-stu-id="a29e4-305">Similar to the Resource Owner Password Credentials Grant, here is console app code:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample21.cs)]
