---
uid: aspnet/overview/owin-and-katana/owin-oauth-20-authorization-server
title: OWIN OAuth 2.0 Autorizační server | Dokumenty společnosti Microsoft
author: hongyes
description: Tento výukový program vás provede tím, jak implementovat Autorizační server OAuth 2.0 pomocí middlewaru OWIN OAuth. Jedná se o pokročilý výukový program, který pouze outlin ...
ms.author: riande
ms.date: 03/20/2014
ms.assetid: 20acee16-c70c-41e9-b38f-92bfcf9a4c1c
msc.legacyurl: /aspnet/overview/owin-and-katana/owin-oauth-20-authorization-server
msc.type: authoredcontent
ms.openlocfilehash: d758fa2639d10e1b7be8d87c5d1f7adb7e292ac7
ms.sourcegitcommit: 022f79dbc1350e0c6ffaa1e7e7c6e850cdabf9af
ms.translationtype: MT
ms.contentlocale: cs-CZ
ms.lasthandoff: 04/17/2020
ms.locfileid: "81540389"
---
<a name="owin-oauth-20-authorization-server"></a><span data-ttu-id="4e400-104">Autorizační server OWIN OAuth 2.0</span><span class="sxs-lookup"><span data-stu-id="4e400-104">OWIN OAuth 2.0 Authorization Server</span></span>
====================
<span data-ttu-id="4e400-105">podle [Hongye Sun](https://github.com/hongyes) a [Praburaj Thiagarajan](https://github.com/Praburaj)</span><span class="sxs-lookup"><span data-stu-id="4e400-105">by [Hongye Sun](https://github.com/hongyes) and [Praburaj Thiagarajan](https://github.com/Praburaj)</span></span>

> <span data-ttu-id="4e400-106">Tento výukový program vás provede tím, jak implementovat Autorizační server OAuth 2.0 pomocí middlewaru OWIN OAuth.</span><span class="sxs-lookup"><span data-stu-id="4e400-106">This tutorial will guide you on how to implement an OAuth 2.0 Authorization Server using OWIN OAuth middleware.</span></span> <span data-ttu-id="4e400-107">Toto je pokročilý kurz, který pouze popisuje kroky k vytvoření Autorizačního serveru OWin OAuth 2.0.</span><span class="sxs-lookup"><span data-stu-id="4e400-107">This is an advanced tutorial that only outlines the steps to create an OWIN OAuth 2.0 Authorization Server.</span></span> <span data-ttu-id="4e400-108">Toto není krok za krokem tutorial.</span><span class="sxs-lookup"><span data-stu-id="4e400-108">This is not a step by step tutorial.</span></span> <span data-ttu-id="4e400-109">[Stáhněte si ukázkový kód](https://code.msdn.microsoft.com/OWIN-OAuth-20-Authorization-ba2b8783/file/114932/1/AuthorizationServer.zip).</span><span class="sxs-lookup"><span data-stu-id="4e400-109">[Download the sample code](https://code.msdn.microsoft.com/OWIN-OAuth-20-Authorization-ba2b8783/file/114932/1/AuthorizationServer.zip).</span></span>
>
> > [!NOTE]
> > <span data-ttu-id="4e400-110">Tento přehled by neměl být určen k vytvoření zabezpečené produkční aplikace.</span><span class="sxs-lookup"><span data-stu-id="4e400-110">This outline should not be intended to be used for creating a secure production app.</span></span> <span data-ttu-id="4e400-111">Tento kurz je určen pouze přehled o tom, jak implementovat OAuth 2.0 Autorizační server pomocí MiddleWare OWIN OAuth.</span><span class="sxs-lookup"><span data-stu-id="4e400-111">This tutorial is intended to provide only an outline on how to implement an OAuth 2.0 Authorization Server using OWIN OAuth middleware.</span></span>
>
>
> ## <a name="software-versions"></a><span data-ttu-id="4e400-112">Verze softwaru</span><span class="sxs-lookup"><span data-stu-id="4e400-112">Software versions</span></span>
>
> | <span data-ttu-id="4e400-113">**Zobrazeno v tutoriálu**</span><span class="sxs-lookup"><span data-stu-id="4e400-113">**Shown in the tutorial**</span></span> | <span data-ttu-id="4e400-114">**Pracuje také s**</span><span class="sxs-lookup"><span data-stu-id="4e400-114">**Also works with**</span></span> |
> | --- | --- |
> | <span data-ttu-id="4e400-115">Windows 8.1</span><span class="sxs-lookup"><span data-stu-id="4e400-115">Windows 8.1</span></span> | <span data-ttu-id="4e400-116">Windows 8, Windows 7</span><span class="sxs-lookup"><span data-stu-id="4e400-116">Windows 8, Windows 7</span></span> |
> | [<span data-ttu-id="4e400-117">Visual Studio 2013</span><span class="sxs-lookup"><span data-stu-id="4e400-117">Visual Studio 2013</span></span>](https://my.visualstudio.com/Downloads?q=visual%20studio%202013) | <span data-ttu-id="4e400-118">[Visual Studio 2013 Express pro stolní počítače](https://my.visualstudio.com/Downloads?q=visual%20studio%202013#d-2013-express).</span><span class="sxs-lookup"><span data-stu-id="4e400-118">[Visual Studio 2013 Express for Desktop](https://my.visualstudio.com/Downloads?q=visual%20studio%202013#d-2013-express).</span></span> <span data-ttu-id="4e400-119">Visual Studio 2012 s nejnovější aktualizací by mělo fungovat, ale kurz nebyl testován s ním a některé nabídky výběry a dialogová okna se liší.</span><span class="sxs-lookup"><span data-stu-id="4e400-119">Visual Studio 2012 with the latest update should work, but the tutorial has not been tested with it, and some menu selections and dialog boxes are different.</span></span> |
> | <span data-ttu-id="4e400-120">.NET 4.5</span><span class="sxs-lookup"><span data-stu-id="4e400-120">.NET 4.5</span></span> |  |
>
> ## <a name="questions-and-comments"></a><span data-ttu-id="4e400-121">Otázky a komentáře</span><span class="sxs-lookup"><span data-stu-id="4e400-121">Questions and Comments</span></span>
>
> <span data-ttu-id="4e400-122">Pokud máte otázky, které přímo nesouvisejí s tutoriálem, můžete je zveřejnit v [projektu Katana na GitHubu](https://github.com/aspnet/AspNetKatana/).</span><span class="sxs-lookup"><span data-stu-id="4e400-122">If you have questions that are not directly related to the tutorial, you can post them at [Katana Project on GitHub](https://github.com/aspnet/AspNetKatana/).</span></span> <span data-ttu-id="4e400-123">Dotazy a komentáře týkající se samotného výukového programu naleznete v části komentáře v dolní části stránky.</span><span class="sxs-lookup"><span data-stu-id="4e400-123">For questions and comments regarding the tutorial itself, see the comments section at the bottom of the page.</span></span>


<span data-ttu-id="4e400-124">Architektura [OAuth 2.0](http://tools.ietf.org/html/rfc6749) umožňuje aplikaci jiného výrobce získat omezený přístup ke službě HTTP.</span><span class="sxs-lookup"><span data-stu-id="4e400-124">The [OAuth 2.0 framework](http://tools.ietf.org/html/rfc6749) enables a third-party app to obtain limited access to an HTTP service.</span></span> <span data-ttu-id="4e400-125">Namísto použití pověření vlastníka prostředku pro přístup k chráněnému prostředku získá klient přístupový token (což je řetězec označující určitý obor, životnost a další atributy přístupu).</span><span class="sxs-lookup"><span data-stu-id="4e400-125">Instead of using the resource owner's credentials to access a protected resource, the client obtains an access token (which is a string denoting a specific scope, lifetime, and other access attributes).</span></span> <span data-ttu-id="4e400-126">Přístupové tokeny jsou vydávány klientům třetích stran autorizačním serverem se souhlasem vlastníka prostředku.</span><span class="sxs-lookup"><span data-stu-id="4e400-126">Access tokens are issued to third-party clients by an authorization server with the approval of the resource owner.</span></span>

<span data-ttu-id="4e400-127">Tento výukový program se bude týkat:</span><span class="sxs-lookup"><span data-stu-id="4e400-127">This tutorial will cover:</span></span>

- <span data-ttu-id="4e400-128">Jak vytvořit autorizační server pro podporu čtyř typů autorizačních oprávnění a tokenů aktualizace:</span><span class="sxs-lookup"><span data-stu-id="4e400-128">How to create an authorization server to support four authorization grant types and refresh tokens:</span></span>
    - <span data-ttu-id="4e400-129">Udělení autorizačního kódu</span><span class="sxs-lookup"><span data-stu-id="4e400-129">Authorization code grant</span></span>
    - <span data-ttu-id="4e400-130">Implicitní grant</span><span class="sxs-lookup"><span data-stu-id="4e400-130">Implicit Grant</span></span>
    - <span data-ttu-id="4e400-131">Grant pověření vlastníka prostředku</span><span class="sxs-lookup"><span data-stu-id="4e400-131">Resource Owner Password Credentials Grant</span></span>
    - <span data-ttu-id="4e400-132">Udělení pověření klienta</span><span class="sxs-lookup"><span data-stu-id="4e400-132">Client Credentials Grant</span></span>
- <span data-ttu-id="4e400-133">Vytvoření serveru prostředků, který je chráněn přístupovým tokenem.</span><span class="sxs-lookup"><span data-stu-id="4e400-133">Creating a resource server which is protected by an access token.</span></span>
- <span data-ttu-id="4e400-134">Vytváření klientů OAuth 2.0.</span><span class="sxs-lookup"><span data-stu-id="4e400-134">Creating OAuth 2.0 clients.</span></span>

<a id="prerequisites"></a>
## <a name="prerequisites"></a><span data-ttu-id="4e400-135">Požadavky</span><span class="sxs-lookup"><span data-stu-id="4e400-135">Prerequisites</span></span>

- <span data-ttu-id="4e400-136">[Visual Studio 2013](https://www.microsoft.com/visualstudio/eng/downloads#d-2013-editions) nebo visual [studio express 2013](https://www.microsoft.com/visualstudio/eng/downloads#d-2013-express)zdarma , jak je uvedeno v **softwarových verzích** v horní části stránky.</span><span class="sxs-lookup"><span data-stu-id="4e400-136">[Visual Studio 2013](https://www.microsoft.com/visualstudio/eng/downloads#d-2013-editions) or the free [Visual Studio Express 2013](https://www.microsoft.com/visualstudio/eng/downloads#d-2013-express), as indicated in **Software Versions** at the top of the page.</span></span>
- <span data-ttu-id="4e400-137">Znalost OWIN.</span><span class="sxs-lookup"><span data-stu-id="4e400-137">Familiarity with OWIN.</span></span> <span data-ttu-id="4e400-138">Viz [Začínáme s katana projektu](https://msdn.microsoft.com/magazine/dn451439.aspx) a [co je nového v OWIN a Katana](index.md).</span><span class="sxs-lookup"><span data-stu-id="4e400-138">See [Getting Started with the Katana Project](https://msdn.microsoft.com/magazine/dn451439.aspx) and [What's new in OWIN and Katana](index.md).</span></span>
- <span data-ttu-id="4e400-139">Znalost terminologie [OAuth,](http://tools.ietf.org/html/rfc6749) včetně [rolí](http://tools.ietf.org/html/rfc6749#section-1.1), [toku protokolu](http://tools.ietf.org/html/rfc6749#section-1.2)a [udělení autorizace](http://tools.ietf.org/html/rfc6749#section-1.3).</span><span class="sxs-lookup"><span data-stu-id="4e400-139">Familiarity with [OAuth](http://tools.ietf.org/html/rfc6749) terminology, including [Roles](http://tools.ietf.org/html/rfc6749#section-1.1), [Protocol Flow](http://tools.ietf.org/html/rfc6749#section-1.2), and [Authorization Grant](http://tools.ietf.org/html/rfc6749#section-1.3).</span></span> <span data-ttu-id="4e400-140">[OAuth 2.0 úvod](http://tools.ietf.org/html/rfc6749#section-1) poskytuje dobrý úvod.</span><span class="sxs-lookup"><span data-stu-id="4e400-140">[OAuth 2.0 introduction](http://tools.ietf.org/html/rfc6749#section-1) provides a good introduction.</span></span>

## <a name="create-an-authorization-server"></a><span data-ttu-id="4e400-141">Vytvoření autorizačního serveru</span><span class="sxs-lookup"><span data-stu-id="4e400-141">Create an Authorization Server</span></span>

<span data-ttu-id="4e400-142">V tomto kurzu budeme zhruba načrtnout, jak používat [OWIN](https://msdn.microsoft.com/magazine/dn451439.aspx) a ASP.NET MVC k vytvoření autorizačního serveru.</span><span class="sxs-lookup"><span data-stu-id="4e400-142">In this tutorial, we will roughly sketch out how to use [OWIN](https://msdn.microsoft.com/magazine/dn451439.aspx) and ASP.NET MVC to create an authorization server.</span></span> <span data-ttu-id="4e400-143">Doufáme, že brzy poskytneme ke stažení pro dokončený vzorek, protože tento výukový program nezahrnuje každý krok.</span><span class="sxs-lookup"><span data-stu-id="4e400-143">We hope to soon provide a download for the completed sample, as this tutorial does not include each step.</span></span> <span data-ttu-id="4e400-144">Nejprve vytvořte prázdnou webovou aplikaci s názvem *AuthorizationServer* a nainstalujte následující balíčky:</span><span class="sxs-lookup"><span data-stu-id="4e400-144">First, create an empty web app named *AuthorizationServer* and install the following packages:</span></span>

- <span data-ttu-id="4e400-145">Microsoft.AspNet.Mvc</span><span class="sxs-lookup"><span data-stu-id="4e400-145">Microsoft.AspNet.Mvc</span></span>
- <span data-ttu-id="4e400-146">Microsoft.Owin.Host.SystemWeb</span><span class="sxs-lookup"><span data-stu-id="4e400-146">Microsoft.Owin.Host.SystemWeb</span></span>
- <span data-ttu-id="4e400-147">Microsoft.Owin.Security.OAuth</span><span class="sxs-lookup"><span data-stu-id="4e400-147">Microsoft.Owin.Security.OAuth</span></span>
- <span data-ttu-id="4e400-148">Microsoft.Owin.Security.Cookies</span><span class="sxs-lookup"><span data-stu-id="4e400-148">Microsoft.Owin.Security.Cookies</span></span>
- <span data-ttu-id="4e400-149">Microsoft.Owin.Security.Google (Nebo jakýkoli jiný balíček pro přihlášení k sociálním sítím, například Microsoft.Owin.Security.Facebook)</span><span class="sxs-lookup"><span data-stu-id="4e400-149">Microsoft.Owin.Security.Google (Or any other social login package such as Microsoft.Owin.Security.Facebook)</span></span>

<span data-ttu-id="4e400-150">Přidejte [třídu OWIN Startup](owin-startup-class-detection.md) pod kořenovou složku projektu s názvem *Startup*.</span><span class="sxs-lookup"><span data-stu-id="4e400-150">Add an [OWIN Startup class](owin-startup-class-detection.md) under the project root folder named *Startup*.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample1.cs?highlight=8)]

<span data-ttu-id="4e400-151">Vytvořte složku *Start aplikace.\_*</span><span class="sxs-lookup"><span data-stu-id="4e400-151">Create an *App\_Start* folder.</span></span> <span data-ttu-id="4e400-152">Vyberte složku *Start\_aplikace* a pomocí shift+alt+a přidejte staženou verzi souboru *AuthorizationServer\Start_App\Startup.Auth.cs.\_*</span><span class="sxs-lookup"><span data-stu-id="4e400-152">Select the *App\_Start* folder and use Shift+Alt+A to add the downloaded version of the *AuthorizationServer\App\_Start\Startup.Auth.cs* file.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample2.cs)]

<span data-ttu-id="4e400-153">Výše uvedený kód umožňuje aplikace / externí přihlášení cookies a ověřování Google, které jsou používány autorizační server sám pro správu účtů.</span><span class="sxs-lookup"><span data-stu-id="4e400-153">The code above enables application/external sign in cookies and Google authentication, which are used by authorization server itself to manage accounts.</span></span>

<span data-ttu-id="4e400-154">Metoda `UseOAuthAuthorizationServer` rozšíření je nastavení autorizačního serveru.</span><span class="sxs-lookup"><span data-stu-id="4e400-154">The `UseOAuthAuthorizationServer` extension method is to setup the authorization server.</span></span> <span data-ttu-id="4e400-155">Možnosti nastavení jsou:</span><span class="sxs-lookup"><span data-stu-id="4e400-155">The setup options are:</span></span>

- <span data-ttu-id="4e400-156">`AuthorizeEndpointPath`: Cesta požadavku, kde klientské aplikace přesměrují uživatelského agenta za účelem získání souhlasu uživatelů s vydáním tokenu nebo kódu.</span><span class="sxs-lookup"><span data-stu-id="4e400-156">`AuthorizeEndpointPath`: The request path where client applications will redirect the user-agent in order to obtain the users consent to issue a token or code.</span></span> <span data-ttu-id="4e400-157">Musí začínat například úvodním`/Authorize`lomítkem " ".</span><span class="sxs-lookup"><span data-stu-id="4e400-157">It must begin with a leading slash, for example, "`/Authorize`".</span></span>
- <span data-ttu-id="4e400-158">`TokenEndpointPath`: Klientské aplikace cesty požadavku přímo komunikují k získání přístupového tokenu.</span><span class="sxs-lookup"><span data-stu-id="4e400-158">`TokenEndpointPath`: The request path client applications directly communicate to obtain the access token.</span></span> <span data-ttu-id="4e400-159">Musí začínat úvodním lomítkem, například "/Token".</span><span class="sxs-lookup"><span data-stu-id="4e400-159">It must begin with a leading slash, like "/Token".</span></span> <span data-ttu-id="4e400-160">Pokud je klientovi vydán [tajný klíč klienta\_](http://tools.ietf.org/html/rfc6749#appendix-A.2), musí být k dispozici do tohoto koncového bodu.</span><span class="sxs-lookup"><span data-stu-id="4e400-160">If the client is issued a [client\_secret](http://tools.ietf.org/html/rfc6749#appendix-A.2), it must be provided to this endpoint.</span></span>
- <span data-ttu-id="4e400-161">`ApplicationCanDisplayErrors`: Nastavte `true` na pokud webová aplikace chce generovat vlastní chybovou stránku pro chyby ověření klienta v `/Authorize` koncovém bodě.</span><span class="sxs-lookup"><span data-stu-id="4e400-161">`ApplicationCanDisplayErrors`: Set to `true` if the web application wants to generate a custom error page for the client validation errors on `/Authorize` endpoint.</span></span> <span data-ttu-id="4e400-162">To je potřeba pouze v případech, kdy prohlížeč není přesměrován zpět `client_id` do `redirect_uri` klientské aplikace, například pokud nebo jsou nesprávné.</span><span class="sxs-lookup"><span data-stu-id="4e400-162">This is only needed for cases where the browser is not redirected back to the client application, for example, when the `client_id` or `redirect_uri` are incorrect.</span></span> <span data-ttu-id="4e400-163">Koncový `/Authorize` bod by měl očekávat, že "oauth. Chyba", "oauth. ErrorDescription", a "oauth. ErrorUri" vlastnosti jsou přidány do prostředí OWIN.</span><span class="sxs-lookup"><span data-stu-id="4e400-163">The `/Authorize` endpoint should expect to see the "oauth.Error", "oauth.ErrorDescription", and "oauth.ErrorUri" properties are added to the OWIN environment.</span></span>

    > [!NOTE]
    > <span data-ttu-id="4e400-164">Pokud není true, autorizační server vrátí výchozí chybovou stránku s podrobnostmi o chybě.</span><span class="sxs-lookup"><span data-stu-id="4e400-164">If not true, the authorization server will return a default error page with the error details.</span></span>
- <span data-ttu-id="4e400-165">`AllowInsecureHttp`: True povolit autorizovat a token požadavky dorazit na adresy `redirect_uri` HTTP URI a umožnit příchozí autorizovat parametry požadavku mít http uri adresy.</span><span class="sxs-lookup"><span data-stu-id="4e400-165">`AllowInsecureHttp`: True to allow authorize and token requests to arrive on HTTP URI addresses, and to allow incoming `redirect_uri` authorize request parameters to have HTTP URI addresses.</span></span>

    > [!WARNING]
    > <span data-ttu-id="4e400-166">Zabezpečení - To to je pouze pro vývoj.</span><span class="sxs-lookup"><span data-stu-id="4e400-166">Security - This is for development only.</span></span>
- <span data-ttu-id="4e400-167">`Provider`: Objekt poskytnutý aplikací ke zpracování událostí vyvolaných middlewarem autorizačního serveru.</span><span class="sxs-lookup"><span data-stu-id="4e400-167">`Provider`: The object provided by the application to process events raised by the Authorization Server middleware.</span></span> <span data-ttu-id="4e400-168">Aplikace může plně implementovat rozhraní nebo může `OAuthAuthorizationServerProvider` vytvořit instanci a přiřadit delegáty nezbytné pro toky OAuth, které tento server podporuje.</span><span class="sxs-lookup"><span data-stu-id="4e400-168">The application may implement the interface fully, or it may create an instance of `OAuthAuthorizationServerProvider` and assign delegates necessary for the OAuth flows this server supports.</span></span>
- <span data-ttu-id="4e400-169">`AuthorizationCodeProvider`: Vytvoří jednopoužití autorizační kód pro návrat do klientské aplikace.</span><span class="sxs-lookup"><span data-stu-id="4e400-169">`AuthorizationCodeProvider`: Produces a single-use authorization code to return to the client application.</span></span> <span data-ttu-id="4e400-170">Pro server OAuth, aby byl zabezpečený, **musí** aplikace poskytnout instanci, `AuthorizationCodeProvider` pro kterou je token vytvořený `OnCreate/OnCreateAsync` událostí považován za platný pouze pro jedno volání . `OnReceive/OnReceiveAsync`</span><span class="sxs-lookup"><span data-stu-id="4e400-170">For the OAuth server to be secure the application **MUST** provide an instance for `AuthorizationCodeProvider` where the token produced by the `OnCreate/OnCreateAsync` event is considered valid for only one call to `OnReceive/OnReceiveAsync`.</span></span>
- <span data-ttu-id="4e400-171">`RefreshTokenProvider`: Vytvoří obnovovací token, který může být použit k vytvoření nového přístupového tokenu v případě potřeby.</span><span class="sxs-lookup"><span data-stu-id="4e400-171">`RefreshTokenProvider`: Produces a refresh token which may be used to produce a new access token when needed.</span></span> <span data-ttu-id="4e400-172">Pokud není k dispozici autorizační server nevrátí `/Token` obnovovací tokeny z koncového bodu.</span><span class="sxs-lookup"><span data-stu-id="4e400-172">If not provided the authorization server will not return refresh tokens from the `/Token` endpoint.</span></span>

## <a name="account-management"></a><span data-ttu-id="4e400-173">Správa účtů</span><span class="sxs-lookup"><span data-stu-id="4e400-173">Account Management</span></span>

<span data-ttu-id="4e400-174">OAuth se nestará o to, kde a jak spravujete informace o svém uživatelském účtu.</span><span class="sxs-lookup"><span data-stu-id="4e400-174">OAuth doesn't care where or how you manage your user account information.</span></span> <span data-ttu-id="4e400-175">Je to [ASP.NET identita,](../../../identity/index.md) která je za to zodpovědná.</span><span class="sxs-lookup"><span data-stu-id="4e400-175">It's [ASP.NET Identity](../../../identity/index.md) which is responsible for it.</span></span> <span data-ttu-id="4e400-176">V tomto tutoriálu zjednodušíme kód pro správu účtu a jen se ujistíme, že se uživatel může přihlásit pomocí middleware souborů Cookie OWIN.</span><span class="sxs-lookup"><span data-stu-id="4e400-176">In this tutorial, we will simplify the account management code and just make sure that user can login using OWIN cookie middleware.</span></span> <span data-ttu-id="4e400-177">Zde je zjednodušený ukázkový kód pro `AccountController`:</span><span class="sxs-lookup"><span data-stu-id="4e400-177">Here is the simplified sample code for the `AccountController`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample3.cs)]

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample4.cs?highlight=1)]

<span data-ttu-id="4e400-178">`ValidateClientRedirectUri`slouží k ověření klienta s registrovanou adresou URL přesměrování.</span><span class="sxs-lookup"><span data-stu-id="4e400-178">`ValidateClientRedirectUri` is used to validate the client with its registered redirect URL.</span></span> <span data-ttu-id="4e400-179">`ValidateClientAuthentication`zkontroluje záhlaví základního schématu a tělo formuláře, aby získal pověření klienta.</span><span class="sxs-lookup"><span data-stu-id="4e400-179">`ValidateClientAuthentication` checks the basic scheme header and form body to get the client's credentials.</span></span>

<span data-ttu-id="4e400-180">Přihlašovací stránka je uvedena níže:</span><span class="sxs-lookup"><span data-stu-id="4e400-180">The login page is shown below:</span></span>

![](owin-oauth-20-authorization-server/_static/image1.png)

<span data-ttu-id="4e400-181">Projděte si sekci IETF OAuth 2 [Authorization Code Grant.](http://tools.ietf.org/html/rfc6749#section-4.1)</span><span class="sxs-lookup"><span data-stu-id="4e400-181">Review the IETF's OAuth 2 [Authorization Code Grant](http://tools.ietf.org/html/rfc6749#section-4.1) section now.</span></span>

<span data-ttu-id="4e400-182">**Zprostředkovatel** (v tabulce níže) je [OAuthAuthorizationServerOptions](https://msdn.microsoft.com/library/microsoft.owin.security.oauth.oauthauthorizationserveroptions(v=vs.111).aspx). Zprostředkovatel, který je `OAuthAuthorizationServerProvider`typu , který obsahuje všechny události serveru OAuth.</span><span class="sxs-lookup"><span data-stu-id="4e400-182">**Provider** (in the table below) is [OAuthAuthorizationServerOptions](https://msdn.microsoft.com/library/microsoft.owin.security.oauth.oauthauthorizationserveroptions(v=vs.111).aspx).Provider, which is of type `OAuthAuthorizationServerProvider`, which contains all OAuth server events.</span></span>

| <span data-ttu-id="4e400-183">Kroky toku z oddílu Udělení autorizačního kódu</span><span class="sxs-lookup"><span data-stu-id="4e400-183">Flow steps from Authorization Code Grant section</span></span> | <span data-ttu-id="4e400-184">Ukázkové stažení provádí tyto kroky pomocí:</span><span class="sxs-lookup"><span data-stu-id="4e400-184">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="4e400-185">(A) Klient iniciuje tok přesměrováním uživatelského agenta vlastníka prostředku na koncový bod autorizace.</span><span class="sxs-lookup"><span data-stu-id="4e400-185">(A) The client initiates the flow by directing the resource owner's user-agent to the authorization endpoint.</span></span> <span data-ttu-id="4e400-186">Klient obsahuje identifikátor klienta, požadovaný obor, místní stav a identifikátor URI přesměrování, ke kterému autorizační server odešle uživatelského agenta zpět, jakmile je udělen (nebo odepřen přístup).</span><span class="sxs-lookup"><span data-stu-id="4e400-186">The client includes its client identifier, requested scope, local state, and a redirection URI to which the authorization server will send the user-agent back once access is granted (or denied).</span></span> | <span data-ttu-id="4e400-187">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span><span class="sxs-lookup"><span data-stu-id="4e400-187">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span></span> |
|  |  |
| <span data-ttu-id="4e400-188">(B) Autorizační server ověří vlastníka prostředku (prostřednictvím uživatelského agenta) a zjistí, zda vlastník prostředku udělí nebo zamítne žádost o přístup klienta.</span><span class="sxs-lookup"><span data-stu-id="4e400-188">(B) The authorization server authenticates the resource owner (via the user-agent) and establishes whether the resource owner grants or denies the client's access request.</span></span> | <span data-ttu-id="4e400-189">**Pokud uživatel udělí přístup&gt; &lt;** Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCode.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="4e400-189">**&lt;If user grants access&gt;** Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="4e400-190">(C) Za předpokladu, že vlastník prostředku udělí přístup, autorizační server přesměruje uživatelského agenta zpět na klienta pomocí dříve poskytnutého identifikátoru URI přesměrování (v požadavku nebo při registraci klienta).</span><span class="sxs-lookup"><span data-stu-id="4e400-190">(C) Assuming the resource owner grants access, the authorization server redirects the user-agent back to the client using the redirection URI provided earlier (in the request or during client registration).</span></span> <span data-ttu-id="4e400-191">...</span><span class="sxs-lookup"><span data-stu-id="4e400-191">...</span></span> |  |
|  |  |
| <span data-ttu-id="4e400-192">(D) Klient požaduje přístupový token z koncového bodu tokenu autorizačního serveru zahrnutím autorizačního kódu přijatého v předchozím kroku.</span><span class="sxs-lookup"><span data-stu-id="4e400-192">(D) The client requests an access token from the authorization server's token endpoint by including the authorization code received in the previous step.</span></span> <span data-ttu-id="4e400-193">Při provádění požadavku se klient ověřuje pomocí autorizačního serveru.</span><span class="sxs-lookup"><span data-stu-id="4e400-193">When making the request, the client authenticates with the authorization server.</span></span> <span data-ttu-id="4e400-194">Klient obsahuje identifikátor URI přesměrování použitý k získání autorizačního kódu pro ověření.</span><span class="sxs-lookup"><span data-stu-id="4e400-194">The client includes the redirection URI used to obtain the authorization code for verification.</span></span> | <span data-ttu-id="4e400-195">Provider.MatchEndpoint Provider.ValidateClientAuthentication AuthorizationProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantAuthorizationCode Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="4e400-195">Provider.MatchEndpoint Provider.ValidateClientAuthentication AuthorizationCodeProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantAuthorizationCode Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |

<span data-ttu-id="4e400-196">Ukázková implementace `AuthorizationCodeProvider.CreateAsync` `ReceiveAsync` a řízení vytvoření a ověření autorizačního kódu je uvedena níže.</span><span class="sxs-lookup"><span data-stu-id="4e400-196">A sample implementation for `AuthorizationCodeProvider.CreateAsync` and `ReceiveAsync` to control the creation and validation of authorization code is shown below.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample5.cs)]

<span data-ttu-id="4e400-197">Výše uvedený kód používá souběžný slovník v paměti k uložení kódu a lístku identity a obnovení identity po přijetí kódu.</span><span class="sxs-lookup"><span data-stu-id="4e400-197">The code above uses an in-memory concurrent dictionary to store the code and identity ticket and restore the identity after receiving the code.</span></span> <span data-ttu-id="4e400-198">V reálné aplikaci by byl nahrazen trvalým úložištěm dat.</span><span class="sxs-lookup"><span data-stu-id="4e400-198">In a real application, it would be replaced by a persistent data store.</span></span> <span data-ttu-id="4e400-199">Koncový bod autorizace je pro vlastníka prostředku udělit přístup ke klientovi.</span><span class="sxs-lookup"><span data-stu-id="4e400-199">The authorization endpoint is for the resource owner to grant access to the client.</span></span> <span data-ttu-id="4e400-200">Obvykle potřebuje uživatelské rozhraní, aby uživatel mohl kliknout na tlačítko a potvrdit udělení.</span><span class="sxs-lookup"><span data-stu-id="4e400-200">Usually, it needs a user interface to allow the user to click a button and confirm the grant.</span></span> <span data-ttu-id="4e400-201">OWIN OAuth middleware umožňuje kód aplikace pro zpracování autorizačního koncového bodu.</span><span class="sxs-lookup"><span data-stu-id="4e400-201">OWIN OAuth middleware allows application code to handle the authorization endpoint.</span></span> <span data-ttu-id="4e400-202">V naší ukázkové aplikaci používáme `OAuthController` řadič MVC volaný k jeho zpracování.</span><span class="sxs-lookup"><span data-stu-id="4e400-202">In our sample app, we use an MVC controller called `OAuthController` to handle it.</span></span> <span data-ttu-id="4e400-203">Zde je ukázka implementace:</span><span class="sxs-lookup"><span data-stu-id="4e400-203">Here is the sample implementation:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample6.cs?highlight=15)]

<span data-ttu-id="4e400-204">Akce `Authorize` nejprve zkontroluje, zda se uživatel přihlásil k autorizačnímu serveru.</span><span class="sxs-lookup"><span data-stu-id="4e400-204">The `Authorize` action will first check if the user has logged in to the authorization server.</span></span> <span data-ttu-id="4e400-205">Pokud tomu tak není, ověřovací middleware vyzve volajícího k ověření pomocí souboru cookie "Aplikace" a přesměruje na přihlašovací stránku.</span><span class="sxs-lookup"><span data-stu-id="4e400-205">If not, the authentication middleware challenges the caller to authenticate using the "Application" cookie and redirects to the login page.</span></span> <span data-ttu-id="4e400-206">(Viz zvýrazněný kód výše.) Pokud se uživatel přihlásil, vykreslí zobrazení Autorizovat, jak je znázorněno níže:</span><span class="sxs-lookup"><span data-stu-id="4e400-206">(See highlighted code above.) If user has logged in, it will render the Authorize view, as shown below:</span></span>

![](owin-oauth-20-authorization-server/_static/image2.png)

<span data-ttu-id="4e400-207">Pokud je **vybráno** tlačítko `Authorize` Grant, akce vytvoří novou identitu "Nosič" a přihlásit se s ním.</span><span class="sxs-lookup"><span data-stu-id="4e400-207">If the **Grant** button is selected, the `Authorize` action will create a new "Bearer" identity and sign in with it.</span></span> <span data-ttu-id="4e400-208">Spustí autorizační server pro generování nosné tokena a odeslat jej zpět klientovi s datovou částí JSON.</span><span class="sxs-lookup"><span data-stu-id="4e400-208">It will trigger the authorization server to generate a bearer token and send it back to the client with JSON payload.</span></span>

### <a name="implicit-grant"></a><span data-ttu-id="4e400-209">Implicitní grant</span><span class="sxs-lookup"><span data-stu-id="4e400-209">Implicit Grant</span></span>

<span data-ttu-id="4e400-210">Naleznete v části [Implicitní grant](http://tools.ietf.org/html/rfc6749#section-4.2) IETF OAuth 2.</span><span class="sxs-lookup"><span data-stu-id="4e400-210">Refer to the IETF's OAuth 2 [Implicit Grant](http://tools.ietf.org/html/rfc6749#section-4.2) section now.</span></span>

 <span data-ttu-id="4e400-211">[Implicitní grantový](http://tools.ietf.org/html/rfc6749#section-4.2) tok znázorněný na obrázku 4 je tok a mapování, které následuje middleware OWin OAuth.</span><span class="sxs-lookup"><span data-stu-id="4e400-211">The [Implicit Grant](http://tools.ietf.org/html/rfc6749#section-4.2) flow shown in Figure 4 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="4e400-212">Kroky toku z části Implicitní grant</span><span class="sxs-lookup"><span data-stu-id="4e400-212">Flow steps from Implicit Grant section</span></span> | <span data-ttu-id="4e400-213">Ukázkové stažení provádí tyto kroky pomocí:</span><span class="sxs-lookup"><span data-stu-id="4e400-213">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="4e400-214">(A) Klient iniciuje tok přesměrováním uživatelského agenta vlastníka prostředku na koncový bod autorizace.</span><span class="sxs-lookup"><span data-stu-id="4e400-214">(A) The client initiates the flow by directing the resource owner's user-agent to the authorization endpoint.</span></span> <span data-ttu-id="4e400-215">Klient obsahuje identifikátor klienta, požadovaný obor, místní stav a identifikátor URI přesměrování, ke kterému autorizační server odešle uživatelského agenta zpět, jakmile je udělen (nebo odepřen přístup).</span><span class="sxs-lookup"><span data-stu-id="4e400-215">The client includes its client identifier, requested scope, local state, and a redirection URI to which the authorization server will send the user-agent back once access is granted (or denied).</span></span> | <span data-ttu-id="4e400-216">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span><span class="sxs-lookup"><span data-stu-id="4e400-216">Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint</span></span> |
|  |  |
| <span data-ttu-id="4e400-217">(B) Autorizační server ověří vlastníka prostředku (prostřednictvím uživatelského agenta) a zjistí, zda vlastník prostředku udělí nebo zamítne žádost o přístup klienta.</span><span class="sxs-lookup"><span data-stu-id="4e400-217">(B) The authorization server authenticates the resource owner (via the user-agent) and establishes whether the resource owner grants or denies the client's access request.</span></span> | <span data-ttu-id="4e400-218">**Pokud uživatel udělí přístup&gt; &lt;** Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCode.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="4e400-218">**&lt;If user grants access&gt;** Provider.MatchEndpoint Provider.ValidateClientRedirectUri Provider.ValidateAuthorizeRequest Provider.AuthorizeEndpoint AuthorizationCodeProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="4e400-219">(C) Za předpokladu, že vlastník prostředku udělí přístup, autorizační server přesměruje uživatelského agenta zpět na klienta pomocí dříve poskytnutého identifikátoru URI přesměrování (v požadavku nebo při registraci klienta).</span><span class="sxs-lookup"><span data-stu-id="4e400-219">(C) Assuming the resource owner grants access, the authorization server redirects the user-agent back to the client using the redirection URI provided earlier (in the request or during client registration).</span></span> <span data-ttu-id="4e400-220">...</span><span class="sxs-lookup"><span data-stu-id="4e400-220">...</span></span> |  |
|  |  |
| <span data-ttu-id="4e400-221">(D) Klient požaduje přístupový token z koncového bodu tokenu autorizačního serveru zahrnutím autorizačního kódu přijatého v předchozím kroku.</span><span class="sxs-lookup"><span data-stu-id="4e400-221">(D) The client requests an access token from the authorization server's token endpoint by including the authorization code received in the previous step.</span></span> <span data-ttu-id="4e400-222">Při provádění požadavku se klient ověřuje pomocí autorizačního serveru.</span><span class="sxs-lookup"><span data-stu-id="4e400-222">When making the request, the client authenticates with the authorization server.</span></span> <span data-ttu-id="4e400-223">Klient obsahuje identifikátor URI přesměrování použitý k získání autorizačního kódu pro ověření.</span><span class="sxs-lookup"><span data-stu-id="4e400-223">The client includes the redirection URI used to obtain the authorization code for verification.</span></span> |  |

<span data-ttu-id="4e400-224">Vzhledem k tomu, že`OAuthController.Authorize` jsme již implementovali koncový bod autorizace (akce) pro udělení autorizačního kódu, automaticky také umožňuje implicitní tok.</span><span class="sxs-lookup"><span data-stu-id="4e400-224">Since we already implemented the authorization endpoint (`OAuthController.Authorize` action) for authorization code grant, it automatically enables implicit flow as well.</span></span> <span data-ttu-id="4e400-225">Poznámka: `Provider.ValidateClientRedirectUri` Slouží k ověření ID klienta s jeho adresou URL přesměrování, která chrání implicitní tok grantu před odesláním přístupového tokenu klientům se zlými úmysly ([Man-in-the-middle attack](https://www.owasp.org/index.php/Man-in-the-middle_attack)).</span><span class="sxs-lookup"><span data-stu-id="4e400-225">Note: `Provider.ValidateClientRedirectUri` is used to validate the client ID with its redirection URL, which protects the implicit grant flow from sending the access token to malicious clients ([Man-in-the-middle attack](https://www.owasp.org/index.php/Man-in-the-middle_attack)).</span></span>

### <a name="resource-owner-password-credentials-grant"></a><span data-ttu-id="4e400-226">Grant pověření vlastníka prostředku</span><span class="sxs-lookup"><span data-stu-id="4e400-226">Resource Owner Password Credentials Grant</span></span>

<span data-ttu-id="4e400-227">Naleznete v části IETF OAuth 2 [Resource Owner Password Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.3) nyní.</span><span class="sxs-lookup"><span data-stu-id="4e400-227">Refer to the IETF's OAuth 2 [Resource Owner Password Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.3) section now.</span></span>

 <span data-ttu-id="4e400-228">Tok pověření hesla [vlastníka prostředku grantový](http://tools.ietf.org/html/rfc6749#section-4.3) tok znázorněný na obrázku 5 je tok a mapování, které následuje middleware OWIN OAuth.</span><span class="sxs-lookup"><span data-stu-id="4e400-228">The [Resource Owner Password Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.3) flow shown in Figure 5 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="4e400-229">Kroky toku z oddílu Grant pověření vlastníka vlastníka prostředku</span><span class="sxs-lookup"><span data-stu-id="4e400-229">Flow steps from Resource Owner Password Credentials Grant section</span></span> | <span data-ttu-id="4e400-230">Ukázkové stažení provádí tyto kroky pomocí:</span><span class="sxs-lookup"><span data-stu-id="4e400-230">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="4e400-231">(A) Vlastník prostředku poskytuje klientovi své uživatelské jméno a heslo.</span><span class="sxs-lookup"><span data-stu-id="4e400-231">(A) The resource owner provides the client with its username and password.</span></span> |  |
|  |  |
| <span data-ttu-id="4e400-232">(B) Klient požaduje přístupový token z koncového bodu tokenu autorizačního serveru zahrnutím pověření přijatých od vlastníka prostředku.</span><span class="sxs-lookup"><span data-stu-id="4e400-232">(B) The client requests an access token from the authorization server's token endpoint by including the credentials received from the resource owner.</span></span> <span data-ttu-id="4e400-233">Při provádění požadavku se klient ověřuje pomocí autorizačního serveru.</span><span class="sxs-lookup"><span data-stu-id="4e400-233">When making the request, the client authenticates with the authorization server.</span></span> | <span data-ttu-id="4e400-234">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantResourceOwnerCredentials Provider.TokenEndpoint AccessToken Provider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="4e400-234">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantResourceOwnerCredentials Provider.TokenEndpoint AccessToken Provider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="4e400-235">(C) Autorizační server ověří klienta a ověří pověření vlastníka prostředku a pokud je platný, vydá přístupový token.</span><span class="sxs-lookup"><span data-stu-id="4e400-235">(C) The authorization server authenticates the client and validates the resource owner credentials, and if valid, issues an access token.</span></span> |  |

<span data-ttu-id="4e400-236">Zde je ukázková `Provider.GrantResourceOwnerCredentials`implementace pro :</span><span class="sxs-lookup"><span data-stu-id="4e400-236">Here is the sample implementation for `Provider.GrantResourceOwnerCredentials`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample7.cs)]

> [!NOTE]
> <span data-ttu-id="4e400-237">Výše uvedený kód je určen k vysvětlení této části kurzu a neměl by být používán v zabezpečených nebo produkčních aplikacích.</span><span class="sxs-lookup"><span data-stu-id="4e400-237">The code above is intended to explain this section of the tutorial and should not be used in secure or production apps.</span></span> <span data-ttu-id="4e400-238">Nekontroluje pověření vlastníků prostředků.</span><span class="sxs-lookup"><span data-stu-id="4e400-238">It does not check the resource owners credentials.</span></span> <span data-ttu-id="4e400-239">Předpokládá, že každé pověření je platné a vytvoří pro něj novou identitu.</span><span class="sxs-lookup"><span data-stu-id="4e400-239">It assumes every credential is valid and creates a new identity for it.</span></span> <span data-ttu-id="4e400-240">Nová identita bude použita ke generování přístupového tokenu a obnovovacího tokenu.</span><span class="sxs-lookup"><span data-stu-id="4e400-240">The new identity will be used to generate the access token and refresh token.</span></span> <span data-ttu-id="4e400-241">Nahraďte kód vlastním zabezpečeným kódem pro správu účtu.</span><span class="sxs-lookup"><span data-stu-id="4e400-241">Please replace the code with your own secure account management code.</span></span>


### <a name="client-credentials-grant"></a><span data-ttu-id="4e400-242">Udělení pověření klienta</span><span class="sxs-lookup"><span data-stu-id="4e400-242">Client Credentials Grant</span></span>

<span data-ttu-id="4e400-243">Naleznete v části IETF OAuth 2 [Client Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.4) nyní.</span><span class="sxs-lookup"><span data-stu-id="4e400-243">Refer to the IETF's OAuth 2 [Client Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.4) section now.</span></span>

 <span data-ttu-id="4e400-244">Tok [grantu pověření klienta](http://tools.ietf.org/html/rfc6749#section-4.4) znázorněný na obrázku 6 je tok a mapování, které následuje middleware OAuth OWIN.</span><span class="sxs-lookup"><span data-stu-id="4e400-244">The [Client Credentials Grant](http://tools.ietf.org/html/rfc6749#section-4.4) flow shown in Figure 6 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="4e400-245">Kroky toku z oddílu Grant pověření klienta</span><span class="sxs-lookup"><span data-stu-id="4e400-245">Flow steps from Client Credentials Grant section</span></span> | <span data-ttu-id="4e400-246">Ukázkové stažení provádí tyto kroky pomocí:</span><span class="sxs-lookup"><span data-stu-id="4e400-246">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="4e400-247">(A) Klient se ověří pomocí autorizačního serveru a požaduje přístupový token z koncového bodu tokenu.</span><span class="sxs-lookup"><span data-stu-id="4e400-247">(A) The client authenticates with the authorization server and requests an access token from the token endpoint.</span></span> | <span data-ttu-id="4e400-248">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantClientCredentials Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="4e400-248">Provider.MatchEndpoint Provider.ValidateClientAuthentication Provider.ValidateTokenRequest Provider.GrantClientCredentials Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="4e400-249">(B) Autorizační server ověřuje klienta a pokud je platný, vydá přístupový token.</span><span class="sxs-lookup"><span data-stu-id="4e400-249">(B) The authorization server authenticates the client, and if valid, issues an access token.</span></span> |  |

<span data-ttu-id="4e400-250">Zde je ukázková `Provider.GrantClientCredentials`implementace pro :</span><span class="sxs-lookup"><span data-stu-id="4e400-250">Here is the sample implementation for `Provider.GrantClientCredentials`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample8.cs)]

> [!NOTE]
> <span data-ttu-id="4e400-251">Výše uvedený kód je určen k vysvětlení této části kurzu a neměl by být používán v zabezpečených nebo produkčních aplikacích.</span><span class="sxs-lookup"><span data-stu-id="4e400-251">The code above is intended to explain this section of the tutorial and should not be used in secure or production apps.</span></span> <span data-ttu-id="4e400-252">Nahraďte kód vlastním zabezpečeným kódem pro správu klienta.</span><span class="sxs-lookup"><span data-stu-id="4e400-252">Please replace the code with your own secure client management code.</span></span>


### <a name="refresh-token"></a><span data-ttu-id="4e400-253">Aktualizovat token</span><span class="sxs-lookup"><span data-stu-id="4e400-253">Refresh Token</span></span>

<span data-ttu-id="4e400-254">Podívejte se na část IETF OAuth 2 [Refresh Token.](http://tools.ietf.org/html/rfc6749#section-1.5)</span><span class="sxs-lookup"><span data-stu-id="4e400-254">Refer to the IETF's OAuth 2 [Refresh Token](http://tools.ietf.org/html/rfc6749#section-1.5) section now.</span></span>

 <span data-ttu-id="4e400-255">[Tok tokenu aktualizace](http://tools.ietf.org/html/rfc6749#section-1.5) znázorněný na obrázku 2 je tok a mapování, které následuje middleware OWin OAuth.</span><span class="sxs-lookup"><span data-stu-id="4e400-255">The [Refresh Token](http://tools.ietf.org/html/rfc6749#section-1.5) flow shown in Figure 2 is the flow and mapping which the OWIN OAuth middleware follows.</span></span>

| <span data-ttu-id="4e400-256">Kroky toku z oddílu Grant pověření klienta</span><span class="sxs-lookup"><span data-stu-id="4e400-256">Flow steps from Client Credentials Grant section</span></span> | <span data-ttu-id="4e400-257">Ukázkové stažení provádí tyto kroky pomocí:</span><span class="sxs-lookup"><span data-stu-id="4e400-257">Sample download performs these steps with:</span></span> |
| --- | --- |
|  |  |
| <span data-ttu-id="4e400-258">(G) Klient požaduje nový přístupový token ověřením pomocí autorizačního serveru a předložením obnovovacího tokenu.</span><span class="sxs-lookup"><span data-stu-id="4e400-258">(G) The client requests a new access token by authenticating with the authorization server and presenting the refresh token.</span></span> <span data-ttu-id="4e400-259">Požadavky na ověření klienta jsou založeny na typu klienta a na zásadách autorizačního serveru.</span><span class="sxs-lookup"><span data-stu-id="4e400-259">The client authentication requirements are based on the client type and on the authorization server policies.</span></span> | <span data-ttu-id="4e400-260">Provider.MatchEndpoint Provider.ValidateClientAuthentication RefreshProviderProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantRefreshToken Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span><span class="sxs-lookup"><span data-stu-id="4e400-260">Provider.MatchEndpoint Provider.ValidateClientAuthentication RefreshTokenProvider.ReceiveAsync Provider.ValidateTokenRequest Provider.GrantRefreshToken Provider.TokenEndpoint AccessTokenProvider.CreateAsync RefreshTokenProvider.CreateAsync</span></span> |
|  |  |
| <span data-ttu-id="4e400-261">(H) Autorizační server ověří klienta a ověří obnovovací token a pokud je platný, vydá nový přístupový token (a volitelně nový obnovovací token).</span><span class="sxs-lookup"><span data-stu-id="4e400-261">(H) The authorization server authenticates the client and validates the refresh token, and if valid, issues a new access token (and, optionally, a new refresh token).</span></span> |  |

<span data-ttu-id="4e400-262">Zde je ukázková `Provider.GrantRefreshToken`implementace pro :</span><span class="sxs-lookup"><span data-stu-id="4e400-262">Here is the sample implementation for `Provider.GrantRefreshToken`:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample9.cs)]

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample10.cs)]

## <a name="create-a-resource-server-which-is-protected-by-access-token"></a><span data-ttu-id="4e400-263">Vytvoření serveru prostředků chráněného přístupovým tokenem</span><span class="sxs-lookup"><span data-stu-id="4e400-263">Create a Resource Server which is protected by Access Token</span></span>

<span data-ttu-id="4e400-264">Vytvořte prázdný projekt webové aplikace a nainstalujte do projektu následující balíčky:</span><span class="sxs-lookup"><span data-stu-id="4e400-264">Create an empty web app project and install following packages in the project:</span></span>

- <span data-ttu-id="4e400-265">Microsoft.AspNet.WebApi.Owin</span><span class="sxs-lookup"><span data-stu-id="4e400-265">Microsoft.AspNet.WebApi.Owin</span></span>
- <span data-ttu-id="4e400-266">Microsoft.Owin.Host.SystemWeb</span><span class="sxs-lookup"><span data-stu-id="4e400-266">Microsoft.Owin.Host.SystemWeb</span></span>
- <span data-ttu-id="4e400-267">Microsoft.Owin.Security.OAuth</span><span class="sxs-lookup"><span data-stu-id="4e400-267">Microsoft.Owin.Security.OAuth</span></span>

<span data-ttu-id="4e400-268">Vytvořte spouštěcí třídu a nakonfigurujte ověřování a webové rozhraní API.</span><span class="sxs-lookup"><span data-stu-id="4e400-268">Create a startup class and configure authentication and Web API.</span></span> <span data-ttu-id="4e400-269">Viz *AuthorizationServer\ResourceServer\Startup.cs* v ukázkovém stažení.</span><span class="sxs-lookup"><span data-stu-id="4e400-269">See *AuthorizationServer\ResourceServer\Startup.cs* in the sample download.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample11.cs)]

<span data-ttu-id="4e400-270">V ukázkovém stažení naleznete informace *o serveru\_AuthorizationServer\ResourceServer\Spuštění aplikace\Startup.Auth.cs.*</span><span class="sxs-lookup"><span data-stu-id="4e400-270">See *AuthorizationServer\ResourceServer\App\_Start\Startup.Auth.cs* in the sample download.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample12.cs)]

<span data-ttu-id="4e400-271">Viz *AuthorizationServer\ResourceServer\Start_App\Startup.WebApi.cs\_* v ukázkovém stažení.</span><span class="sxs-lookup"><span data-stu-id="4e400-271">See *AuthorizationServer\ResourceServer\App\_Start\Startup.WebApi.cs* in the sample download.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample13.cs)]

- <span data-ttu-id="4e400-272">`UseCors`metoda umožňuje CORS pro všechny domény.</span><span class="sxs-lookup"><span data-stu-id="4e400-272">`UseCors` method allows CORS for all domains.</span></span>
- <span data-ttu-id="4e400-273">`UseOAuthBearerAuthentication`metoda umožňuje OAuth nosné token ověřování middleware, který bude přijímat a ověřovat nosný token z autorizační hlavičky v požadavku.</span><span class="sxs-lookup"><span data-stu-id="4e400-273">`UseOAuthBearerAuthentication` method enables OAuth bearer token authentication middleware which will receive and validate bearer token from authorization header in the request.</span></span>
- <span data-ttu-id="4e400-274">`Config.SuppressDefaultHostAuthenticaiton`potlačí výchozí objekt zabezpečení ověřený hostitele z aplikace, proto budou všechny požadavky anonymní po tomto volání.</span><span class="sxs-lookup"><span data-stu-id="4e400-274">`Config.SuppressDefaultHostAuthenticaiton` suppresses default host authenticated principal from the app, therefore all requests will be anonymous after this call.</span></span>
- <span data-ttu-id="4e400-275">`HostAuthenticationFilter`umožňuje ověřování pouze pro zadaný typ ověřování.</span><span class="sxs-lookup"><span data-stu-id="4e400-275">`HostAuthenticationFilter` enables authentication just for the specified authentication type.</span></span> <span data-ttu-id="4e400-276">V tomto případě je typ ověřování nosiče.</span><span class="sxs-lookup"><span data-stu-id="4e400-276">In this case, it's bearer authentication type.</span></span>

<span data-ttu-id="4e400-277">Aby bylo možné demonstrovat ověřenou identitu, vytvoříme ApiController pro výstup aktuálního uživatele deklarací.</span><span class="sxs-lookup"><span data-stu-id="4e400-277">In order to demonstrate the authenticated identity, we create an ApiController to output current user's claims.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample14.cs)]

<span data-ttu-id="4e400-278">Pokud autorizační server a server prostředků nejsou ve stejném počítači, middleware OAuth použije různé klíče počítače k šifrování a dešifrování přístupového tokenu nosiče.</span><span class="sxs-lookup"><span data-stu-id="4e400-278">If the authorization server and the resource server are not on the same computer, the OAuth middleware will use the different machine keys to encrypt and decrypt bearer access token.</span></span> <span data-ttu-id="4e400-279">Abybylo možné sdílet stejný soukromý klíč mezi oběma `machinekey` projekty, přidáme stejné nastavení v obou souborech *web.config.*</span><span class="sxs-lookup"><span data-stu-id="4e400-279">In order to share the same private key between both projects, we add the same `machinekey` setting in both *web.config* files.</span></span>

[!code-xml[Main](owin-oauth-20-authorization-server/samples/sample15.xml?highlight=8-10)]

## <a name="create-oauth-20-clients"></a><span data-ttu-id="4e400-280">Vytvořit klienty OAuth 2.0</span><span class="sxs-lookup"><span data-stu-id="4e400-280">Create OAuth 2.0 Clients</span></span>

 <span data-ttu-id="4e400-281">Ke zjednodušení klientského kódu používáme balíček [DotNetOpenAuth.OAuth2.Client](http://www.nuget.org/packages/DotNetOpenAuth.OAuth2.Client) NuGet.</span><span class="sxs-lookup"><span data-stu-id="4e400-281">We use the [DotNetOpenAuth.OAuth2.Client](http://www.nuget.org/packages/DotNetOpenAuth.OAuth2.Client) NuGet package to simplify the client code.</span></span>

### <a name="authorization-code-grant-client"></a><span data-ttu-id="4e400-282">Klient udělení autorizačního kódu</span><span class="sxs-lookup"><span data-stu-id="4e400-282">Authorization Code Grant Client</span></span>

 <span data-ttu-id="4e400-283">Tento klient je aplikace MVC.</span><span class="sxs-lookup"><span data-stu-id="4e400-283">This client is an MVC application.</span></span> <span data-ttu-id="4e400-284">Spustí tok udělení autorizačního kódu získat přístupový token z back-endu.</span><span class="sxs-lookup"><span data-stu-id="4e400-284">It will trigger an authorization code grant flow to get the access token from backend.</span></span> <span data-ttu-id="4e400-285">Má jednu stránku, jak je znázorněno níže:</span><span class="sxs-lookup"><span data-stu-id="4e400-285">It has a single page as shown below:</span></span>

![](owin-oauth-20-authorization-server/_static/image3.png)

- <span data-ttu-id="4e400-286">Tlačítko **Autorizovat** přesměruje prohlížeč na autorizační server a upozorní vlastníka prostředku, aby tomuto klientovi udělil přístup.</span><span class="sxs-lookup"><span data-stu-id="4e400-286">The **Authorize** button will redirect browser to the authorization server to notify the resource owner to grant access to this client.</span></span>
- <span data-ttu-id="4e400-287">Tlačítko **Aktualizovat** získá nový přístupový token a obnovovací token pomocí aktuálního obnovovacího tokenu.</span><span class="sxs-lookup"><span data-stu-id="4e400-287">The **Refresh** button will get a new access token and refresh token using the current refresh token.</span></span>
- <span data-ttu-id="4e400-288">Tlačítko **Rozhraní ACCESS Protected Resource API** zavolá server prostředků, aby získalo data deklarací identity aktuálního uživatele a zobrazilo je na stránce.</span><span class="sxs-lookup"><span data-stu-id="4e400-288">The **Access Protected Resource API** button will call the resource server to get current user's claims data and show them on the page.</span></span>

<span data-ttu-id="4e400-289">Zde je ukázkový `HomeController` kód klienta.</span><span class="sxs-lookup"><span data-stu-id="4e400-289">Here is the sample code of the `HomeController` of the client.</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample16.cs)]

<span data-ttu-id="4e400-290">`DotNetOpenAuth`ve výchozím nastavení vyžaduje ssl.</span><span class="sxs-lookup"><span data-stu-id="4e400-290">`DotNetOpenAuth` requires SSL by default.</span></span> <span data-ttu-id="4e400-291">Vzhledem k tomu, že naše demo používá HTTP, musíte přidat následující nastavení do konfiguračního souboru:</span><span class="sxs-lookup"><span data-stu-id="4e400-291">Since our demo is using HTTP, you need to add following setting in the config file:</span></span>

[!code-xml[Main](owin-oauth-20-authorization-server/samples/sample17.xml?highlight=4-6)]

> [!WARNING]
> <span data-ttu-id="4e400-292">Zabezpečení – Nikdy nezakažte ssl v produkční aplikaci.</span><span class="sxs-lookup"><span data-stu-id="4e400-292">Security - Never disable SSL in a production app.</span></span> <span data-ttu-id="4e400-293">Vaše přihlašovací údaje jsou nyní odesílány ve prostém textu přes drát.</span><span class="sxs-lookup"><span data-stu-id="4e400-293">Your login credentials are now being sent in clear-text across the wire.</span></span> <span data-ttu-id="4e400-294">Výše uvedený kód je určen pouze pro místní ukázkové ladění a průzkum.</span><span class="sxs-lookup"><span data-stu-id="4e400-294">The code above is just for local sample debugging and exploration.</span></span>


### <a name="implicit-grant-client"></a><span data-ttu-id="4e400-295">Implicitní klient grantu</span><span class="sxs-lookup"><span data-stu-id="4e400-295">Implicit Grant Client</span></span>

<span data-ttu-id="4e400-296">Tento klient používá JavaScript k:</span><span class="sxs-lookup"><span data-stu-id="4e400-296">This client is using JavaScript to:</span></span>

1. <span data-ttu-id="4e400-297">Otevřete nové okno a přesměrujte na autorizační koncový bod autorizačního serveru.</span><span class="sxs-lookup"><span data-stu-id="4e400-297">Open a new window and redirect to the authorize endpoint of the Authorization Server.</span></span>
2. <span data-ttu-id="4e400-298">Získejte přístupový token z fragmentů adresy URL, když se přesměruje zpět.</span><span class="sxs-lookup"><span data-stu-id="4e400-298">Get the access token from URL fragments when it redirects back.</span></span>

<span data-ttu-id="4e400-299">Následující obrázek ukazuje tento proces:</span><span class="sxs-lookup"><span data-stu-id="4e400-299">The following image shows this process:</span></span>

![](owin-oauth-20-authorization-server/_static/image4.png)

<span data-ttu-id="4e400-300">Klient by měl mít dvě stránky: jednu pro domovskou stránku a druhou pro zpětné volání. Zde je ukázkový kód JavaScriptu nalezený v souboru *Index.cshtml:*</span><span class="sxs-lookup"><span data-stu-id="4e400-300">The client should have two pages: one for home page and the other for callback.Here is the sample JavaScript code found in the *Index.cshtml* file:</span></span>

[!code-cshtml[Main](owin-oauth-20-authorization-server/samples/sample18.cshtml)]

<span data-ttu-id="4e400-301">Zde je kód zpracování zpětného volání v souboru *SignIn.cshtml:*</span><span class="sxs-lookup"><span data-stu-id="4e400-301">Here is the callback handling code in *SignIn.cshtml* file:</span></span>

[!code-cshtml[Main](owin-oauth-20-authorization-server/samples/sample19.cshtml)]

> [!NOTE]
> <span data-ttu-id="4e400-302">Osvědčeným postupem je přesunout JavaScript do externího souboru a nevložit jej pomocí značky Razor.</span><span class="sxs-lookup"><span data-stu-id="4e400-302">A best practice is to move the JavaScript to an external file and not embed it with the Razor markup.</span></span> <span data-ttu-id="4e400-303">Aby byl tento vzorek jednoduchý, byly kombinovány.</span><span class="sxs-lookup"><span data-stu-id="4e400-303">To keep this sample simple, they have been combined.</span></span>


### <a name="resource-owner-password-credentials-grant-client"></a><span data-ttu-id="4e400-304">Klient a klient hesla vlastníka prostředku</span><span class="sxs-lookup"><span data-stu-id="4e400-304">Resource Owner Password Credentials Grant Client</span></span>

<span data-ttu-id="4e400-305">Používáme konzolovou aplikaci k demo tohoto klienta.</span><span class="sxs-lookup"><span data-stu-id="4e400-305">We uses a console app to demo this client.</span></span> <span data-ttu-id="4e400-306">Zde je kód:</span><span class="sxs-lookup"><span data-stu-id="4e400-306">Here is the code:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample20.cs)]

### <a name="client-credentials-grant-client"></a><span data-ttu-id="4e400-307">Klientpověření udělit klienta</span><span class="sxs-lookup"><span data-stu-id="4e400-307">Client Credentials Grant Client</span></span>

<span data-ttu-id="4e400-308">Podobně jako u grantu přihlašovacích údajů vlastníka prostředku je zde kód aplikace konzoly:</span><span class="sxs-lookup"><span data-stu-id="4e400-308">Similar to the Resource Owner Password Credentials Grant, here is console app code:</span></span>

[!code-csharp[Main](owin-oauth-20-authorization-server/samples/sample21.cs)]
