---
uid: web-forms/overview/data-access/accessing-the-database-directly-from-an-aspnet-page/implementing-optimistic-concurrency-with-the-sqldatasource-cs
title: Implementace optimistického řízení souběžnosti pomocí SqlDataSourceC#() | Microsoft Docs
author: rick-anderson
description: V tomto kurzu si projdeme základy optimistického řízení souběžnosti a potom si Prozkoumejte, jak ho implementovat pomocí ovládacího prvku SqlDataSource.
ms.author: riande
ms.date: 02/20/2007
ms.assetid: df999966-ac48-460e-b82b-4877a57d6ab9
msc.legacyurl: /web-forms/overview/data-access/accessing-the-database-directly-from-an-aspnet-page/implementing-optimistic-concurrency-with-the-sqldatasource-cs
msc.type: authoredcontent
ms.openlocfilehash: 87fca52e2e8be844411b2fff8382c6002eccbe09
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: cs-CZ
ms.lasthandoff: 03/06/2020
ms.locfileid: "78553233"
---
# <a name="implementing-optimistic-concurrency-with-the-sqldatasource-c"></a><span data-ttu-id="d13a9-103">Implementace optimistického řízení souběžnosti ovládacím prvkem SqlDataSource (C#)</span><span class="sxs-lookup"><span data-stu-id="d13a9-103">Implementing Optimistic Concurrency with the SqlDataSource (C#)</span></span>

<span data-ttu-id="d13a9-104">[Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="d13a9-104">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="d13a9-105">[Stáhnout ukázkovou aplikaci](https://download.microsoft.com/download/4/a/7/4a7a3b18-d80e-4014-8e53-a6a2427f0d93/ASPNET_Data_Tutorial_50_CS.exe) nebo [Stáhnout PDF](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/datatutorial50cs1.pdf)</span><span class="sxs-lookup"><span data-stu-id="d13a9-105">[Download Sample App](https://download.microsoft.com/download/4/a/7/4a7a3b18-d80e-4014-8e53-a6a2427f0d93/ASPNET_Data_Tutorial_50_CS.exe) or [Download PDF](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/datatutorial50cs1.pdf)</span></span>

> <span data-ttu-id="d13a9-106">V tomto kurzu si projdeme základy optimistického řízení souběžnosti a potom si Prozkoumejte, jak ho implementovat pomocí ovládacího prvku SqlDataSource.</span><span class="sxs-lookup"><span data-stu-id="d13a9-106">In this tutorial we review the essentials of optimistic concurrency control and then explore how to implement it using the SqlDataSource control.</span></span>

## <a name="introduction"></a><span data-ttu-id="d13a9-107">Úvod</span><span class="sxs-lookup"><span data-stu-id="d13a9-107">Introduction</span></span>

<span data-ttu-id="d13a9-108">V předchozím kurzu jsme prozkoumali, jak přidat do ovládacího prvku SqlDataSource možnosti vkládání, aktualizace a odstraňování.</span><span class="sxs-lookup"><span data-stu-id="d13a9-108">In the preceding tutorial we examined how to add inserting, updating, and deleting capabilities to the SqlDataSource control.</span></span> <span data-ttu-id="d13a9-109">V krátkém případě je potřeba zadat odpovídající funkce `INSERT`, `UPDATE`nebo `DELETE` jazyka SQL ve vlastnostech ovládacího prvku `InsertCommand`, `UpdateCommand`nebo `DeleteCommand`, společně s příslušnými parametry v `InsertParameters`, `UpdateParameters`a `DeleteParameters` kolekcích.</span><span class="sxs-lookup"><span data-stu-id="d13a9-109">In short, to provide these features we needed to specify the corresponding `INSERT`, `UPDATE`, or `DELETE` SQL statement in the control s `InsertCommand`, `UpdateCommand`, or `DeleteCommand` properties, along with the appropriate parameters in the `InsertParameters`, `UpdateParameters`, and `DeleteParameters` collections.</span></span> <span data-ttu-id="d13a9-110">I když lze tyto vlastnosti a kolekce zadat ručně, tlačítko Konfigurovat Průvodce konfigurací zdroje dat nabízí zaškrtávací políčko Generovat `INSERT`, `UPDATE`a `DELETE`, které automaticky vytvoří tyto příkazy na základě příkazu `SELECT`.</span><span class="sxs-lookup"><span data-stu-id="d13a9-110">While these properties and collections can be specified manually, the Configure Data Source wizard s Advanced button offers a Generate `INSERT`, `UPDATE`, and `DELETE` statements checkbox that will auto-create these statements based on the `SELECT` statement.</span></span>

<span data-ttu-id="d13a9-111">Společně s zaškrtnutím políčka Generovat `INSERT`, `UPDATE`a `DELETE` se zobrazí dialogové okno Pokročilé možnosti generování SQL, které obsahuje možnost použití optimistického řízení souběžnosti (viz obrázek 1).</span><span class="sxs-lookup"><span data-stu-id="d13a9-111">Along with the Generate `INSERT`, `UPDATE`, and `DELETE` statements checkbox, the Advanced SQL Generation Options dialog box includes a Use optimistic concurrency option (see Figure 1).</span></span> <span data-ttu-id="d13a9-112">Pokud je zaškrtnuto, klauzule `WHERE` v automaticky vygenerovaných `UPDATE` a `DELETE` příkazy se upraví tak, aby se prováděly pouze aktualizace, nebo odstranění, pokud se podkladová data databáze nezměnila, protože uživatel data naposledy načetl do mřížky.</span><span class="sxs-lookup"><span data-stu-id="d13a9-112">When checked, the `WHERE` clauses in the autogenerated `UPDATE` and `DELETE` statements are modified to only perform the update or delete if the underlying database data hasn't been modified since the user last loaded the data into the grid.</span></span>

![Můžete přidat podporu optimistického řízení souběžnosti z dialogového okna Upřesnit možnosti generování SQL.](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image1.gif)

<span data-ttu-id="d13a9-114">**Obrázek 1**: z dialogového okna Upřesnit možnosti generování SQL můžete přidat podporu optimistického řízení souběžnosti.</span><span class="sxs-lookup"><span data-stu-id="d13a9-114">**Figure 1**: You Can Add Optimistic Concurrency Support from the Advanced SQL Generation Options Dialog Box</span></span>

<span data-ttu-id="d13a9-115">Zpátky v [implementaci optimistického kurzu pro souběžnost](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-cs.md) jsme prozkoumali základy optimistického řízení souběžnosti a způsob, jak ho přidat do prvku ObjectDataSource.</span><span class="sxs-lookup"><span data-stu-id="d13a9-115">Back in the [Implementing Optimistic Concurrency](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-cs.md) tutorial we examined the fundamentals of optimistic concurrency control and how to add it to the ObjectDataSource.</span></span> <span data-ttu-id="d13a9-116">V tomto kurzu se podíváme na základy optimistického řízení souběžnosti a potom si Prozkoumejte, jak ho implementovat pomocí SqlDataSource.</span><span class="sxs-lookup"><span data-stu-id="d13a9-116">In this tutorial we'll retouch on the essentials of optimistic concurrency control and then explore how to implement it using the SqlDataSource.</span></span>

## <a name="a-recap-of-optimistic-concurrency"></a><span data-ttu-id="d13a9-117">Rekapitulace optimistické souběžnosti</span><span class="sxs-lookup"><span data-stu-id="d13a9-117">A Recap of Optimistic Concurrency</span></span>

<span data-ttu-id="d13a9-118">U webových aplikací, které umožňují více souběžným uživatelům upravovat nebo odstraňovat stejná data, existuje možnost, že jeden uživatel může omylem přepsat další změny.</span><span class="sxs-lookup"><span data-stu-id="d13a9-118">For web applications that allow multiple, simultaneous users to edit or delete the same data, there exists a possibility that one user may accidentally overwrite another s changes.</span></span> <span data-ttu-id="d13a9-119">V kurzu [implementace optimistického řízení souběžnosti](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-cs.md) jsem zadali následující příklad:</span><span class="sxs-lookup"><span data-stu-id="d13a9-119">In the [Implementing Optimistic Concurrency](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-cs.md) tutorial I provided the following example:</span></span>

<span data-ttu-id="d13a9-120">Představte si, že dva uživatelé, Jisun a Sam, navštívili stránku v aplikaci, která umožňuje návštěvníkům aktualizovat a odstraňovat produkty prostřednictvím ovládacího prvku GridView.</span><span class="sxs-lookup"><span data-stu-id="d13a9-120">Imagine that two users, Jisun and Sam, were both visiting a page in an application that allowed visitors to update and delete products through a GridView control.</span></span> <span data-ttu-id="d13a9-121">Klikněte na tlačítko Upravit pro příkaz Chai přibližně po stejnou dobu.</span><span class="sxs-lookup"><span data-stu-id="d13a9-121">Both click the Edit button for Chai around the same time.</span></span> <span data-ttu-id="d13a9-122">Jisun změní název produktu na Chai čaj a klikne na tlačítko Aktualizovat.</span><span class="sxs-lookup"><span data-stu-id="d13a9-122">Jisun changes the product name to Chai Tea and clicks the Update button.</span></span> <span data-ttu-id="d13a9-123">Čistým výsledkem je příkaz `UPDATE`, který se pošle do databáze, která nastaví *všechna* pole, která lze aktualizovat, a to i v případě, že Jisun aktualizuje jenom jedno pole `ProductName`).</span><span class="sxs-lookup"><span data-stu-id="d13a9-123">The net result is an `UPDATE` statement that is sent to the database, which sets *all* of the product s updateable fields (even though Jisun only updated one field, `ProductName`).</span></span> <span data-ttu-id="d13a9-124">V tomto okamžiku má databáze hodnoty Chai čaj, kategorie nápoje, exotické kapaliny dodavatele a tak dále pro tento konkrétní produkt.</span><span class="sxs-lookup"><span data-stu-id="d13a9-124">At this point in time, the database has the values Chai Tea, the category Beverages, the supplier Exotic Liquids, and so on for this particular product.</span></span> <span data-ttu-id="d13a9-125">Na obrazovce GridView v Sam s se však stále zobrazuje název produktu v upravitelném řádku GridView jako Chai.</span><span class="sxs-lookup"><span data-stu-id="d13a9-125">However, the GridView on Sam s screen still shows the product name in the editable GridView row as Chai.</span></span> <span data-ttu-id="d13a9-126">Za několik sekund po potvrzení změn Jisun se Sam aktualizuje kategorie na koření a klikne na aktualizovat.</span><span class="sxs-lookup"><span data-stu-id="d13a9-126">A few seconds after Jisun s changes have been committed, Sam updates the category to Condiments and clicks Update.</span></span> <span data-ttu-id="d13a9-127">Výsledkem je příkaz `UPDATE` odeslaný do databáze, která nastaví název produktu na Chai, `CategoryID` na odpovídající ID kategorie koření, a tak dále.</span><span class="sxs-lookup"><span data-stu-id="d13a9-127">This results in an `UPDATE` statement sent to the database that sets the product name to Chai, the `CategoryID` to the corresponding Condiments category ID, and so on.</span></span> <span data-ttu-id="d13a9-128">Změny názvu produktu Jisun s byly přepsány.</span><span class="sxs-lookup"><span data-stu-id="d13a9-128">Jisun s changes to the product name have been overwritten.</span></span>

<span data-ttu-id="d13a9-129">Tato interakce je znázorněna na obrázku 2.</span><span class="sxs-lookup"><span data-stu-id="d13a9-129">Figure 2 illustrates this interaction.</span></span>

<span data-ttu-id="d13a9-130">[![, když dva uživatelé současně aktualizují záznam, u kterých se může změnit jeden uživatel a přepsat ostatní s.](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image2.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="d13a9-130">[![When Two Users Simultaneously Update a Record There s Potential for One User s Changes to Overwrite the Other s](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image2.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image1.png)</span></span>

<span data-ttu-id="d13a9-131">**Obrázek 2**: když dva uživatelé současně aktualizují záznam, který je potenciální pro změny jednoho uživatele, aby přepsal ostatní s ([kliknutím zobrazíte obrázek v plné velikosti](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image2.png))</span><span class="sxs-lookup"><span data-stu-id="d13a9-131">**Figure 2**: When Two Users Simultaneously Update a Record There s Potential for One User s Changes to Overwrite the Other s ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image2.png))</span></span>

<span data-ttu-id="d13a9-132">Chcete-li zabránit tomuto scénáři v odložení, musí být implementována forma [řízení souběžnosti](http://en.wikipedia.org/wiki/Concurrency_control) .</span><span class="sxs-lookup"><span data-stu-id="d13a9-132">To prevent this scenario from unfolding, a form of [concurrency control](http://en.wikipedia.org/wiki/Concurrency_control) must be implemented.</span></span> <span data-ttu-id="d13a9-133">[Optimistická souběžnost](http://en.wikipedia.org/wiki/Optimistic_concurrency_control) v tomto kurzu pracuje na předpokladu, že v současné době může dojít ke konfliktům souběžnosti, a to v případě, že dojde k neúspěšnému výskytu takových konfliktů.</span><span class="sxs-lookup"><span data-stu-id="d13a9-133">[Optimistic concurrency](http://en.wikipedia.org/wiki/Optimistic_concurrency_control) the focus of this tutorial works on the assumption that while there may be concurrency conflicts every now and then, the vast majority of the time such conflicts won't arise.</span></span> <span data-ttu-id="d13a9-134">Proto pokud dojde ke konfliktu, optimistické řízení souběžnosti jednoduše informuje uživatele o tom, že je možné uložit změny, protože stejná data změnil jiný uživatel.</span><span class="sxs-lookup"><span data-stu-id="d13a9-134">Therefore, if a conflict does arise, optimistic concurrency control simply informs the user that their changes can t be saved because another user has modified the same data.</span></span>

> [!NOTE]
> <span data-ttu-id="d13a9-135">U aplikací, kde se předpokládá, že dojde ke konfliktu souběžnosti, nebo pokud tyto konflikty nejsou přípustné, lze místo toho použít pesimistické řízení souběžnosti.</span><span class="sxs-lookup"><span data-stu-id="d13a9-135">For applications where it is assumed that there will be many concurrency conflicts or if such conflicts are not tolerable, then pessimistic concurrency control can be used instead.</span></span> <span data-ttu-id="d13a9-136">Přečtěte si kurz [implementace optimistického řízení souběžnosti](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-cs.md) pro podrobnější diskuzi o pesimistické kontrole souběžnosti.</span><span class="sxs-lookup"><span data-stu-id="d13a9-136">Refer back to the [Implementing Optimistic Concurrency](../editing-inserting-and-deleting-data/implementing-optimistic-concurrency-cs.md) tutorial for a more thorough discussion on pessimistic concurrency control.</span></span>

<span data-ttu-id="d13a9-137">Optimistické řízení souběžnosti funguje tak, že zajistí, že záznam, který má být aktualizován nebo odstraněn, má stejné hodnoty jako při zahájení procesu aktualizace nebo odstranění.</span><span class="sxs-lookup"><span data-stu-id="d13a9-137">Optimistic concurrency control works by ensuring that the record being updated or deleted has the same values as it did when the updating or deleting process started.</span></span> <span data-ttu-id="d13a9-138">Například když kliknete na tlačítko Upravit ve upravitelném prvku GridView, hodnoty záznamu s se čtou z databáze a zobrazují se v textových polích a dalších webových ovládacích prvcích.</span><span class="sxs-lookup"><span data-stu-id="d13a9-138">For example, when clicking the Edit button in an editable GridView, the record s values are read from the database and displayed in TextBoxes and other Web controls.</span></span> <span data-ttu-id="d13a9-139">Tyto původní hodnoty jsou uloženy v prvku GridView.</span><span class="sxs-lookup"><span data-stu-id="d13a9-139">These original values are saved by the GridView.</span></span> <span data-ttu-id="d13a9-140">Později poté, co uživatel provede změny a klikne na tlačítko Aktualizovat, musí použitý příkaz `UPDATE` vzít v úvahu původní hodnoty a nové hodnoty a aktualizovat pouze podkladový záznam databáze pouze v případě, že původní hodnoty, které uživatel začal upravovat, jsou shodné s hodnotami stále v databázi.</span><span class="sxs-lookup"><span data-stu-id="d13a9-140">Later, after the user makes her changes and clicks the Update button, the `UPDATE` statement used must take into account the original values plus the new values and only update the underlying database record if the original values that the user started editing are identical to the values still in the database.</span></span> <span data-ttu-id="d13a9-141">Obrázek 3 znázorňuje tuto posloupnost událostí.</span><span class="sxs-lookup"><span data-stu-id="d13a9-141">Figure 3 depicts this sequence of events.</span></span>

<span data-ttu-id="d13a9-142">[![aby se aktualizace nebo odstranění zdařily, měly by se původní hodnoty rovnat aktuálním hodnotám databáze.](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image3.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="d13a9-142">[![For the Update or Delete to Succeed, the Original Values Must Be Equal to the Current Database Values](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image3.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image3.png)</span></span>

<span data-ttu-id="d13a9-143">**Obrázek 3**: aby byla aktualizace nebo odstranění úspěšná, původní hodnoty se musí rovnat aktuálním hodnotám databáze ([kliknutím zobrazíte obrázek v plné velikosti).](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image4.png)</span><span class="sxs-lookup"><span data-stu-id="d13a9-143">**Figure 3**: For the Update or Delete to Succeed, the Original Values Must Be Equal to the Current Database Values ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image4.png))</span></span>

<span data-ttu-id="d13a9-144">Existují různé přístupy k implementaci optimistického řízení souběžnosti (viz [Petra a. Bromberg](http://www.eggheadcafe.com/articles/pbrombergresume.asp) [optimistická logika souběžného zpracování](http://www.eggheadcafe.com/articles/20050719.asp) pro Stručný pohled na řadu možností).</span><span class="sxs-lookup"><span data-stu-id="d13a9-144">There are various approaches to implementing optimistic concurrency (see [Peter A. Bromberg](http://www.eggheadcafe.com/articles/pbrombergresume.asp)'s [Optimistic Concurrency Updating Logic](http://www.eggheadcafe.com/articles/20050719.asp) for a brief look at a number of options).</span></span> <span data-ttu-id="d13a9-145">Technika, kterou používá třída SqlDataSource (stejně jako datové sady ADO.NET typu používané v naší vrstvě přístupu k datům) rozšiřuje klauzuli `WHERE`, aby zahrnovala porovnání všech původních hodnot.</span><span class="sxs-lookup"><span data-stu-id="d13a9-145">The technique used by the SqlDataSource (as well as by the ADO.NET Typed DataSets used in our Data Access Layer) augments the `WHERE` clause to include a comparison of all of the original values.</span></span> <span data-ttu-id="d13a9-146">Následující příkaz `UPDATE` například aktualizuje název a cenu produktu pouze v případě, že aktuální hodnoty databáze jsou rovny hodnotám, které byly původně načteny při aktualizaci záznamu v prvku GridView.</span><span class="sxs-lookup"><span data-stu-id="d13a9-146">The following `UPDATE` statement, for example, updates the name and price of a product only if the current database values are equal to the values that were originally retrieved when updating the record in the GridView.</span></span> <span data-ttu-id="d13a9-147">Parametry `@ProductName` a `@UnitPrice` obsahují nové hodnoty zadané uživatelem, zatímco `@original_ProductName` a `@original_UnitPrice` obsahují hodnoty, které byly původně načteny do prvku GridView při kliknutí na tlačítko pro úpravy:</span><span class="sxs-lookup"><span data-stu-id="d13a9-147">The `@ProductName` and `@UnitPrice` parameters contain the new values entered by the user, whereas `@original_ProductName` and `@original_UnitPrice` contain the values that were originally loaded into the GridView when the Edit button was clicked:</span></span>

[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample1.sql)]

<span data-ttu-id="d13a9-148">Jak je uvedeno v tomto kurzu, povolení optimistického řízení souběžnosti se sadou SqlDataSource je stejně jednoduché jako zaškrtnutí políčka.</span><span class="sxs-lookup"><span data-stu-id="d13a9-148">As we'll see in this tutorial, enabling optimistic concurrency control with the SqlDataSource is as simple as checking a checkbox.</span></span>

## <a name="step-1-creating-a-sqldatasource-that-supports-optimistic-concurrency"></a><span data-ttu-id="d13a9-149">Krok 1: vytvoření SqlDataSource podporující optimistické řízení souběžnosti</span><span class="sxs-lookup"><span data-stu-id="d13a9-149">Step 1: Creating a SqlDataSource that Supports Optimistic Concurrency</span></span>

<span data-ttu-id="d13a9-150">Začněte tím, že otevřete stránku `OptimisticConcurrency.aspx` ze složky `SqlDataSource`.</span><span class="sxs-lookup"><span data-stu-id="d13a9-150">Start by opening the `OptimisticConcurrency.aspx` page from the `SqlDataSource` folder.</span></span> <span data-ttu-id="d13a9-151">Přetáhněte ovládací prvek SqlDataSource ze sady nástrojů do návrháře, nastavení vlastnosti `ID` na `ProductsDataSourceWithOptimisticConcurrency`.</span><span class="sxs-lookup"><span data-stu-id="d13a9-151">Drag a SqlDataSource control from the Toolbox onto the Designer, settings its `ID` property to `ProductsDataSourceWithOptimisticConcurrency`.</span></span> <span data-ttu-id="d13a9-152">Potom klikněte na odkaz konfigurace zdroje dat z inteligentní značky Control s.</span><span class="sxs-lookup"><span data-stu-id="d13a9-152">Next, click on the Configure Data Source link from the control s smart tag.</span></span> <span data-ttu-id="d13a9-153">Na první obrazovce průvodce vyberte možnost pracovat s `NORTHWINDConnectionString` a klikněte na tlačítko Další.</span><span class="sxs-lookup"><span data-stu-id="d13a9-153">From the first screen in the wizard, choose to work with the `NORTHWINDConnectionString` and click Next.</span></span>

<span data-ttu-id="d13a9-154">[![se rozhodnout, jak pracovat s NORTHWINDConnectionString](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image4.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="d13a9-154">[![Choose to Work with the NORTHWINDConnectionString](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image4.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image5.png)</span></span>

<span data-ttu-id="d13a9-155">**Obrázek 4**: volba pro práci s `NORTHWINDConnectionString`m ([kliknutím zobrazíte obrázek v plné velikosti](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="d13a9-155">**Figure 4**: Choose to Work with the `NORTHWINDConnectionString` ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image6.png))</span></span>

<span data-ttu-id="d13a9-156">V tomto příkladu přidáme prvek GridView, který umožní uživatelům upravovat `Products` tabulku.</span><span class="sxs-lookup"><span data-stu-id="d13a9-156">For this example we'll be adding a GridView that enables users to edit the `Products` table.</span></span> <span data-ttu-id="d13a9-157">Proto z obrazovky konfigurace příkazu SELECT vyberte v rozevíracím seznamu tabulku `Products` a vyberte sloupce `ProductID`, `ProductName`, `UnitPrice`a `Discontinued`, jak je znázorněno na obrázku 5.</span><span class="sxs-lookup"><span data-stu-id="d13a9-157">Therefore, from the Configure the Select Statement screen, choose the `Products` table from the drop-down list and select the `ProductID`, `ProductName`, `UnitPrice`, and `Discontinued` columns, as shown in Figure 5.</span></span>

<span data-ttu-id="d13a9-158">[![z tabulky Products vrátí sloupce ProductID, ProductName, UnitPrice a vyřazeno.](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image5.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="d13a9-158">[![From the Products Table, Return the ProductID, ProductName, UnitPrice, and Discontinued Columns](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image5.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image7.png)</span></span>

<span data-ttu-id="d13a9-159">**Obrázek 5**: v tabulce `Products` vrátíte sloupce `ProductID`, `ProductName`, `UnitPrice`a `Discontinued` ([kliknutím zobrazíte obrázek v plné velikosti).](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image8.png)</span><span class="sxs-lookup"><span data-stu-id="d13a9-159">**Figure 5**: From the `Products` Table, Return the `ProductID`, `ProductName`, `UnitPrice`, and `Discontinued` Columns ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image8.png))</span></span>

<span data-ttu-id="d13a9-160">Po výběru sloupců klikněte na tlačítko Upřesnit a zobrazte tak dialogové okno Upřesnit možnosti generování kódu SQL.</span><span class="sxs-lookup"><span data-stu-id="d13a9-160">After picking the columns, click the Advanced button to bring up the Advanced SQL Generation Options dialog box.</span></span> <span data-ttu-id="d13a9-161">Zaškrtněte příkazy generovat `INSERT`, `UPDATE`a `DELETE` a použijte políčka Optimistická souběžnost a klikněte na tlačítko OK (pro snímek obrazovky přejděte zpět na obrázek 1).</span><span class="sxs-lookup"><span data-stu-id="d13a9-161">Check the Generate `INSERT`, `UPDATE`, and `DELETE` statements and Use optimistic concurrency checkboxes and click OK (refer back to Figure 1 for a screenshot).</span></span> <span data-ttu-id="d13a9-162">Dokončete průvodce kliknutím na tlačítko Další a potom na Dokončit.</span><span class="sxs-lookup"><span data-stu-id="d13a9-162">Complete the wizard by clicking Next, then Finish.</span></span>

<span data-ttu-id="d13a9-163">Po dokončení Průvodce konfigurací zdroje dat si Projděte výsledný `DeleteCommand` a `UpdateCommand` vlastnosti a kolekce `DeleteParameters` a `UpdateParameters`.</span><span class="sxs-lookup"><span data-stu-id="d13a9-163">After completing the Configure Data Source wizard, take a moment to examine the resulting `DeleteCommand` and `UpdateCommand` properties and the `DeleteParameters` and `UpdateParameters` collections.</span></span> <span data-ttu-id="d13a9-164">Nejjednodušší způsob, jak to provést, je kliknout na kartu zdroj v levém dolním rohu, aby se zobrazila deklarativní syntaxe stránky.</span><span class="sxs-lookup"><span data-stu-id="d13a9-164">The easiest way to do this is to click on the Source tab in the lower left corner to see the page s declarative syntax.</span></span> <span data-ttu-id="d13a9-165">Vyhledá se `UpdateCommand` hodnota:</span><span class="sxs-lookup"><span data-stu-id="d13a9-165">There you will find an `UpdateCommand` value of:</span></span>

[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample2.sql)]

<span data-ttu-id="d13a9-166">Se sedmi parametry v kolekci `UpdateParameters`:</span><span class="sxs-lookup"><span data-stu-id="d13a9-166">With seven parameters in the `UpdateParameters` collection:</span></span>

[!code-aspx[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample3.aspx)]

<span data-ttu-id="d13a9-167">Podobně `DeleteCommand` vlastnost a kolekce `DeleteParameters` by měly vypadat takto:</span><span class="sxs-lookup"><span data-stu-id="d13a9-167">Similarly, the `DeleteCommand` property and `DeleteParameters` collection should look like the following:</span></span>

[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample4.sql)]

[!code-aspx[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample5.aspx)]

<span data-ttu-id="d13a9-168">Kromě rozšíření `WHERE`ch klauzulí vlastností `UpdateCommand` a `DeleteCommand` (a přidání dalších parametrů do odpovídajících kolekcí parametrů), výběrem možnosti použít optimistickou souběžnost upraví dvě další vlastnosti:</span><span class="sxs-lookup"><span data-stu-id="d13a9-168">In addition to augmenting the `WHERE` clauses of the `UpdateCommand` and `DeleteCommand` properties (and adding the additional parameters to the respective parameter collections), selecting the Use optimistic concurrency option adjusts two other properties:</span></span>

- <span data-ttu-id="d13a9-169">Změní [vlastnost`ConflictDetection`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.sqldatasource.conflictdetection.aspx) z `OverwriteChanges` (výchozí) na `CompareAllValues`</span><span class="sxs-lookup"><span data-stu-id="d13a9-169">Changes the [`ConflictDetection` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.sqldatasource.conflictdetection.aspx) from `OverwriteChanges` (the default) to `CompareAllValues`</span></span>
- <span data-ttu-id="d13a9-170">Změní [vlastnost`OldValuesParameterFormatString`](https://msdn.microsoft.com/library/system.web.ui.webcontrols.sqldatasource.oldvaluesparameterformatstring.aspx) z {0} (výchozí) na původní\_{0}.</span><span class="sxs-lookup"><span data-stu-id="d13a9-170">Changes the [`OldValuesParameterFormatString` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.sqldatasource.oldvaluesparameterformatstring.aspx) from {0} (the default) to original\_{0} .</span></span>

<span data-ttu-id="d13a9-171">Když webová ovládací prvek data vyvolá metodu SqlDataSource s `Update()` nebo `Delete()`, projde původními hodnotami.</span><span class="sxs-lookup"><span data-stu-id="d13a9-171">When the data Web control invokes the SqlDataSource s `Update()` or `Delete()` method, it passes in the original values.</span></span> <span data-ttu-id="d13a9-172">Je-li vlastnost `ConflictDetection` SqlDataSource nastavena na hodnotu `CompareAllValues`, jsou tyto původní hodnoty přidány do příkazu.</span><span class="sxs-lookup"><span data-stu-id="d13a9-172">If the SqlDataSource s `ConflictDetection` property is set to `CompareAllValues`, these original values are added to the command.</span></span> <span data-ttu-id="d13a9-173">Vlastnost `OldValuesParameterFormatString` poskytuje vzor pro pojmenování, který se používá pro tyto původní hodnoty parametrů.</span><span class="sxs-lookup"><span data-stu-id="d13a9-173">The `OldValuesParameterFormatString` property provides the naming pattern used for these original value parameters.</span></span> <span data-ttu-id="d13a9-174">Průvodce konfigurací zdroje dat používá původní\_{0} a odpovídajícím způsobem pojmenuje všechny původní parametry v `UpdateCommand` a `DeleteCommand` vlastnosti a `UpdateParameters` a `DeleteParameters` kolekcí.</span><span class="sxs-lookup"><span data-stu-id="d13a9-174">The Configure Data Source wizard uses original\_{0} and names each original parameter in the `UpdateCommand` and `DeleteCommand` properties and `UpdateParameters` and `DeleteParameters` collections accordingly.</span></span>

> [!NOTE]
> <span data-ttu-id="d13a9-175">Vzhledem k tomu, že nepoužíváme možnosti vložení ovládacího prvku SqlDataSource, můžete odebrat vlastnost `InsertCommand` a její `InsertParameters` kolekci.</span><span class="sxs-lookup"><span data-stu-id="d13a9-175">Since we re not using the SqlDataSource control s inserting capabilities, feel free to remove the `InsertCommand` property and its `InsertParameters` collection.</span></span>

## <a name="correctly-handlingnullvalues"></a><span data-ttu-id="d13a9-176">Správné zpracování hodnot`NULL`</span><span class="sxs-lookup"><span data-stu-id="d13a9-176">Correctly Handling`NULL`Values</span></span>

<span data-ttu-id="d13a9-177">Nicméně rozšířené `UPDATE` a `DELETE` příkazy automaticky generované průvodcem konfigurovat zdroj dat při použití optimistické souběžnosti *nefungují se* záznamy, které obsahují `NULL` hodnoty.</span><span class="sxs-lookup"><span data-stu-id="d13a9-177">Unfortunately, the augmented `UPDATE` and `DELETE` statements autogenerated by the Configure Data Source wizard when using optimistic concurrency do *not* work with records that contain `NULL` values.</span></span> <span data-ttu-id="d13a9-178">Chcete-li zjistit, proč, zvažte naši `UpdateCommand`SqlDataSource:</span><span class="sxs-lookup"><span data-stu-id="d13a9-178">To see why, consider our SqlDataSource s `UpdateCommand`:</span></span>

[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample6.sql)]

<span data-ttu-id="d13a9-179">`UnitPrice` sloupec v tabulce `Products` může mít `NULL` hodnoty.</span><span class="sxs-lookup"><span data-stu-id="d13a9-179">The `UnitPrice` column in the `Products` table can have `NULL` values.</span></span> <span data-ttu-id="d13a9-180">Pokud má konkrétní záznam `NULL` hodnotu pro `UnitPrice`, `WHERE` část klauzule `[UnitPrice] = @original_UnitPrice` se *vždycky* vyhodnotí jako false, protože `NULL = NULL` vždycky vrátí hodnotu false.</span><span class="sxs-lookup"><span data-stu-id="d13a9-180">If a particular record has a `NULL` value for `UnitPrice`, the `WHERE` clause portion `[UnitPrice] = @original_UnitPrice` will *always* evaluate to False because `NULL = NULL` always returns False.</span></span> <span data-ttu-id="d13a9-181">Záznamy obsahující `NULL` hodnoty proto nelze upravovat ani odstraňovat, protože příkazy `UPDATE` a `DELETE` `WHERE` klauzule nevrátí žádné řádky, které by se měly aktualizovat nebo odstranit.</span><span class="sxs-lookup"><span data-stu-id="d13a9-181">Therefore, records that contain `NULL` values cannot be edited or deleted, as the `UPDATE` and `DELETE` statements `WHERE` clauses won't return any rows to update or delete.</span></span>

> [!NOTE]
> <span data-ttu-id="d13a9-182">Tato chyba byla poprvé oznámena společností Microsoft v červnu 2004 ve [třídě SqlDataSource generuje nesprávné příkazy SQL](https://connect.microsoft.com/VisualStudio/feedback/ViewFeedback.aspx?FeedbackID=93937) a je naplánovaná tak, aby byla opravena v další verzi ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="d13a9-182">This bug was first reported to Microsoft in June of 2004 in [SqlDataSource Generates Incorrect SQL Statements](https://connect.microsoft.com/VisualStudio/feedback/ViewFeedback.aspx?FeedbackID=93937) and is reportedly scheduled to be fixed in the next version of ASP.NET.</span></span>

<span data-ttu-id="d13a9-183">Chcete-li tento problém vyřešit, je nutné ručně aktualizovat klauzule `WHERE` ve vlastnostech `UpdateCommand` a `DeleteCommand` pro **všechny** sloupce, které mohou mít hodnoty `NULL`.</span><span class="sxs-lookup"><span data-stu-id="d13a9-183">To fix this, we have to manually update the `WHERE` clauses in both the `UpdateCommand` and `DeleteCommand` properties for **all** columns that can have `NULL` values.</span></span> <span data-ttu-id="d13a9-184">V obecném případě změňte `[ColumnName] = @original_ColumnName` na:</span><span class="sxs-lookup"><span data-stu-id="d13a9-184">In general, change `[ColumnName] = @original_ColumnName` to:</span></span>

[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample7.sql)]

<span data-ttu-id="d13a9-185">Tuto úpravu lze provést přímo prostřednictvím deklarativní značky, prostřednictvím možností UpdateQuery nebo DeleteQuery z okno Vlastnosti, nebo prostřednictvím karet UPDATE a DELETE v příkazu zadat vlastní příkaz SQL nebo v možnosti uložená procedura v části Konfigurace dat. Průvodce zdrojem</span><span class="sxs-lookup"><span data-stu-id="d13a9-185">This modification can be made directly through the declarative markup, via the UpdateQuery or DeleteQuery options from the Properties window, or through the UPDATE and DELETE tabs in the Specify a custom SQL statement or stored procedure option in the Configure Data Source wizard.</span></span> <span data-ttu-id="d13a9-186">Tuto změnu je třeba provést pro *všechny* sloupce v klauzuli `UpdateCommand` a `DeleteCommand` s `WHERE`, které mohou obsahovat hodnoty `NULL`.</span><span class="sxs-lookup"><span data-stu-id="d13a9-186">Again, this modification must be made for *every* column in the `UpdateCommand` and `DeleteCommand` s `WHERE` clause that can contain `NULL` values.</span></span>

<span data-ttu-id="d13a9-187">Použití tohoto příkladu v našem příkladu vede k následujícím upraveným `UpdateCommand` a `DeleteCommand`m hodnotám:</span><span class="sxs-lookup"><span data-stu-id="d13a9-187">Applying this to our example results in the following modified `UpdateCommand` and `DeleteCommand` values:</span></span>

[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample8.sql)]

## <a name="step-2-adding-a-gridview-with-edit-and-delete-options"></a><span data-ttu-id="d13a9-188">Krok 2: Přidání prvku GridView s možnostmi Upravit a odstranit</span><span class="sxs-lookup"><span data-stu-id="d13a9-188">Step 2: Adding a GridView with Edit and Delete Options</span></span>

<span data-ttu-id="d13a9-189">U prvku SqlDataSource nakonfigurovaného pro podporu optimistické souběžnosti je vše k disměně pro přidání webového ovládacího prvku pro datovou stránku, který využívá toto řízení souběžnosti.</span><span class="sxs-lookup"><span data-stu-id="d13a9-189">With the SqlDataSource configured to support optimistic concurrency, all that remains is to add a data Web control to the page that utilizes this concurrency control.</span></span> <span data-ttu-id="d13a9-190">Pro tento kurz přidejte ovládací prvek GridView, který poskytuje funkce úprav i odstranění.</span><span class="sxs-lookup"><span data-stu-id="d13a9-190">For this tutorial, let s add a GridView that provides both edit and delete functionality.</span></span> <span data-ttu-id="d13a9-191">Chcete-li toho dosáhnout, přetáhněte prvek GridView z panelu nástrojů do návrháře a nastavte jeho `ID` na `Products`.</span><span class="sxs-lookup"><span data-stu-id="d13a9-191">To accomplish this, drag a GridView from the Toolbox onto the Designer and set its `ID` to `Products`.</span></span> <span data-ttu-id="d13a9-192">Z inteligentní značky GridView s, navažte ji k ovládacímu prvku `ProductsDataSourceWithOptimisticConcurrency` SqlDataSource přidanému v kroku 1.</span><span class="sxs-lookup"><span data-stu-id="d13a9-192">From the GridView s smart tag, bind it to the `ProductsDataSourceWithOptimisticConcurrency` SqlDataSource control added in Step 1.</span></span> <span data-ttu-id="d13a9-193">Nakonec zaškrtněte možnosti Povolit úpravy a povolit odstraňování z inteligentní značky.</span><span class="sxs-lookup"><span data-stu-id="d13a9-193">Finally, check the Enable Editing and Enable Deleting options from the smart tag.</span></span>

<span data-ttu-id="d13a9-194">[![vytvořit vazby prvku GridView ke třídě SqlDataSource a povolit úpravy a odstranění](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image6.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="d13a9-194">[![Bind the GridView to the SqlDataSource and Enable Editing and Deleting](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image6.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image9.png)</span></span>

<span data-ttu-id="d13a9-195">**Obrázek 6**: vazba prvku GridView ke třídě SqlDataSource a povolení úprav a odstranění ([kliknutím zobrazíte obrázek v plné velikosti](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image10.png))</span><span class="sxs-lookup"><span data-stu-id="d13a9-195">**Figure 6**: Bind the GridView to the SqlDataSource and Enable Editing and Deleting ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image10.png))</span></span>

<span data-ttu-id="d13a9-196">Po přidání prvku GridView nakonfigurujte jeho vzhled tak, že odeberete `ProductID` vlastnost BoundField, změníte vlastnost `ProductName` vlastnost BoundField s `HeaderText` na produkt a aktualizujete `UnitPrice` vlastnost BoundField tak, aby jeho `HeaderText`ová vlastnost byla jednoduše Price.</span><span class="sxs-lookup"><span data-stu-id="d13a9-196">After adding the GridView, configure its appearance by removing the `ProductID` BoundField, changing the `ProductName` BoundField s `HeaderText` property to Product, and updating the `UnitPrice` BoundField so that its `HeaderText` property is simply Price.</span></span> <span data-ttu-id="d13a9-197">V ideálním případě jsme vylepšili rozhraní pro úpravy, aby zahrnovalo RequiredFieldValidator hodnotu `ProductName` a CompareValidator pro hodnotu `UnitPrice` (aby se zajistilo, že je správně naformátovaná číselná hodnota).</span><span class="sxs-lookup"><span data-stu-id="d13a9-197">Ideally, we d enhance the editing interface to include a RequiredFieldValidator for the `ProductName` value and a CompareValidator for the `UnitPrice` value (to ensure it s a properly formatted numeric value).</span></span> <span data-ttu-id="d13a9-198">Podrobnější informace o přizpůsobení rozhraní pro úpravy prvku GridView naleznete v kurzu [přizpůsobení rozhraní pro úpravu dat](../editing-inserting-and-deleting-data/customizing-the-data-modification-interface-cs.md) .</span><span class="sxs-lookup"><span data-stu-id="d13a9-198">Refer to the [Customizing the Data Modification Interface](../editing-inserting-and-deleting-data/customizing-the-data-modification-interface-cs.md) tutorial for a more in-depth look at customizing the GridView s editing interface.</span></span>

> [!NOTE]
> <span data-ttu-id="d13a9-199">Stav zobrazení GridView s musí být povolen, protože původní hodnoty předané z prvku GridView do SqlDataSource jsou uloženy ve stavu zobrazení.</span><span class="sxs-lookup"><span data-stu-id="d13a9-199">The GridView s view state must be enabled since the original values passed from the GridView to the SqlDataSource are stored in view state.</span></span>

<span data-ttu-id="d13a9-200">Po provedení těchto úprav prvku GridView by deklarativní označení GridView a SqlDataSource mělo vypadat podobně jako následující:</span><span class="sxs-lookup"><span data-stu-id="d13a9-200">After making these modifications to the GridView, the GridView and SqlDataSource declarative markup should look similar to the following:</span></span>

[!code-aspx[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample9.aspx)]

<span data-ttu-id="d13a9-201">Chcete-li zobrazit optimistické řízení souběžnosti v akci, otevřete dvě okna prohlížeče a načtěte `OptimisticConcurrency.aspx` stránku v obou.</span><span class="sxs-lookup"><span data-stu-id="d13a9-201">To see the optimistic concurrency control in action, open two browser windows and load the `OptimisticConcurrency.aspx` page in both.</span></span> <span data-ttu-id="d13a9-202">Klikněte na tlačítka pro úpravy prvního produktu v obou prohlížečích.</span><span class="sxs-lookup"><span data-stu-id="d13a9-202">Click on the Edit buttons for the first product in both browsers.</span></span> <span data-ttu-id="d13a9-203">V jednom prohlížeči změňte název produktu a klikněte na aktualizovat.</span><span class="sxs-lookup"><span data-stu-id="d13a9-203">In one browser, change the product name and click Update.</span></span> <span data-ttu-id="d13a9-204">Prohlížeč odešle zpět a GridView se vrátí do režimu před úpravou, který zobrazuje nový název produktu pro záznam, který je právě upravován.</span><span class="sxs-lookup"><span data-stu-id="d13a9-204">The browser will postback and the GridView will return to its pre-editing mode, showing the new product name for the record just edited.</span></span>

<span data-ttu-id="d13a9-205">V druhém okně prohlížeče změňte cenu (ale ponechte název produktu jako původní hodnotu) a klikněte na aktualizovat.</span><span class="sxs-lookup"><span data-stu-id="d13a9-205">In the second browser window, change the price (but leave the product name as its original value) and click Update.</span></span> <span data-ttu-id="d13a9-206">Při zpětném volání se mřížka vrátí do režimu před úpravou, ale změna ceny se nezaznamená.</span><span class="sxs-lookup"><span data-stu-id="d13a9-206">On postback, the grid returns to its pre-editing mode, but the change to the price is not recorded.</span></span> <span data-ttu-id="d13a9-207">Druhý prohlížeč zobrazí stejnou hodnotu jako první název nového produktu se starou cenou.</span><span class="sxs-lookup"><span data-stu-id="d13a9-207">The second browser shows the same value as the first one the new product name with the old price.</span></span> <span data-ttu-id="d13a9-208">Změny provedené v druhém okně prohlížeče byly ztraceny.</span><span class="sxs-lookup"><span data-stu-id="d13a9-208">The changes made in the second browser window were lost.</span></span> <span data-ttu-id="d13a9-209">Kromě toho se změny ztratily spíše, protože nebyla žádná výjimka nebo zpráva oznamující, že došlo k narušení souběžnosti.</span><span class="sxs-lookup"><span data-stu-id="d13a9-209">Moreover, the changes were lost rather quietly, as there was no exception or message indicating that a concurrency violation just occurred.</span></span>

<span data-ttu-id="d13a9-210">[![změny v druhém okně prohlížeče byly Tichy ztraceny](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image7.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="d13a9-210">[![The Changes in the Second Browser Window Were Silently Lost](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image7.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image11.png)</span></span>

<span data-ttu-id="d13a9-211">**Obrázek 7**: změny ve druhém okně prohlížeče byly tiše ztraceny ([kliknutím zobrazíte obrázek v plné velikosti).](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image12.png)</span><span class="sxs-lookup"><span data-stu-id="d13a9-211">**Figure 7**: The Changes in the Second Browser Window Were Silently Lost ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image12.png))</span></span>

<span data-ttu-id="d13a9-212">Důvod, proč změny v druhém prohlížeči nebyly potvrzeny, protože klauzule `UPDATE` s `WHERE` vyfiltroval všechny záznamy, a proto neovlivnila žádné řádky.</span><span class="sxs-lookup"><span data-stu-id="d13a9-212">The reason why the second browser s changes were not committed was because the `UPDATE` statement s `WHERE` clause filtered out all records and therefore did not affect any rows.</span></span> <span data-ttu-id="d13a9-213">Pojďme se podívat na příkaz `UPDATE` znovu:</span><span class="sxs-lookup"><span data-stu-id="d13a9-213">Let s look at the `UPDATE` statement again:</span></span>

[!code-sql[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample10.sql)]

<span data-ttu-id="d13a9-214">Když druhé okno prohlížeče aktualizuje záznam, původní název produktu zadaný v klauzuli `WHERE` nesouhlasí s existujícím názvem produktu (protože byl změněn prvním prohlížečem).</span><span class="sxs-lookup"><span data-stu-id="d13a9-214">When the second browser window updates the record, the original product name specified in the `WHERE` clause doesn t match up with the existing product name (since it was changed by the first browser).</span></span> <span data-ttu-id="d13a9-215">Proto příkaz `[ProductName] = @original_ProductName` vrátí hodnotu false a `UPDATE` nemá vliv na žádné záznamy.</span><span class="sxs-lookup"><span data-stu-id="d13a9-215">Therefore, the statement `[ProductName] = @original_ProductName` returns False, and the `UPDATE` does not affect any records.</span></span>

> [!NOTE]
> <span data-ttu-id="d13a9-216">Odstranění funguje stejným způsobem.</span><span class="sxs-lookup"><span data-stu-id="d13a9-216">Delete works in the same manner.</span></span> <span data-ttu-id="d13a9-217">Se dvěma otevřenými okny prohlížeče začněte úpravou daného produktu s použitím jednoho a uložením změn.</span><span class="sxs-lookup"><span data-stu-id="d13a9-217">With two browser windows open, start by editing a given product with one, and then saving its changes.</span></span> <span data-ttu-id="d13a9-218">Po uložení změn v jednom prohlížeči klikněte na tlačítko Odstranit pro stejný produkt v druhé.</span><span class="sxs-lookup"><span data-stu-id="d13a9-218">After saving the changes in the one browser, click the Delete button for the same product in the other.</span></span> <span data-ttu-id="d13a9-219">Vzhledem k tomu, že se původní hodnoty neshodují v klauzuli `DELETE` příkazu s `WHERE`, odstranění se v tichém režimu nezdařilo.</span><span class="sxs-lookup"><span data-stu-id="d13a9-219">Since the original values don t match up in the `DELETE` statement s `WHERE` clause, the delete silently fails.</span></span>

<span data-ttu-id="d13a9-220">V perspektivě koncového uživatele v druhém okně prohlížeče po kliknutí na tlačítko Aktualizovat se mřížka vrátí do režimu před úpravami, ale jejich změny byly ztraceny.</span><span class="sxs-lookup"><span data-stu-id="d13a9-220">From the end user s perspective in the second browser window, after clicking the Update button the grid returns to the pre-editing mode, but their changes were lost.</span></span> <span data-ttu-id="d13a9-221">Neexistuje ale žádná vizuální zpětná vazba, na kterou se změny nezměnily.</span><span class="sxs-lookup"><span data-stu-id="d13a9-221">However, there s no visual feedback that their changes didn't stick.</span></span> <span data-ttu-id="d13a9-222">V ideálním případě platí, že pokud dojde ke ztrátě změn uživatelů v důsledku porušení souběžnosti, informujte je, že je to třeba, aby byla mřížka v režimu úprav.</span><span class="sxs-lookup"><span data-stu-id="d13a9-222">Ideally, if a user s changes are lost to a concurrency violation, we d notify them and, perhaps, keep the grid in edit mode.</span></span> <span data-ttu-id="d13a9-223">Pojďme se podívat, jak to provést.</span><span class="sxs-lookup"><span data-stu-id="d13a9-223">Let s look at how to accomplish this.</span></span>

## <a name="step-3-determining-when-a-concurrency-violation-has-occurred"></a><span data-ttu-id="d13a9-224">Krok 3: určení, kdy došlo k narušení souběžnosti</span><span class="sxs-lookup"><span data-stu-id="d13a9-224">Step 3: Determining When a Concurrency Violation Has Occurred</span></span>

<span data-ttu-id="d13a9-225">Vzhledem k tomu, že porušení souběžnosti odmítne změny provedené v souběžnosti, by bylo skvělé upozornit uživatele, když došlo k narušení souběžnosti.</span><span class="sxs-lookup"><span data-stu-id="d13a9-225">Since a concurrency violation rejects the changes one has made, it would be nice to alert the user when a concurrency violation has occurred.</span></span> <span data-ttu-id="d13a9-226">Chcete-li uživatele upozornit, přidejte ovládací prvek web Label na začátek stránky s názvem `ConcurrencyViolationMessage`, jehož vlastnost `Text` zobrazí následující zprávu: Pokusili jste se aktualizovat nebo odstranit záznam, který byl současně aktualizován jiným uživatelem.</span><span class="sxs-lookup"><span data-stu-id="d13a9-226">To alert the user, let s add a Label Web control to the top of the page named `ConcurrencyViolationMessage` whose `Text` property displays the following message: You have attempted to update or delete a record that was simultaneously updated by another user.</span></span> <span data-ttu-id="d13a9-227">Zkontrolujte změny provedené ostatními uživateli a znovu proveďte aktualizaci nebo odstranění.</span><span class="sxs-lookup"><span data-stu-id="d13a9-227">Please review the other user's changes and then redo your update or delete.</span></span> <span data-ttu-id="d13a9-228">Nastavte vlastnost popisku `CssClass` ovládacího prvku na hodnotu Warning, což je Třída CSS definovaná v `Styles.css`, která zobrazuje text červeně, kurzívou, tučně a velkým písmem.</span><span class="sxs-lookup"><span data-stu-id="d13a9-228">Set the Label control s `CssClass` property to Warning, which is a CSS class defined in `Styles.css` that displays text in a red, italic, bold, and large font.</span></span> <span data-ttu-id="d13a9-229">Nakonec nastavte vlastnosti Label `Visible` a `EnableViewState` na `false`.</span><span class="sxs-lookup"><span data-stu-id="d13a9-229">Finally, set the Label s `Visible` and `EnableViewState` properties to `false`.</span></span> <span data-ttu-id="d13a9-230">Tato operace skryje popisek s výjimkou těch, u kterých jsme explicitně nastavili vlastnost `Visible` na hodnotu `true`.</span><span class="sxs-lookup"><span data-stu-id="d13a9-230">This will hide the Label except for only those postbacks where we explicitly set its `Visible` property to `true`.</span></span>

<span data-ttu-id="d13a9-231">[![přidání ovládacího prvku popisek na stránku, aby se zobrazilo upozornění](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image8.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="d13a9-231">[![Add a Label Control to the Page to Display the Warning](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image8.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image13.png)</span></span>

<span data-ttu-id="d13a9-232">**Obrázek 8**: Přidání ovládacího prvku popisek na stránku, aby se zobrazilo upozornění ([kliknutím zobrazíte obrázek v plné velikosti](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image14.png))</span><span class="sxs-lookup"><span data-stu-id="d13a9-232">**Figure 8**: Add a Label Control to the Page to Display the Warning ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image14.png))</span></span>

<span data-ttu-id="d13a9-233">Při provádění rutiny Update nebo DELETE se ovládací prvky GridView s `RowUpdated` a `RowDeleted` aktivují poté, co ovládací prvek zdroje dat provede požadovanou aktualizaci nebo odstranění.</span><span class="sxs-lookup"><span data-stu-id="d13a9-233">When performing an update or delete, the GridView s `RowUpdated` and `RowDeleted` event handlers fire after its data source control has performed the requested update or delete.</span></span> <span data-ttu-id="d13a9-234">Můžeme určit, kolik řádků bylo ovlivněno operací z těchto obslužných rutin událostí.</span><span class="sxs-lookup"><span data-stu-id="d13a9-234">We can determine how many rows were affected by the operation from these event handlers.</span></span> <span data-ttu-id="d13a9-235">Pokud jste ovlivnili nulové řádky, chceme zobrazit `ConcurrencyViolationMessage` popisku.</span><span class="sxs-lookup"><span data-stu-id="d13a9-235">If zero rows were affected, we want to display the `ConcurrencyViolationMessage` Label.</span></span>

<span data-ttu-id="d13a9-236">Vytvořte obslužnou rutinu události pro události `RowUpdated` i `RowDeleted` a přidejte následující kód:</span><span class="sxs-lookup"><span data-stu-id="d13a9-236">Create an event handler for both the `RowUpdated` and `RowDeleted` events and add the following code:</span></span>

[!code-csharp[Main](implementing-optimistic-concurrency-with-the-sqldatasource-cs/samples/sample11.cs)]

<span data-ttu-id="d13a9-237">V obou obslužných rutinách událostí kontrolujeme vlastnost `e.AffectedRows` a pokud se rovná 0, nastavte vlastnost `ConcurrencyViolationMessage` popisek s `Visible` na `true`.</span><span class="sxs-lookup"><span data-stu-id="d13a9-237">In both event handlers we check the `e.AffectedRows` property and, if it equals 0, set the `ConcurrencyViolationMessage` Label s `Visible` property to `true`.</span></span> <span data-ttu-id="d13a9-238">V obslužné rutině události `RowUpdated` také instruujte ovládací prvek GridView, aby zůstal v režimu úprav nastavením vlastnosti `KeepInEditMode` na hodnotu true.</span><span class="sxs-lookup"><span data-stu-id="d13a9-238">In the `RowUpdated` event handler, we also instruct the GridView to stay in edit mode by setting the `KeepInEditMode` property to true.</span></span> <span data-ttu-id="d13a9-239">V takovém případě musíme data znovu navazovat do mřížky, aby se data ostatních uživatelů načetla do rozhraní pro úpravy.</span><span class="sxs-lookup"><span data-stu-id="d13a9-239">In doing so, we need to rebind the data to the grid so that the other user s data is loaded into the editing interface.</span></span> <span data-ttu-id="d13a9-240">Toho lze dosáhnout voláním metody `DataBind()` GridView.</span><span class="sxs-lookup"><span data-stu-id="d13a9-240">This is accomplished by calling the GridView s `DataBind()` method.</span></span>

<span data-ttu-id="d13a9-241">Jak ukazuje obrázek 9, u těchto dvou obslužných rutin událostí se zobrazí velmi znatelné zpráva, kdykoli dojde k porušení souběžnosti.</span><span class="sxs-lookup"><span data-stu-id="d13a9-241">As Figure 9 shows, with these two event handlers, a very noticeable message is displayed whenever a concurrency violation occurs.</span></span>

<span data-ttu-id="d13a9-242">[![se zpráva zobrazí na ploše narušení souběžnosti](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image9.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="d13a9-242">[![A Message is Displayed in the Face of a Concurrency Violation](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image9.gif)](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image15.png)</span></span>

<span data-ttu-id="d13a9-243">**Obrázek 9**: zpráva se zobrazí na ploše narušení souběžnosti ([kliknutím zobrazíte obrázek v plné velikosti).](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image16.png)</span><span class="sxs-lookup"><span data-stu-id="d13a9-243">**Figure 9**: A Message is Displayed in the Face of a Concurrency Violation ([Click to view full-size image](implementing-optimistic-concurrency-with-the-sqldatasource-cs/_static/image16.png))</span></span>

## <a name="summary"></a><span data-ttu-id="d13a9-244">Souhrn</span><span class="sxs-lookup"><span data-stu-id="d13a9-244">Summary</span></span>

<span data-ttu-id="d13a9-245">Při vytváření webové aplikace, kde více souběžných uživatelů může upravovat stejná data, je důležité zvážit možnosti řízení souběžnosti.</span><span class="sxs-lookup"><span data-stu-id="d13a9-245">When creating a web application where multiple, concurrent users may be editing the same data, it is important to consider concurrency control options.</span></span> <span data-ttu-id="d13a9-246">Ve výchozím nastavení webové ovládací prvky dat ASP.NET a ovládací prvky zdroje dat nevyužívají žádné řízení souběžnosti.</span><span class="sxs-lookup"><span data-stu-id="d13a9-246">By default, the ASP.NET data Web controls and data source controls do not employ any concurrency control.</span></span> <span data-ttu-id="d13a9-247">Jak jsme viděli v tomto kurzu, implementace optimistického řízení souběžnosti se sadou SqlDataSource je relativně rychlá a jednoduchá.</span><span class="sxs-lookup"><span data-stu-id="d13a9-247">As we saw in this tutorial, implementing optimistic concurrency control with the SqlDataSource is relatively quick and easy.</span></span> <span data-ttu-id="d13a9-248">Třída SqlDataSource zpracovává většinu samotnému pro přidání rozšířených `WHERE` klauzulí do automaticky generovaných příkazů `UPDATE` a `DELETE`, ale existuje několik odlišností ve zpracování `NULL` hodnotových sloupců, jak je popsáno v části správné zpracování `NULL`ch hodnot.</span><span class="sxs-lookup"><span data-stu-id="d13a9-248">The SqlDataSource handles most of the legwork for your adding augmented `WHERE` clauses to the autogenerated `UPDATE` and `DELETE` statements but there are a few subtleties in handling `NULL` value columns, as discussed in the Correctly Handling `NULL` Values section.</span></span>

<span data-ttu-id="d13a9-249">V tomto kurzu se uzavře naše prohlídka na třídě SqlDataSource.</span><span class="sxs-lookup"><span data-stu-id="d13a9-249">This tutorial concludes our examination of the SqlDataSource.</span></span> <span data-ttu-id="d13a9-250">Naše zbývající kurzy se vrátí k práci s daty pomocí architektury ObjectDataSource a vrstvené architektury.</span><span class="sxs-lookup"><span data-stu-id="d13a9-250">Our remaining tutorials will return to working with data using the ObjectDataSource and tiered architecture.</span></span>

<span data-ttu-id="d13a9-251">Šťastné programování!</span><span class="sxs-lookup"><span data-stu-id="d13a9-251">Happy Programming!</span></span>

## <a name="about-the-author"></a><span data-ttu-id="d13a9-252">O autorovi</span><span class="sxs-lookup"><span data-stu-id="d13a9-252">About the Author</span></span>

<span data-ttu-id="d13a9-253">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), autor 7 ASP/ASP. NET Books a zakladatel of [4GuysFromRolla.com](http://www.4guysfromrolla.com), pracoval s webovými technologiemi Microsoftu od 1998.</span><span class="sxs-lookup"><span data-stu-id="d13a9-253">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="d13a9-254">Scott funguje jako nezávislý konzultant, Trainer a zapisovač.</span><span class="sxs-lookup"><span data-stu-id="d13a9-254">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="d13a9-255">Nejnovější kniha je [*Sams naučit se ASP.NET 2,0 za 24 hodin*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span><span class="sxs-lookup"><span data-stu-id="d13a9-255">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="d13a9-256">Dá se získat na [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="d13a9-256">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="d13a9-257">nebo prostřednictvím svého blogu, který najdete na adrese [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span><span class="sxs-lookup"><span data-stu-id="d13a9-257">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="d13a9-258">[Předchozí](inserting-updating-and-deleting-data-with-the-sqldatasource-cs.md)
> [Další](querying-data-with-the-sqldatasource-control-vb.md)</span><span class="sxs-lookup"><span data-stu-id="d13a9-258">[Previous](inserting-updating-and-deleting-data-with-the-sqldatasource-cs.md)
[Next](querying-data-with-the-sqldatasource-control-vb.md)</span></span>
