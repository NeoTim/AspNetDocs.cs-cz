---
uid: web-forms/overview/data-access/working-with-batched-data/wrapping-database-modifications-within-a-transaction-cs
title: Zabalení úprav databáze do transakce (C#) | Dokumentace Microsoftu
author: rick-anderson
description: Tento kurz je první ze čtyř, která srovnává aktualizace, odstraňování a vkládání dat dávek. V tomto kurzu jsme dozvíte, jak povolit databázové transakce...
ms.author: riande
ms.date: 06/26/2007
ms.assetid: b45fede3-c53a-4ea1-824b-20200808dbae
msc.legacyurl: /web-forms/overview/data-access/working-with-batched-data/wrapping-database-modifications-within-a-transaction-cs
msc.type: authoredcontent
ms.openlocfilehash: bbc54a39ba6ca3771acd7c4da37795a23e8ee2df
ms.sourcegitcommit: 0f1119340e4464720cfd16d0ff15764746ea1fea
ms.translationtype: MT
ms.contentlocale: cs-CZ
ms.lasthandoff: 04/17/2019
ms.locfileid: "59383379"
---
# <a name="wrapping-database-modifications-within-a-transaction-c"></a><span data-ttu-id="e8357-104">Zabalení úprav databáze do transakce (C#)</span><span class="sxs-lookup"><span data-stu-id="e8357-104">Wrapping Database Modifications within a Transaction (C#)</span></span>

<span data-ttu-id="e8357-105">podle [Scott Meisnerová](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="e8357-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="e8357-106">[Stáhněte si kód](http://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_63_CS.zip) nebo [stahovat PDF](wrapping-database-modifications-within-a-transaction-cs/_static/datatutorial63cs1.pdf)</span><span class="sxs-lookup"><span data-stu-id="e8357-106">[Download Code](http://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_63_CS.zip) or [Download PDF](wrapping-database-modifications-within-a-transaction-cs/_static/datatutorial63cs1.pdf)</span></span>

> <span data-ttu-id="e8357-107">Tento kurz je první ze čtyř, která srovnává aktualizace, odstraňování a vkládání dat dávek.</span><span class="sxs-lookup"><span data-stu-id="e8357-107">This tutorial is the first of four that looks at updating, deleting, and inserting batches of data.</span></span> <span data-ttu-id="e8357-108">V tomto kurzu jsme dozvíte, jak povolit batch změny prováděné jako atomickou operaci, což zajistí, že všechny kroky úspěšné nebo neúspěšné všechny kroky, databázové transakce.</span><span class="sxs-lookup"><span data-stu-id="e8357-108">In this tutorial we learn how database transactions allow batch modifications to be carried out as an atomic operation, which ensures that either all steps succeed or all steps fail.</span></span>


## <a name="introduction"></a><span data-ttu-id="e8357-109">Úvod</span><span class="sxs-lookup"><span data-stu-id="e8357-109">Introduction</span></span>

<span data-ttu-id="e8357-110">Jak jsme viděli, počínaje [přehled o vložení, aktualizace a odstranění dat](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-cs.md) kurzu prvku GridView obsahuje integrovanou podporu pro úpravy na úrovni řádků a odstranění.</span><span class="sxs-lookup"><span data-stu-id="e8357-110">As we saw starting with the [An Overview of Inserting, Updating, and Deleting Data](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-cs.md) tutorial, the GridView provides built-in support for row-level editing and deleting.</span></span> <span data-ttu-id="e8357-111">Pomocí několika kliknutí myši je možné vytvořit rozhraní úpravy velké množství dat bez nutnosti psát kód, tak dlouho, dokud se obsah s úpravy a odstranění na základě na řádek.</span><span class="sxs-lookup"><span data-stu-id="e8357-111">With a few clicks of the mouse it is possible to create a rich data modification interface without writing a line of code, so long as you are content with editing and deleting on a per-row basis.</span></span> <span data-ttu-id="e8357-112">Ale v některých případech to nestačí a My potřebujeme uživatelům poskytnout možnost upravit nebo odstranit dávky záznamů.</span><span class="sxs-lookup"><span data-stu-id="e8357-112">However, in certain scenarios this is insufficient and we need to provide users with the ability to edit or delete a batch of records.</span></span>

<span data-ttu-id="e8357-113">Například nejvíce webové e-mailoví klienti pomocí mřížky do seznamu každá zpráva kde každý řádek obsahuje zaškrtávací políčko společně s informacemi s e-mailu (předmět, odesílatele a tak dále).</span><span class="sxs-lookup"><span data-stu-id="e8357-113">For example, most web-based email clients use a grid to list each message where each row includes a checkbox along with the email s information (subject, sender, and so forth).</span></span> <span data-ttu-id="e8357-114">Toto rozhraní umožňuje uživateli odstranit více zpráv tak, že je a potom klikněte na tlačítko Odstranit vybrané zprávy.</span><span class="sxs-lookup"><span data-stu-id="e8357-114">This interface permits the user to delete multiple messages by checking them and then clicking a Delete Selected Messages button.</span></span> <span data-ttu-id="e8357-115">Úpravy rozhraní batch je ideální v situacích, kde uživatelé běžně upravovat mnoho různých záznamů.</span><span class="sxs-lookup"><span data-stu-id="e8357-115">A batch editing interface is ideal in situations where users commonly edit many different records.</span></span> <span data-ttu-id="e8357-116">Místo vynucení uživatel klepne na tlačítko Upravit, proveďte jejich změnu a klepněte na tlačítko Aktualizovat pro každý záznam, který musí být upravena, batch úpravy rozhraní vykreslí každý řádek s jeho úpravy rozhraní.</span><span class="sxs-lookup"><span data-stu-id="e8357-116">Rather than forcing the user to click Edit, make their change, and then click Update for each record that needs to be modified, a batch editing interface renders each row with its editing interface.</span></span> <span data-ttu-id="e8357-117">Uživatel můžete rychle změnit sadu řádků, které je potřeba změnit a tyto změny uložit kliknutím na tlačítko Aktualizovat vše.</span><span class="sxs-lookup"><span data-stu-id="e8357-117">The user can quickly modify the set of rows that need to be changed and then save these changes by clicking an Update All button.</span></span> <span data-ttu-id="e8357-118">V této sérii kurzů prozkoumáme vytvoření rozhraní pro vkládání, úpravy a odstranění dat dávek.</span><span class="sxs-lookup"><span data-stu-id="e8357-118">In this set of tutorials we'll examine how to create interfaces for inserting, editing, and deleting batches of data.</span></span>

<span data-ttu-id="e8357-119">Při provádění dávkových operací se nezdaří s důležité určit, zda by mělo být možné u některých operací ve službě batch k úspěšnému while ostatním uživatelům.</span><span class="sxs-lookup"><span data-stu-id="e8357-119">When performing batch operations it s important to determine whether it should be possible for some of the operations in the batch to succeed while others fail.</span></span> <span data-ttu-id="e8357-120">Vezměte v úvahu dávkové odstranění rozhraní – co se stane při splnění první vybraný záznam byl úspěšně odstraněn, ale druhá selže, například z důvodu narušení omezení pro cizí klíč?</span><span class="sxs-lookup"><span data-stu-id="e8357-120">Consider a batch deleting interface - what should happen if the first selected record is deleted successfully, but the second one fails, say, because of a foreign key constraint violation?</span></span> <span data-ttu-id="e8357-121">By měl být první odstranění záznamu s vrátila zpět nebo je přijatelné pro první záznam zůstat odstraněné?</span><span class="sxs-lookup"><span data-stu-id="e8357-121">Should the first record s delete be rolled back or is it acceptable for the first record to remain deleted?</span></span>

<span data-ttu-id="e8357-122">Pokud chcete, aby dávkové operace zacházeno jako [atomické operace](http://en.wikipedia.org/wiki/Atomic_operation), jeden kde buď všechny kroky proběhly úspěšně nebo všechny kroky nezdaří, pak vrstvy přístupu k datům musí být rozšíření zahrnují podporu pro [databáze transakce](http://en.wikipedia.org/wiki/Database_transaction).</span><span class="sxs-lookup"><span data-stu-id="e8357-122">If you want the batch operation to be treated as an [atomic operation](http://en.wikipedia.org/wiki/Atomic_operation), one where either all of the steps succeed or all of the steps fail, then the Data Access Layer needs to be augmented to include support for [database transactions](http://en.wikipedia.org/wiki/Database_transaction).</span></span> <span data-ttu-id="e8357-123">Databázové transakce zaručit atomicitu pro sadu `INSERT`, `UPDATE`, a `DELETE` příkazy spouští pod zastřešující transakce a jsou funkcí podporovaných většina všechny moderní databázovými systémy.</span><span class="sxs-lookup"><span data-stu-id="e8357-123">Database transactions guarantee atomicity for the set of `INSERT`, `UPDATE`, and `DELETE` statements executed under the umbrella of the transaction and are a feature supported by most all modern database systems.</span></span>

<span data-ttu-id="e8357-124">V tomto kurzu podíváme na tom, jak rozšířit DAL použít databázové transakce.</span><span class="sxs-lookup"><span data-stu-id="e8357-124">In this tutorial we'll look at how to extend the DAL to use database transactions.</span></span> <span data-ttu-id="e8357-125">Dalších kurzech se zaměřuje implementující webové stránky pro dávkové vložení, aktualizace nebo odstranění rozhraní.</span><span class="sxs-lookup"><span data-stu-id="e8357-125">Subsequent tutorials will examine implementing web pages for batch inserting, updating, and deleting interfaces.</span></span> <span data-ttu-id="e8357-126">Začínáme s let!</span><span class="sxs-lookup"><span data-stu-id="e8357-126">Let s get started!</span></span>

> [!NOTE]
> <span data-ttu-id="e8357-127">Při změně dat v rámci dávkové transakce, není vždy nutné atomicitu.</span><span class="sxs-lookup"><span data-stu-id="e8357-127">When modifying data in a batch transaction, atomicity is not always needed.</span></span> <span data-ttu-id="e8357-128">V některých případech může být přijatelný mít některé změny dat, které jsou úspěšné a dalším uživatelům ve stejné dávkové nezdaří, třeba při odstranění sady e-mailů z klienta webového e-mailu.</span><span class="sxs-lookup"><span data-stu-id="e8357-128">In some scenarios, it may be acceptable to have some data modifications succeed and others in the same batch fail, such as when deleting a set of emails from a web-based email client.</span></span> <span data-ttu-id="e8357-129">Pokud je zde s zpracování databáze chyba, polovině odstranění, ho s pravděpodobně přijatelný, zůstaly odstraněné záznamy zpracovat bez chyb.</span><span class="sxs-lookup"><span data-stu-id="e8357-129">If there s a database error midway through the deletion process, it s probably acceptable that those records processed without error remain deleted.</span></span> <span data-ttu-id="e8357-130">V takových případech není potřeba DAL upravit tak, aby podporu transakcí databáze.</span><span class="sxs-lookup"><span data-stu-id="e8357-130">In such cases, the DAL does not need to be modified to support database transactions.</span></span> <span data-ttu-id="e8357-131">Existují další dávkové operace scénáře, však kde atomicitu je důležité.</span><span class="sxs-lookup"><span data-stu-id="e8357-131">There are other batch operation scenarios, however, where atomicity is vital.</span></span> <span data-ttu-id="e8357-132">Pokud zákazník přesune její prostředků z jednoho účtu bank do jiného, musí provést dvě operace: prostředků musí být odečtena od první účet a pak přidá do druhé.</span><span class="sxs-lookup"><span data-stu-id="e8357-132">When a customer moves her funds from one bank account to another, two operations must be performed: the funds must be deducted from the first account and then added to the second.</span></span> <span data-ttu-id="e8357-133">Banka nemusí vadit s prvním krokem úspěšné, ale druhý krok nezdaří, může být svým zákazníkům understandably nespokojený.</span><span class="sxs-lookup"><span data-stu-id="e8357-133">While the bank may not mind having the first step succeed but the second step fail, its customers would understandably be upset.</span></span> <span data-ttu-id="e8357-134">Můžu vám doporučujeme projít tento kurz a implementaci rozšíření pro podporu transakcí databáze i v případě, že nemáte v plánu na jejich použití v dávkové vložení, aktualizace nebo odstranění rozhraní, které nám budete vytvářet v následujících kurzech tři vrstvy Dal.</span><span class="sxs-lookup"><span data-stu-id="e8357-134">I encourage you to work through this tutorial and implement the enhancements to the DAL to support database transactions even if you do not plan on using them in the batch inserting, updating, and deleting interfaces we'll be building in the following three tutorials.</span></span>


## <a name="an-overview-of-transactions"></a><span data-ttu-id="e8357-135">Přehled transakcí</span><span class="sxs-lookup"><span data-stu-id="e8357-135">An Overview of Transactions</span></span>

<span data-ttu-id="e8357-136">Většina databází zahrnují podporu pro *transakce*, které povolují více příkazů databáze seskupeny do jedné logické jednotky práce.</span><span class="sxs-lookup"><span data-stu-id="e8357-136">Most databases include support for *transactions*, which enable multiple database commands to be grouped into a single logical unit of work.</span></span> <span data-ttu-id="e8357-137">Příkazy databáze, které tvoří transakci je zaručena atomické, což znamená, že buď všechny příkazy se nezdaří, nebo všechny proběhne úspěšně.</span><span class="sxs-lookup"><span data-stu-id="e8357-137">The database commands that comprise a transaction are guaranteed to be atomic, meaning that either all commands will fail or all will succeed.</span></span>

<span data-ttu-id="e8357-138">Obecně platí transakce jsou implementované pomocí příkazy SQL s použitím následujícího vzorce:</span><span class="sxs-lookup"><span data-stu-id="e8357-138">In general, transactions are implemented through SQL statements using the following pattern:</span></span>

1. <span data-ttu-id="e8357-139">Označení začátku transakce.</span><span class="sxs-lookup"><span data-stu-id="e8357-139">Indicate the start of a transaction.</span></span>
2. <span data-ttu-id="e8357-140">Spouštění příkazů jazyka SQL, které tvoří příslušnou transakci.</span><span class="sxs-lookup"><span data-stu-id="e8357-140">Execute the SQL statements that comprise the transaction.</span></span>
3. <span data-ttu-id="e8357-141">Pokud dojde k chybě v některém z příkazů z kroku 2, vrácení transakce.</span><span class="sxs-lookup"><span data-stu-id="e8357-141">If there is an error in one of the statements from Step 2, rollback the transaction.</span></span>
4. <span data-ttu-id="e8357-142">Pokud všechny příkazy z kroku 2 dokončena bez chyb, potvrzení transakce.</span><span class="sxs-lookup"><span data-stu-id="e8357-142">If all of the statements from Step 2 complete without error, commit the transaction.</span></span>

<span data-ttu-id="e8357-143">Příkazy SQL použitý k vytvoření, potvrzení a vrácení transakce se dají zadat ručně při psaní skriptů SQL nebo vytváření uložených procedur nebo prostřednictvím programový znamená, že pomocí ADO.NET nebo tříd v [ `System.Transactions` obor názvů](https://msdn.microsoft.com/library/system.transactions.aspx).</span><span class="sxs-lookup"><span data-stu-id="e8357-143">The SQL statements used to create, commit, and roll back the transaction can be entered manually when writing SQL scripts or creating stored procedures, or through programmatic means using either ADO.NET or the classes in the [`System.Transactions` namespace](https://msdn.microsoft.com/library/system.transactions.aspx).</span></span> <span data-ttu-id="e8357-144">V tomto kurzu, který pouze prozkoumáme Správa transakce pomocí technologie ADO.NET.</span><span class="sxs-lookup"><span data-stu-id="e8357-144">In this tutorial we will only examine managing transactions using ADO.NET.</span></span> <span data-ttu-id="e8357-145">V budoucích kurzech se podíváme na tom, jak pomocí uložených procedur v vrstvy přístupu k datům, po kterém se podíváme příkazů SQL pro vytváření, vrácení zpět a potvrzování transakcí.</span><span class="sxs-lookup"><span data-stu-id="e8357-145">In a future tutorial we will look at how to use stored procedures in the Data Access Layer, at which time we'll explore the SQL statements for creating, rolling back, and committing transactions.</span></span> <span data-ttu-id="e8357-146">Do té doby najdete [Správa transakcí v SQL serveru uložené procedury](http://www.4guysfromrolla.com/webtech/080305-1.shtml) Další informace.</span><span class="sxs-lookup"><span data-stu-id="e8357-146">In the meantime, consult [Managing Transactions in SQL Server Stored Procedures](http://www.4guysfromrolla.com/webtech/080305-1.shtml) for more information.</span></span>

> [!NOTE]
> <span data-ttu-id="e8357-147">[ `TransactionScope` Třídy](https://msdn.microsoft.com/library/system.transactions.transactionscope.aspx) v `System.Transactions` obor názvů umožňuje vývojářům programově zabalení řadu příkazů v rámci oboru transakce a zahrnuje podporu pro složité transakce, které se týkají více zdroje, jako jsou dva různé databáze nebo dokonce heterogenních typů úložišť dat, jako je například databáze Microsoft SQL Server, Oracle database a webové služby.</span><span class="sxs-lookup"><span data-stu-id="e8357-147">The [`TransactionScope` class](https://msdn.microsoft.com/library/system.transactions.transactionscope.aspx) in the `System.Transactions` namespace enables developers to programmatically wrap a series of statements within the scope of a transaction and includes support for complex transactions that involve multiple sources, such as two different databases or even heterogeneous types of data stores, such as a Microsoft SQL Server database, an Oracle database, and a Web service.</span></span> <span data-ttu-id="e8357-148">Můžu uložit se rozhodli použít transakce ADO.NET pro účely tohoto kurzu místo `TransactionScope` třídy, protože je určené pro databázové transakce a v mnoha případech ADO.NET je mnohem méně náročná.</span><span class="sxs-lookup"><span data-stu-id="e8357-148">I ve decided to use ADO.NET transactions for this tutorial instead of the `TransactionScope` class because ADO.NET is more specific for database transactions and, in many cases, is far less resource intensive.</span></span> <span data-ttu-id="e8357-149">Kromě toho v určitých případech `TransactionScope` třída používá Microsoft distribuované transakce koordinátor (MSDTC).</span><span class="sxs-lookup"><span data-stu-id="e8357-149">In addition, under certain scenarios the `TransactionScope` class uses the Microsoft Distributed Transaction Coordinator (MSDTC).</span></span> <span data-ttu-id="e8357-150">Problémy s konfigurací, implementaci a výkonu okolního MSDTC umožňuje místo specializované a pokročilé tématu a nad rámec těchto kurzů.</span><span class="sxs-lookup"><span data-stu-id="e8357-150">The configuration, implementation, and performance issues surrounding MSDTC makes it a rather specialized and advanced topic and beyond the scope of these tutorials.</span></span>


<span data-ttu-id="e8357-151">Při práci se zprostředkovatelem SqlClient v ADO.NET, transakce inicializována prostřednictvím volání [ `SqlConnection` třídy](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) s [ `BeginTransaction` metoda](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.begintransaction.aspx), který vrátí hodnotu [ `SqlTransaction` objekt](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.aspx).</span><span class="sxs-lookup"><span data-stu-id="e8357-151">When working with the SqlClient provider in ADO.NET, transactions are initiated through a call to the [`SqlConnection` class](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) s [`BeginTransaction` method](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.begintransaction.aspx), which returns a [`SqlTransaction` object](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.aspx).</span></span> <span data-ttu-id="e8357-152">Příkazy změny dat, které strukturu transakce jsou umístěny v rámci `try...catch` bloku.</span><span class="sxs-lookup"><span data-stu-id="e8357-152">The data modification statements that makeup the transaction are placed within a `try...catch` block.</span></span> <span data-ttu-id="e8357-153">Pokud dojde k chybě v příkazu v `try` blokovat spuštění přenosy do `catch` bloku, ve kterém můžete transakce vrácena zpět prostřednictvím `SqlTransaction` objektu s [ `Rollback` metoda](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.rollback.aspx).</span><span class="sxs-lookup"><span data-stu-id="e8357-153">If an error occurs in a statement in the `try` block, execution transfers to the `catch` block where the transaction can be rolled back via the `SqlTransaction` object s [`Rollback` method](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.rollback.aspx).</span></span> <span data-ttu-id="e8357-154">Pokud všechny příkazy úspěšně dokončil, volání `SqlTransaction` objektu s [ `Commit` metoda](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.commit.aspx) na konci `try` bloku potvrzení transakce.</span><span class="sxs-lookup"><span data-stu-id="e8357-154">If all of the statements complete successfully, a call to the `SqlTransaction` object s [`Commit` method](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.commit.aspx) at the end of the `try` block commits the transaction.</span></span> <span data-ttu-id="e8357-155">Následující fragment kódu ukazuje tento model.</span><span class="sxs-lookup"><span data-stu-id="e8357-155">The following code snippet illustrates this pattern.</span></span> <span data-ttu-id="e8357-156">Zobrazit [zachování konzistence databáze s transakcemi](http://aspnet.4guysfromrolla.com/articles/072705-1.aspx) další syntaxe a příklady použití transakcí pomocí ADO.NET.</span><span class="sxs-lookup"><span data-stu-id="e8357-156">See [Maintaining Database Consistency with Transactions](http://aspnet.4guysfromrolla.com/articles/072705-1.aspx) for additional syntax and examples of using transactions with ADO.NET.</span></span>


[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample1.cs)]

<span data-ttu-id="e8357-157">Ve výchozím nastavení nepoužívejte objekty TableAdapter v datové sadě zadán transakce.</span><span class="sxs-lookup"><span data-stu-id="e8357-157">By default, the TableAdapters in a Typed DataSet do not use transactions.</span></span> <span data-ttu-id="e8357-158">Poskytuje podporu pro transakce potřebujeme k posílení třídy TableAdapter, které chcete zahrnout další metody, které používají vyšší vzor provádět řadu příkazů úpravy dat v rámci oboru transakce.</span><span class="sxs-lookup"><span data-stu-id="e8357-158">To provide support for transactions we need to augment the TableAdapter classes to include additional methods that use the above pattern to perform a series of data modification statements within the scope of a transaction.</span></span> <span data-ttu-id="e8357-159">V kroku 2 uvidíme, jak používat částečné třídy pro přidání těchto metod.</span><span class="sxs-lookup"><span data-stu-id="e8357-159">In Step 2 we'll see how to use partial classes to add these methods.</span></span>

## <a name="step-1-creating-the-working-with-batched-data-web-pages"></a><span data-ttu-id="e8357-160">Krok 1: Vytvoření práce s daty uspořádanými do dávek webové stránky</span><span class="sxs-lookup"><span data-stu-id="e8357-160">Step 1: Creating the Working with Batched Data Web Pages</span></span>

<span data-ttu-id="e8357-161">Než začneme zkoumat, jak rozšířit vrstvy DAL k podpoře databázové transakce, umožní s nejdřív využít k vytvoření webových stránek ASP.NET, které potřebujeme pro účely tohoto kurzu a tři, které následují.</span><span class="sxs-lookup"><span data-stu-id="e8357-161">Before we start exploring how to augment the DAL to support database transactions, let s first take a moment to create the ASP.NET web pages that we will need for this tutorial and the three that follow.</span></span> <span data-ttu-id="e8357-162">Začněte přidáním novou složku s názvem `BatchData` a pak přidejte následující stránky technologie ASP.NET, přidruží s každou stránku `Site.master` stránky předlohy.</span><span class="sxs-lookup"><span data-stu-id="e8357-162">Start by adding a new folder named `BatchData` and then add the following ASP.NET pages, associating each page with the `Site.master` master page.</span></span>

- `Default.aspx`
- `Transactions.aspx`
- `BatchUpdate.aspx`
- `BatchDelete.aspx`
- `BatchInsert.aspx`


![Přidání stránky technologie ASP.NET pro SqlDataSource související kurzy](wrapping-database-modifications-within-a-transaction-cs/_static/image1.gif)

<span data-ttu-id="e8357-164">**Obrázek 1**: Přidání stránky technologie ASP.NET pro SqlDataSource související kurzy</span><span class="sxs-lookup"><span data-stu-id="e8357-164">**Figure 1**: Add the ASP.NET Pages for the SqlDataSource-Related Tutorials</span></span>


<span data-ttu-id="e8357-165">Stejně jako u jiných složkách `Default.aspx` použije `SectionLevelTutorialListing.ascx` uživatelského ovládacího prvku seznam kurzů v rámci jeho části.</span><span class="sxs-lookup"><span data-stu-id="e8357-165">As with the other folders, `Default.aspx` will use the `SectionLevelTutorialListing.ascx` User Control to list the tutorials within its section.</span></span> <span data-ttu-id="e8357-166">Proto přidat tento uživatelský ovládací prvek `Default.aspx` přetažením v Průzkumníku řešení na stránku s návrhové zobrazení.</span><span class="sxs-lookup"><span data-stu-id="e8357-166">Therefore, add this User Control to `Default.aspx` by dragging it from the Solution Explorer onto the page s Design view.</span></span>


<span data-ttu-id="e8357-167">[![Přidat na stránku Default.aspx SectionLevelTutorialListing.ascx uživatelského ovládacího prvku](wrapping-database-modifications-within-a-transaction-cs/_static/image2.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="e8357-167">[![Add the SectionLevelTutorialListing.ascx User Control to Default.aspx](wrapping-database-modifications-within-a-transaction-cs/_static/image2.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image1.png)</span></span>

<span data-ttu-id="e8357-168">**Obrázek 2**: Přidat `SectionLevelTutorialListing.ascx` uživatelský ovládací prvek `Default.aspx` ([kliknutím ji zobrazíte obrázek v plné velikosti](wrapping-database-modifications-within-a-transaction-cs/_static/image2.png))</span><span class="sxs-lookup"><span data-stu-id="e8357-168">**Figure 2**: Add the `SectionLevelTutorialListing.ascx` User Control to `Default.aspx` ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image2.png))</span></span>


<span data-ttu-id="e8357-169">A konečně, přidejte tyto čtyři stránky jako položky `Web.sitemap` souboru.</span><span class="sxs-lookup"><span data-stu-id="e8357-169">Lastly, add these four pages as entries to the `Web.sitemap` file.</span></span> <span data-ttu-id="e8357-170">Konkrétně, přidejte následující kód za vlastní nastavení mapy webu `<siteMapNode>`:</span><span class="sxs-lookup"><span data-stu-id="e8357-170">Specifically, add the following markup after the Customizing the Site Map `<siteMapNode>`:</span></span>


[!code-xml[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample2.xml)]

<span data-ttu-id="e8357-171">Po aktualizaci `Web.sitemap`, věnujte chvíli zobrazit kurzy web prostřednictvím prohlížeče.</span><span class="sxs-lookup"><span data-stu-id="e8357-171">After updating `Web.sitemap`, take a moment to view the tutorials website through a browser.</span></span> <span data-ttu-id="e8357-172">V nabídce na levé straně teď obsahuje položky pro práci s daty uspořádanými do dávek kurzy.</span><span class="sxs-lookup"><span data-stu-id="e8357-172">The menu on the left now includes items for the working with batched data tutorials.</span></span>


![Mapa webu nyní obsahuje záznamy pro práci s daty uspořádanými do dávek kurzy](wrapping-database-modifications-within-a-transaction-cs/_static/image3.gif)

<span data-ttu-id="e8357-174">**Obrázek 3**: Mapa webu nyní obsahuje záznamy pro práci s daty uspořádanými do dávek kurzy</span><span class="sxs-lookup"><span data-stu-id="e8357-174">**Figure 3**: The Site Map Now Includes Entries for the Working with Batched Data Tutorials</span></span>


## <a name="step-2-updating-the-data-access-layer-to-support-database-transactions"></a><span data-ttu-id="e8357-175">Krok 2: Aktualizuje se vrstva přístupu k datům pro podporu databázové transakce</span><span class="sxs-lookup"><span data-stu-id="e8357-175">Step 2: Updating the Data Access Layer to Support Database Transactions</span></span>

<span data-ttu-id="e8357-176">Jak jsme probírali v prvním kurzu [vytvoření vrstvy přístupu k datům](../introduction/creating-a-data-access-layer-cs.md), typová v našich DAL se skládá z datové tabulky a objekty TableAdapter.</span><span class="sxs-lookup"><span data-stu-id="e8357-176">As we discussed back in the first tutorial, [Creating a Data Access Layer](../introduction/creating-a-data-access-layer-cs.md), the Typed DataSet in our DAL is composed of DataTables and TableAdapters.</span></span> <span data-ttu-id="e8357-177">Datové tabulky obsahují data, zatímco objekty TableAdapter poskytují funkce pro čtení dat z databáze do datové tabulky k aktualizaci databáze se změnami provedenými datové tabulky a tak dále.</span><span class="sxs-lookup"><span data-stu-id="e8357-177">The DataTables hold data while the TableAdapters provide the functionality to read data from the database into the DataTables, to update the database with changes made to the DataTables, and so forth.</span></span> <span data-ttu-id="e8357-178">Připomínáme, že objekty TableAdapter poskytnout dva modely pro aktualizaci dat, který uvedené jako aktualizace služby Batch a DB přímo.</span><span class="sxs-lookup"><span data-stu-id="e8357-178">Recall that the TableAdapters provide two patterns for updating data, which I referred to as Batch Update and DB-Direct.</span></span> <span data-ttu-id="e8357-179">Se vzorkem aktualizace služby Batch je předán TableAdapter datové sady, datové tabulky nebo kolekce DataRows.</span><span class="sxs-lookup"><span data-stu-id="e8357-179">With the Batch Update pattern, the TableAdapter is passed a DataSet, DataTable, or collection of DataRows.</span></span> <span data-ttu-id="e8357-180">Tato data je vypočten a pro každou vložit, změnit nebo odstranit řádek, `InsertCommand`, `UpdateCommand`, nebo `DeleteCommand` provádí.</span><span class="sxs-lookup"><span data-stu-id="e8357-180">This data is enumerated and for each inserted, modified, or deleted row, the `InsertCommand`, `UpdateCommand`, or `DeleteCommand` is executed.</span></span> <span data-ttu-id="e8357-181">Se vzorkem DB přímo TableAdapter místo toho předána hodnoty sloupce, které jsou nezbytné pro vkládání, aktualizaci nebo odstranění jednoho záznamu.</span><span class="sxs-lookup"><span data-stu-id="e8357-181">With the DB-Direct pattern, the TableAdapter is instead passed the values of the columns necessary for inserting, updating, or deleting a single record.</span></span> <span data-ttu-id="e8357-182">Tyto hodnoty předané DB přímé metody vzor pak používá ke spouštění odpovídající `InsertCommand`, `UpdateCommand`, nebo `DeleteCommand` příkazu.</span><span class="sxs-lookup"><span data-stu-id="e8357-182">The DB Direct pattern method then uses those passed-in values to execute the appropriate `InsertCommand`, `UpdateCommand`, or `DeleteCommand` statement.</span></span>

<span data-ttu-id="e8357-183">Objekty TableAdapter automaticky generované metody bez ohledu na aktualizace vzor používá, nepoužívejte transakce.</span><span class="sxs-lookup"><span data-stu-id="e8357-183">Regardless of the update pattern used, the TableAdapters auto-generated methods do not use transactions.</span></span> <span data-ttu-id="e8357-184">Ve výchozím nastavení každý insert, update nebo delete provedené objektu TableAdapter je považován za jedné diskrétní operace.</span><span class="sxs-lookup"><span data-stu-id="e8357-184">By default each insert, update, or delete performed by the TableAdapter is treated as a single discrete operation.</span></span> <span data-ttu-id="e8357-185">Představte si například, že vzor DB přímým používá nějaký kód ve službě BLL k vložení deset záznamů do databáze.</span><span class="sxs-lookup"><span data-stu-id="e8357-185">For instance, imagine that the DB-Direct pattern is used by some code in the BLL to insert ten records into the database.</span></span> <span data-ttu-id="e8357-186">Tento kód by volat TableAdapter s `Insert` metoda desetkrát.</span><span class="sxs-lookup"><span data-stu-id="e8357-186">This code would call the TableAdapter s `Insert` method ten times.</span></span> <span data-ttu-id="e8357-187">Prvních pět vloží úspěšné, ale ten šestého způsobila výjimku, by prvních pět záznamů vložené zůstanou v databázi.</span><span class="sxs-lookup"><span data-stu-id="e8357-187">If the first five inserts succeed, but the sixth one resulted in an exception, the first five inserted records would remain in the database.</span></span> <span data-ttu-id="e8357-188">Podobně, pokud vzor aktualizace služby Batch se používá k provedení operace vložení, aktualizace a odstranění do vloženého, upravit a odstranit řádky v objektu DataTable, pokud první několik změn bylo úspěšné, ale novější verzi došlo k chybě, ty dřívější změny, které dokončení by zůstat v databázi.</span><span class="sxs-lookup"><span data-stu-id="e8357-188">Similarly, if the Batch Update pattern is used to perform inserts, updates, and deletes to the inserted, modified, and deleted rows in a DataTable, if the first several modifications succeeded but a later one encountered an error, those earlier modifications that completed would remain in the database.</span></span>

<span data-ttu-id="e8357-189">V některých scénářích chceme zajistit nedělitelnost napříč řadou změny.</span><span class="sxs-lookup"><span data-stu-id="e8357-189">In certain scenarios we want to ensure atomicity across a series of modifications.</span></span> <span data-ttu-id="e8357-190">K tomu TableAdapter jsme musí ručně rozšířit přidáním nových metod, které jsou spouštěny `InsertCommand`, `UpdateCommand`, a `DeleteCommand` s pod zastřešující transakce.</span><span class="sxs-lookup"><span data-stu-id="e8357-190">To accomplish this we must manually extend the TableAdapter by adding new methods that execute the `InsertCommand`, `UpdateCommand`, and `DeleteCommand` s under the umbrella of a transaction.</span></span> <span data-ttu-id="e8357-191">V [vytvoření vrstvy přístupu k datům](../introduction/creating-a-data-access-layer-cs.md) zvažovali jsme i pomocí [částečné třídy](http://en.wikipedia.org/wiki/Partial_type) rozšíření funkcí datové tabulky v datové sadě zadán.</span><span class="sxs-lookup"><span data-stu-id="e8357-191">In [Creating a Data Access Layer](../introduction/creating-a-data-access-layer-cs.md) we looked at using [partial classes](http://en.wikipedia.org/wiki/Partial_type) to extend the functionality of the DataTables within the Typed DataSet.</span></span> <span data-ttu-id="e8357-192">Tento postup můžete použít také pomocí instancí TableAdapter.</span><span class="sxs-lookup"><span data-stu-id="e8357-192">This technique can also be used with TableAdapters.</span></span>

<span data-ttu-id="e8357-193">Datová sada typu `Northwind.xsd` se nachází v `App_Code` složku s `DAL` podsložky.</span><span class="sxs-lookup"><span data-stu-id="e8357-193">The Typed DataSet `Northwind.xsd` is located in the `App_Code` folder s `DAL` subfolder.</span></span> <span data-ttu-id="e8357-194">Vytvořte podsložku v `DAL` složku s názvem `TransactionSupport` a přidejte nový soubor třídy s názvem `ProductsTableAdapter.TransactionSupport.cs` (viz obrázek 4).</span><span class="sxs-lookup"><span data-stu-id="e8357-194">Create a subfolder in the `DAL` folder named `TransactionSupport` and add a new class file named `ProductsTableAdapter.TransactionSupport.cs` (see Figure 4).</span></span> <span data-ttu-id="e8357-195">Tento soubor bude obsahovat částečnou implementaci `ProductsTableAdapter` , který obsahuje metody pro provádění změny dat pomocí transakce.</span><span class="sxs-lookup"><span data-stu-id="e8357-195">This file will hold the partial implementation of the `ProductsTableAdapter` that includes methods for performing data modifications using a transaction.</span></span>


![Přidat složku s názvem TransactionSupport a soubor třídy s názvem ProductsTableAdapter.TransactionSupport.cs](wrapping-database-modifications-within-a-transaction-cs/_static/image4.gif)

<span data-ttu-id="e8357-197">**Obrázek 4**: Přidat složku s názvem `TransactionSupport` a soubor třídy s názvem `ProductsTableAdapter.TransactionSupport.cs`</span><span class="sxs-lookup"><span data-stu-id="e8357-197">**Figure 4**: Add a Folder Named `TransactionSupport` and a Class File Named `ProductsTableAdapter.TransactionSupport.cs`</span></span>


<span data-ttu-id="e8357-198">Zadejte následující kód do `ProductsTableAdapter.TransactionSupport.cs` souboru:</span><span class="sxs-lookup"><span data-stu-id="e8357-198">Enter the following code into the `ProductsTableAdapter.TransactionSupport.cs` file:</span></span>


[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample3.cs)]

<span data-ttu-id="e8357-199">`partial` Označuje klíčové slovo v deklaraci třídy, které jsou členy přidanými v rámci přidávaného do kompilátoru `ProductsTableAdapter` třídy v `NorthwindTableAdapters` oboru názvů.</span><span class="sxs-lookup"><span data-stu-id="e8357-199">The `partial` keyword in the class declaration here indicates to the compiler that the members added within are to be added to the `ProductsTableAdapter` class in the `NorthwindTableAdapters` namespace.</span></span> <span data-ttu-id="e8357-200">Poznámka: `using System.Data.SqlClient` příkazu v horní části souboru.</span><span class="sxs-lookup"><span data-stu-id="e8357-200">Note the `using System.Data.SqlClient` statement at the top of the file.</span></span> <span data-ttu-id="e8357-201">Protože TableAdapter byl konfigurován pro použití zprostředkovatelem SqlClient, interně používá [ `SqlDataAdapter` ](https://msdn.microsoft.com/library/system.data.sqlclient.sqldataadapter.aspx) objekt vydat jeho příkazy do databáze.</span><span class="sxs-lookup"><span data-stu-id="e8357-201">Since the TableAdapter was configured to use the SqlClient provider, internally it uses a [`SqlDataAdapter`](https://msdn.microsoft.com/library/system.data.sqlclient.sqldataadapter.aspx) object to issue its commands to the database.</span></span> <span data-ttu-id="e8357-202">V důsledku toho je třeba použít `SqlTransaction` třída spustit transakci a potom ho potvrzení nebo vrácení zpět.</span><span class="sxs-lookup"><span data-stu-id="e8357-202">Consequently, we need to use the `SqlTransaction` class to begin the transaction and then to commit it or roll it back.</span></span> <span data-ttu-id="e8357-203">Pokud používáte úložiště dat než Microsoft SQL Server, budete muset použít odpovídající zprostředkovatele.</span><span class="sxs-lookup"><span data-stu-id="e8357-203">If you are using a data store other than Microsoft SQL Server, you'll need to use the appropriate provider.</span></span>

<span data-ttu-id="e8357-204">Tyto metody poskytují stavební bloky potřebné ke spuštění, vrácení zpět a potvrdit transakci.</span><span class="sxs-lookup"><span data-stu-id="e8357-204">These methods provide the building blocks needed to start, rollback, and commit a transaction.</span></span> <span data-ttu-id="e8357-205">Nejsou označeny jako `public`, což jim umožňuje použít v rámci `ProductsTableAdapter`z jiné třídy v vrstvy DAL a z jiné vrstvy v architektuře, jako je například BLL.</span><span class="sxs-lookup"><span data-stu-id="e8357-205">They are marked `public`, enabling them to be used from within the `ProductsTableAdapter`, from another class in the DAL, or from another layer in the architecture, such as the BLL.</span></span> <span data-ttu-id="e8357-206">`BeginTransaction` Otevře interní TableAdapter s `SqlConnection` (v případě potřeby), začíná transakce a přiřadí ji k `Transaction` vlastnost a připojí k interní transakce `SqlDataAdapter` s `SqlCommand` objekty.</span><span class="sxs-lookup"><span data-stu-id="e8357-206">`BeginTransaction` opens the TableAdapter s internal `SqlConnection` (if needed), begins the transaction and assigns it to the `Transaction` property, and attaches the transaction to the internal `SqlDataAdapter` s `SqlCommand` objects.</span></span> <span data-ttu-id="e8357-207">`CommitTransaction` a `RollbackTransaction` volání `Transaction` objektu s `Commit` a `Rollback` metody, resp. před jeho zavřením interní `Connection` objektu.</span><span class="sxs-lookup"><span data-stu-id="e8357-207">`CommitTransaction` and `RollbackTransaction` call the `Transaction` object s `Commit` and `Rollback` methods, respectively, before closing the internal `Connection` object.</span></span>

## <a name="step-3-adding-methods-to-update-and-delete-data-under-the-umbrella-of-a-transaction"></a><span data-ttu-id="e8357-208">Krok 3: Přidání metody k aktualizaci a odstraňování dat v rámci zastřešující transakce</span><span class="sxs-lookup"><span data-stu-id="e8357-208">Step 3: Adding Methods to Update and Delete Data Under the Umbrella of a Transaction</span></span>

<span data-ttu-id="e8357-209">S těmito metodami kompletní jsme re jste připravení začít přidejte metody do `ProductsDataTable` nebo BLL, který vykonávat řadu příkazů v rámci zastřešující transakce.</span><span class="sxs-lookup"><span data-stu-id="e8357-209">With these methods complete, we re ready to add methods to `ProductsDataTable` or the BLL that perform a series of commands under the umbrella of a transaction.</span></span> <span data-ttu-id="e8357-210">Následující metoda používá vzor aktualizace služby Batch k aktualizaci `ProductsDataTable` instance pomocí transakce.</span><span class="sxs-lookup"><span data-stu-id="e8357-210">The following method uses the Batch Update pattern to update a `ProductsDataTable` instance using a transaction.</span></span> <span data-ttu-id="e8357-211">Spustí transakci voláním `BeginTransaction` metody a poté ji používá `try...catch` bloku k vydávání příkazů změny data.</span><span class="sxs-lookup"><span data-stu-id="e8357-211">It starts a transaction by calling the `BeginTransaction` method and then uses a `try...catch` block to issue the data modification statements.</span></span> <span data-ttu-id="e8357-212">Pokud volání `Adapter` objektu s `Update` metodu výsledkem výjimky, provádění přenese na `catch` bloku, ve kterém transakce bude vrácena zpět a znovu vyvolána výjimka.</span><span class="sxs-lookup"><span data-stu-id="e8357-212">If the call to the `Adapter` object s `Update` method results in an exception, execution will transfer to the `catch` block where the transaction will be rolled back and the exception re-thrown.</span></span> <span data-ttu-id="e8357-213">Vzpomeňte si, že `Update` metoda implementuje vzor dávkové aktualizace vytyčením řádky zadané `ProductsDataTable` a provádění potřebných `InsertCommand`, `UpdateCommand`, a `DeleteCommand` s.</span><span class="sxs-lookup"><span data-stu-id="e8357-213">Recall that the `Update` method implements the Batch Update pattern by enumerating the rows of the supplied `ProductsDataTable` and performing the necessary `InsertCommand`, `UpdateCommand`, and `DeleteCommand` s.</span></span> <span data-ttu-id="e8357-214">Pokud některá z těchto příkazů dojde k chybě, transakce se zrušila, vrácení zpět na předchozí změny po celou dobu životnosti s transakcí.</span><span class="sxs-lookup"><span data-stu-id="e8357-214">If any one of these commands results in an error, the transaction is rolled back, undoing the previous modifications made during the transaction s lifetime.</span></span> <span data-ttu-id="e8357-215">By měl `Update` příkaz dokončit bez chyby, transakce se potvrdí v celém rozsahu.</span><span class="sxs-lookup"><span data-stu-id="e8357-215">Should the `Update` statement complete without error, the transaction is committed in its entirety.</span></span>


[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample4.cs)]

<span data-ttu-id="e8357-216">Přidat `UpdateWithTransaction` metodu `ProductsTableAdapter` třídu v rámci částečné třídy v `ProductsTableAdapter.TransactionSupport.cs`.</span><span class="sxs-lookup"><span data-stu-id="e8357-216">Add the `UpdateWithTransaction` method to the `ProductsTableAdapter` class through the partial class in `ProductsTableAdapter.TransactionSupport.cs`.</span></span> <span data-ttu-id="e8357-217">Případně, tato metoda může být přidán do vrstvy obchodní logiky s `ProductsBLL` třída s atributem několik menších syntaktických změn.</span><span class="sxs-lookup"><span data-stu-id="e8357-217">Alternatively, this method could be added to the Business Logic Layer s `ProductsBLL` class with a few minor syntactical changes.</span></span> <span data-ttu-id="e8357-218">Konkrétně, klíčové slovo to `this.BeginTransaction()`, `this.CommitTransaction()`, a `this.RollbackTransaction()` by bylo potřeba nahradit `Adapter` (Vzpomeňte si, že `Adapter` je název vlastnosti v `ProductsBLL` typu `ProductsTableAdapter`).</span><span class="sxs-lookup"><span data-stu-id="e8357-218">Namely, the keyword this in `this.BeginTransaction()`, `this.CommitTransaction()`, and `this.RollbackTransaction()` would need to be replaced with `Adapter` (recall that `Adapter` is the name of a property in `ProductsBLL` of type `ProductsTableAdapter`).</span></span>

<span data-ttu-id="e8357-219">`UpdateWithTransaction` Metoda používá vzor aktualizace služby Batch, ale řadu DB přímé volání lze také v rámci oboru transakcí, jak ukazuje následující metody.</span><span class="sxs-lookup"><span data-stu-id="e8357-219">The `UpdateWithTransaction` method uses the Batch Update pattern, but a series of DB-Direct calls can also be used within the scope of a transaction, as the following method shows.</span></span> <span data-ttu-id="e8357-220">`DeleteProductsWithTransaction` Metoda přijímá jako vstup `List<T>` typu `int`, které jsou `ProductID` s odstranit.</span><span class="sxs-lookup"><span data-stu-id="e8357-220">The `DeleteProductsWithTransaction` method accepts as input a `List<T>` of type `int`, which are the `ProductID` s to delete.</span></span> <span data-ttu-id="e8357-221">Metoda inicializuje transakci prostřednictvím volání `BeginTransaction` a pak na `try` blokovat, iteruje zadaný seznam volání vzor DB přímým `Delete` metoda pro každou `ProductID` hodnotu.</span><span class="sxs-lookup"><span data-stu-id="e8357-221">The method initiates the transaction via a call to `BeginTransaction` and then, in the `try` block, iterates through the supplied list calling the DB-Direct pattern `Delete` method for each `ProductID` value.</span></span> <span data-ttu-id="e8357-222">Pokud je libovolná z volání `Delete` selže, je kontrola předána `catch` bloku, ve kterém transakce je vrácena zpět a znovu vyvolána výjimka.</span><span class="sxs-lookup"><span data-stu-id="e8357-222">If any of the calls to `Delete` fails, control is transferred to the `catch` block where the transaction is rolled back and the exception re-thrown.</span></span> <span data-ttu-id="e8357-223">Pokud veškerá volání `Delete` úspěšné, pak je transakce potvrzena.</span><span class="sxs-lookup"><span data-stu-id="e8357-223">If all calls to `Delete` succeed, then transaction is committed.</span></span> <span data-ttu-id="e8357-224">Přidejte tuto metodu za účelem `ProductsBLL` třídy.</span><span class="sxs-lookup"><span data-stu-id="e8357-224">Add this method to the `ProductsBLL` class.</span></span>


[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample5.cs)]

## <a name="applying-transactions-across-multiple-tableadapters"></a><span data-ttu-id="e8357-225">Použití transakce napříč více objektů TableAdapter</span><span class="sxs-lookup"><span data-stu-id="e8357-225">Applying Transactions Across Multiple TableAdapters</span></span>

<span data-ttu-id="e8357-226">Transakce související kód, prozkoumat v tomto kurzu umožňuje více příkazů proti `ProductsTableAdapter` zacházeno jako atomickou operaci.</span><span class="sxs-lookup"><span data-stu-id="e8357-226">The transaction-related code examined in this tutorial allows for multiple statements against the `ProductsTableAdapter` to be treated as an atomic operation.</span></span> <span data-ttu-id="e8357-227">Ale co když víc úpravy do jiných databázových tabulek musí provádět atomicky?</span><span class="sxs-lookup"><span data-stu-id="e8357-227">But what if multiple modifications to different database tables need to be performed atomically?</span></span> <span data-ttu-id="e8357-228">Například při odstraňování kategorie, může být nejprve chceme změnit přiřazení jeho aktuální produkty do některé kategorie.</span><span class="sxs-lookup"><span data-stu-id="e8357-228">For instance, when deleting a category, we might first want to reassign its current products to some other category.</span></span> <span data-ttu-id="e8357-229">Tyto dva kroky přiřazení produkty a odstraňuje se kategorie by měl být provedeny jako atomickou operaci.</span><span class="sxs-lookup"><span data-stu-id="e8357-229">These two steps reassigning the products and deleting the category should be executed as an atomic operation.</span></span> <span data-ttu-id="e8357-230">Ale `ProductsTableAdapter` zahrnuje pouze metody pro úpravu `Products` tabulky a `CategoriesTableAdapter` zahrnuje pouze metody pro úpravu `Categories` tabulky.</span><span class="sxs-lookup"><span data-stu-id="e8357-230">But the `ProductsTableAdapter` includes only methods for modifying the `Products` table and the `CategoriesTableAdapter` includes only methods for modifying the `Categories` table.</span></span> <span data-ttu-id="e8357-231">Jak může zahrnovat transakce oba objekty TableAdapter?</span><span class="sxs-lookup"><span data-stu-id="e8357-231">So how can a transaction encompass both TableAdapters?</span></span>

<span data-ttu-id="e8357-232">Jednou z možností je přidání metody do `CategoriesTableAdapter` s názvem `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` a mají metody volání uložené procedury, která znovu přiřadí produktů i odstraní kategorii v rámci oboru transakce definované v rámci uložené procedury.</span><span class="sxs-lookup"><span data-stu-id="e8357-232">One option is to add a method to the `CategoriesTableAdapter` named `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` and have that method call a stored procedure that both reassigns the products and deletes the category within the scope of a transaction defined within the stored procedure.</span></span> <span data-ttu-id="e8357-233">Podíváme se na tom, jak začít, potvrzení a vrácení zpět transakcí v uložených procedurách v budoucích kurzech.</span><span class="sxs-lookup"><span data-stu-id="e8357-233">We'll look at how to begin, commit, and rollback transactions in stored procedures in a future tutorial.</span></span>

<span data-ttu-id="e8357-234">Další možností je vytvořit v DAL, který obsahuje pomocnou třídu `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` metody.</span><span class="sxs-lookup"><span data-stu-id="e8357-234">Another option is to create a helper class in the DAL that contains the `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` method.</span></span> <span data-ttu-id="e8357-235">Tato metoda by vytvořit instanci `CategoriesTableAdapter` a `ProductsTableAdapter` a nastavte tyto dva objekty TableAdapter `Connection` vlastnosti na stejný `SqlConnection` instance.</span><span class="sxs-lookup"><span data-stu-id="e8357-235">This method would create an instance of the `CategoriesTableAdapter` and the `ProductsTableAdapter` and then set these two TableAdapters `Connection` properties to the same `SqlConnection` instance.</span></span> <span data-ttu-id="e8357-236">AT tento bod jednu ze dvou objektů TableAdapter by zahájení transakce voláním `BeginTransaction`.</span><span class="sxs-lookup"><span data-stu-id="e8357-236">At that point, either one of the two TableAdapters would initiate the transaction with a call to `BeginTransaction`.</span></span> <span data-ttu-id="e8357-237">Objekty TableAdapter metody pro přiřazení produkty a odstraňuje se kategorie by vyvolat v `try...catch` blok s transakce potvrzena nebo vrácena zpět, podle potřeby.</span><span class="sxs-lookup"><span data-stu-id="e8357-237">The TableAdapters methods for reassigning the products and deleting the category would be invoked in a `try...catch` block with the transaction committed or rolled back as needed.</span></span>

## <a name="step-4-adding-theupdatewithtransactionmethod-to-the-business-logic-layer"></a><span data-ttu-id="e8357-238">Krok 4: Přidávání`UpdateWithTransaction`metodu pro vrstvy obchodní logiky</span><span class="sxs-lookup"><span data-stu-id="e8357-238">Step 4: Adding the`UpdateWithTransaction`Method to the Business Logic Layer</span></span>

<span data-ttu-id="e8357-239">V kroku 3 jsme přidali `UpdateWithTransaction` metodu `ProductsTableAdapter` v vrstvy DAL.</span><span class="sxs-lookup"><span data-stu-id="e8357-239">In Step 3 we added an `UpdateWithTransaction` method to the `ProductsTableAdapter` in the DAL.</span></span> <span data-ttu-id="e8357-240">BLL jsme měli přidat odpovídající metody.</span><span class="sxs-lookup"><span data-stu-id="e8357-240">We should add a corresponding method to the BLL.</span></span> <span data-ttu-id="e8357-241">Zatímco prezentační vrstva může volat přímo do vrstvy DAL k vyvolání `UpdateWithTransaction` metody tyto kurzy mají strived k definování vícevrstvou architekturu, která insulates DAL od prezentační vrstvy.</span><span class="sxs-lookup"><span data-stu-id="e8357-241">While the Presentation Layer could call directly down to the DAL to invoke the `UpdateWithTransaction` method, these tutorials have strived to define a layered architecture that insulates the DAL from the Presentation Layer.</span></span> <span data-ttu-id="e8357-242">Proto behooves museli tento přístup.</span><span class="sxs-lookup"><span data-stu-id="e8357-242">Therefore, it behooves us to continue this approach.</span></span>

<span data-ttu-id="e8357-243">Otevřít `ProductsBLL` třídy soubor a přidejte metodu s názvem `UpdateWithTransaction` volající jednoduše dolů odpovídající metody vrstvy DAL.</span><span class="sxs-lookup"><span data-stu-id="e8357-243">Open the `ProductsBLL` class file and add a method named `UpdateWithTransaction` that simply calls down to the corresponding DAL method.</span></span> <span data-ttu-id="e8357-244">By měla nyní být dvou nových metod v `ProductsBLL`: `UpdateWithTransaction`, který jste právě přidali, a `DeleteProductsWithTransaction`, který byl přidán v kroku 3.</span><span class="sxs-lookup"><span data-stu-id="e8357-244">There should now be two new methods in `ProductsBLL`: `UpdateWithTransaction`, which you just added, and `DeleteProductsWithTransaction`, which was added in Step 3.</span></span>


[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample6.cs)]

> [!NOTE]
> <span data-ttu-id="e8357-245">Tyto metody nejsou zahrnuté `DataObjectMethodAttribute` atribut přiřazený ke Většina metod v `ProductsBLL` třídy vzhledem k tomu, že nám budete volání těchto metod přímo z třídy modelu code-behind stránky ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="e8357-245">These methods do not include the `DataObjectMethodAttribute` attribute assigned to most other methods in the `ProductsBLL` class because we'll be invoking these methods directly from the ASP.NET pages code-behind classes.</span></span> <span data-ttu-id="e8357-246">Vzpomeňte si, že `DataObjectMethodAttribute` slouží k nastavení příznaku, jaké metody by se měla objevit v prvku ObjectDataSource s zdroj dat konfigurace průvodce a na kartě jaké (SELECT, UPDATE, INSERT nebo DELETE).</span><span class="sxs-lookup"><span data-stu-id="e8357-246">Recall that `DataObjectMethodAttribute` is used to flag what methods should appear in the ObjectDataSource s Configure Data Source wizard and under what tab (SELECT, UPDATE, INSERT, or DELETE).</span></span> <span data-ttu-id="e8357-247">Protože prvku GridView. nemá žádné integrovanou podporu pro službu batch, úpravy nebo odstranění, musíme programově volat tyto metody než pomocí bez použití kódu deklarativní přístup.</span><span class="sxs-lookup"><span data-stu-id="e8357-247">Since the GridView lacks any built-in support for batch editing or deleting, we'll have to invoke these methods programmatically rather than use the code-free declarative approach.</span></span>


## <a name="step-5-atomically-updating-database-data-from-the-presentation-layer"></a><span data-ttu-id="e8357-248">Krok 5: Atomicky aktualizace databázových dat od prezentační vrstvy</span><span class="sxs-lookup"><span data-stu-id="e8357-248">Step 5: Atomically Updating Database Data from the Presentation Layer</span></span>

<span data-ttu-id="e8357-249">Pro ilustraci vliv transakce při aktualizaci dávky záznamů, které umožňují s vytváření uživatelského rozhraní, která zobrazuje seznam všech produktů v GridView a zahrnuje webové tlačítko ovládací prvek, který, po kliknutí na znovu přiřadí produkty `CategoryID` hodnoty.</span><span class="sxs-lookup"><span data-stu-id="e8357-249">To illustrate the effect that the transaction has when updating a batch of records, let s create a user interface that lists all products in a GridView and includes a Button Web control that, when clicked, reassigns the products `CategoryID` values.</span></span> <span data-ttu-id="e8357-250">Konkrétně se opětovné přiřazení kategorie průběhu tak, aby první několik produktů jsou přiřazeny platný `CategoryID` přiřazena hodnota, zatímco jiné jsou záměrně neexistující `CategoryID` hodnotu.</span><span class="sxs-lookup"><span data-stu-id="e8357-250">In particular, the category reassignment will progress so that the first several products are assigned a valid `CategoryID` value while others are purposefully assigned a non-existent `CategoryID` value.</span></span> <span data-ttu-id="e8357-251">Pokud budeme opakovat pokus o aktualizaci databáze s produktem jehož `CategoryID` neodpovídá existující kategorie s `CategoryID`, dojde k porušení omezení pro cizí klíč a bude vyvolána výjimka.</span><span class="sxs-lookup"><span data-stu-id="e8357-251">If we attempt to update the database with a product whose `CategoryID` does not match an existing category s `CategoryID`, a foreign key constraint violation will occur and an exception will be raised.</span></span> <span data-ttu-id="e8357-252">Vidíme v tomto příkladu je, že při použití transakcí výjimka vyvolána v porušení omezení pro cizí klíč způsobí předchozí platné `CategoryID` změny vrátit zpět.</span><span class="sxs-lookup"><span data-stu-id="e8357-252">What we'll see in this example is that when using a transaction the exception raised from the foreign key constraint violation will cause the previous valid `CategoryID` changes to be rolled back.</span></span> <span data-ttu-id="e8357-253">Pokud nepoužíváte transakce, ale změny počáteční kategorie zůstane.</span><span class="sxs-lookup"><span data-stu-id="e8357-253">When not using a transaction, however, the modifications to the initial categories will remain.</span></span>

<span data-ttu-id="e8357-254">Začněte otevřením `Transactions.aspx` stránku `BatchData` složky a GridView přetáhněte z panelu nástrojů do návrháře.</span><span class="sxs-lookup"><span data-stu-id="e8357-254">Start by opening the `Transactions.aspx` page in the `BatchData` folder and drag a GridView from the Toolbox onto the Designer.</span></span> <span data-ttu-id="e8357-255">Nastavte jeho `ID` k `Products` a z inteligentních značek, jeho vazbu na nového prvku ObjectDataSource s názvem `ProductsDataSource`.</span><span class="sxs-lookup"><span data-stu-id="e8357-255">Set its `ID` to `Products` and, from its smart tag, bind it to a new ObjectDataSource named `ProductsDataSource`.</span></span> <span data-ttu-id="e8357-256">Konfigurace ObjectDataSource přebírat jeho data ze `ProductsBLL` třída s `GetProducts` metody.</span><span class="sxs-lookup"><span data-stu-id="e8357-256">Configure the ObjectDataSource to pull its data from the `ProductsBLL` class s `GetProducts` method.</span></span> <span data-ttu-id="e8357-257">To bude GridView jen pro čtení, proto nastavte rozevírací seznamy v UPDATE, INSERT a odstranit karty na (žádný) a klikněte na tlačítko Dokončit.</span><span class="sxs-lookup"><span data-stu-id="e8357-257">This will be a read-only GridView, so set the drop-down lists in the UPDATE, INSERT, and DELETE tabs to (None) and click Finish.</span></span>


<span data-ttu-id="e8357-258">[![Obrázek 5: Konfigurace ObjectDataSource metody GetProducts ProductsBLL třída s](wrapping-database-modifications-within-a-transaction-cs/_static/image5.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="e8357-258">[![Figure 5: Configure the ObjectDataSource to Use the ProductsBLL Class s GetProducts Method](wrapping-database-modifications-within-a-transaction-cs/_static/image5.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image3.png)</span></span>

<span data-ttu-id="e8357-259">**Obrázek 5**: Obrázek 5: Konfigurace ObjectDataSource k použití `ProductsBLL` třída s `GetProducts` – metoda ([kliknutím ji zobrazíte obrázek v plné velikosti](wrapping-database-modifications-within-a-transaction-cs/_static/image4.png))</span><span class="sxs-lookup"><span data-stu-id="e8357-259">**Figure 5**: Figure 5: Configure the ObjectDataSource to Use the `ProductsBLL` Class s `GetProducts` Method ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image4.png))</span></span>


<span data-ttu-id="e8357-260">[![Nastavte rozevírací seznamy v UPDATE, INSERT a odstranit karty na (žádný)](wrapping-database-modifications-within-a-transaction-cs/_static/image6.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="e8357-260">[![Set the Drop-Down Lists in the UPDATE, INSERT, and DELETE Tabs to (None)](wrapping-database-modifications-within-a-transaction-cs/_static/image6.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image5.png)</span></span>

<span data-ttu-id="e8357-261">**Obrázek 6**: Nastavte rozevírací seznam obsahuje v UPDATE, INSERT a odstranit záložky (žádný) ([kliknutím ji zobrazíte obrázek v plné velikosti](wrapping-database-modifications-within-a-transaction-cs/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="e8357-261">**Figure 6**: Set the Drop-Down Lists in the UPDATE, INSERT, and DELETE Tabs to (None) ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image6.png))</span></span>


<span data-ttu-id="e8357-262">Po dokončení Průvodce nakonfigurovat zdroj dat, vytvoří Visual Studio BoundFields a třídě CheckBoxField pro datová pole produktu.</span><span class="sxs-lookup"><span data-stu-id="e8357-262">After completing the Configure Data Source wizard, Visual Studio will create BoundFields and a CheckBoxField for the product data fields.</span></span> <span data-ttu-id="e8357-263">Odebrat všechna tato pole s výjimkou `ProductID`, `ProductName`, `CategoryID`, a `CategoryName` a přejmenovat `ProductName` a `CategoryName` BoundFields `HeaderText` vlastností produkt a kategorie, v uvedeném pořadí.</span><span class="sxs-lookup"><span data-stu-id="e8357-263">Remove all of these fields except for `ProductID`, `ProductName`, `CategoryID`, and `CategoryName` and rename the `ProductName` and `CategoryName` BoundFields `HeaderText` properties to Product and Category, respectively.</span></span> <span data-ttu-id="e8357-264">Z inteligentních značek zaškrtněte možnost Povolit stránkování.</span><span class="sxs-lookup"><span data-stu-id="e8357-264">From the smart tag, check the Enable Paging option.</span></span> <span data-ttu-id="e8357-265">Po provedení těchto změn, ovládacími prvky GridView a prvku ObjectDataSource s deklarativní by měl vypadat nějak takto:</span><span class="sxs-lookup"><span data-stu-id="e8357-265">After making these modifications, the GridView and ObjectDataSource s declarative markup should look like the following:</span></span>


[!code-aspx[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample7.aspx)]

<span data-ttu-id="e8357-266">Dále přidejte tři ovládací prvky tlačítka webového nad prvku GridView.</span><span class="sxs-lookup"><span data-stu-id="e8357-266">Next, add three Button Web controls above the GridView.</span></span> <span data-ttu-id="e8357-267">Nastavte na první tlačítko s vlastností Text k aktualizaci mřížky, druhý s upravit kategorie (transakce s) a třetí jeden s upravit kategorie (bez transakce).</span><span class="sxs-lookup"><span data-stu-id="e8357-267">Set the first Button s Text property to Refresh Grid, the second s to Modify Categories (WITH TRANSACTION), and the third one s to Modify Categories (WITHOUT TRANSACTION) .</span></span>


[!code-aspx[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample8.aspx)]

<span data-ttu-id="e8357-268">Zobrazení návrhu v sadě Visual Studio v tomto okamžiku by měla vypadat podobně jako obrazovky je vidět na obrázku 7.</span><span class="sxs-lookup"><span data-stu-id="e8357-268">At this point the Design view in Visual Studio should look similar to the screen shot shown in Figure 7.</span></span>


<span data-ttu-id="e8357-269">[![Tato stránka obsahuje GridView a tři webové ovládací prvky tlačítek](wrapping-database-modifications-within-a-transaction-cs/_static/image7.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="e8357-269">[![The Page Contains a GridView and Three Button Web Controls](wrapping-database-modifications-within-a-transaction-cs/_static/image7.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image7.png)</span></span>

<span data-ttu-id="e8357-270">**Obrázek 7**: Tato stránka obsahuje GridView a tři webové ovládací prvky tlačítka ([kliknutím ji zobrazíte obrázek v plné velikosti](wrapping-database-modifications-within-a-transaction-cs/_static/image8.png))</span><span class="sxs-lookup"><span data-stu-id="e8357-270">**Figure 7**: The Page Contains a GridView and Three Button Web Controls ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image8.png))</span></span>


<span data-ttu-id="e8357-271">Vytváření obslužných rutin událostí pro všechny tři tlačítka s `Click` události a pomocí následujícího kódu:</span><span class="sxs-lookup"><span data-stu-id="e8357-271">Create event handlers for each of the three Button s `Click` events and use the following code:</span></span>


[!code-csharp[Main](wrapping-database-modifications-within-a-transaction-cs/samples/sample9.cs)]

<span data-ttu-id="e8357-272">Aktualizace tlačítko s `Click` obslužná rutina události je znovu jednoduše připojí data do prvku GridView voláním `Products` GridView s `DataBind` metody.</span><span class="sxs-lookup"><span data-stu-id="e8357-272">The refresh Button s `Click` event handler simply rebinds the data to the GridView by calling the `Products` GridView s `DataBind` method.</span></span>

<span data-ttu-id="e8357-273">Druhá obslužná rutina události znovu přiřadí produkty `CategoryID` s a použije metodu nové transakce z knihoven BLL provádět databáze aktualizuje pod zastřešující transakce.</span><span class="sxs-lookup"><span data-stu-id="e8357-273">The second event handler reassigns the products `CategoryID` s and uses the new transaction method from the BLL to perform the database updates under the umbrella of a transaction.</span></span> <span data-ttu-id="e8357-274">Všimněte si, že každý produkt s `CategoryID` libovolně nastavena na stejnou hodnotu jako jeho `ProductID`.</span><span class="sxs-lookup"><span data-stu-id="e8357-274">Note that each product s `CategoryID` is arbitrarily set to the same value as its `ProductID`.</span></span> <span data-ttu-id="e8357-275">To bude fungovat pro první jen málo produktů, protože tyto produkty mají `ProductID` hodnoty, ke kterým dochází k mapování na platný `CategoryID` s.</span><span class="sxs-lookup"><span data-stu-id="e8357-275">This will work fine for the first few products, since those products have `ProductID` values that happen to map to valid `CategoryID` s.</span></span> <span data-ttu-id="e8357-276">Ale jednou `ProductID` spuštění s začíná být moc velká, tento náhodný překrytí `ProductID` s a `CategoryID` s už neplatí.</span><span class="sxs-lookup"><span data-stu-id="e8357-276">But once the `ProductID` s start getting too large, this coincidental overlap of `ProductID` s and `CategoryID` s no longer applies.</span></span>

<span data-ttu-id="e8357-277">Třetí `Click` obslužná rutina události aktualizace produktů `CategoryID` s stejným způsobem, ale pošle aktualizace do databáze pomocí `ProductsTableAdapter` s výchozí `Update` metody.</span><span class="sxs-lookup"><span data-stu-id="e8357-277">The third `Click` event handler updates the products `CategoryID` s in the same manner, but sends the update to the database using the `ProductsTableAdapter` s default `Update` method.</span></span> <span data-ttu-id="e8357-278">To `Update` metoda nezalamuje řadu příkazů v rámci transakce, tak tyto změny před první chybou porušení došlo k omezení cizího klíče se zachová.</span><span class="sxs-lookup"><span data-stu-id="e8357-278">This `Update` method does not wrap the series of commands within a transaction, so those changes are made prior to the first encountered foreign key constraint violation error will persist.</span></span>

<span data-ttu-id="e8357-279">Chcete-li toto chování ilustrují, navštivte tuto stránku prostřednictvím prohlížeče.</span><span class="sxs-lookup"><span data-stu-id="e8357-279">To demonstrate this behavior, visit this page through a browser.</span></span> <span data-ttu-id="e8357-280">Původně měli byste vidět první stránka dat, jak je znázorněno na obrázku 8.</span><span class="sxs-lookup"><span data-stu-id="e8357-280">Initially you should see the first page of data as shown in Figure 8.</span></span> <span data-ttu-id="e8357-281">V dalším kroku klikněte na tlačítko Upravit kategorie (transakce s).</span><span class="sxs-lookup"><span data-stu-id="e8357-281">Next, click the Modify Categories (WITH TRANSACTION) button.</span></span> <span data-ttu-id="e8357-282">To způsobí zpětné odeslání a pokus o aktualizaci všech produktů, které `CategoryID` hodnoty, ale bude mít za následek porušení omezení pro cizí klíč (viz obrázek 9).</span><span class="sxs-lookup"><span data-stu-id="e8357-282">This will cause a postback and attempt to update all of the products `CategoryID` values, but will result in a foreign key constraint violation (see Figure 9).</span></span>


<span data-ttu-id="e8357-283">[![Produkty jsou zobrazeny v stránkované GridView](wrapping-database-modifications-within-a-transaction-cs/_static/image8.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="e8357-283">[![The Products are Displayed in a Pageable GridView](wrapping-database-modifications-within-a-transaction-cs/_static/image8.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image9.png)</span></span>

<span data-ttu-id="e8357-284">**Obrázek 8**: Produkty jsou zobrazeny v stránkované ovládacího prvku GridView ([kliknutím ji zobrazíte obrázek v plné velikosti](wrapping-database-modifications-within-a-transaction-cs/_static/image10.png))</span><span class="sxs-lookup"><span data-stu-id="e8357-284">**Figure 8**: The Products are Displayed in a Pageable GridView ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image10.png))</span></span>


<span data-ttu-id="e8357-285">[![Přiřazení kategorie výsledků v narušení omezení pro cizí klíč](wrapping-database-modifications-within-a-transaction-cs/_static/image9.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="e8357-285">[![Reassigning the Categories Results in a Foreign Key Constraint Violation](wrapping-database-modifications-within-a-transaction-cs/_static/image9.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image11.png)</span></span>

<span data-ttu-id="e8357-286">**Obrázek 9**: Přiřazení kategorie výsledků v porušení omezení cizího klíče ([kliknutím ji zobrazíte obrázek v plné velikosti](wrapping-database-modifications-within-a-transaction-cs/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="e8357-286">**Figure 9**: Reassigning the Categories Results in a Foreign Key Constraint Violation ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image12.png))</span></span>


<span data-ttu-id="e8357-287">Nyní stiskněte tlačítko zpět váš prohlížeč s a pak klikněte na tlačítko Aktualizovat čar mřížky.</span><span class="sxs-lookup"><span data-stu-id="e8357-287">Now hit your browser s Back button and then click the Refresh Grid button.</span></span> <span data-ttu-id="e8357-288">Při aktualizaci dat byste měli vidět přesně stejný výstup, jak je znázorněno na obrázku 8.</span><span class="sxs-lookup"><span data-stu-id="e8357-288">Upon refreshing the data you should see the exact same output as shown in Figure 8.</span></span> <span data-ttu-id="e8357-289">To znamená, i když některé z produktů `CategoryID` s byly změněné na právní hodnoty a aktualizována v databázi, že byly vráceny zpět, když došlo k porušení omezení pro cizí klíč.</span><span class="sxs-lookup"><span data-stu-id="e8357-289">That is, even though some of the products `CategoryID` s were changed to legal values and updated in the database, they were rolled back when the foreign key constraint violation occurred.</span></span>

<span data-ttu-id="e8357-290">Zkuste to teď kliknutím na tlačítko Upravit kategorie (bez transakce).</span><span class="sxs-lookup"><span data-stu-id="e8357-290">Now try clicking the Modify Categories (WITHOUT TRANSACTION) button.</span></span> <span data-ttu-id="e8357-291">Výsledkem bude stejná chyba porušení omezení pro cizí klíč (viz obrázek 9), ale v tuto chvíli tyto produkty jehož `CategoryID` hodnoty byly změněny na právní hodnotu, nebudou vráceny zpět.</span><span class="sxs-lookup"><span data-stu-id="e8357-291">This will result in the same foreign key constraint violation error (see Figure 9), but this time those products whose `CategoryID` values were changed to a legal value will not be rolled back.</span></span> <span data-ttu-id="e8357-292">Stiskněte v prohlížeči s tlačítko Zpět a potom na tlačítko Aktualizovat mřížky.</span><span class="sxs-lookup"><span data-stu-id="e8357-292">Hit your browser s Back button and then the Refresh Grid button.</span></span> <span data-ttu-id="e8357-293">Obrázek 10 ukazuje, `CategoryID` s produkty prvních osm byl znovu přiřazen.</span><span class="sxs-lookup"><span data-stu-id="e8357-293">As Figure 10 shows, the `CategoryID` s of the first eight products have been reassigned.</span></span> <span data-ttu-id="e8357-294">Například na obrázku 8, měl Chang `CategoryID` 1, ale v obrázek 10 it s změnilo na 2.</span><span class="sxs-lookup"><span data-stu-id="e8357-294">For example, in Figure 8, Chang had a `CategoryID` of 1, but in Figure 10 it s been reassigned to 2.</span></span>


<span data-ttu-id="e8357-295">[![Některé hodnoty ID kategorie produktů nebyly aktualizovány při jiné byly](wrapping-database-modifications-within-a-transaction-cs/_static/image10.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="e8357-295">[![Some Products CategoryID Values were Updated While Others Were Not](wrapping-database-modifications-within-a-transaction-cs/_static/image10.gif)](wrapping-database-modifications-within-a-transaction-cs/_static/image13.png)</span></span>

<span data-ttu-id="e8357-296">**Obrázek 10**: Některé produkty `CategoryID` hodnoty nebyly aktualizovány při jiné byly ([kliknutím ji zobrazíte obrázek v plné velikosti](wrapping-database-modifications-within-a-transaction-cs/_static/image14.png))</span><span class="sxs-lookup"><span data-stu-id="e8357-296">**Figure 10**: Some Products `CategoryID` Values were Updated While Others Were Not ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-cs/_static/image14.png))</span></span>


## <a name="summary"></a><span data-ttu-id="e8357-297">Souhrn</span><span class="sxs-lookup"><span data-stu-id="e8357-297">Summary</span></span>

<span data-ttu-id="e8357-298">Ve výchozím nastavení metod TableAdapter s nezalamují příkazy spuštěné databáze v rámci oboru transakce, ale trochu práce můžeme přidat metody, které se vytvoří, potvrzení a vrátit zpět transakci.</span><span class="sxs-lookup"><span data-stu-id="e8357-298">By default, the TableAdapter s methods do not wrap the executed database statements within the scope of a transaction, but with a little work we can add methods that will create, commit, and rollback a transaction.</span></span> <span data-ttu-id="e8357-299">V tomto kurzu jsme vytvořili v těchto tří metod `ProductsTableAdapter` třídy: `BeginTransaction`, `CommitTransaction`, a `RollbackTransaction`.</span><span class="sxs-lookup"><span data-stu-id="e8357-299">In this tutorial we created three such methods in the `ProductsTableAdapter` class: `BeginTransaction`, `CommitTransaction`, and `RollbackTransaction`.</span></span> <span data-ttu-id="e8357-300">Jsme viděli, jak používat tyto metody společně s `try...catch` blok atomic provádět řadu příkazů změny data.</span><span class="sxs-lookup"><span data-stu-id="e8357-300">We saw how to use these methods along with a `try...catch` block to make a series of data modification statements atomic.</span></span> <span data-ttu-id="e8357-301">Konkrétně jsme vytvořili `UpdateWithTransaction` metodu `ProductsTableAdapter`, která používá vzor dávkové aktualizace provést potřebné změny, které řádky zadaného `ProductsDataTable`.</span><span class="sxs-lookup"><span data-stu-id="e8357-301">In particular, we created the `UpdateWithTransaction` method in the `ProductsTableAdapter`, which uses the Batch Update pattern to perform the necessary modifications to the rows of a supplied `ProductsDataTable`.</span></span> <span data-ttu-id="e8357-302">Přidali jsme také `DeleteProductsWithTransaction` metodu `ProductsBLL` třídy v BLL, který dokáže akceptovat nezadání `List` z `ProductID` hodnoty jako vstup a volá metodu vzor DB přímo `Delete` pro každou `ProductID`.</span><span class="sxs-lookup"><span data-stu-id="e8357-302">We also added the `DeleteProductsWithTransaction` method to the `ProductsBLL` class in the BLL, which accepts a `List` of `ProductID` values as its input and calls the DB-Direct pattern method `Delete` for each `ProductID`.</span></span> <span data-ttu-id="e8357-303">Obě metody, začněte tím, že vytváření transakcí a spouštěním příkazů úpravy dat v rámci `try...catch` bloku.</span><span class="sxs-lookup"><span data-stu-id="e8357-303">Both methods start by creating a transaction and then executing the data modification statements within a `try...catch` block.</span></span> <span data-ttu-id="e8357-304">Pokud dojde k výjimce, transakce se zrušila, jinak nebude potvrzena změna.</span><span class="sxs-lookup"><span data-stu-id="e8357-304">If an exception occurs, the transaction is rolled back, otherwise it is committed.</span></span>

<span data-ttu-id="e8357-305">Krok 5 ukázal efekt transakční dávkové aktualizace a aktualizace služby batch, které opominul použití transakcí.</span><span class="sxs-lookup"><span data-stu-id="e8357-305">Step 5 illustrated the effect of transactional batch updates versus batch updates that neglected to use a transaction.</span></span> <span data-ttu-id="e8357-306">V následujících třech kurzech budeme vycházejí z základ, podle tohoto kurzu a vytvořit uživatelské rozhraní pro provádění dávkových aktualizací, odstranění a vložení.</span><span class="sxs-lookup"><span data-stu-id="e8357-306">In the next three tutorials we will build upon the foundation laid in this tutorial and create user interfaces for performing batch updates, deletes, and inserts.</span></span>

<span data-ttu-id="e8357-307">Všechno nejlepší programování!</span><span class="sxs-lookup"><span data-stu-id="e8357-307">Happy Programming!</span></span>

## <a name="further-reading"></a><span data-ttu-id="e8357-308">Další čtení</span><span class="sxs-lookup"><span data-stu-id="e8357-308">Further Reading</span></span>

<span data-ttu-id="e8357-309">Další informace o tématech, které jsou popsané v tomto kurzu najdete na následujících odkazech:</span><span class="sxs-lookup"><span data-stu-id="e8357-309">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- [<span data-ttu-id="e8357-310">Zachování konzistence databáze s transakcemi</span><span class="sxs-lookup"><span data-stu-id="e8357-310">Maintaining Database Consistency with Transactions</span></span>](http://aspnet.4guysfromrolla.com/articles/072705-1.aspx)
- [<span data-ttu-id="e8357-311">Správa transakcí v systému SQL Server uložené procedury</span><span class="sxs-lookup"><span data-stu-id="e8357-311">Managing Transactions in SQL Server Stored Procedures</span></span>](http://www.4guysfromrolla.com/webtech/080305-1.shtml)
- [<span data-ttu-id="e8357-312">Transakce provedené snadno: `System.Transactions`</span><span class="sxs-lookup"><span data-stu-id="e8357-312">Transactions Made Easy: `System.Transactions`</span></span>](https://blogs.msdn.com/florinlazar/archive/2004/07/23/192239.aspx)
- [<span data-ttu-id="e8357-313">Objekt TransactionScope a adaptérů dat</span><span class="sxs-lookup"><span data-stu-id="e8357-313">TransactionScope and DataAdapters</span></span>](http://andyclymer.blogspot.com/2007/01/transactionscope-and-dataadapters.html)
- [<span data-ttu-id="e8357-314">Použití Oracle databázové transakce v rozhraní .NET</span><span class="sxs-lookup"><span data-stu-id="e8357-314">Using Oracle Database Transactions in .NET</span></span>](http://www.oracle.com/technology/pub/articles/price_dbtrans_dotnet.html)

## <a name="about-the-author"></a><span data-ttu-id="e8357-315">O autorovi</span><span class="sxs-lookup"><span data-stu-id="e8357-315">About the Author</span></span>

<span data-ttu-id="e8357-316">[Scott Meisnerová](http://www.4guysfromrolla.com/ScottMitchell.shtml), Autor sedm ASP/ASP.NET knih a Zakladatel [4GuysFromRolla.com](http://www.4guysfromrolla.com), má práce s Microsoft webových technologiích od roku 1998.</span><span class="sxs-lookup"><span data-stu-id="e8357-316">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="e8357-317">Scott funguje jako nezávislý konzultant, trainer a zapisovače.</span><span class="sxs-lookup"><span data-stu-id="e8357-317">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="e8357-318">Jeho nejnovější knihy [ *Edice nakladatelství Sams naučit sami ASP.NET 2.0 za 24 hodin*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span><span class="sxs-lookup"><span data-stu-id="e8357-318">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="e8357-319">Může být dosáhl v [ mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="e8357-319">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="e8357-320">nebo prostřednictvím jeho blogu, který lze nalézt v [ http://ScottOnWriting.NET ](http://ScottOnWriting.NET).</span><span class="sxs-lookup"><span data-stu-id="e8357-320">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="e8357-321">Speciální k</span><span class="sxs-lookup"><span data-stu-id="e8357-321">Special Thanks To</span></span>

<span data-ttu-id="e8357-322">V této sérii kurzů byl recenzován uživatelem mnoho užitečných revidující.</span><span class="sxs-lookup"><span data-stu-id="e8357-322">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="e8357-323">Vedoucí revidující pro účely tohoto kurzu byly Dave Gardner Hilton Giesenow a Teresy Murphy.</span><span class="sxs-lookup"><span data-stu-id="e8357-323">Lead reviewers for this tutorial were Dave Gardner, Hilton Giesenow, and Teresa Murphy.</span></span> <span data-ttu-id="e8357-324">Zajímat téma Moje nadcházejících článcích MSDN?</span><span class="sxs-lookup"><span data-stu-id="e8357-324">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="e8357-325">Pokud ano, vyřaďte mě řádek na [ mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="e8357-325">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> [<span data-ttu-id="e8357-326">Next</span><span class="sxs-lookup"><span data-stu-id="e8357-326">Next</span></span>](batch-updating-cs.md)
