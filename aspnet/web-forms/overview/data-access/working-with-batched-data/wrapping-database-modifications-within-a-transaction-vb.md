---
uid: web-forms/overview/data-access/working-with-batched-data/wrapping-database-modifications-within-a-transaction-vb
title: Zalamování změn databáze v rámci transakce (VB) | Microsoft Docs
author: rick-anderson
description: Tento kurz je první ze čtyř, které se prohlíží při aktualizaci, odstraňování a vkládání dávek dat. V tomto kurzu se dozvíte, jak povolují transakce databáze...
ms.author: riande
ms.date: 06/26/2007
ms.assetid: 7d821db5-6cbb-4b38-af14-198f9155fc82
msc.legacyurl: /web-forms/overview/data-access/working-with-batched-data/wrapping-database-modifications-within-a-transaction-vb
msc.type: authoredcontent
ms.openlocfilehash: dee95ee2789a69aac5aa79b8358e58e3ee99e1b2
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: cs-CZ
ms.lasthandoff: 03/06/2020
ms.locfileid: "78588688"
---
# <a name="wrapping-database-modifications-within-a-transaction-vb"></a><span data-ttu-id="7c76b-104">Zabalení úprav databáze do transakce (VB)</span><span class="sxs-lookup"><span data-stu-id="7c76b-104">Wrapping Database Modifications within a Transaction (VB)</span></span>

<span data-ttu-id="7c76b-105">[Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="7c76b-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="7c76b-106">[Stažení kódu](https://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_63_VB.zip) nebo [stažení PDF](wrapping-database-modifications-within-a-transaction-vb/_static/datatutorial63vb1.pdf)</span><span class="sxs-lookup"><span data-stu-id="7c76b-106">[Download Code](https://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_63_VB.zip) or [Download PDF](wrapping-database-modifications-within-a-transaction-vb/_static/datatutorial63vb1.pdf)</span></span>

> <span data-ttu-id="7c76b-107">Tento kurz je první ze čtyř, které se prohlíží při aktualizaci, odstraňování a vkládání dávek dat.</span><span class="sxs-lookup"><span data-stu-id="7c76b-107">This tutorial is the first of four that looks at updating, deleting, and inserting batches of data.</span></span> <span data-ttu-id="7c76b-108">V tomto kurzu se dozvíte, jak transakce databáze umožňují provádět úpravy dávek jako atomická operace, která zajišťuje, že se všechny kroky úspěšně nebo selžou.</span><span class="sxs-lookup"><span data-stu-id="7c76b-108">In this tutorial we learn how database transactions allow batch modifications to be carried out as an atomic operation, which ensures that either all steps succeed or all steps fail.</span></span>

## <a name="introduction"></a><span data-ttu-id="7c76b-109">Úvod</span><span class="sxs-lookup"><span data-stu-id="7c76b-109">Introduction</span></span>

<span data-ttu-id="7c76b-110">Jak jsme zjistili, že jsme začali s [přehledem vkládání, aktualizace a odstraňování dat](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-vb.md) , prvek GridView nabízí integrovanou podporu pro úpravy a odstraňování na úrovni řádků.</span><span class="sxs-lookup"><span data-stu-id="7c76b-110">As we saw starting with the [An Overview of Inserting, Updating, and Deleting Data](../editing-inserting-and-deleting-data/an-overview-of-inserting-updating-and-deleting-data-vb.md) tutorial, the GridView provides built-in support for row-level editing and deleting.</span></span> <span data-ttu-id="7c76b-111">Pomocí několika kliknutí myši je možné vytvořit bohatou rozhraní pro úpravu dat bez psaní řádku kódu, pokud jste obsah s úpravami a odstraňováním na jednotlivých řádcích.</span><span class="sxs-lookup"><span data-stu-id="7c76b-111">With a few clicks of the mouse it is possible to create a rich data modification interface without writing a line of code, so long as you are content with editing and deleting on a per-row basis.</span></span> <span data-ttu-id="7c76b-112">V některých scénářích to však není dostačující a musíme uživatelům poskytnout možnost upravit nebo odstranit dávku záznamů.</span><span class="sxs-lookup"><span data-stu-id="7c76b-112">However, in certain scenarios this is insufficient and we need to provide users with the ability to edit or delete a batch of records.</span></span>

<span data-ttu-id="7c76b-113">Například většina webových e-mailových klientů používá mřížku k vypsání každé zprávy, kde každý řádek obsahuje zaškrtávací políčko spolu s informacemi o e-mailu (předmět, odesilatel atd.).</span><span class="sxs-lookup"><span data-stu-id="7c76b-113">For example, most web-based email clients use a grid to list each message where each row includes a checkbox along with the email s information (subject, sender, and so forth).</span></span> <span data-ttu-id="7c76b-114">Toto rozhraní umožňuje uživateli odstranit více zpráv tím, že je zkontroluje a pak klikne na tlačítko Odstranit vybrané zprávy.</span><span class="sxs-lookup"><span data-stu-id="7c76b-114">This interface permits the user to delete multiple messages by checking them and then clicking a Delete Selected Messages button.</span></span> <span data-ttu-id="7c76b-115">Rozhraní pro úpravu dávky je ideální v situacích, kdy uživatelé běžně upravují mnoho různých záznamů.</span><span class="sxs-lookup"><span data-stu-id="7c76b-115">A batch editing interface is ideal in situations where users commonly edit many different records.</span></span> <span data-ttu-id="7c76b-116">Místo toho, aby uživatel mohl kliknout na upravit, provést změnu a pak kliknout na aktualizovat u každého záznamu, který je potřeba upravit, rozhraní pro úpravu dávky vykresluje jednotlivé řádky s rozhraním pro úpravu.</span><span class="sxs-lookup"><span data-stu-id="7c76b-116">Rather than forcing the user to click Edit, make their change, and then click Update for each record that needs to be modified, a batch editing interface renders each row with its editing interface.</span></span> <span data-ttu-id="7c76b-117">Uživatel může rychle upravit sadu řádků, které je potřeba změnit, a pak tyto změny uložit kliknutím na tlačítko Aktualizovat vše.</span><span class="sxs-lookup"><span data-stu-id="7c76b-117">The user can quickly modify the set of rows that need to be changed and then save these changes by clicking an Update All button.</span></span> <span data-ttu-id="7c76b-118">V této sadě kurzů podíváme se, jak vytvořit rozhraní pro vkládání, úpravu a odstraňování dávek dat.</span><span class="sxs-lookup"><span data-stu-id="7c76b-118">In this set of tutorials we'll examine how to create interfaces for inserting, editing, and deleting batches of data.</span></span>

<span data-ttu-id="7c76b-119">Při provádění dávkových operací je důležité určit, jestli má být možné, aby některé operace v dávce byly úspěšné, zatímco jiné selžou.</span><span class="sxs-lookup"><span data-stu-id="7c76b-119">When performing batch operations it s important to determine whether it should be possible for some of the operations in the batch to succeed while others fail.</span></span> <span data-ttu-id="7c76b-120">Vezměte v úvahu dávkové odstranění rozhraní – co se stane, když se první vybraný záznam úspěšně odstraní, ale druhý z nich se nezdaří, například kvůli porušení omezení cizího klíče?</span><span class="sxs-lookup"><span data-stu-id="7c76b-120">Consider a batch deleting interface - what should happen if the first selected record is deleted successfully, but the second one fails, say, because of a foreign key constraint violation?</span></span> <span data-ttu-id="7c76b-121">Má se první záznam odstranit zpátky nebo je přijatelný, aby se první záznam stále odstranil?</span><span class="sxs-lookup"><span data-stu-id="7c76b-121">Should the first record s delete be rolled back or is it acceptable for the first record to remain deleted?</span></span>

<span data-ttu-id="7c76b-122">Pokud chcete, aby se operace dávky zpracovala jako [atomická operace](http://en.wikipedia.org/wiki/Atomic_operation), jedna, kde všechny kroky proběhly úspěšně, nebo všechny kroky selžou, je nutné rozšířit vrstvu přístupu k datům, aby zahrnovala podporu [databázových transakcí](http://en.wikipedia.org/wiki/Database_transaction).</span><span class="sxs-lookup"><span data-stu-id="7c76b-122">If you want the batch operation to be treated as an [atomic operation](http://en.wikipedia.org/wiki/Atomic_operation), one where either all of the steps succeed or all of the steps fail, then the Data Access Layer needs to be augmented to include support for [database transactions](http://en.wikipedia.org/wiki/Database_transaction).</span></span> <span data-ttu-id="7c76b-123">Transakce databáze zaručují nedělitelnost pro sadu `INSERT`, `UPDATE`a `DELETE`ch příkazů spouštěných v rámci transakce a jsou funkcí podporovanými většinou všech moderních databázových systémů.</span><span class="sxs-lookup"><span data-stu-id="7c76b-123">Database transactions guarantee atomicity for the set of `INSERT`, `UPDATE`, and `DELETE` statements executed under the umbrella of the transaction and are a feature supported by most all modern database systems.</span></span>

<span data-ttu-id="7c76b-124">V tomto kurzu se podíváme na to, jak rozšiřujete DAL na použití databázových transakcí.</span><span class="sxs-lookup"><span data-stu-id="7c76b-124">In this tutorial we'll look at how to extend the DAL to use database transactions.</span></span> <span data-ttu-id="7c76b-125">Další kurzy budou kontrolovat implementaci webových stránek pro dávkové vkládání, aktualizaci a odstraňování rozhraní.</span><span class="sxs-lookup"><span data-stu-id="7c76b-125">Subsequent tutorials will examine implementing web pages for batch inserting, updating, and deleting interfaces.</span></span> <span data-ttu-id="7c76b-126">Pojďme začít!</span><span class="sxs-lookup"><span data-stu-id="7c76b-126">Let s get started!</span></span>

> [!NOTE]
> <span data-ttu-id="7c76b-127">Při úpravě dat v transakci dávky není atomie vždy potřeba.</span><span class="sxs-lookup"><span data-stu-id="7c76b-127">When modifying data in a batch transaction, atomicity is not always needed.</span></span> <span data-ttu-id="7c76b-128">V některých scénářích může být přijatelné, aby některé změny dat byly úspěšné a jiné ve stejné dávce selžou, například při odstraňování sady e-mailů z webového e-mailového klienta.</span><span class="sxs-lookup"><span data-stu-id="7c76b-128">In some scenarios, it may be acceptable to have some data modifications succeed and others in the same batch fail, such as when deleting a set of emails from a web-based email client.</span></span> <span data-ttu-id="7c76b-129">Pokud dojde k chybě databáze na základě procesu odstranění, je pravděpodobné, že tyto záznamy byly zpracovány bez chyby, ale zůstanou odstraněny.</span><span class="sxs-lookup"><span data-stu-id="7c76b-129">If there s a database error midway through the deletion process, it s probably acceptable that those records processed without error remain deleted.</span></span> <span data-ttu-id="7c76b-130">V takových případech není nutné upravovat DAL pro podporu databázových transakcí.</span><span class="sxs-lookup"><span data-stu-id="7c76b-130">In such cases, the DAL does not need to be modified to support database transactions.</span></span> <span data-ttu-id="7c76b-131">Existují i další scénáře operace Batch, kde je však nevýznamná atomická akce.</span><span class="sxs-lookup"><span data-stu-id="7c76b-131">There are other batch operation scenarios, however, where atomicity is vital.</span></span> <span data-ttu-id="7c76b-132">Když zákazník přesune své prostředky z jednoho bankovního účtu do jiného, musí se provést dvě operace: prostředky se musí od prvního účtu odečíst a pak se přidají k druhému.</span><span class="sxs-lookup"><span data-stu-id="7c76b-132">When a customer moves her funds from one bank account to another, two operations must be performed: the funds must be deducted from the first account and then added to the second.</span></span> <span data-ttu-id="7c76b-133">I když banka nemusí mít k úspěšnému prvnímu kroku úspěch, ale druhý krok selže, jeho zákazníci by pochopili, že by se nemuseli rušit.</span><span class="sxs-lookup"><span data-stu-id="7c76b-133">While the bank may not mind having the first step succeed but the second step fail, its customers would understandably be upset.</span></span> <span data-ttu-id="7c76b-134">Doporučujeme, abyste s tímto kurzem pracovali a implementovali vylepšení pro podporu transakcí databáze i v případě, že je neplánujete při jejich použití v dávkách vkládat, aktualizovat a odstraňovat rozhraní Batch, která se budou sestavovat v následujících třech kurzech.</span><span class="sxs-lookup"><span data-stu-id="7c76b-134">I encourage you to work through this tutorial and implement the enhancements to the DAL to support database transactions even if you do not plan on using them in the batch inserting, updating, and deleting interfaces we'll be building in the following three tutorials.</span></span>

## <a name="an-overview-of-transactions"></a><span data-ttu-id="7c76b-135">Přehled transakcí</span><span class="sxs-lookup"><span data-stu-id="7c76b-135">An Overview of Transactions</span></span>

<span data-ttu-id="7c76b-136">Většina databází zahrnuje podporu pro *transakce*, které umožňují seskupení více databázových příkazů do jedné logické jednotky práce.</span><span class="sxs-lookup"><span data-stu-id="7c76b-136">Most databases include support for *transactions*, which enable multiple database commands to be grouped into a single logical unit of work.</span></span> <span data-ttu-id="7c76b-137">Příkazy databáze, které tvoří transakci, jsou zaručené jako atomické, což znamená, že všechny příkazy selžou nebo budou úspěšné.</span><span class="sxs-lookup"><span data-stu-id="7c76b-137">The database commands that comprise a transaction are guaranteed to be atomic, meaning that either all commands will fail or all will succeed.</span></span>

<span data-ttu-id="7c76b-138">Obecně platí, že transakce jsou implementovány prostřednictvím příkazů SQL pomocí následujícího vzoru:</span><span class="sxs-lookup"><span data-stu-id="7c76b-138">In general, transactions are implemented through SQL statements using the following pattern:</span></span>

1. <span data-ttu-id="7c76b-139">Označuje začátek transakce.</span><span class="sxs-lookup"><span data-stu-id="7c76b-139">Indicate the start of a transaction.</span></span>
2. <span data-ttu-id="7c76b-140">Spusťte příkazy SQL, které tvoří transakci.</span><span class="sxs-lookup"><span data-stu-id="7c76b-140">Execute the SQL statements that comprise the transaction.</span></span>
3. <span data-ttu-id="7c76b-141">Pokud dojde k chybě v jednom z příkazů z kroku 2, vraťte transakci zpět.</span><span class="sxs-lookup"><span data-stu-id="7c76b-141">If there is an error in one of the statements from Step 2, rollback the transaction.</span></span>
4. <span data-ttu-id="7c76b-142">Pokud všechny příkazy z kroku 2 se dokončí bez chyby, potvrďte transakci.</span><span class="sxs-lookup"><span data-stu-id="7c76b-142">If all of the statements from Step 2 complete without error, commit the transaction.</span></span>

<span data-ttu-id="7c76b-143">Příkazy jazyka SQL použité k vytvoření, potvrzení a vrácení transakce lze zadat ručně při psaní skriptů SQL nebo při vytváření uložených procedur nebo prostřednictvím programových prostředků s použitím buď ADO.NET nebo třídy v [oboru názvů`System.Transactions`](https://msdn.microsoft.com/library/system.transactions.aspx).</span><span class="sxs-lookup"><span data-stu-id="7c76b-143">The SQL statements used to create, commit, and roll back the transaction can be entered manually when writing SQL scripts or creating stored procedures, or through programmatic means using either ADO.NET or the classes in the [`System.Transactions` namespace](https://msdn.microsoft.com/library/system.transactions.aspx).</span></span> <span data-ttu-id="7c76b-144">V tomto kurzu prověříme jenom správu transakcí pomocí ADO.NET.</span><span class="sxs-lookup"><span data-stu-id="7c76b-144">In this tutorial we will only examine managing transactions using ADO.NET.</span></span> <span data-ttu-id="7c76b-145">V budoucím kurzu se podíváme na to, jak používat uložené procedury ve vrstvě přístupu k datům. v této době prozkoumáme příkazy SQL pro vytváření, vracení zpátky a potvrzování transakcí.</span><span class="sxs-lookup"><span data-stu-id="7c76b-145">In a future tutorial we will look at how to use stored procedures in the Data Access Layer, at which time we'll explore the SQL statements for creating, rolling back, and committing transactions.</span></span> <span data-ttu-id="7c76b-146">Mezitím si přečtěte další informace [v části Správa transakcí v uložených procedurách SQL Server](http://www.4guysfromrolla.com/webtech/080305-1.shtml) .</span><span class="sxs-lookup"><span data-stu-id="7c76b-146">In the meantime, consult [Managing Transactions in SQL Server Stored Procedures](http://www.4guysfromrolla.com/webtech/080305-1.shtml) for more information.</span></span>

> [!NOTE]
> <span data-ttu-id="7c76b-147">[Třída`TransactionScope`](https://msdn.microsoft.com/library/system.transactions.transactionscope.aspx) v oboru názvů `System.Transactions` umožňuje vývojářům programově zabalit řadu příkazů v rámci oboru transakce a zahrnuje podporu pro komplexní transakce, které zahrnují více zdrojů, jako jsou dvě různé databáze nebo dokonce heterogenní typy úložišť dat, jako je například databáze Microsoft SQL Server, databáze Oracle a webová služba.</span><span class="sxs-lookup"><span data-stu-id="7c76b-147">The [`TransactionScope` class](https://msdn.microsoft.com/library/system.transactions.transactionscope.aspx) in the `System.Transactions` namespace enables developers to programmatically wrap a series of statements within the scope of a transaction and includes support for complex transactions that involve multiple sources, such as two different databases or even heterogeneous types of data stores, such as a Microsoft SQL Server database, an Oracle database, and a Web service.</span></span> <span data-ttu-id="7c76b-148">Rozhodl (a) použít transakce ADO.NET pro tento kurz místo `TransactionScope` třídy, protože ADO.NET je konkrétnější pro databázové transakce a v mnoha případech je mnohem méně náročná na prostředky.</span><span class="sxs-lookup"><span data-stu-id="7c76b-148">I ve decided to use ADO.NET transactions for this tutorial instead of the `TransactionScope` class because ADO.NET is more specific for database transactions and, in many cases, is far less resource intensive.</span></span> <span data-ttu-id="7c76b-149">Kromě toho se v některých scénářích `TransactionScope` třída používá Microsoft DTC (Distributed Transaction Coordinator) (MSDTC).</span><span class="sxs-lookup"><span data-stu-id="7c76b-149">In addition, under certain scenarios the `TransactionScope` class uses the Microsoft Distributed Transaction Coordinator (MSDTC).</span></span> <span data-ttu-id="7c76b-150">Problémy s konfigurací, implementací a výkonem v případě, že koordinátor MSDTC vytvoří místo specializovaného a pokročilého tématu a překračuje rozsah těchto kurzů.</span><span class="sxs-lookup"><span data-stu-id="7c76b-150">The configuration, implementation, and performance issues surrounding MSDTC makes it a rather specialized and advanced topic and beyond the scope of these tutorials.</span></span>

<span data-ttu-id="7c76b-151">Při práci se zprostředkovatelem SqlClient v ADO.NET jsou transakce iniciovány prostřednictvím volání [metody`BeginTransaction`](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.begintransaction.aspx) [třídy`SqlConnection`](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) , která vrací [objekt`SqlTransaction`](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.aspx).</span><span class="sxs-lookup"><span data-stu-id="7c76b-151">When working with the SqlClient provider in ADO.NET, transactions are initiated through a call to the [`SqlConnection` class](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) s [`BeginTransaction` method](https://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.begintransaction.aspx), which returns a [`SqlTransaction` object](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.aspx).</span></span> <span data-ttu-id="7c76b-152">Příkazy změny dat, které strukturu transakci, jsou umístěny v rámci `try...catch`ho bloku.</span><span class="sxs-lookup"><span data-stu-id="7c76b-152">The data modification statements that makeup the transaction are placed within a `try...catch` block.</span></span> <span data-ttu-id="7c76b-153">Pokud dojde k chybě v příkazu v bloku `try`, spuštění se přenese do bloku `catch`, kde lze transakci vrátit zpět prostřednictvím metody `SqlTransaction` objektů s [`Rollback`](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.rollback.aspx).</span><span class="sxs-lookup"><span data-stu-id="7c76b-153">If an error occurs in a statement in the `try` block, execution transfers to the `catch` block where the transaction can be rolled back via the `SqlTransaction` object s [`Rollback` method](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.rollback.aspx).</span></span> <span data-ttu-id="7c76b-154">Pokud všechny příkazy byly úspěšně dokončeny, volání metody `SqlTransaction` objektu s [`Commit`](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.commit.aspx) na konci bloku `try` potvrdí transakci.</span><span class="sxs-lookup"><span data-stu-id="7c76b-154">If all of the statements complete successfully, a call to the `SqlTransaction` object s [`Commit` method](https://msdn.microsoft.com/library/system.data.sqlclient.sqltransaction.commit.aspx) at the end of the `try` block commits the transaction.</span></span> <span data-ttu-id="7c76b-155">Tento model ilustruje následující fragment kódu.</span><span class="sxs-lookup"><span data-stu-id="7c76b-155">The following code snippet illustrates this pattern.</span></span> <span data-ttu-id="7c76b-156">Další syntaxe a příklady použití transakcí s ADO.NET najdete v tématu [Údržba konzistence databáze pomocí transakcí](http://aspnet.4guysfromrolla.com/articles/072705-1.aspx) .</span><span class="sxs-lookup"><span data-stu-id="7c76b-156">See [Maintaining Database Consistency with Transactions](http://aspnet.4guysfromrolla.com/articles/072705-1.aspx) for additional syntax and examples of using transactions with ADO.NET.</span></span>

[!code-vb[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample1.vb)]

<span data-ttu-id="7c76b-157">Ve výchozím nastavení objekty TableAdapter ve typované datové sadě nepoužívá transakce.</span><span class="sxs-lookup"><span data-stu-id="7c76b-157">By default, the TableAdapters in a Typed DataSet do not use transactions.</span></span> <span data-ttu-id="7c76b-158">Pro zajištění podpory pro transakce, které potřebujeme k rozšíření tříd TableAdapter, aby zahrnovaly další metody, které používají výše uvedený vzor k provádění řady příkazů pro úpravu dat v rámci oboru transakce.</span><span class="sxs-lookup"><span data-stu-id="7c76b-158">To provide support for transactions we need to augment the TableAdapter classes to include additional methods that use the above pattern to perform a series of data modification statements within the scope of a transaction.</span></span> <span data-ttu-id="7c76b-159">V kroku 2 se dozvíte, jak použít částečné třídy pro přidání těchto metod.</span><span class="sxs-lookup"><span data-stu-id="7c76b-159">In Step 2 we'll see how to use partial classes to add these methods.</span></span>

## <a name="step-1-creating-the-working-with-batched-data-web-pages"></a><span data-ttu-id="7c76b-160">Krok 1: vytvoření práce s webovými stránkami dávková data</span><span class="sxs-lookup"><span data-stu-id="7c76b-160">Step 1: Creating the Working with Batched Data Web Pages</span></span>

<span data-ttu-id="7c76b-161">Předtím, než začneme zkoumat, jak rozšířit DAL na podporu databázových transakcí, si nejdřív chvíli počkejte, než se vytvoří webové stránky ASP.NET, které budeme potřebovat pro tento kurz a tři kroky.</span><span class="sxs-lookup"><span data-stu-id="7c76b-161">Before we start exploring how to augment the DAL to support database transactions, let s first take a moment to create the ASP.NET web pages that we will need for this tutorial and the three that follow.</span></span> <span data-ttu-id="7c76b-162">Začněte přidáním nové složky s názvem `BatchData` a pak přidejte následující stránky ASP.NET a přiřadíte každou stránku k `Site.master` stránce předlohy.</span><span class="sxs-lookup"><span data-stu-id="7c76b-162">Start by adding a new folder named `BatchData` and then add the following ASP.NET pages, associating each page with the `Site.master` master page.</span></span>

- `Default.aspx`
- `Transactions.aspx`
- `BatchUpdate.aspx`
- `BatchDelete.aspx`
- `BatchInsert.aspx`

![Přidání stránek ASP.NET pro kurzy týkající se SqlDataSource](wrapping-database-modifications-within-a-transaction-vb/_static/image1.gif)

<span data-ttu-id="7c76b-164">**Obrázek 1**: přidání stránek ASP.NET pro kurzy týkající se SqlDataSource</span><span class="sxs-lookup"><span data-stu-id="7c76b-164">**Figure 1**: Add the ASP.NET Pages for the SqlDataSource-Related Tutorials</span></span>

<span data-ttu-id="7c76b-165">Stejně jako u ostatních složek `Default.aspx` použije uživatelský ovládací prvek `SectionLevelTutorialListing.ascx` k vypsání kurzů v rámci své části.</span><span class="sxs-lookup"><span data-stu-id="7c76b-165">As with the other folders, `Default.aspx` will use the `SectionLevelTutorialListing.ascx` User Control to list the tutorials within its section.</span></span> <span data-ttu-id="7c76b-166">Proto tento uživatelský ovládací prvek přidejte do `Default.aspx` tím, že ho přetáhnete z Průzkumník řešení na zobrazení Návrh stránky.</span><span class="sxs-lookup"><span data-stu-id="7c76b-166">Therefore, add this User Control to `Default.aspx` by dragging it from the Solution Explorer onto the page s Design view.</span></span>

<span data-ttu-id="7c76b-167">[![přidat uživatelský ovládací prvek SectionLevelTutorialListing. ascx do default. aspx](wrapping-database-modifications-within-a-transaction-vb/_static/image2.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="7c76b-167">[![Add the SectionLevelTutorialListing.ascx User Control to Default.aspx](wrapping-database-modifications-within-a-transaction-vb/_static/image2.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image1.png)</span></span>

<span data-ttu-id="7c76b-168">**Obrázek 2**: Přidání uživatelského ovládacího prvku `SectionLevelTutorialListing.ascx` do `Default.aspx` ([kliknutím zobrazíte obrázek v plné velikosti](wrapping-database-modifications-within-a-transaction-vb/_static/image2.png))</span><span class="sxs-lookup"><span data-stu-id="7c76b-168">**Figure 2**: Add the `SectionLevelTutorialListing.ascx` User Control to `Default.aspx` ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-vb/_static/image2.png))</span></span>

<span data-ttu-id="7c76b-169">Nakonec tyto čtyři stránky přidejte jako položky do souboru `Web.sitemap`.</span><span class="sxs-lookup"><span data-stu-id="7c76b-169">Lastly, add these four pages as entries to the `Web.sitemap` file.</span></span> <span data-ttu-id="7c76b-170">Konkrétně přidejte následující značky po přizpůsobení mapy webu `<siteMapNode>`:</span><span class="sxs-lookup"><span data-stu-id="7c76b-170">Specifically, add the following markup after the Customizing the Site Map `<siteMapNode>`:</span></span>

[!code-xml[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample2.xml)]

<span data-ttu-id="7c76b-171">Po aktualizaci `Web.sitemap`chvíli počkejte, než se zobrazí web kurzy prostřednictvím prohlížeče.</span><span class="sxs-lookup"><span data-stu-id="7c76b-171">After updating `Web.sitemap`, take a moment to view the tutorials website through a browser.</span></span> <span data-ttu-id="7c76b-172">Nabídka na levé straně teď obsahuje položky pro práci s kurzy dat v dávce.</span><span class="sxs-lookup"><span data-stu-id="7c76b-172">The menu on the left now includes items for the working with batched data tutorials.</span></span>

![Mapa webu teď obsahuje položky pro práci s kurzy dat v dávce.](wrapping-database-modifications-within-a-transaction-vb/_static/image3.gif)

<span data-ttu-id="7c76b-174">**Obrázek 3**: Mapa webu teď obsahuje položky pro práci s kurzy dat v dávce.</span><span class="sxs-lookup"><span data-stu-id="7c76b-174">**Figure 3**: The Site Map Now Includes Entries for the Working with Batched Data Tutorials</span></span>

## <a name="step-2-updating-the-data-access-layer-to-support-database-transactions"></a><span data-ttu-id="7c76b-175">Krok 2: aktualizace vrstvy přístupu k datům pro podporu databázových transakcí</span><span class="sxs-lookup"><span data-stu-id="7c76b-175">Step 2: Updating the Data Access Layer to Support Database Transactions</span></span>

<span data-ttu-id="7c76b-176">Jak jsme probrali zpět v prvním kurzu, [Vytvoření vrstvy přístupu k datům](../introduction/creating-a-data-access-layer-vb.md), zadaná datová sada v naší dál se skládá z datových tabulek a objekty TableAdapter.</span><span class="sxs-lookup"><span data-stu-id="7c76b-176">As we discussed back in the first tutorial, [Creating a Data Access Layer](../introduction/creating-a-data-access-layer-vb.md), the Typed DataSet in our DAL is composed of DataTables and TableAdapters.</span></span> <span data-ttu-id="7c76b-177">Datové tabulky uchovávají data, zatímco objekty TableAdapter poskytuje funkce pro čtení dat z databáze do datových tabulek, k aktualizaci databáze se změnami provedenými v datových tabulkách a tak dále.</span><span class="sxs-lookup"><span data-stu-id="7c76b-177">The DataTables hold data while the TableAdapters provide the functionality to read data from the database into the DataTables, to update the database with changes made to the DataTables, and so forth.</span></span> <span data-ttu-id="7c76b-178">Odvoláte si, že objekty TableAdapter poskytuje dva vzory pro aktualizaci dat, které se označují jako dávkové aktualizace a DB-Direct.</span><span class="sxs-lookup"><span data-stu-id="7c76b-178">Recall that the TableAdapters provide two patterns for updating data, which I referred to as Batch Update and DB-Direct.</span></span> <span data-ttu-id="7c76b-179">Se vzorem aktualizace pro dávku je TableAdapter předán objekt DataSet, DataTable nebo kolekce datových řádků.</span><span class="sxs-lookup"><span data-stu-id="7c76b-179">With the Batch Update pattern, the TableAdapter is passed a DataSet, DataTable, or collection of DataRows.</span></span> <span data-ttu-id="7c76b-180">Tato data jsou vyčíslovaná a pro každý vložený, změněný nebo odstraněný řádek, `InsertCommand`, `UpdateCommand`nebo `DeleteCommand`.</span><span class="sxs-lookup"><span data-stu-id="7c76b-180">This data is enumerated and for each inserted, modified, or deleted row, the `InsertCommand`, `UpdateCommand`, or `DeleteCommand` is executed.</span></span> <span data-ttu-id="7c76b-181">Pomocí vzoru DB-Direct je TableAdapter místo toho předán hodnot sloupců potřebných pro vložení, aktualizaci nebo odstranění jednoho záznamu.</span><span class="sxs-lookup"><span data-stu-id="7c76b-181">With the DB-Direct pattern, the TableAdapter is instead passed the values of the columns necessary for inserting, updating, or deleting a single record.</span></span> <span data-ttu-id="7c76b-182">Metoda přímého vzoru DB pak pomocí těchto předaných hodnot provede příslušný `InsertCommand`, `UpdateCommand`nebo příkaz `DeleteCommand`.</span><span class="sxs-lookup"><span data-stu-id="7c76b-182">The DB Direct pattern method then uses those passed-in values to execute the appropriate `InsertCommand`, `UpdateCommand`, or `DeleteCommand` statement.</span></span>

<span data-ttu-id="7c76b-183">Bez ohledu na použitý vzor aktualizace nepoužívají automaticky generované metody objekty TableAdapter transakce.</span><span class="sxs-lookup"><span data-stu-id="7c76b-183">Regardless of the update pattern used, the TableAdapters auto-generated methods do not use transactions.</span></span> <span data-ttu-id="7c76b-184">Ve výchozím nastavení se každé vložení, aktualizace nebo odstranění prováděné TableAdapter považuje za jednu diskrétní operaci.</span><span class="sxs-lookup"><span data-stu-id="7c76b-184">By default each insert, update, or delete performed by the TableAdapter is treated as a single discrete operation.</span></span> <span data-ttu-id="7c76b-185">Představte si například, že vzor DB-Direct je použit nějakým kódem v knihoven BLL k vložení deseti záznamů do databáze.</span><span class="sxs-lookup"><span data-stu-id="7c76b-185">For instance, imagine that the DB-Direct pattern is used by some code in the BLL to insert ten records into the database.</span></span> <span data-ttu-id="7c76b-186">Tento kód by volal metodu TableAdapter s `Insert` desetkrát.</span><span class="sxs-lookup"><span data-stu-id="7c76b-186">This code would call the TableAdapter s `Insert` method ten times.</span></span> <span data-ttu-id="7c76b-187">Pokud je první pět vložení úspěšné, ale šestá z nich způsobila výjimku, prvních pět vložených záznamů by v databázi zůstalo.</span><span class="sxs-lookup"><span data-stu-id="7c76b-187">If the first five inserts succeed, but the sixth one resulted in an exception, the first five inserted records would remain in the database.</span></span> <span data-ttu-id="7c76b-188">Podobně platí, že pokud se vzor aktualizace dávky používá k provádění vložení, aktualizace a odstranění řádků vložených, upravených a odstraněných v objektu DataTable, pokud bylo prvních několik změn úspěšné, ale později v nich došlo k chybě, tyto dřívější úpravy dokončeno by zůstalo v databázi.</span><span class="sxs-lookup"><span data-stu-id="7c76b-188">Similarly, if the Batch Update pattern is used to perform inserts, updates, and deletes to the inserted, modified, and deleted rows in a DataTable, if the first several modifications succeeded but a later one encountered an error, those earlier modifications that completed would remain in the database.</span></span>

<span data-ttu-id="7c76b-189">V některých scénářích chceme zajistit nedělitelnost v rámci řady úprav.</span><span class="sxs-lookup"><span data-stu-id="7c76b-189">In certain scenarios we want to ensure atomicity across a series of modifications.</span></span> <span data-ttu-id="7c76b-190">Aby bylo možné tento postup provést, je nutné ručně rozšíření TableAdapter přidáním nových metod, které spouštějí `InsertCommand`, `UpdateCommand`a `DeleteCommand` s v rámci transakce.</span><span class="sxs-lookup"><span data-stu-id="7c76b-190">To accomplish this we must manually extend the TableAdapter by adding new methods that execute the `InsertCommand`, `UpdateCommand`, and `DeleteCommand` s under the umbrella of a transaction.</span></span> <span data-ttu-id="7c76b-191">Při [vytváření vrstvy přístupu k datům](../introduction/creating-a-data-access-layer-vb.md) jsme prohlédli pomocí [částečných tříd](http://en.wikipedia.org/wiki/Partial_type) a rozšířili jsme funkce datových tabulek v rámci typové datové sady.</span><span class="sxs-lookup"><span data-stu-id="7c76b-191">In [Creating a Data Access Layer](../introduction/creating-a-data-access-layer-vb.md) we looked at using [partial classes](http://en.wikipedia.org/wiki/Partial_type) to extend the functionality of the DataTables within the Typed DataSet.</span></span> <span data-ttu-id="7c76b-192">Tento postup lze také použít s objekty TableAdapter.</span><span class="sxs-lookup"><span data-stu-id="7c76b-192">This technique can also be used with TableAdapters.</span></span>

<span data-ttu-id="7c76b-193">Zadaná datová sada `Northwind.xsd` je umístěná v podsložce `App_Code` složky s `DAL`.</span><span class="sxs-lookup"><span data-stu-id="7c76b-193">The Typed DataSet `Northwind.xsd` is located in the `App_Code` folder s `DAL` subfolder.</span></span> <span data-ttu-id="7c76b-194">Vytvořte podsložku ve složce `DAL` s názvem `TransactionSupport` a přidejte nový soubor třídy s názvem `ProductsTableAdapter.TransactionSupport.vb` (viz obrázek 4).</span><span class="sxs-lookup"><span data-stu-id="7c76b-194">Create a subfolder in the `DAL` folder named `TransactionSupport` and add a new class file named `ProductsTableAdapter.TransactionSupport.vb` (see Figure 4).</span></span> <span data-ttu-id="7c76b-195">Tento soubor bude obsahovat částečnou implementaci `ProductsTableAdapter`, která obsahuje metody pro provádění úprav dat pomocí transakce.</span><span class="sxs-lookup"><span data-stu-id="7c76b-195">This file will hold the partial implementation of the `ProductsTableAdapter` that includes methods for performing data modifications using a transaction.</span></span>

![Přidejte složku s názvem TransactionSupport a soubor třídy s názvem ProductsTableAdapter. TransactionSupport. vb.](wrapping-database-modifications-within-a-transaction-vb/_static/image4.gif)

<span data-ttu-id="7c76b-197">**Obrázek 4**: přidejte složku s názvem `TransactionSupport` a soubor třídy s názvem `ProductsTableAdapter.TransactionSupport.vb`</span><span class="sxs-lookup"><span data-stu-id="7c76b-197">**Figure 4**: Add a Folder Named `TransactionSupport` and a Class File Named `ProductsTableAdapter.TransactionSupport.vb`</span></span>

<span data-ttu-id="7c76b-198">Do souboru `ProductsTableAdapter.TransactionSupport.vb` zadejte následující kód:</span><span class="sxs-lookup"><span data-stu-id="7c76b-198">Enter the following code into the `ProductsTableAdapter.TransactionSupport.vb` file:</span></span>

[!code-vb[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample3.vb)]

<span data-ttu-id="7c76b-199">Klíčové slovo `Partial` v deklaraci třídy zde označuje kompilátor, že členy přidané v rámci mají být přidány do `ProductsTableAdapter` třídy v oboru názvů `NorthwindTableAdapters`.</span><span class="sxs-lookup"><span data-stu-id="7c76b-199">The `Partial` keyword in the class declaration here indicates to the compiler that the members added within are to be added to the `ProductsTableAdapter` class in the `NorthwindTableAdapters` namespace.</span></span> <span data-ttu-id="7c76b-200">Všimněte si příkazu `Imports System.Data.SqlClient` v horní části souboru.</span><span class="sxs-lookup"><span data-stu-id="7c76b-200">Note the `Imports System.Data.SqlClient` statement at the top of the file.</span></span> <span data-ttu-id="7c76b-201">Vzhledem k tomu, že služba TableAdapter byla nakonfigurovaná tak, aby používala poskytovatele SqlClient, interně použije objekt [`SqlDataAdapter`](https://msdn.microsoft.com/library/system.data.sqlclient.sqldataadapter.aspx) k vystavení příkazů do databáze.</span><span class="sxs-lookup"><span data-stu-id="7c76b-201">Since the TableAdapter was configured to use the SqlClient provider, internally it uses a [`SqlDataAdapter`](https://msdn.microsoft.com/library/system.data.sqlclient.sqldataadapter.aspx) object to issue its commands to the database.</span></span> <span data-ttu-id="7c76b-202">V důsledku toho je potřeba použít třídu `SqlTransaction` k zahájení transakce a pak ji potvrdit nebo vrátit zpět.</span><span class="sxs-lookup"><span data-stu-id="7c76b-202">Consequently, we need to use the `SqlTransaction` class to begin the transaction and then to commit it or roll it back.</span></span> <span data-ttu-id="7c76b-203">Pokud používáte jiné úložiště dat než Microsoft SQL Server, bude nutné použít příslušného poskytovatele.</span><span class="sxs-lookup"><span data-stu-id="7c76b-203">If you are using a data store other than Microsoft SQL Server, you'll need to use the appropriate provider.</span></span>

<span data-ttu-id="7c76b-204">Tyto metody poskytují stavební bloky potřebné ke spuštění, vrácení zpět a potvrzení transakce.</span><span class="sxs-lookup"><span data-stu-id="7c76b-204">These methods provide the building blocks needed to start, rollback, and commit a transaction.</span></span> <span data-ttu-id="7c76b-205">Jsou označeny `Public`a umožňují jejich použití v rámci `ProductsTableAdapter`, z jiné třídy v DAL nebo z jiné vrstvy v architektuře, jako je například knihoven BLL.</span><span class="sxs-lookup"><span data-stu-id="7c76b-205">They are marked `Public`, enabling them to be used from within the `ProductsTableAdapter`, from another class in the DAL, or from another layer in the architecture, such as the BLL.</span></span> <span data-ttu-id="7c76b-206">`BeginTransaction` otevře interní `SqlConnection` TableAdapter s (v případě potřeby), zahájí transakci a přiřadí ji k vlastnosti `Transaction` a připojí transakci k interním objektům `SqlCommand` `SqlDataAdapter` s.</span><span class="sxs-lookup"><span data-stu-id="7c76b-206">`BeginTransaction` opens the TableAdapter s internal `SqlConnection` (if needed), begins the transaction and assigns it to the `Transaction` property, and attaches the transaction to the internal `SqlDataAdapter` s `SqlCommand` objects.</span></span> <span data-ttu-id="7c76b-207">`CommitTransaction` a `RollbackTransaction` před zavřením interního objektu `Rollback` zavolá `Transaction` Object s `Commit` a `Connection` metody.</span><span class="sxs-lookup"><span data-stu-id="7c76b-207">`CommitTransaction` and `RollbackTransaction` call the `Transaction` object s `Commit` and `Rollback` methods, respectively, before closing the internal `Connection` object.</span></span>

## <a name="step-3-adding-methods-to-update-and-delete-data-under-the-umbrella-of-a-transaction"></a><span data-ttu-id="7c76b-208">Krok 3: Přidání metod, které aktualizují a odstraňují data v zastřešující transakci</span><span class="sxs-lookup"><span data-stu-id="7c76b-208">Step 3: Adding Methods to Update and Delete Data Under the Umbrella of a Transaction</span></span>

<span data-ttu-id="7c76b-209">Po dokončení těchto metod jsme znovu připraveni přidat metody do `ProductsDataTable` nebo knihoven BLL, které provádějí řadu příkazů v rámci transakce.</span><span class="sxs-lookup"><span data-stu-id="7c76b-209">With these methods complete, we re ready to add methods to `ProductsDataTable` or the BLL that perform a series of commands under the umbrella of a transaction.</span></span> <span data-ttu-id="7c76b-210">Následující metoda používá vzor aktualizace Batch k aktualizaci instance `ProductsDataTable` pomocí transakce.</span><span class="sxs-lookup"><span data-stu-id="7c76b-210">The following method uses the Batch Update pattern to update a `ProductsDataTable` instance using a transaction.</span></span> <span data-ttu-id="7c76b-211">Spustí transakci voláním metody `BeginTransaction` a poté pomocí bloku `Try...Catch` vystaví příkazy pro úpravu dat.</span><span class="sxs-lookup"><span data-stu-id="7c76b-211">It starts a transaction by calling the `BeginTransaction` method and then uses a `Try...Catch` block to issue the data modification statements.</span></span> <span data-ttu-id="7c76b-212">Pokud volání metody `Adapter` objektů `Update` má za následek výjimku, provádění se převede na blok `catch`, kde transakce bude vrácena zpět a výjimka se znovu vyvolala.</span><span class="sxs-lookup"><span data-stu-id="7c76b-212">If the call to the `Adapter` object s `Update` method results in an exception, execution will transfer to the `catch` block where the transaction will be rolled back and the exception re-thrown.</span></span> <span data-ttu-id="7c76b-213">Vyvoláním metody `Update` implementuje vzor aktualizace dávky vytvořením výčtu řádků zadaného `ProductsDataTable` a provedením potřebných `InsertCommand`, `UpdateCommand`a `DeleteCommand` s.</span><span class="sxs-lookup"><span data-stu-id="7c76b-213">Recall that the `Update` method implements the Batch Update pattern by enumerating the rows of the supplied `ProductsDataTable` and performing the necessary `InsertCommand`, `UpdateCommand`, and `DeleteCommand` s.</span></span> <span data-ttu-id="7c76b-214">Pokud některý z těchto příkazů způsobí chybu, transakce se vrátí zpět a vrátí zpět předchozí změny provedené během doby platnosti transakce.</span><span class="sxs-lookup"><span data-stu-id="7c76b-214">If any one of these commands results in an error, the transaction is rolled back, undoing the previous modifications made during the transaction s lifetime.</span></span> <span data-ttu-id="7c76b-215">Pokud by byl příkaz `Update` dokončen bez chyby, transakce je zapsána v celém rozsahu.</span><span class="sxs-lookup"><span data-stu-id="7c76b-215">Should the `Update` statement complete without error, the transaction is committed in its entirety.</span></span>

[!code-vb[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample4.vb)]

<span data-ttu-id="7c76b-216">Přidejte metodu `UpdateWithTransaction` do `ProductsTableAdapter` třídy prostřednictvím částečné třídy v `ProductsTableAdapter.TransactionSupport.vb`.</span><span class="sxs-lookup"><span data-stu-id="7c76b-216">Add the `UpdateWithTransaction` method to the `ProductsTableAdapter` class through the partial class in `ProductsTableAdapter.TransactionSupport.vb`.</span></span> <span data-ttu-id="7c76b-217">Alternativně lze tuto metodu přidat do třídy `ProductsBLL` vrstvy obchodní logiky s několika vedlejšími syntaktickými změnami.</span><span class="sxs-lookup"><span data-stu-id="7c76b-217">Alternatively, this method could be added to the Business Logic Layer s `ProductsBLL` class with a few minor syntactical changes.</span></span> <span data-ttu-id="7c76b-218">Klíčové slovo `Me` v `Me.BeginTransaction()`, `Me.CommitTransaction()`a `Me.RollbackTransaction()` by proto muselo být nahrazeno `Adapter` (odvolání `Adapter` je název vlastnosti v `ProductsBLL` typu `ProductsTableAdapter`).</span><span class="sxs-lookup"><span data-stu-id="7c76b-218">Namely, the keyword `Me` in `Me.BeginTransaction()`, `Me.CommitTransaction()`, and `Me.RollbackTransaction()` would need to be replaced with `Adapter` (recall that `Adapter` is the name of a property in `ProductsBLL` of type `ProductsTableAdapter`).</span></span>

<span data-ttu-id="7c76b-219">Metoda `UpdateWithTransaction` používá vzor aktualizace služby Batch, ale v rámci rozsahu transakce lze také použít řadu volání DB-Direct, jak ukazuje následující metoda.</span><span class="sxs-lookup"><span data-stu-id="7c76b-219">The `UpdateWithTransaction` method uses the Batch Update pattern, but a series of DB-Direct calls can also be used within the scope of a transaction, as the following method shows.</span></span> <span data-ttu-id="7c76b-220">Metoda `DeleteProductsWithTransaction` přijímá jako vstup `List(Of T)` typu `Integer`, což jsou `ProductID` s pro odstranění.</span><span class="sxs-lookup"><span data-stu-id="7c76b-220">The `DeleteProductsWithTransaction` method accepts as input a `List(Of T)` of type `Integer`, which are the `ProductID` s to delete.</span></span> <span data-ttu-id="7c76b-221">Metoda inicializuje transakci prostřednictvím volání `BeginTransaction` a poté v bloku `Try` prochází dodaným seznamem voláním metody `Delete` vzoru DB-Direct pro každou `ProductID` hodnotu.</span><span class="sxs-lookup"><span data-stu-id="7c76b-221">The method initiates the transaction via a call to `BeginTransaction` and then, in the `Try` block, iterates through the supplied list calling the DB-Direct pattern `Delete` method for each `ProductID` value.</span></span> <span data-ttu-id="7c76b-222">Pokud některá z volání `Delete` selžou, řízení je převedeno do `Catch` bloku, kde transakce je vrácena zpět a výjimka je znovu vyvolána.</span><span class="sxs-lookup"><span data-stu-id="7c76b-222">If any of the calls to `Delete` fails, control is transferred to the `Catch` block where the transaction is rolled back and the exception re-thrown.</span></span> <span data-ttu-id="7c76b-223">Pokud všechna volání `Delete` úspěšná, transakce je potvrzena.</span><span class="sxs-lookup"><span data-stu-id="7c76b-223">If all calls to `Delete` succeed, then transaction is committed.</span></span> <span data-ttu-id="7c76b-224">Přidejte tuto metodu do třídy `ProductsBLL`.</span><span class="sxs-lookup"><span data-stu-id="7c76b-224">Add this method to the `ProductsBLL` class.</span></span>

[!code-vb[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample5.vb)]

## <a name="applying-transactions-across-multiple-tableadapters"></a><span data-ttu-id="7c76b-225">Použití transakcí napříč několika objekty TableAdapter</span><span class="sxs-lookup"><span data-stu-id="7c76b-225">Applying Transactions Across Multiple TableAdapters</span></span>

<span data-ttu-id="7c76b-226">Kód, který je v tomto kurzu přezkoumán, umožňuje, aby bylo více příkazů na `ProductsTableAdapter` považováno za atomickou operaci.</span><span class="sxs-lookup"><span data-stu-id="7c76b-226">The transaction-related code examined in this tutorial allows for multiple statements against the `ProductsTableAdapter` to be treated as an atomic operation.</span></span> <span data-ttu-id="7c76b-227">Ale co dělat v případě, že je potřeba provést nedělitelnost více změn v různých databázových tabulkách?</span><span class="sxs-lookup"><span data-stu-id="7c76b-227">But what if multiple modifications to different database tables need to be performed atomically?</span></span> <span data-ttu-id="7c76b-228">Například při odstraňování kategorie můžeme nejdřív chtít změnit přiřazení aktuálních produktů k jiné kategorii.</span><span class="sxs-lookup"><span data-stu-id="7c76b-228">For instance, when deleting a category, we might first want to reassign its current products to some other category.</span></span> <span data-ttu-id="7c76b-229">Tyto dva kroky mění přiřazení produktů a odstraňování kategorie by se měly provádět jako atomická operace.</span><span class="sxs-lookup"><span data-stu-id="7c76b-229">These two steps reassigning the products and deleting the category should be executed as an atomic operation.</span></span> <span data-ttu-id="7c76b-230">`ProductsTableAdapter` však obsahují pouze metody pro úpravu tabulky `Products` a `CategoriesTableAdapter` obsahuje pouze metody pro úpravu tabulky `Categories`.</span><span class="sxs-lookup"><span data-stu-id="7c76b-230">But the `ProductsTableAdapter` includes only methods for modifying the `Products` table and the `CategoriesTableAdapter` includes only methods for modifying the `Categories` table.</span></span> <span data-ttu-id="7c76b-231">Jak může transakce zahrnovat jak objekty TableAdapter?</span><span class="sxs-lookup"><span data-stu-id="7c76b-231">So how can a transaction encompass both TableAdapters?</span></span>

<span data-ttu-id="7c76b-232">Jednou z možností je přidat metodu do `CategoriesTableAdapter` s názvem `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` a tato metoda volá uloženou proceduru, která znovu přiřadí produkty a odstraní kategorii v rámci oboru transakce definované v rámci uložené procedury.</span><span class="sxs-lookup"><span data-stu-id="7c76b-232">One option is to add a method to the `CategoriesTableAdapter` named `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` and have that method call a stored procedure that both reassigns the products and deletes the category within the scope of a transaction defined within the stored procedure.</span></span> <span data-ttu-id="7c76b-233">V budoucím kurzu se podíváme na to, jak začít, potvrzovat a vrátit zpátky transakce v uložených procedurách.</span><span class="sxs-lookup"><span data-stu-id="7c76b-233">We'll look at how to begin, commit, and rollback transactions in stored procedures in a future tutorial.</span></span>

<span data-ttu-id="7c76b-234">Další možností je vytvořit pomocnou třídu v rámci DAL, která obsahuje metodu `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)`.</span><span class="sxs-lookup"><span data-stu-id="7c76b-234">Another option is to create a helper class in the DAL that contains the `DeleteCategoryAndReassignProducts(categoryIDtoDelete, reassignToCategoryID)` method.</span></span> <span data-ttu-id="7c76b-235">Tato metoda vytvoří instanci `CategoriesTableAdapter` a `ProductsTableAdapter` a poté nastaví tyto dvě vlastnosti objekty TableAdapter `Connection` na stejnou instanci `SqlConnection`.</span><span class="sxs-lookup"><span data-stu-id="7c76b-235">This method would create an instance of the `CategoriesTableAdapter` and the `ProductsTableAdapter` and then set these two TableAdapters `Connection` properties to the same `SqlConnection` instance.</span></span> <span data-ttu-id="7c76b-236">V tomto okamžiku buď jedna ze dvou objekty TableAdapter zahájí transakci se voláním `BeginTransaction`.</span><span class="sxs-lookup"><span data-stu-id="7c76b-236">At that point, either one of the two TableAdapters would initiate the transaction with a call to `BeginTransaction`.</span></span> <span data-ttu-id="7c76b-237">Metody objekty TableAdapter pro opětovné přiřazení produktů a odstraňování kategorie by se vyvolaly v `Try...Catch`ovém bloku s transakcí potvrzenou nebo vrácenou zpět podle potřeby.</span><span class="sxs-lookup"><span data-stu-id="7c76b-237">The TableAdapters methods for reassigning the products and deleting the category would be invoked in a `Try...Catch` block with the transaction committed or rolled back as needed.</span></span>

## <a name="step-4-adding-theupdatewithtransactionmethod-to-the-business-logic-layer"></a><span data-ttu-id="7c76b-238">Krok 4: Přidání metody`UpdateWithTransaction`do vrstvy obchodní logiky</span><span class="sxs-lookup"><span data-stu-id="7c76b-238">Step 4: Adding the`UpdateWithTransaction`Method to the Business Logic Layer</span></span>

<span data-ttu-id="7c76b-239">V kroku 3 jsme do `ProductsTableAdapter` do DAL přidali metodu `UpdateWithTransaction`.</span><span class="sxs-lookup"><span data-stu-id="7c76b-239">In Step 3 we added an `UpdateWithTransaction` method to the `ProductsTableAdapter` in the DAL.</span></span> <span data-ttu-id="7c76b-240">Do knihoven BLL bychom měli přidat odpovídající metodu.</span><span class="sxs-lookup"><span data-stu-id="7c76b-240">We should add a corresponding method to the BLL.</span></span> <span data-ttu-id="7c76b-241">Zatímco prezentační vrstva může zavolat přímo dolů na DAL k vyvolání metody `UpdateWithTransaction`, tyto kurzy se snaží definovat vrstvenou architekturu, která z prezentační vrstvy izolaci DAL.</span><span class="sxs-lookup"><span data-stu-id="7c76b-241">While the Presentation Layer could call directly down to the DAL to invoke the `UpdateWithTransaction` method, these tutorials have strived to define a layered architecture that insulates the DAL from the Presentation Layer.</span></span> <span data-ttu-id="7c76b-242">Proto behooves nás, abychom mohli pokračovat v tomto přístupu.</span><span class="sxs-lookup"><span data-stu-id="7c76b-242">Therefore, it behooves us to continue this approach.</span></span>

<span data-ttu-id="7c76b-243">Otevřete soubor `ProductsBLL` třídy a přidejte metodu nazvanou `UpdateWithTransaction`, která jednoduše zavolá do odpovídající metody DAL.</span><span class="sxs-lookup"><span data-stu-id="7c76b-243">Open the `ProductsBLL` class file and add a method named `UpdateWithTransaction` that simply calls down to the corresponding DAL method.</span></span> <span data-ttu-id="7c76b-244">V `ProductsBLL`by teď měly být dvě nové metody: `UpdateWithTransaction`, které jste právě přidali, a `DeleteProductsWithTransaction`, které jste přidali v kroku 3.</span><span class="sxs-lookup"><span data-stu-id="7c76b-244">There should now be two new methods in `ProductsBLL`: `UpdateWithTransaction`, which you just added, and `DeleteProductsWithTransaction`, which was added in Step 3.</span></span>

[!code-vb[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample6.vb)]

> [!NOTE]
> <span data-ttu-id="7c76b-245">Tyto metody neobsahují atribut `DataObjectMethodAttribute` přiřazený většině jiných metod v `ProductsBLL` třídě, protože budeme vydávat tyto metody přímo ze tříd kódu na pozadí ASP.NET stránek.</span><span class="sxs-lookup"><span data-stu-id="7c76b-245">These methods do not include the `DataObjectMethodAttribute` attribute assigned to most other methods in the `ProductsBLL` class because we'll be invoking these methods directly from the ASP.NET pages code-behind classes.</span></span> <span data-ttu-id="7c76b-246">Odvolání tohoto `DataObjectMethodAttribute` slouží k označení toho, jaké metody se mají zobrazit v průvodci ObjectDataSource s konfigurací zdroje dat, a v části jakou kartu (výběr, aktualizace, vložení nebo odstranění).</span><span class="sxs-lookup"><span data-stu-id="7c76b-246">Recall that `DataObjectMethodAttribute` is used to flag what methods should appear in the ObjectDataSource s Configure Data Source wizard and under what tab (SELECT, UPDATE, INSERT, or DELETE).</span></span> <span data-ttu-id="7c76b-247">Vzhledem k tomu, že v prvku GridView chybí integrovaná podpora pro dávkové úpravy nebo odstranění, bude nutné tyto metody vyvolat programově namísto použití deklarativního přístupu bez kódu.</span><span class="sxs-lookup"><span data-stu-id="7c76b-247">Since the GridView lacks any built-in support for batch editing or deleting, we'll have to invoke these methods programmatically rather than use the code-free declarative approach.</span></span>

## <a name="step-5-atomically-updating-database-data-from-the-presentation-layer"></a><span data-ttu-id="7c76b-248">Krok 5: atomická aktualizace databázových dat z prezentační vrstvy</span><span class="sxs-lookup"><span data-stu-id="7c76b-248">Step 5: Atomically Updating Database Data from the Presentation Layer</span></span>

<span data-ttu-id="7c76b-249">Pro ilustraci účinku, který má transakce při aktualizaci dávky záznamů, vytvoříme uživatelské rozhraní, které obsahuje seznam všech produktů v prvku GridView a obsahuje ovládací prvek web Button, který po kliknutí znovu přiřadí produkty `CategoryID` hodnoty.</span><span class="sxs-lookup"><span data-stu-id="7c76b-249">To illustrate the effect that the transaction has when updating a batch of records, let s create a user interface that lists all products in a GridView and includes a Button Web control that, when clicked, reassigns the products `CategoryID` values.</span></span> <span data-ttu-id="7c76b-250">Konkrétně bude postup opětovného přiřazení kategorie mít za následek, že prvnímu z těchto produktů je přiřazena platná `CategoryID` hodnota, zatímco ostatní jsou záměrně přiřazeny neexistující `CategoryID` hodnotě.</span><span class="sxs-lookup"><span data-stu-id="7c76b-250">In particular, the category reassignment will progress so that the first several products are assigned a valid `CategoryID` value while others are purposefully assigned a non-existent `CategoryID` value.</span></span> <span data-ttu-id="7c76b-251">Pokud se pokusíme aktualizovat databázi s produktem, jehož `CategoryID` se neshoduje s `CategoryID`existující kategorie, dojde k porušení omezení cizího klíče a vyvolá se výjimka.</span><span class="sxs-lookup"><span data-stu-id="7c76b-251">If we attempt to update the database with a product whose `CategoryID` does not match an existing category s `CategoryID`, a foreign key constraint violation will occur and an exception will be raised.</span></span> <span data-ttu-id="7c76b-252">V tomto příkladu se dozvíte, že při použití transakce výjimka vyvolaná z porušení omezení cizího klíče způsobí, že se předchozí platná `CategoryID` změny vrátí zpátky.</span><span class="sxs-lookup"><span data-stu-id="7c76b-252">What we'll see in this example is that when using a transaction the exception raised from the foreign key constraint violation will cause the previous valid `CategoryID` changes to be rolled back.</span></span> <span data-ttu-id="7c76b-253">Pokud se však transakce nepoužívá, změny původních kategorií zůstanou.</span><span class="sxs-lookup"><span data-stu-id="7c76b-253">When not using a transaction, however, the modifications to the initial categories will remain.</span></span>

<span data-ttu-id="7c76b-254">Začněte otevřením stránky `Transactions.aspx` ve složce `BatchData` a přetažením prvku GridView z panelu nástrojů do návrháře.</span><span class="sxs-lookup"><span data-stu-id="7c76b-254">Start by opening the `Transactions.aspx` page in the `BatchData` folder and drag a GridView from the Toolbox onto the Designer.</span></span> <span data-ttu-id="7c76b-255">Nastavte jeho `ID` na `Products` a ze své inteligentní značky ho navažte na nový prvek ObjectDataSource s názvem `ProductsDataSource`.</span><span class="sxs-lookup"><span data-stu-id="7c76b-255">Set its `ID` to `Products` and, from its smart tag, bind it to a new ObjectDataSource named `ProductsDataSource`.</span></span> <span data-ttu-id="7c76b-256">Nakonfigurujte prvek ObjectDataSource tak, aby vyčetl data z `ProductsBLL` třídy s `GetProducts` metody.</span><span class="sxs-lookup"><span data-stu-id="7c76b-256">Configure the ObjectDataSource to pull its data from the `ProductsBLL` class s `GetProducts` method.</span></span> <span data-ttu-id="7c76b-257">Toto bude prvek GridView, který je jen pro čtení, proto nastavte rozevírací seznamy na kartách aktualizace, vložení a odstranění na hodnotu (žádné) a klikněte na tlačítko Dokončit.</span><span class="sxs-lookup"><span data-stu-id="7c76b-257">This will be a read-only GridView, so set the drop-down lists in the UPDATE, INSERT, and DELETE tabs to (None) and click Finish.</span></span>

<span data-ttu-id="7c76b-258">[![nakonfigurovat prvek ObjectDataSource tak, aby používal metodu ProductsBLL třídy s GetProducts](wrapping-database-modifications-within-a-transaction-vb/_static/image5.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="7c76b-258">[![Configure the ObjectDataSource to Use the ProductsBLL Class s GetProducts Method](wrapping-database-modifications-within-a-transaction-vb/_static/image5.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image3.png)</span></span>

<span data-ttu-id="7c76b-259">**Obrázek 5**: Konfigurace prvku ObjectDataSource pro použití `GetProducts` metody `ProductsBLL` třídy s ([kliknutím zobrazíte obrázek v plné velikosti](wrapping-database-modifications-within-a-transaction-vb/_static/image4.png))</span><span class="sxs-lookup"><span data-stu-id="7c76b-259">**Figure 5**: Configure the ObjectDataSource to Use the `ProductsBLL` Class s `GetProducts` Method ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-vb/_static/image4.png))</span></span>

<span data-ttu-id="7c76b-260">[![nastavení rozevíracích seznamů na kartách aktualizace, vložení a odstranění na (žádné)](wrapping-database-modifications-within-a-transaction-vb/_static/image6.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="7c76b-260">[![Set the Drop-Down Lists in the UPDATE, INSERT, and DELETE Tabs to (None)](wrapping-database-modifications-within-a-transaction-vb/_static/image6.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image5.png)</span></span>

<span data-ttu-id="7c76b-261">**Obrázek 6**: nastavení rozevíracích seznamů na kartách aktualizace, vložení a odstranění na (žádné) ([kliknutím zobrazíte obrázek v plné velikosti](wrapping-database-modifications-within-a-transaction-vb/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="7c76b-261">**Figure 6**: Set the Drop-Down Lists in the UPDATE, INSERT, and DELETE Tabs to (None) ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-vb/_static/image6.png))</span></span>

<span data-ttu-id="7c76b-262">Po dokončení Průvodce konfigurací zdroje dat vytvoří Visual Studio BoundFields a třídě CheckBoxField podporována pro pole dat produktu.</span><span class="sxs-lookup"><span data-stu-id="7c76b-262">After completing the Configure Data Source wizard, Visual Studio will create BoundFields and a CheckBoxField for the product data fields.</span></span> <span data-ttu-id="7c76b-263">Odeberte všechna tato pole s výjimkou `ProductID`, `ProductName`, `CategoryID`a `CategoryName` a přejmenujte `ProductName` `CategoryName` `HeaderText` vlastností na produkt a kategorii v uvedeném pořadí.</span><span class="sxs-lookup"><span data-stu-id="7c76b-263">Remove all of these fields except for `ProductID`, `ProductName`, `CategoryID`, and `CategoryName` and rename the `ProductName` and `CategoryName` BoundFields `HeaderText` properties to Product and Category, respectively.</span></span> <span data-ttu-id="7c76b-264">Z inteligentní značky zaškrtněte možnost Povolit stránkování.</span><span class="sxs-lookup"><span data-stu-id="7c76b-264">From the smart tag, check the Enable Paging option.</span></span> <span data-ttu-id="7c76b-265">Po provedení těchto úprav by deklarativní označení GridView a ObjectDataSource s mělo vypadat takto:</span><span class="sxs-lookup"><span data-stu-id="7c76b-265">After making these modifications, the GridView and ObjectDataSource s declarative markup should look like the following:</span></span>

[!code-aspx[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample7.aspx)]

<span data-ttu-id="7c76b-266">Dále přidejte tři webové ovládací prvky tlačítka nad ovládací prvek GridView.</span><span class="sxs-lookup"><span data-stu-id="7c76b-266">Next, add three Button Web controls above the GridView.</span></span> <span data-ttu-id="7c76b-267">Nastavte vlastnost text prvního tlačítka na aktualizovat mřížku, druhé s pro úpravu kategorií (s transakcí) a třetí jednu pro úpravu kategorií (bez transakcí).</span><span class="sxs-lookup"><span data-stu-id="7c76b-267">Set the first Button s Text property to Refresh Grid, the second s to Modify Categories (WITH TRANSACTION), and the third one s to Modify Categories (WITHOUT TRANSACTION) .</span></span>

[!code-aspx[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample8.aspx)]

<span data-ttu-id="7c76b-268">V tomto okamžiku by zobrazení Návrh v aplikaci Visual Studio mělo vypadat podobně jako snímek obrazovky, který je znázorněn na obrázku 7.</span><span class="sxs-lookup"><span data-stu-id="7c76b-268">At this point the Design view in Visual Studio should look similar to the screen shot shown in Figure 7.</span></span>

<span data-ttu-id="7c76b-269">[![stránka obsahuje ovládací prvky GridView a tři tlačítka webu](wrapping-database-modifications-within-a-transaction-vb/_static/image7.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="7c76b-269">[![The Page Contains a GridView and Three Button Web Controls](wrapping-database-modifications-within-a-transaction-vb/_static/image7.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image7.png)</span></span>

<span data-ttu-id="7c76b-270">**Obrázek 7**: stránka obsahuje ovládací prvky GridView a tři tlačítka webu ([kliknutím zobrazíte obrázek v plné velikosti](wrapping-database-modifications-within-a-transaction-vb/_static/image8.png)).</span><span class="sxs-lookup"><span data-stu-id="7c76b-270">**Figure 7**: The Page Contains a GridView and Three Button Web Controls ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-vb/_static/image8.png))</span></span>

<span data-ttu-id="7c76b-271">Vytvořte obslužné rutiny událostí pro každé tři tlačítko s `Click` událostí a použijte následující kód:</span><span class="sxs-lookup"><span data-stu-id="7c76b-271">Create event handlers for each of the three Button s `Click` events and use the following code:</span></span>

[!code-vb[Main](wrapping-database-modifications-within-a-transaction-vb/samples/sample9.vb)]

<span data-ttu-id="7c76b-272">Obslužná rutina události `Click` tlačítky aktualizovat jednoduše znovu naváže data na prvek GridView voláním metody `Products` GridView. `DataBind`.</span><span class="sxs-lookup"><span data-stu-id="7c76b-272">The refresh Button s `Click` event handler simply rebinds the data to the GridView by calling the `Products` GridView s `DataBind` method.</span></span>

<span data-ttu-id="7c76b-273">Druhá obslužná rutina události znovu přiřadí produkty `CategoryID` s a používá novou metodu transakce z knihoven BLL k provedení aktualizací databáze za zastřešujícím v rámci transakce.</span><span class="sxs-lookup"><span data-stu-id="7c76b-273">The second event handler reassigns the products `CategoryID` s and uses the new transaction method from the BLL to perform the database updates under the umbrella of a transaction.</span></span> <span data-ttu-id="7c76b-274">Všimněte si, že každý `CategoryID` produktů je libovolně nastavený na stejnou hodnotu jako jeho `ProductID`.</span><span class="sxs-lookup"><span data-stu-id="7c76b-274">Note that each product s `CategoryID` is arbitrarily set to the same value as its `ProductID`.</span></span> <span data-ttu-id="7c76b-275">Tato operace bude pro prvních několik produktů fungovat správně, protože tyto produkty mají `ProductID` hodnoty, které se namapují na platné `CategoryID` s.</span><span class="sxs-lookup"><span data-stu-id="7c76b-275">This will work fine for the first few products, since those products have `ProductID` values that happen to map to valid `CategoryID` s.</span></span> <span data-ttu-id="7c76b-276">Když ale `ProductID` s začne hodně velká, tento překrytí `ProductID` s a `CategoryID` se už nepoužijí.</span><span class="sxs-lookup"><span data-stu-id="7c76b-276">But once the `ProductID` s start getting too large, this coincidental overlap of `ProductID` s and `CategoryID` s no longer applies.</span></span>

<span data-ttu-id="7c76b-277">Třetí `Click` obslužná rutina události aktualizuje produkty `CategoryID` stejným způsobem, ale odešle aktualizaci do databáze pomocí výchozí `Update` metody `ProductsTableAdapter` s.</span><span class="sxs-lookup"><span data-stu-id="7c76b-277">The third `Click` event handler updates the products `CategoryID` s in the same manner, but sends the update to the database using the `ProductsTableAdapter` s default `Update` method.</span></span> <span data-ttu-id="7c76b-278">Tato `Update` metoda nezalomí řadu příkazů v rámci transakce, takže tyto změny jsou provedeny před prvním zjištěným chybou porušení omezení cizího klíče.</span><span class="sxs-lookup"><span data-stu-id="7c76b-278">This `Update` method does not wrap the series of commands within a transaction, so those changes are made prior to the first encountered foreign key constraint violation error will persist.</span></span>

<span data-ttu-id="7c76b-279">Pokud chcete toto chování předvést, navštivte tuto stránku v prohlížeči.</span><span class="sxs-lookup"><span data-stu-id="7c76b-279">To demonstrate this behavior, visit this page through a browser.</span></span> <span data-ttu-id="7c76b-280">Zpočátku byste měli vidět první stránku dat, jak je znázorněno na obrázku 8.</span><span class="sxs-lookup"><span data-stu-id="7c76b-280">Initially you should see the first page of data as shown in Figure 8.</span></span> <span data-ttu-id="7c76b-281">Potom klikněte na tlačítko upravit kategorie (s transakcí).</span><span class="sxs-lookup"><span data-stu-id="7c76b-281">Next, click the Modify Categories (WITH TRANSACTION) button.</span></span> <span data-ttu-id="7c76b-282">Tím dojde k provedení zpětného volání a pokusu o aktualizaci všech produktů `CategoryID` hodnoty, ale výsledkem bude porušení omezení cizího klíče (viz obrázek 9).</span><span class="sxs-lookup"><span data-stu-id="7c76b-282">This will cause a postback and attempt to update all of the products `CategoryID` values, but will result in a foreign key constraint violation (see Figure 9).</span></span>

<span data-ttu-id="7c76b-283">[![se produkty zobrazují ve stránkovém prvku GridView](wrapping-database-modifications-within-a-transaction-vb/_static/image8.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="7c76b-283">[![The Products are Displayed in a Pageable GridView](wrapping-database-modifications-within-a-transaction-vb/_static/image8.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image9.png)</span></span>

<span data-ttu-id="7c76b-284">**Obrázek 8**: produkty se zobrazují ve stránkovém prvku GridView ([kliknutím zobrazíte obrázek v plné velikosti](wrapping-database-modifications-within-a-transaction-vb/_static/image10.png)).</span><span class="sxs-lookup"><span data-stu-id="7c76b-284">**Figure 8**: The Products are Displayed in a Pageable GridView ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-vb/_static/image10.png))</span></span>

<span data-ttu-id="7c76b-285">[![Změna přiřazení kategorií má za následek porušení omezení cizího klíče](wrapping-database-modifications-within-a-transaction-vb/_static/image9.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="7c76b-285">[![Reassigning the Categories Results in a Foreign Key Constraint Violation](wrapping-database-modifications-within-a-transaction-vb/_static/image9.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image11.png)</span></span>

<span data-ttu-id="7c76b-286">**Obrázek 9**: Změna přiřazení kategorií má za následek porušení omezení cizího klíče ([kliknutím zobrazíte obrázek v plné velikosti).](wrapping-database-modifications-within-a-transaction-vb/_static/image12.png)</span><span class="sxs-lookup"><span data-stu-id="7c76b-286">**Figure 9**: Reassigning the Categories Results in a Foreign Key Constraint Violation ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-vb/_static/image12.png))</span></span>

<span data-ttu-id="7c76b-287">Nyní stiskněte tlačítko zpět v prohlížeči a potom klikněte na tlačítko Obnovit mřížku.</span><span class="sxs-lookup"><span data-stu-id="7c76b-287">Now hit your browser s Back button and then click the Refresh Grid button.</span></span> <span data-ttu-id="7c76b-288">Po aktualizaci dat byste měli vidět přesný stejný výstup, jak je znázorněno na obrázku 8.</span><span class="sxs-lookup"><span data-stu-id="7c76b-288">Upon refreshing the data you should see the exact same output as shown in Figure 8.</span></span> <span data-ttu-id="7c76b-289">To znamená, že i když byly některé z produktů `CategoryID` změněny na platné hodnoty a aktualizovány v databázi, byly vráceny zpět v případě, že došlo k porušení omezení cizího klíče.</span><span class="sxs-lookup"><span data-stu-id="7c76b-289">That is, even though some of the products `CategoryID` s were changed to legal values and updated in the database, they were rolled back when the foreign key constraint violation occurred.</span></span>

<span data-ttu-id="7c76b-290">Nyní zkuste kliknout na tlačítko upravit kategorie (bez transakce).</span><span class="sxs-lookup"><span data-stu-id="7c76b-290">Now try clicking the Modify Categories (WITHOUT TRANSACTION) button.</span></span> <span data-ttu-id="7c76b-291">Výsledkem bude stejná chyba při porušení omezení cizího klíče (viz obrázek 9), ale tentokrát se tyto produkty, jejichž hodnoty `CategoryID` změnily na platnou hodnotu, nevrátí zpět.</span><span class="sxs-lookup"><span data-stu-id="7c76b-291">This will result in the same foreign key constraint violation error (see Figure 9), but this time those products whose `CategoryID` values were changed to a legal value will not be rolled back.</span></span> <span data-ttu-id="7c76b-292">Stiskněte tlačítko zpět v prohlížeči a pak klikněte na tlačítko Obnovit mřížku.</span><span class="sxs-lookup"><span data-stu-id="7c76b-292">Hit your browser s Back button and then the Refresh Grid button.</span></span> <span data-ttu-id="7c76b-293">Jak ukazuje obrázek 10, `CategoryID` s prvních osm produkty byly znovu přiřazeny.</span><span class="sxs-lookup"><span data-stu-id="7c76b-293">As Figure 10 shows, the `CategoryID` s of the first eight products have been reassigned.</span></span> <span data-ttu-id="7c76b-294">Například na obrázku 8 má změn `CategoryID` hodnotu 1, ale na obrázku 10 bylo přiřazeno 2.</span><span class="sxs-lookup"><span data-stu-id="7c76b-294">For example, in Figure 8, Chang had a `CategoryID` of 1, but in Figure 10 it s been reassigned to 2.</span></span>

<span data-ttu-id="7c76b-295">[![některé produkty v hodnotách KódKategorie byly aktualizovány, zatímco jiné nebyly](wrapping-database-modifications-within-a-transaction-vb/_static/image10.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="7c76b-295">[![Some Products CategoryID Values were Updated While Others Were Not](wrapping-database-modifications-within-a-transaction-vb/_static/image10.gif)](wrapping-database-modifications-within-a-transaction-vb/_static/image13.png)</span></span>

<span data-ttu-id="7c76b-296">**Obrázek 10**: některé produkty `CategoryID` hodnoty byly aktualizovány, i když jiné nebyly ([kliknutím zobrazíte obrázek v plné velikosti).](wrapping-database-modifications-within-a-transaction-vb/_static/image14.png)</span><span class="sxs-lookup"><span data-stu-id="7c76b-296">**Figure 10**: Some Products `CategoryID` Values were Updated While Others Were Not ([Click to view full-size image](wrapping-database-modifications-within-a-transaction-vb/_static/image14.png))</span></span>

## <a name="summary"></a><span data-ttu-id="7c76b-297">Souhrn</span><span class="sxs-lookup"><span data-stu-id="7c76b-297">Summary</span></span>

<span data-ttu-id="7c76b-298">Ve výchozím nastavení metody TableAdapter s nebalí provedené příkazy databáze v rámci oboru transakce, ale s malým množstvím práce můžeme přidat metody, které vytvoří, potvrdí a vrátí zpět transakci.</span><span class="sxs-lookup"><span data-stu-id="7c76b-298">By default, the TableAdapter s methods do not wrap the executed database statements within the scope of a transaction, but with a little work we can add methods that will create, commit, and rollback a transaction.</span></span> <span data-ttu-id="7c76b-299">V tomto kurzu jsme vytvořili tři takové metody ve třídě `ProductsTableAdapter`: `BeginTransaction`, `CommitTransaction`a `RollbackTransaction`.</span><span class="sxs-lookup"><span data-stu-id="7c76b-299">In this tutorial we created three such methods in the `ProductsTableAdapter` class: `BeginTransaction`, `CommitTransaction`, and `RollbackTransaction`.</span></span> <span data-ttu-id="7c76b-300">Zjistili jsme, jak tyto metody použít spolu s blokem `Try...Catch` a vytvořit tak řadu příkazů pro úpravu dat.</span><span class="sxs-lookup"><span data-stu-id="7c76b-300">We saw how to use these methods along with a `Try...Catch` block to make a series of data modification statements atomic.</span></span> <span data-ttu-id="7c76b-301">Konkrétně jsme vytvořili metodu `UpdateWithTransaction` v `ProductsTableAdapter`, která používá vzor aktualizace Batch k provedení nezbytných úprav řádků zadaného `ProductsDataTable`.</span><span class="sxs-lookup"><span data-stu-id="7c76b-301">In particular, we created the `UpdateWithTransaction` method in the `ProductsTableAdapter`, which uses the Batch Update pattern to perform the necessary modifications to the rows of a supplied `ProductsDataTable`.</span></span> <span data-ttu-id="7c76b-302">Přidali jsme také metodu `DeleteProductsWithTransaction` do `ProductsBLL` třídy v knihoven BLL, která přijímá `List` `ProductID` hodnot jako svůj vstup a volá metodu vzoru DB-Direct `Delete` pro každý `ProductID`.</span><span class="sxs-lookup"><span data-stu-id="7c76b-302">We also added the `DeleteProductsWithTransaction` method to the `ProductsBLL` class in the BLL, which accepts a `List` of `ProductID` values as its input and calls the DB-Direct pattern method `Delete` for each `ProductID`.</span></span> <span data-ttu-id="7c76b-303">Obě metody se spustí vytvořením transakce a následným spuštěním příkazů pro úpravu dat v rámci `Try...Catch`ho bloku.</span><span class="sxs-lookup"><span data-stu-id="7c76b-303">Both methods start by creating a transaction and then executing the data modification statements within a `Try...Catch` block.</span></span> <span data-ttu-id="7c76b-304">Pokud dojde k výjimce, transakce je vrácena zpět, jinak je potvrzena.</span><span class="sxs-lookup"><span data-stu-id="7c76b-304">If an exception occurs, the transaction is rolled back, otherwise it is committed.</span></span>

<span data-ttu-id="7c76b-305">Krok 5 ilustruje účinek transakčních aktualizací dávek a aktualizací dávek, které opomíjeny použít transakci.</span><span class="sxs-lookup"><span data-stu-id="7c76b-305">Step 5 illustrated the effect of transactional batch updates versus batch updates that neglected to use a transaction.</span></span> <span data-ttu-id="7c76b-306">V následujících třech kurzech vytvoříme základ uvedený v tomto kurzu a vytvoříme uživatelská rozhraní pro provádění aktualizací dávek, odstraňování a vkládání.</span><span class="sxs-lookup"><span data-stu-id="7c76b-306">In the next three tutorials we will build upon the foundation laid in this tutorial and create user interfaces for performing batch updates, deletes, and inserts.</span></span>

<span data-ttu-id="7c76b-307">Šťastné programování!</span><span class="sxs-lookup"><span data-stu-id="7c76b-307">Happy Programming!</span></span>

## <a name="further-reading"></a><span data-ttu-id="7c76b-308">Další čtení</span><span class="sxs-lookup"><span data-stu-id="7c76b-308">Further Reading</span></span>

<span data-ttu-id="7c76b-309">Další informace o tématech popsaných v tomto kurzu najdete v následujících zdrojích informací:</span><span class="sxs-lookup"><span data-stu-id="7c76b-309">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- [<span data-ttu-id="7c76b-310">Údržba konzistence databáze s transakcemi</span><span class="sxs-lookup"><span data-stu-id="7c76b-310">Maintaining Database Consistency with Transactions</span></span>](http://aspnet.4guysfromrolla.com/articles/072705-1.aspx)
- [<span data-ttu-id="7c76b-311">Správa transakcí v uložených procedurách SQL Server</span><span class="sxs-lookup"><span data-stu-id="7c76b-311">Managing Transactions in SQL Server Stored Procedures</span></span>](http://www.4guysfromrolla.com/webtech/080305-1.shtml)
- [<span data-ttu-id="7c76b-312">Jednoduché transakce: `System.Transactions`</span><span class="sxs-lookup"><span data-stu-id="7c76b-312">Transactions Made Easy: `System.Transactions`</span></span>](https://blogs.msdn.com/florinlazar/archive/2004/07/23/192239.aspx)
- [<span data-ttu-id="7c76b-313">Objekt TransactionScope a dataadaptéry</span><span class="sxs-lookup"><span data-stu-id="7c76b-313">TransactionScope and DataAdapters</span></span>](http://andyclymer.blogspot.com/2007/01/transactionscope-and-dataadapters.html)
- [<span data-ttu-id="7c76b-314">Používání transakcí Oracle Database v .NET</span><span class="sxs-lookup"><span data-stu-id="7c76b-314">Using Oracle Database Transactions in .NET</span></span>](http://www.oracle.com/technology/pub/articles/price_dbtrans_dotnet.html)

## <a name="about-the-author"></a><span data-ttu-id="7c76b-315">O autorovi</span><span class="sxs-lookup"><span data-stu-id="7c76b-315">About the Author</span></span>

<span data-ttu-id="7c76b-316">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), autor 7 ASP/ASP. NET Books a zakladatel of [4GuysFromRolla.com](http://www.4guysfromrolla.com), pracoval s webovými technologiemi Microsoftu od 1998.</span><span class="sxs-lookup"><span data-stu-id="7c76b-316">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="7c76b-317">Scott funguje jako nezávislý konzultant, Trainer a zapisovač.</span><span class="sxs-lookup"><span data-stu-id="7c76b-317">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="7c76b-318">Nejnovější kniha je [*Sams naučit se ASP.NET 2,0 za 24 hodin*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span><span class="sxs-lookup"><span data-stu-id="7c76b-318">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="7c76b-319">Dá se získat na [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="7c76b-319">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="7c76b-320">nebo prostřednictvím svého blogu, který najdete na adrese [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span><span class="sxs-lookup"><span data-stu-id="7c76b-320">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="7c76b-321">Zvláštní díky</span><span class="sxs-lookup"><span data-stu-id="7c76b-321">Special Thanks To</span></span>

<span data-ttu-id="7c76b-322">Tato řada kurzů byla přezkoumána mnoha užitečnými kontrolory.</span><span class="sxs-lookup"><span data-stu-id="7c76b-322">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="7c76b-323">Kontroloři vedoucích k tomuto kurzu byli Dave Gardner, Hilton Giesenow a Teresa Murphy.</span><span class="sxs-lookup"><span data-stu-id="7c76b-323">Lead reviewers for this tutorial were Dave Gardner, Hilton Giesenow, and Teresa Murphy.</span></span> <span data-ttu-id="7c76b-324">Uvažujete o přezkoumání mých nadcházejících článků na webu MSDN?</span><span class="sxs-lookup"><span data-stu-id="7c76b-324">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="7c76b-325">Pokud ano, vyřaďte mi řádek na [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="7c76b-325">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="7c76b-326">[Předchozí](batch-inserting-cs.md)
> [Další](batch-updating-vb.md)</span><span class="sxs-lookup"><span data-stu-id="7c76b-326">[Previous](batch-inserting-cs.md)
[Next](batch-updating-vb.md)</span></span>
