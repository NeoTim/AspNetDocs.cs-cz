---
uid: web-forms/overview/older-versions-getting-started/continuing-with-ef/handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application
title: Ošetření souběžnosti se sadou Entity Framework 4.0 v ASP.NET 4 webové aplikace | Dokumentace Microsoftu
author: tdykstra
description: V této sérii kurzů staví na Contoso University webovou aplikaci, která se vytvořila Začínáme s Entity Framework 4.0 série kurzů. I...
ms.author: riande
ms.date: 01/26/2011
ms.assetid: a5aa22a6-fb7f-4f41-9c7f-addda151940b
msc.legacyurl: /web-forms/overview/older-versions-getting-started/continuing-with-ef/handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application
msc.type: authoredcontent
ms.openlocfilehash: fc9ce539005bce1790c726dfb859305f4ff78a6b
ms.sourcegitcommit: 0f1119340e4464720cfd16d0ff15764746ea1fea
ms.translationtype: MT
ms.contentlocale: cs-CZ
ms.lasthandoff: 04/17/2019
ms.locfileid: "59422561"
---
# <a name="handling-concurrency-with-the-entity-framework-40-in-an-aspnet-4-web-application"></a><span data-ttu-id="d3d96-104">Ošetření souběžnosti se sadou Entity Framework 4.0 v ASP.NET 4 webové aplikace</span><span class="sxs-lookup"><span data-stu-id="d3d96-104">Handling Concurrency with the Entity Framework 4.0 in an ASP.NET 4 Web Application</span></span>

<span data-ttu-id="d3d96-105">podle [Petr Dykstra](https://github.com/tdykstra)</span><span class="sxs-lookup"><span data-stu-id="d3d96-105">by [Tom Dykstra](https://github.com/tdykstra)</span></span>

> <span data-ttu-id="d3d96-106">V této sérii kurzů staví na Contoso University webovou aplikaci, která se vytvořila [Začínáme s Entity Framework 4.0](https://asp.net/entity-framework/tutorials#Getting%20Started) série kurzů.</span><span class="sxs-lookup"><span data-stu-id="d3d96-106">This tutorial series builds on the Contoso University web application that is created by the [Getting Started with the Entity Framework 4.0](https://asp.net/entity-framework/tutorials#Getting%20Started) tutorial series.</span></span> <span data-ttu-id="d3d96-107">Pokud nebyla dokončena v předchozích kurzech, jako výchozí bod pro účely tohoto kurzu můžete [stáhnout aplikaci](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) , kterou by jste vytvořili.</span><span class="sxs-lookup"><span data-stu-id="d3d96-107">If you didn't complete the earlier tutorials, as a starting point for this tutorial you can [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) that you would have created.</span></span> <span data-ttu-id="d3d96-108">Můžete také [stáhnout aplikaci](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) , který vytvoří kompletní série kurzů.</span><span class="sxs-lookup"><span data-stu-id="d3d96-108">You can also [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) that is created by the complete tutorial series.</span></span> <span data-ttu-id="d3d96-109">Pokud máte dotazy týkající se těchto kurzů, můžete je publikovat [fórum ASP.NET Entity Framework](https://forums.asp.net/1227.aspx).</span><span class="sxs-lookup"><span data-stu-id="d3d96-109">If you have questions about the tutorials, you can post them to the [ASP.NET Entity Framework forum](https://forums.asp.net/1227.aspx).</span></span>


<span data-ttu-id="d3d96-110">V předchozím kurzu jste zjistili, jak řadit a filtrovat data s využitím `ObjectDataSource` ovládacího prvku a Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="d3d96-110">In the previous tutorial you learned how to sort and filter data using the `ObjectDataSource` control and the Entity Framework.</span></span> <span data-ttu-id="d3d96-111">Tento kurz ukazuje možnosti pro ošetření souběžnosti ve webové aplikaci ASP.NET, která používá Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="d3d96-111">This tutorial shows options for handling concurrency in an ASP.NET web application that uses the Entity Framework.</span></span> <span data-ttu-id="d3d96-112">Vytvoří novou webovou stránku, který je vyhrazen pro aktualizaci přiřazení office instruktorem.</span><span class="sxs-lookup"><span data-stu-id="d3d96-112">You will create a new web page that's dedicated to updating instructor office assignments.</span></span> <span data-ttu-id="d3d96-113">Postaráme potíže se souběžností na této stránce a na stránce oddělení, který jste vytvořili dříve.</span><span class="sxs-lookup"><span data-stu-id="d3d96-113">You'll handle concurrency issues in that page and in the Departments page that you created earlier.</span></span>

<span data-ttu-id="d3d96-114">[![Image06](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image2.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="d3d96-114">[![Image06](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image2.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image1.png)</span></span>

<span data-ttu-id="d3d96-115">[![Image01](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image4.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="d3d96-115">[![Image01](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image4.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image3.png)</span></span>

## <a name="concurrency-conflicts"></a><span data-ttu-id="d3d96-116">Konflikty souběžnosti</span><span class="sxs-lookup"><span data-stu-id="d3d96-116">Concurrency Conflicts</span></span>

<span data-ttu-id="d3d96-117">Když jeden uživatel upraví záznam a jiný uživatel upraví stejný záznam před první uživatel změn je zapsána do databáze dojde ke konfliktu souběžnosti.</span><span class="sxs-lookup"><span data-stu-id="d3d96-117">A concurrency conflict occurs when one user edits a record and another user edits the same record before the first user's change is written to the database.</span></span> <span data-ttu-id="d3d96-118">Pokud nenastavíte Entity Framework takové konflikty je zjistit, kdo aktualizuje databázi poslední přepíše změny dalších uživatelů.</span><span class="sxs-lookup"><span data-stu-id="d3d96-118">If you don't set up the Entity Framework to detect such conflicts, whoever updates the database last overwrites the other user's changes.</span></span> <span data-ttu-id="d3d96-119">V mnoha aplikacích toto riziko je přijatelné a není nutné nakonfigurovat aplikaci pro zpracování konfliktů souběžnosti je to možné.</span><span class="sxs-lookup"><span data-stu-id="d3d96-119">In many applications, this risk is acceptable, and you don't have to configure the application to handle possible concurrency conflicts.</span></span> <span data-ttu-id="d3d96-120">(Pokud existuje několik uživatelů nebo několik aktualizací, nebo pokud není skutečně důležité, pokud některé změny budou přepsány, výhody vyváží nižší náklady na programování pro souběžnost.) Pokud není nutné se starat o konfliktů souběžnosti, můžete přeskočit tento kurz; Zbývající dva kurzy z této série nejsou závislé na všechno, co vytvoříte v tohoto objektu.</span><span class="sxs-lookup"><span data-stu-id="d3d96-120">(If there are few users, or few updates, or if isn't really critical if some changes are overwritten, the cost of programming for concurrency might outweigh the benefit.) If you don't need to worry about concurrency conflicts, you can skip this tutorial; the remaining two tutorials in the series don't depend on anything you build in this one.</span></span>

### <a name="pessimistic-concurrency-locking"></a><span data-ttu-id="d3d96-121">Pesimistická souběžnost (uzamčení)</span><span class="sxs-lookup"><span data-stu-id="d3d96-121">Pessimistic Concurrency (Locking)</span></span>

<span data-ttu-id="d3d96-122">Pokud vaše aplikace potřebuje se tak ztrátě dat ve scénářích souběžnosti, je to udělat jedním ze způsobů použití uzamčení databáze.</span><span class="sxs-lookup"><span data-stu-id="d3d96-122">If your application does need to prevent accidental data loss in concurrency scenarios, one way to do that is to use database locks.</span></span> <span data-ttu-id="d3d96-123">Tento postup se nazývá *Pesimistická souběžnost*.</span><span class="sxs-lookup"><span data-stu-id="d3d96-123">This is called *pessimistic concurrency*.</span></span> <span data-ttu-id="d3d96-124">Například předtím, než se pustíte do čtení řádku z databáze, můžete požádat o zámek pro jen pro čtení nebo pro přístup k aktualizaci.</span><span class="sxs-lookup"><span data-stu-id="d3d96-124">For example, before you read a row from a database, you request a lock for read-only or for update access.</span></span> <span data-ttu-id="d3d96-125">Pokud řádek pro aktualizaci přístup, žádné uživatelé můžou zamknout řádku, buď pro jen pro čtení nebo aktualizaci přístup, protože by dostanou kopii dat, která se právě mění.</span><span class="sxs-lookup"><span data-stu-id="d3d96-125">If you lock a row for update access, no other users are allowed to lock the row either for read-only or update access, because they would get a copy of data that's in the process of being changed.</span></span> <span data-ttu-id="d3d96-126">Pokud řádek pro přístup jen pro čtení, ostatní také zařízení Uzamknout pro přístup jen pro čtení, ale ne pro aktualizace.</span><span class="sxs-lookup"><span data-stu-id="d3d96-126">If you lock a row for read-only access, others can also lock it for read-only access but not for update.</span></span>

<span data-ttu-id="d3d96-127">Zámky pro správu obsahuje i určité nevýhody.</span><span class="sxs-lookup"><span data-stu-id="d3d96-127">Managing locks has some disadvantages.</span></span> <span data-ttu-id="d3d96-128">Může být složité do programu.</span><span class="sxs-lookup"><span data-stu-id="d3d96-128">It can be complex to program.</span></span> <span data-ttu-id="d3d96-129">Vyžaduje významné databáze správy zdrojů, a to může způsobit problémy s výkonem jako počet uživatelů aplikace zvyšuje (to znamená, ho nemá uspokojivé škálování).</span><span class="sxs-lookup"><span data-stu-id="d3d96-129">It requires significant database management resources, and it can cause performance problems as the number of users of an application increases (that is, it doesn't scale well).</span></span> <span data-ttu-id="d3d96-130">Z těchto důvodů ne všechny systémy správy databáze nepodporují Pesimistická souběžnost.</span><span class="sxs-lookup"><span data-stu-id="d3d96-130">For these reasons, not all database management systems support pessimistic concurrency.</span></span> <span data-ttu-id="d3d96-131">Entity Framework obsahuje předdefinovanou podporu pro ni a v tomto kurzu nezobrazí způsobu jeho implementace.</span><span class="sxs-lookup"><span data-stu-id="d3d96-131">The Entity Framework provides no built-in support for it, and this tutorial doesn't show you how to implement it.</span></span>

### <a name="optimistic-concurrency"></a><span data-ttu-id="d3d96-132">Optimistická metoda souběžného zpracování</span><span class="sxs-lookup"><span data-stu-id="d3d96-132">Optimistic Concurrency</span></span>

<span data-ttu-id="d3d96-133">Je alternativou k Pesimistická souběžnost *optimistického řízení souběžnosti*.</span><span class="sxs-lookup"><span data-stu-id="d3d96-133">The alternative to pessimistic concurrency is *optimistic concurrency*.</span></span> <span data-ttu-id="d3d96-134">Povolení konfliktů souběžnosti, která se provede a reaguje správně, pokud tomu znamená, že optimistického řízení souběžnosti.</span><span class="sxs-lookup"><span data-stu-id="d3d96-134">Optimistic concurrency means allowing concurrency conflicts to happen, and then reacting appropriately if they do.</span></span> <span data-ttu-id="d3d96-135">Například Jan spustí *Department.aspx* stránce, kliknutí **upravit** odkaz pro oddělení historie a snižuje **rozpočtu** částku od 1,000,000.00 $ $ 125,000.00.</span><span class="sxs-lookup"><span data-stu-id="d3d96-135">For example, John runs the *Department.aspx* page, clicks the **Edit** link for the History department, and reduces the **Budget** amount from $1,000,000.00 to $125,000.00.</span></span> <span data-ttu-id="d3d96-136">(Jan spravuje konkurenční oddělení a chce uvolnit tak peníze pro své oddělení.)</span><span class="sxs-lookup"><span data-stu-id="d3d96-136">(John administers a competing department and wants to free up money for his own department.)</span></span>

<span data-ttu-id="d3d96-137">[![Image07](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image6.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="d3d96-137">[![Image07](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image6.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image5.png)</span></span>

<span data-ttu-id="d3d96-138">Předtím, než Jan klikne **aktualizace**, Jana běží na stejné stránce, kliknutí **upravit** odkaz historie oddělení, a potom klepněte na změny **datum zahájení** pole z 1/10/2011 na 1/1 / 1999.</span><span class="sxs-lookup"><span data-stu-id="d3d96-138">Before John clicks **Update**, Jane runs the same page, clicks the **Edit** link for the History department, and then changes the **Start Date** field from 1/10/2011 to 1/1/1999.</span></span> <span data-ttu-id="d3d96-139">(Jana spravuje oddělení historie a chce, aby se pro ni další služební.)</span><span class="sxs-lookup"><span data-stu-id="d3d96-139">(Jane administers the History department and wants to give it more seniority.)</span></span>

<span data-ttu-id="d3d96-140">[![Image08](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image8.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="d3d96-140">[![Image08](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image8.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image7.png)</span></span>

<span data-ttu-id="d3d96-141">Jan klikne **aktualizace** pak Jana nejprve klikne **aktualizace**.</span><span class="sxs-lookup"><span data-stu-id="d3d96-141">John clicks **Update** first, then Jane clicks **Update**.</span></span> <span data-ttu-id="d3d96-142">Jana prohlížeč teď seznamy **rozpočtu** objem $1,000,000.00, ale to je nesprávná, protože velikost změnila Jan na 125,000.00 $.</span><span class="sxs-lookup"><span data-stu-id="d3d96-142">Jane's browser now lists the **Budget** amount as $1,000,000.00, but this is incorrect because the amount has been changed by John to $125,000.00.</span></span>

<span data-ttu-id="d3d96-143">Některé akce, které si můžete v tomto scénáři patří:</span><span class="sxs-lookup"><span data-stu-id="d3d96-143">Some of the actions you can take in this scenario include the following:</span></span>

- <span data-ttu-id="d3d96-144">Můžete sledovat, které vlastnosti uživatele byl změněn a aktualizovat pouze odpovídající sloupce v databázi.</span><span class="sxs-lookup"><span data-stu-id="d3d96-144">You can keep track of which property a user has modified and update only the corresponding columns in the database.</span></span> <span data-ttu-id="d3d96-145">V ukázkovém scénáři žádné by dojít ke ztrátě dat., protože různé vlastnosti byly aktualizovány dva uživatelé.</span><span class="sxs-lookup"><span data-stu-id="d3d96-145">In the example scenario, no data would be lost, because different properties were updated by the two users.</span></span> <span data-ttu-id="d3d96-146">Při příštím někdo prohlíží historii oddělení, zobrazí se 1/1/1999 a 125,000.00 $.</span><span class="sxs-lookup"><span data-stu-id="d3d96-146">The next time someone browses the History department, they will see 1/1/1999 and $125,000.00.</span></span> 

    <span data-ttu-id="d3d96-147">Toto je výchozí chování v Entity Framework a může podstatně snížit počet konfliktů, ke kterým může dojít ke ztrátě.</span><span class="sxs-lookup"><span data-stu-id="d3d96-147">This is the default behavior in the Entity Framework, and it can substantially reduce the number of conflicts that could result in data loss.</span></span> <span data-ttu-id="d3d96-148">Ale toto chování není nedošlo ke ztrátě dat. Pokud konkurenční změn na stejnou vlastnost entity.</span><span class="sxs-lookup"><span data-stu-id="d3d96-148">However, this behavior doesn't avoid data loss if competing changes are made to the same property of an entity.</span></span> <span data-ttu-id="d3d96-149">Kromě toho není toto chování vždycky možné; Při mapování uložené procedury pro typ entity, všechny vlastnosti entity jsou aktualizovány při jakékoli změny v entitě v databázi.</span><span class="sxs-lookup"><span data-stu-id="d3d96-149">In addition, this behavior isn't always possible; when you map stored procedures to an entity type, all of an entity's properties are updated when any changes to the entity are made in the database.</span></span>
- <span data-ttu-id="d3d96-150">Můžete umožnit změnu Jana John's změna přepsána.</span><span class="sxs-lookup"><span data-stu-id="d3d96-150">You can let Jane's change overwrite John's change.</span></span> <span data-ttu-id="d3d96-151">Po kliknutí Jana **aktualizace**, **rozpočtu** částka se vrátí do 1,000,000.00 $.</span><span class="sxs-lookup"><span data-stu-id="d3d96-151">After Jane clicks **Update**, the **Budget** amount goes back to $1,000,000.00.</span></span> <span data-ttu-id="d3d96-152">Tento postup se nazývá *Wins, klient* nebo *poslední ve službě Wins* scénář.</span><span class="sxs-lookup"><span data-stu-id="d3d96-152">This is called a *Client Wins* or *Last in Wins* scenario.</span></span> <span data-ttu-id="d3d96-153">(Hodnoty klienta přednost co je v úložišti.)</span><span class="sxs-lookup"><span data-stu-id="d3d96-153">(The client's values take precedence over what's in the data store.)</span></span>
- <span data-ttu-id="d3d96-154">Jana změny můžete zabránit aktualizují v databázi.</span><span class="sxs-lookup"><span data-stu-id="d3d96-154">You can prevent Jane's change from being updated in the database.</span></span> <span data-ttu-id="d3d96-155">By obvykle zobrazí chybovou zprávu, zobrazit její aktuální stav dat a manažerovi zadejte znovu své změny, pokud chce je.</span><span class="sxs-lookup"><span data-stu-id="d3d96-155">Typically, you would display an error message, show her the current state of the data, and allow her to reenter her changes if she still wants to make them.</span></span> <span data-ttu-id="d3d96-156">Uložením svůj vstup a poskytne jí příležitost znovu bez nutnosti znovu zadat ho může dál automatizovat proces.</span><span class="sxs-lookup"><span data-stu-id="d3d96-156">You could further automate the process by saving her input and giving her an opportunity to reapply it without having to reenter it.</span></span> <span data-ttu-id="d3d96-157">Tento postup se nazývá *Store Wins* scénář.</span><span class="sxs-lookup"><span data-stu-id="d3d96-157">This is called a *Store Wins* scenario.</span></span> <span data-ttu-id="d3d96-158">(Hodnoty úložiště dat přednost hodnoty odeslány klientem.)</span><span class="sxs-lookup"><span data-stu-id="d3d96-158">(The data-store values take precedence over the values submitted by the client.)</span></span>

### <a name="detecting-concurrency-conflicts"></a><span data-ttu-id="d3d96-159">Zjišťování konfliktů souběžnosti</span><span class="sxs-lookup"><span data-stu-id="d3d96-159">Detecting Concurrency Conflicts</span></span>

<span data-ttu-id="d3d96-160">V rozhraní Entity Framework lze vyřešit konflikty zpracování `OptimisticConcurrencyException` výjimky, které vyvolá rozhraní Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="d3d96-160">In the Entity Framework, you can resolve conflicts by handling `OptimisticConcurrencyException` exceptions that the Entity Framework throws.</span></span> <span data-ttu-id="d3d96-161">Pokud chcete zjistit, kdy se má vyvolat tyto výjimky, musí být schopen rozpoznat konflikty Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="d3d96-161">In order to know when to throw these exceptions, the Entity Framework must be able to detect conflicts.</span></span> <span data-ttu-id="d3d96-162">Proto je nutné nakonfigurovat databázi a datový model odpovídajícím způsobem.</span><span class="sxs-lookup"><span data-stu-id="d3d96-162">Therefore, you must configure the database and the data model appropriately.</span></span> <span data-ttu-id="d3d96-163">Některé možnosti aktivace zjišťování konfliktů, patří:</span><span class="sxs-lookup"><span data-stu-id="d3d96-163">Some options for enabling conflict detection include the following:</span></span>

- <span data-ttu-id="d3d96-164">V databázi zahrnují sloupce tabulky, který slouží k určení, kdy změnil řádek.</span><span class="sxs-lookup"><span data-stu-id="d3d96-164">In the database, include a table column that can be used to determine when a row has been changed.</span></span> <span data-ttu-id="d3d96-165">Potom můžete nakonfigurovat rozhraní Entity Framework patří tento sloupec ve `Where` klauzule SQL `Update` nebo `Delete` příkazy.</span><span class="sxs-lookup"><span data-stu-id="d3d96-165">You can then configure the Entity Framework to include that column in the `Where` clause of SQL `Update` or `Delete` commands.</span></span>

    <span data-ttu-id="d3d96-166">To je účel `Timestamp` sloupec v `OfficeAssignment` tabulky.</span><span class="sxs-lookup"><span data-stu-id="d3d96-166">That's the purpose of the `Timestamp` column in the `OfficeAssignment` table.</span></span>

    <span data-ttu-id="d3d96-167">[![Image09](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image10.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="d3d96-167">[![Image09](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image10.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image9.png)</span></span>

    <span data-ttu-id="d3d96-168">Datový typ `Timestamp` sloupce se také nazývá `Timestamp`.</span><span class="sxs-lookup"><span data-stu-id="d3d96-168">The data type of the `Timestamp` column is also called `Timestamp`.</span></span> <span data-ttu-id="d3d96-169">Sloupec však skutečně neobsahuje hodnotu data a času.</span><span class="sxs-lookup"><span data-stu-id="d3d96-169">However, the column doesn't actually contain a date or time value.</span></span> <span data-ttu-id="d3d96-170">Místo toho je hodnota pořadové číslo, které se zvýší pokaždé, když se aktualizuje řádek.</span><span class="sxs-lookup"><span data-stu-id="d3d96-170">Instead, the value is a sequential number that's incremented each time the row is updated.</span></span> <span data-ttu-id="d3d96-171">V `Update` nebo `Delete` příkazu `Where` klauzule obsahuje původní `Timestamp` hodnotu.</span><span class="sxs-lookup"><span data-stu-id="d3d96-171">In an `Update` or `Delete` command, the `Where` clause includes the original `Timestamp` value.</span></span> <span data-ttu-id="d3d96-172">Pokud se změnila řádek aktualizován jiným uživatelem, hodnota v `Timestamp` se liší od původní hodnoty, proto `Where` klauzule vrátí žádný řádek aktualizovat.</span><span class="sxs-lookup"><span data-stu-id="d3d96-172">If the row being updated has been changed by another user, the value in `Timestamp` is different than the original value, so the `Where` clause returns no row to update.</span></span> <span data-ttu-id="d3d96-173">Při Entity Framework zjistí, že byly aktualizovány žádné řádky aktuální `Update` nebo `Delete` příkazu (to znamená, když počet ovlivněných řádků je nula), který interpretuje jako ke konfliktu souběžnosti.</span><span class="sxs-lookup"><span data-stu-id="d3d96-173">When the Entity Framework finds that no rows have been updated by the current `Update` or `Delete` command (that is, when the number of affected rows is zero), it interprets that as a concurrency conflict.</span></span>
- <span data-ttu-id="d3d96-174">Konfigurace rozhraní Entity Framework pro zahrnutí původní hodnota každý sloupec v tabulce `Where` klauzuli `Update` a `Delete` příkazy.</span><span class="sxs-lookup"><span data-stu-id="d3d96-174">Configure the Entity Framework to include the original values of every column in the table in the `Where` clause of `Update` and `Delete` commands.</span></span>

    <span data-ttu-id="d3d96-175">Jako první možnost, pokud něco v řádku od řádku se nejdřív přečíst, změnila `Where` klauzule nevrátí řádek k aktualizaci, která nastavení interpretuje Entity Framework jako ke konfliktu souběžnosti.</span><span class="sxs-lookup"><span data-stu-id="d3d96-175">As in the first option, if anything in the row has changed since the row was first read, the `Where` clause won't return a row to update, which the Entity Framework interprets as a concurrency conflict.</span></span> <span data-ttu-id="d3d96-176">Tato metoda je co nejúčinnější pomocí `Timestamp` pole, ale může být neefektivní.</span><span class="sxs-lookup"><span data-stu-id="d3d96-176">This method is as effective as using a `Timestamp` field, but can be inefficient.</span></span> <span data-ttu-id="d3d96-177">Pro databázové tabulky, které mají mnoho sloupců, to může vést k velmi velké `Where` klauzule, a ve webové aplikaci může vyžadovat, že udržujete velké množství stavu.</span><span class="sxs-lookup"><span data-stu-id="d3d96-177">For database tables that have many columns, it can result in very large `Where` clauses, and in a web application it can require that you maintain large amounts of state.</span></span> <span data-ttu-id="d3d96-178">Správa velkého objemu stavu může ovlivnit výkon aplikace, protože ji vyžaduje prostředky serveru (například stav relace) nebo musí být součástí webové stránky (například stav zobrazení).</span><span class="sxs-lookup"><span data-stu-id="d3d96-178">Maintaining large amounts of state can affect application performance because it either requires server resources (for example, session state) or must be included in the web page itself (for example, view state).</span></span>

<span data-ttu-id="d3d96-179">V tomto kurzu přidáte optimistického řízení souběžnosti konflikty pro entitu, která nemá vlastnost sledování zpracování chyb ( `Department` entity) a entity, které mají vlastnost sledování ( `OfficeAssignment` entity).</span><span class="sxs-lookup"><span data-stu-id="d3d96-179">In this tutorial you will add error handling for optimistic concurrency conflicts for an entity that doesn't have a tracking property (the `Department` entity) and for an entity that does have a tracking property (the `OfficeAssignment` entity).</span></span>

## <a name="handling-optimistic-concurrency-without-a-tracking-property"></a><span data-ttu-id="d3d96-180">Zpracování optimistického řízení souběžnosti bez vlastnosti sledování do</span><span class="sxs-lookup"><span data-stu-id="d3d96-180">Handling Optimistic Concurrency Without a Tracking Property</span></span>

<span data-ttu-id="d3d96-181">Implementace optimistického řízení souběžnosti pro `Department` entity, která nemá sleduje (`Timestamp`) vlastnost, se dokončí následující úkoly:</span><span class="sxs-lookup"><span data-stu-id="d3d96-181">To implement optimistic concurrency for the `Department` entity, which doesn't have a tracking (`Timestamp`) property, you will complete the following tasks:</span></span>

- <span data-ttu-id="d3d96-182">Změnit datový model, který povolit sledování souběžnosti `Department` entity.</span><span class="sxs-lookup"><span data-stu-id="d3d96-182">Change the data model to enable concurrency tracking for `Department` entities.</span></span>
- <span data-ttu-id="d3d96-183">V `SchoolRepository` třídy, zpracování výjimek souběžnosti v `SaveChanges` metody.</span><span class="sxs-lookup"><span data-stu-id="d3d96-183">In the `SchoolRepository` class, handle concurrency exceptions in the `SaveChanges` method.</span></span>
- <span data-ttu-id="d3d96-184">V *Departments.aspx* stránky, zpracování výjimek souběžnosti zobrazením uživateli upozornění, že neúspěšné pokusy o změny byly úspěšné.</span><span class="sxs-lookup"><span data-stu-id="d3d96-184">In the *Departments.aspx* page, handle concurrency exceptions by displaying a message to the user warning that the attempted changes were unsuccessful.</span></span> <span data-ttu-id="d3d96-185">Uživatel můžete zobrazit aktuální hodnoty a zkuste změny, pokud jsou stále potřeba.</span><span class="sxs-lookup"><span data-stu-id="d3d96-185">The user can then see the current values and retry the changes if they are still needed.</span></span>

### <a name="enabling-concurrency-tracking-in-the-data-model"></a><span data-ttu-id="d3d96-186">Povolení sledování v datovém modelu souběžnosti</span><span class="sxs-lookup"><span data-stu-id="d3d96-186">Enabling Concurrency Tracking in the Data Model</span></span>

<span data-ttu-id="d3d96-187">V sadě Visual Studio otevřete webová aplikace Contoso University, kterým jste pracovali v předchozím kurzu této série.</span><span class="sxs-lookup"><span data-stu-id="d3d96-187">In Visual Studio, open the Contoso University web application that you were working with in the previous tutorial in this series.</span></span>

<span data-ttu-id="d3d96-188">Otevřít *SchoolModel.edmx*a v Návrháři modelů dat, klikněte pravým tlačítkem `Name` vlastnost v `Department` entity a pak klikněte na tlačítko **vlastnosti**.</span><span class="sxs-lookup"><span data-stu-id="d3d96-188">Open *SchoolModel.edmx*, and in the data model designer, right-click the `Name` property in the `Department` entity and then click **Properties**.</span></span> <span data-ttu-id="d3d96-189">V **vlastnosti** okno Změnit `ConcurrencyMode` vlastnost `Fixed`.</span><span class="sxs-lookup"><span data-stu-id="d3d96-189">In the **Properties** window, change the `ConcurrencyMode` property to `Fixed`.</span></span>

<span data-ttu-id="d3d96-190">[![Image16](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image12.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="d3d96-190">[![Image16](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image12.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image11.png)</span></span>

<span data-ttu-id="d3d96-191">Provést totéž pro ostatní primární klíč Skalární vlastnosti (`Budget`, `StartDate`, a `Administrator`.) (Nelze to provést pro navigační vlastnosti.) Určuje, že vždy, když rozhraní Entity Framework generuje `Update` nebo `Delete` příkaz SQL pro aktualizaci `Department` entitu v databázi, tyto sloupce (s původní hodnoty) musí být součástí `Where` klauzuli.</span><span class="sxs-lookup"><span data-stu-id="d3d96-191">Do the same for the other non-primary-key scalar properties (`Budget`, `StartDate`, and `Administrator`.) (You can't do this for navigation properties.) This specifies that whenever the Entity Framework generates a `Update` or `Delete` SQL command to update the `Department` entity in the database, these columns (with original values) must be included in the `Where` clause.</span></span> <span data-ttu-id="d3d96-192">Pokud není nalezen žádný řádek, kdy `Update` nebo `Delete` příkaz spustí, Entity Framework vyvolá výjimku optimistického řízení souběžnosti.</span><span class="sxs-lookup"><span data-stu-id="d3d96-192">If no row is found when the `Update` or `Delete` command executes, the Entity Framework will throw an optimistic-concurrency exception.</span></span>

<span data-ttu-id="d3d96-193">Uložte a zavřete datový model.</span><span class="sxs-lookup"><span data-stu-id="d3d96-193">Save and close the data model.</span></span>

### <a name="handling-concurrency-exceptions-in-the-dal"></a><span data-ttu-id="d3d96-194">Zpracování výjimky souběžnosti v vrstvy DAL</span><span class="sxs-lookup"><span data-stu-id="d3d96-194">Handling Concurrency Exceptions in the DAL</span></span>

<span data-ttu-id="d3d96-195">Otevřít *SchoolRepository.cs* a přidejte následující `using` příkaz `System.Data` obor názvů:</span><span class="sxs-lookup"><span data-stu-id="d3d96-195">Open *SchoolRepository.cs* and add the following `using` statement for the `System.Data` namespace:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample1.cs)]

<span data-ttu-id="d3d96-196">Přidejte následující novou `SaveChanges` metodu, která zpracovává výjimky optimistického řízení souběžnosti:</span><span class="sxs-lookup"><span data-stu-id="d3d96-196">Add the following new `SaveChanges` method, which handles optimistic concurrency exceptions:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample2.cs)]

<span data-ttu-id="d3d96-197">Pokud došlo k chybě souběžnosti nastane, pokud tato metoda je volána, hodnoty vlastností entity v paměti se nahradí hodnotami aktuálně v databázi.</span><span class="sxs-lookup"><span data-stu-id="d3d96-197">If a concurrency error occurs when this method is called, the property values of the entity in memory are replaced with the values currently in the database.</span></span> <span data-ttu-id="d3d96-198">Výjimky souběžnosti je znovu vyvolána, takže ji můžete zpracovat webové stránky.</span><span class="sxs-lookup"><span data-stu-id="d3d96-198">The concurrency exception is rethrown so that the web page can handle it.</span></span>

<span data-ttu-id="d3d96-199">V `DeleteDepartment` a `UpdateDepartment` metody, nahraďte existující volání `context.SaveChanges()` voláním `SaveChanges()` k vyvolání nové metody.</span><span class="sxs-lookup"><span data-stu-id="d3d96-199">In the `DeleteDepartment` and `UpdateDepartment` methods, replace the existing call to `context.SaveChanges()` with a call to `SaveChanges()` in order to invoke the new method.</span></span>

### <a name="handling-concurrency-exceptions-in-the-presentation-layer"></a><span data-ttu-id="d3d96-200">Zpracování výjimky souběžnosti v prezentační vrstvě</span><span class="sxs-lookup"><span data-stu-id="d3d96-200">Handling Concurrency Exceptions in the Presentation Layer</span></span>

<span data-ttu-id="d3d96-201">Otevřít *Departments.aspx* a přidat `OnDeleted="DepartmentsObjectDataSource_Deleted"` atribut `DepartmentsObjectDataSource` ovládacího prvku.</span><span class="sxs-lookup"><span data-stu-id="d3d96-201">Open *Departments.aspx* and add an `OnDeleted="DepartmentsObjectDataSource_Deleted"` attribute to the `DepartmentsObjectDataSource` control.</span></span> <span data-ttu-id="d3d96-202">Počáteční značka pro ovládací prvek bude nyní vypadat podobně jako v následujícím příkladu.</span><span class="sxs-lookup"><span data-stu-id="d3d96-202">The opening tag for the control will now resemble the following example.</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample3.aspx)]

<span data-ttu-id="d3d96-203">V `DepartmentsGridView` řídit, zadejte možnost all sloupců tabulky podle `DataKeyNames` atributu, jak je znázorněno v následujícím příkladu.</span><span class="sxs-lookup"><span data-stu-id="d3d96-203">In the `DepartmentsGridView` control, specify all of the table columns in the `DataKeyNames` attribute, as shown in the following example.</span></span> <span data-ttu-id="d3d96-204">Všimněte si, že tím se vytvoří zobrazení velmi velkého pole stavu, což je jedním z důvodů důvod, proč pomocí sledování pole je obecně preferovaný způsob, jak sledovat konfliktů souběžnosti.</span><span class="sxs-lookup"><span data-stu-id="d3d96-204">Note that this will create very large view state fields, which is one reason why using a tracking field is generally the preferred way to track concurrency conflicts.</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample4.aspx)]

<span data-ttu-id="d3d96-205">Otevřít *Departments.aspx.cs* a přidejte následující `using` příkaz `System.Data` obor názvů:</span><span class="sxs-lookup"><span data-stu-id="d3d96-205">Open *Departments.aspx.cs* and add the following `using` statement for the `System.Data` namespace:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample5.cs)]

<span data-ttu-id="d3d96-206">Přidejte následující novou metodu, která bude volat z ovládacího prvku zdroje dat `Updated` a `Deleted` obslužné rutiny událostí pro zpracování výjimky souběžnosti:</span><span class="sxs-lookup"><span data-stu-id="d3d96-206">Add the following new method, which you will call from the data source control's `Updated` and `Deleted` event handlers for handling concurrency exceptions:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample6.cs)]

<span data-ttu-id="d3d96-207">Tento kód ověří typ výjimky, a pokud se jedná výjimky souběžnosti, kód dynamicky vytvoří `CustomValidator` ovládací prvek, který se pak zobrazí zprávu v `ValidationSummary` ovládacího prvku.</span><span class="sxs-lookup"><span data-stu-id="d3d96-207">This code checks the exception type, and if it's a concurrency exception, the code dynamically creates a `CustomValidator` control that in turn displays a message in the `ValidationSummary` control.</span></span>

<span data-ttu-id="d3d96-208">Zavolat novou metodu z `Updated` obslužná rutina události, které jste přidali dříve.</span><span class="sxs-lookup"><span data-stu-id="d3d96-208">Call the new method from the `Updated` event handler that you added earlier.</span></span> <span data-ttu-id="d3d96-209">Kromě toho, vytvořte nový `Deleted` obslužná rutina události, která volá metodu stejné (ale nebude dělat nic jiného):</span><span class="sxs-lookup"><span data-stu-id="d3d96-209">In addition, create a new `Deleted` event handler that calls the same method (but doesn't do anything else):</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample7.cs)]

### <a name="testing-optimistic-concurrency-in-the-departments-page"></a><span data-ttu-id="d3d96-210">Na stránce oddělení testování optimistického řízení souběžnosti</span><span class="sxs-lookup"><span data-stu-id="d3d96-210">Testing Optimistic Concurrency in the Departments Page</span></span>

<span data-ttu-id="d3d96-211">Spustit *Departments.aspx* stránky.</span><span class="sxs-lookup"><span data-stu-id="d3d96-211">Run the *Departments.aspx* page.</span></span>

<span data-ttu-id="d3d96-212">[![Image17](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image14.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="d3d96-212">[![Image17](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image14.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image13.png)</span></span>

<span data-ttu-id="d3d96-213">Klikněte na tlačítko **upravit** v řádku a změňte hodnotu v **rozpočtu** sloupce.</span><span class="sxs-lookup"><span data-stu-id="d3d96-213">Click **Edit** in a row and change the value in the **Budget** column.</span></span> <span data-ttu-id="d3d96-214">(Mějte na paměti, že lze upravit pouze záznamy, které jste vytvořili pro účely tohoto kurzu, protože stávající `School` záznamy v databázi obsahují neplatná data.</span><span class="sxs-lookup"><span data-stu-id="d3d96-214">(Remember that you can only edit records that you've created for this tutorial, because the existing `School` database records contain some invalid data.</span></span> <span data-ttu-id="d3d96-215">Záznam pro oddělení hospodárnost je bezpečné můžete experimentovat.)</span><span class="sxs-lookup"><span data-stu-id="d3d96-215">The record for the Economics department is a safe one to experiment with.)</span></span>

<span data-ttu-id="d3d96-216">[![Image18](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image16.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="d3d96-216">[![Image18](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image16.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image15.png)</span></span>

<span data-ttu-id="d3d96-217">Otevřete nové okno prohlížeče a spusťte znovu stránky (zkopírovat adresu URL z pole adresy první okno prohlížeče na druhé okno prohlížeče).</span><span class="sxs-lookup"><span data-stu-id="d3d96-217">Open a new browser window and run the page again (copy the URL from the first browser window's address box to the second browser window).</span></span>

<span data-ttu-id="d3d96-218">[![Image17](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image18.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image17.png)</span><span class="sxs-lookup"><span data-stu-id="d3d96-218">[![Image17](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image18.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image17.png)</span></span>

<span data-ttu-id="d3d96-219">Klikněte na tlačítko **upravit** ve stejném řádku jste upravili v předchozích krocích a změnit **rozpočtu** hodnotu na něco jiného.</span><span class="sxs-lookup"><span data-stu-id="d3d96-219">Click **Edit** in the same row you edited earlier and change the **Budget** value to something different.</span></span>

<span data-ttu-id="d3d96-220">[![Image19](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image20.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="d3d96-220">[![Image19](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image20.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image19.png)</span></span>

<span data-ttu-id="d3d96-221">V druhém okně prohlížeče, klikněte na tlačítko **aktualizace**.</span><span class="sxs-lookup"><span data-stu-id="d3d96-221">In the second browser window, click **Update**.</span></span> <span data-ttu-id="d3d96-222">**Rozpočtu** částka se úspěšně změnil na této nové hodnoty.</span><span class="sxs-lookup"><span data-stu-id="d3d96-222">The **Budget** amount is successfully changed to this new value.</span></span>

<span data-ttu-id="d3d96-223">[![Image20](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image22.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image21.png)</span><span class="sxs-lookup"><span data-stu-id="d3d96-223">[![Image20](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image22.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image21.png)</span></span>

<span data-ttu-id="d3d96-224">V prvním okně prohlížeče, klikněte na tlačítko **aktualizace**.</span><span class="sxs-lookup"><span data-stu-id="d3d96-224">In the first browser window, click **Update**.</span></span> <span data-ttu-id="d3d96-225">Aktualizace se nezdaří.</span><span class="sxs-lookup"><span data-stu-id="d3d96-225">The update fails.</span></span> <span data-ttu-id="d3d96-226">**Rozpočtu** částka se zobrazí znovu pomocí hodnotu nastavenou v druhém okně prohlížeče a zobrazí chybovou zprávu.</span><span class="sxs-lookup"><span data-stu-id="d3d96-226">The **Budget** amount is redisplayed using the value you set in the second browser window, and you see an error message.</span></span>

<span data-ttu-id="d3d96-227">[![Image21](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image24.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image23.png)</span><span class="sxs-lookup"><span data-stu-id="d3d96-227">[![Image21](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image24.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image23.png)</span></span>

## <a name="handling-optimistic-concurrency-using-a-tracking-property"></a><span data-ttu-id="d3d96-228">Zpracování pomocí vlastnosti sledování do optimistického řízení souběžnosti</span><span class="sxs-lookup"><span data-stu-id="d3d96-228">Handling Optimistic Concurrency Using a Tracking Property</span></span>

<span data-ttu-id="d3d96-229">Pro zpracování optimistického řízení souběžnosti, který má vlastnosti sledování do entity, se dokončí následující úkoly:</span><span class="sxs-lookup"><span data-stu-id="d3d96-229">To handle optimistic concurrency for an entity that has a tracking property, you will complete the following tasks:</span></span>

- <span data-ttu-id="d3d96-230">Přidat uložené procedury do datového modelu pro správu `OfficeAssignment` entity.</span><span class="sxs-lookup"><span data-stu-id="d3d96-230">Add stored procedures to the data model to manage `OfficeAssignment` entities.</span></span> <span data-ttu-id="d3d96-231">(Vlastnosti sledování a uložené procedury nemusí být použity současně, jsou právě seskupeny dohromady zde ukázky)</span><span class="sxs-lookup"><span data-stu-id="d3d96-231">(Tracking properties and stored procedures don't have to be used together; they're just grouped together here for illustration.)</span></span>
- <span data-ttu-id="d3d96-232">Přidejte metody CRUD vrstvy DAL a BLL pro `OfficeAssignment` entitami, včetně kód pro zpracování výjimek optimistického řízení souběžnosti v vrstvy DAL.</span><span class="sxs-lookup"><span data-stu-id="d3d96-232">Add CRUD methods to the DAL and the BLL for `OfficeAssignment` entities, including code to handle optimistic concurrency exceptions in the DAL.</span></span>
- <span data-ttu-id="d3d96-233">Vytvořte webovou stránku office přiřazení.</span><span class="sxs-lookup"><span data-stu-id="d3d96-233">Create an office-assignments web page.</span></span>
- <span data-ttu-id="d3d96-234">Otestujte optimistického řízení souběžnosti v nové webové stránky.</span><span class="sxs-lookup"><span data-stu-id="d3d96-234">Test optimistic concurrency in the new web page.</span></span>

### <a name="adding-officeassignment-stored-procedures-to-the-data-model"></a><span data-ttu-id="d3d96-235">Přidání OfficeAssignment uložené procedury do datového modelu</span><span class="sxs-lookup"><span data-stu-id="d3d96-235">Adding OfficeAssignment Stored Procedures to the Data Model</span></span>

<span data-ttu-id="d3d96-236">Otevřít *SchoolModel.edmx* soubor v Návrháři modelů klikněte pravým tlačítkem na návrhové ploše a klikněte na tlačítko **aktualizace modelů z databáze**.</span><span class="sxs-lookup"><span data-stu-id="d3d96-236">Open the *SchoolModel.edmx* file in the model designer, right-click the design surface, and click **Update Model from Database**.</span></span> <span data-ttu-id="d3d96-237">V **přidat** karty **zvolte vaše databázové objekty** dialogového okna rozbalte **uložené procedury** a vyberte tři `OfficeAssignment` uložených procedur komponentami TableAdapter (naleznete v tématu Následující snímek obrazovky) a potom klikněte na tlačítko **Dokončit**.</span><span class="sxs-lookup"><span data-stu-id="d3d96-237">In the **Add** tab of the **Choose Your Database Objects** dialog box, expand **Stored Procedures** and select the three `OfficeAssignment` stored procedures (see the following screenshot), and then click **Finish**.</span></span> <span data-ttu-id="d3d96-238">(Tyto uložené procedury bylo již v databázi při jste stáhli nebo vytvořili pomocí skriptu.)</span><span class="sxs-lookup"><span data-stu-id="d3d96-238">(These stored procedures were already in the database when you downloaded or created it using a script.)</span></span>

<span data-ttu-id="d3d96-239">[![Image02](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image26.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image25.png)</span><span class="sxs-lookup"><span data-stu-id="d3d96-239">[![Image02](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image26.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image25.png)</span></span>

<span data-ttu-id="d3d96-240">Klikněte pravým tlačítkem myši `OfficeAssignment` entity a vyberte **mapování uložené procedury**.</span><span class="sxs-lookup"><span data-stu-id="d3d96-240">Right-click the `OfficeAssignment` entity and select **Stored Procedure Mapping**.</span></span>

<span data-ttu-id="d3d96-241">[![Image03](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image28.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image27.png)</span><span class="sxs-lookup"><span data-stu-id="d3d96-241">[![Image03](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image28.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image27.png)</span></span>

<span data-ttu-id="d3d96-242">Nastavte **vložit**, **aktualizace**, a **odstranit** funkce použít odpovídající uložené procedury.</span><span class="sxs-lookup"><span data-stu-id="d3d96-242">Set the **Insert**, **Update**, and **Delete** functions to use their corresponding stored procedures.</span></span> <span data-ttu-id="d3d96-243">Pro `OrigTimestamp` parametr `Update` fungovat, nastavte **vlastnost** k `Timestamp` a vyberte **původní hodnotu použití** možnost.</span><span class="sxs-lookup"><span data-stu-id="d3d96-243">For the `OrigTimestamp` parameter of the `Update` function, set the **Property** to `Timestamp` and select the **Use Original Value** option.</span></span>

<span data-ttu-id="d3d96-244">[![Image04](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image30.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image29.png)</span><span class="sxs-lookup"><span data-stu-id="d3d96-244">[![Image04](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image30.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image29.png)</span></span>

<span data-ttu-id="d3d96-245">Když volá rozhraní Entity Framework `UpdateOfficeAssignment` uložené procedury, předá se původní hodnoty `Timestamp` sloupec v `OrigTimestamp` parametr.</span><span class="sxs-lookup"><span data-stu-id="d3d96-245">When the Entity Framework calls the `UpdateOfficeAssignment` stored procedure, it will pass the original value of the `Timestamp` column in the `OrigTimestamp` parameter.</span></span> <span data-ttu-id="d3d96-246">Uložená procedura použije tento parametr v jeho `Where` klauzule:</span><span class="sxs-lookup"><span data-stu-id="d3d96-246">The stored procedure uses this parameter in its `Where` clause:</span></span>

[!code-sql[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample8.sql)]

<span data-ttu-id="d3d96-247">Uložená procedura také vybere novou hodnotu `Timestamp` sloupec po aktualizaci tak, aby rozhraní Entity Framework můžete ponechat `OfficeAssignment` entity, která je v paměti synchronizované s odpovídající řádek.</span><span class="sxs-lookup"><span data-stu-id="d3d96-247">The stored procedure also selects the new value of the `Timestamp` column after the update so that the Entity Framework can keep the `OfficeAssignment` entity that's in memory in sync with the corresponding database row.</span></span>

<span data-ttu-id="d3d96-248">(Všimněte si, že nemá uložené procedury pro odstranění přiřazení kanceláře `OrigTimestamp` parametru.</span><span class="sxs-lookup"><span data-stu-id="d3d96-248">(Note that the stored procedure for deleting an office assignment doesn't have an `OrigTimestamp` parameter.</span></span> <span data-ttu-id="d3d96-249">Z tohoto důvodu Entity Framework nelze ověřit, že je před jejím odstraněním beze změny entity.)</span><span class="sxs-lookup"><span data-stu-id="d3d96-249">Because of this, the Entity Framework can't verify that an entity is unchanged before deleting it.)</span></span>

<span data-ttu-id="d3d96-250">Uložte a zavřete datový model.</span><span class="sxs-lookup"><span data-stu-id="d3d96-250">Save and close the data model.</span></span>

### <a name="adding-officeassignment-methods-to-the-dal"></a><span data-ttu-id="d3d96-251">Přidání metody OfficeAssignment vrstvy Dal</span><span class="sxs-lookup"><span data-stu-id="d3d96-251">Adding OfficeAssignment Methods to the DAL</span></span>

<span data-ttu-id="d3d96-252">Otevřít *ISchoolRepository.cs* a přidejte následující metody CRUD pro `OfficeAssignment` sady entit:</span><span class="sxs-lookup"><span data-stu-id="d3d96-252">Open *ISchoolRepository.cs* and add the following CRUD methods for the `OfficeAssignment` entity set:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample9.cs)]

<span data-ttu-id="d3d96-253">Přidejte následující nové metody, které *SchoolRepository.cs*.</span><span class="sxs-lookup"><span data-stu-id="d3d96-253">Add the following new methods to *SchoolRepository.cs*.</span></span> <span data-ttu-id="d3d96-254">V `UpdateOfficeAssignment` metodu zavoláte místní `SaveChanges` metoda místo `context.SaveChanges`.</span><span class="sxs-lookup"><span data-stu-id="d3d96-254">In the `UpdateOfficeAssignment` method, you call the local `SaveChanges` method instead of `context.SaveChanges`.</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample10.cs)]

<span data-ttu-id="d3d96-255">V projektu testů otevřete *MockSchoolRepository.cs* a přidejte následující `OfficeAssignment` kolekce a CRUD metody k němu.</span><span class="sxs-lookup"><span data-stu-id="d3d96-255">In the test project, open *MockSchoolRepository.cs* and add the following `OfficeAssignment` collection and CRUD methods to it.</span></span> <span data-ttu-id="d3d96-256">(Mock úložiště musí implementovat rozhraní úložiště nebo řešení nebude kompilovat.)</span><span class="sxs-lookup"><span data-stu-id="d3d96-256">(The mock repository must implement the repository interface, or the solution won't compile.)</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample11.cs)]

### <a name="adding-officeassignment-methods-to-the-bll"></a><span data-ttu-id="d3d96-257">Přidání metody OfficeAssignment BLL</span><span class="sxs-lookup"><span data-stu-id="d3d96-257">Adding OfficeAssignment Methods to the BLL</span></span>

<span data-ttu-id="d3d96-258">V hlavním projektu otevřete *SchoolBL.cs* a přidejte následující metody CRUD pro `OfficeAssignment` sada entit k ní:</span><span class="sxs-lookup"><span data-stu-id="d3d96-258">In the main project, open *SchoolBL.cs* and add the following CRUD methods for the `OfficeAssignment` entity set to it:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample12.cs)]

## <a name="creating-an-officeassignments-web-page"></a><span data-ttu-id="d3d96-259">Vytvoření webové stránky OfficeAssignments</span><span class="sxs-lookup"><span data-stu-id="d3d96-259">Creating an OfficeAssignments Web Page</span></span>

<span data-ttu-id="d3d96-260">Vytvořit novou webovou stránku, která používá *Site.Master* stránku předlohy a pojmenujte ho *OfficeAssignments.aspx*.</span><span class="sxs-lookup"><span data-stu-id="d3d96-260">Create a new web page that uses the *Site.Master* master page and name it *OfficeAssignments.aspx*.</span></span> <span data-ttu-id="d3d96-261">Přidejte následující kód k `Content` ovládací prvek s názvem `Content2`:</span><span class="sxs-lookup"><span data-stu-id="d3d96-261">Add the following markup to the `Content` control named `Content2`:</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample13.aspx)]

<span data-ttu-id="d3d96-262">Všimněte si, že v `DataKeyNames` atribut, určuje kód `Timestamp` vlastnosti, jakož i klíč záznamu (`InstructorID`).</span><span class="sxs-lookup"><span data-stu-id="d3d96-262">Notice that in the `DataKeyNames` attribute, the markup specifies the `Timestamp` property as well as the record key (`InstructorID`).</span></span> <span data-ttu-id="d3d96-263">Zadání vlastnosti `DataKeyNames` atribut způsobí, že ovládací prvek k jejich uložení v stav ovládacího prvku (které je podobné zobrazení stavu) tak, že původní hodnoty jsou k dispozici během zpracování zpětného volání.</span><span class="sxs-lookup"><span data-stu-id="d3d96-263">Specifying properties in the `DataKeyNames` attribute causes the control to save them in control state (which is similar to view state) so that the original values are available during postback processing.</span></span>

<span data-ttu-id="d3d96-264">Pokud jste neprovedli `Timestamp` hodnotu, Entity Framework nemusí ho `Where` klauzule SQL `Update` příkazu.</span><span class="sxs-lookup"><span data-stu-id="d3d96-264">If you didn't save the `Timestamp` value, the Entity Framework would not have it for the `Where` clause of the SQL `Update` command.</span></span> <span data-ttu-id="d3d96-265">V důsledku nic bude nalezen aktualizovat.</span><span class="sxs-lookup"><span data-stu-id="d3d96-265">Consequently nothing would be found to update.</span></span> <span data-ttu-id="d3d96-266">V důsledku toho by Entity Framework vyvolat výjimku optimistického řízení souběžnosti pokaždé, když `OfficeAssignment` se aktualizuje entitu.</span><span class="sxs-lookup"><span data-stu-id="d3d96-266">As a result, the Entity Framework would throw an optimistic concurrency exception every time an `OfficeAssignment` entity is updated.</span></span>

<span data-ttu-id="d3d96-267">Otevřít *OfficeAssignments.aspx.cs* a přidejte následující `using` příkaz pro vrstvy přístupu k datům:</span><span class="sxs-lookup"><span data-stu-id="d3d96-267">Open *OfficeAssignments.aspx.cs* and add the following `using` statement for the data access layer:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample14.cs)]

<span data-ttu-id="d3d96-268">Přidejte následující `Page_Init` metodu, která povoluje funkce Dynamická Data.</span><span class="sxs-lookup"><span data-stu-id="d3d96-268">Add the following `Page_Init` method, which enables Dynamic Data functionality.</span></span> <span data-ttu-id="d3d96-269">Také přidejte následující obslužnou rutinu pro `ObjectDataSource` ovládacího prvku `Updated` událostí za účelem ověření chyby souběžnosti:</span><span class="sxs-lookup"><span data-stu-id="d3d96-269">Also add the following handler for the `ObjectDataSource` control's `Updated` event in order to check for concurrency errors:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample15.cs)]

### <a name="testing-optimistic-concurrency-in-the-officeassignments-page"></a><span data-ttu-id="d3d96-270">Na stránce OfficeAssignments testování optimistického řízení souběžnosti</span><span class="sxs-lookup"><span data-stu-id="d3d96-270">Testing Optimistic Concurrency in the OfficeAssignments Page</span></span>

<span data-ttu-id="d3d96-271">Spustit *OfficeAssignments.aspx* stránky.</span><span class="sxs-lookup"><span data-stu-id="d3d96-271">Run the *OfficeAssignments.aspx* page.</span></span>

<span data-ttu-id="d3d96-272">[![Image10](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image32.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image31.png)</span><span class="sxs-lookup"><span data-stu-id="d3d96-272">[![Image10](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image32.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image31.png)</span></span>

<span data-ttu-id="d3d96-273">Klikněte na tlačítko **upravit** v řádku a změňte hodnotu v **umístění** sloupce.</span><span class="sxs-lookup"><span data-stu-id="d3d96-273">Click **Edit** in a row and change the value in the **Location** column.</span></span>

<span data-ttu-id="d3d96-274">[![Image11](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image34.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image33.png)</span><span class="sxs-lookup"><span data-stu-id="d3d96-274">[![Image11](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image34.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image33.png)</span></span>

<span data-ttu-id="d3d96-275">Otevřete nové okno prohlížeče a spusťte znovu stránku (zkopírovat adresu URL z první okno prohlížeče na druhé okno prohlížeče).</span><span class="sxs-lookup"><span data-stu-id="d3d96-275">Open a new browser window and run the page again (copy the URL from the first browser window to the second browser window).</span></span>

<span data-ttu-id="d3d96-276">[![Image10](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image36.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image35.png)</span><span class="sxs-lookup"><span data-stu-id="d3d96-276">[![Image10](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image36.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image35.png)</span></span>

<span data-ttu-id="d3d96-277">Klikněte na tlačítko **upravit** ve stejném řádku jste upravili v předchozích krocích a změnit **umístění** hodnotu na něco jiného.</span><span class="sxs-lookup"><span data-stu-id="d3d96-277">Click **Edit** in the same row you edited earlier and change the **Location** value to something different.</span></span>

<span data-ttu-id="d3d96-278">[![Image12](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image38.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image37.png)</span><span class="sxs-lookup"><span data-stu-id="d3d96-278">[![Image12](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image38.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image37.png)</span></span>

<span data-ttu-id="d3d96-279">V druhém okně prohlížeče, klikněte na tlačítko **aktualizace**.</span><span class="sxs-lookup"><span data-stu-id="d3d96-279">In the second browser window, click **Update**.</span></span>

<span data-ttu-id="d3d96-280">[![Image13](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image40.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image39.png)</span><span class="sxs-lookup"><span data-stu-id="d3d96-280">[![Image13](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image40.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image39.png)</span></span>

<span data-ttu-id="d3d96-281">Přepněte na první okno prohlížeče a klikněte na tlačítko **aktualizace**.</span><span class="sxs-lookup"><span data-stu-id="d3d96-281">Switch to the first browser window and click **Update**.</span></span>

<span data-ttu-id="d3d96-282">[![Image15](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image42.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image41.png)</span><span class="sxs-lookup"><span data-stu-id="d3d96-282">[![Image15](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image42.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image41.png)</span></span>

<span data-ttu-id="d3d96-283">Zobrazí chybová zpráva a **umístění** hodnota se aktualizovala na Zobrazit hodnotu ho na změně v druhém okně prohlížeče.</span><span class="sxs-lookup"><span data-stu-id="d3d96-283">You see an error message and the **Location** value has been updated to show the value you changed it to in the second browser window.</span></span>

## <a name="handling-concurrency-with-the-entitydatasource-control"></a><span data-ttu-id="d3d96-284">Ošetření souběžnosti s ovládacím prvkem EntityDataSource</span><span class="sxs-lookup"><span data-stu-id="d3d96-284">Handling Concurrency with the EntityDataSource Control</span></span>

<span data-ttu-id="d3d96-285">`EntityDataSource` Ovládací prvek obsahuje integrovanou logikou, která rozpozná nastavení souběžnosti v datovém modelu a popisovače aktualizační a odstraňovací operace odpovídajícím způsobem.</span><span class="sxs-lookup"><span data-stu-id="d3d96-285">The `EntityDataSource` control includes built-in logic that recognizes the concurrency settings in the data model and handles update and delete operations accordingly.</span></span> <span data-ttu-id="d3d96-286">Nicméně, stejně jako u všech výjimek, musí zpracovat `OptimisticConcurrencyException` výjimky sami negace popisnou chybovou zprávu.</span><span class="sxs-lookup"><span data-stu-id="d3d96-286">However, as with all exceptions, you must handle `OptimisticConcurrencyException` exceptions yourself in order to provide a user-friendly error message.</span></span>

<span data-ttu-id="d3d96-287">Dále je nutné nakonfigurovat *Courses.aspx* stránky (který používá `EntityDataSource` ovládací prvek) Chcete-li povolit aktualizaci a odstraňování a se zobrazí chybová zpráva, pokud dojde ke konfliktu souběžnosti.</span><span class="sxs-lookup"><span data-stu-id="d3d96-287">Next, you will configure the *Courses.aspx* page (which uses an `EntityDataSource` control) to allow update and delete operations and to display an error message if a concurrency conflict occurs.</span></span> <span data-ttu-id="d3d96-288">`Course` Entita nemá souběžnosti sledování sloupců, což vám umožní používat stejné metody, které jste prováděli pomocí `Department` entity: sledování hodnoty všech vlastností neklíčovým.</span><span class="sxs-lookup"><span data-stu-id="d3d96-288">The `Course` entity doesn't have a concurrency tracking column, so you will use the same method that you did with the `Department` entity: track the values of all non-key properties.</span></span>

<span data-ttu-id="d3d96-289">Otevřít *SchoolModel.edmx* souboru.</span><span class="sxs-lookup"><span data-stu-id="d3d96-289">Open the *SchoolModel.edmx* file.</span></span> <span data-ttu-id="d3d96-290">Pro vlastnosti neklíčovým `Course` entity (`Title`, `Credits`, a `DepartmentID`), můžete nastavit **souběžný režim** vlastnost `Fixed`.</span><span class="sxs-lookup"><span data-stu-id="d3d96-290">For the non-key properties of the `Course` entity (`Title`, `Credits`, and `DepartmentID`), set the **Concurrency Mode** property to `Fixed`.</span></span> <span data-ttu-id="d3d96-291">Potom uložte a zavřete datový model.</span><span class="sxs-lookup"><span data-stu-id="d3d96-291">Then save and close the data model.</span></span>

<span data-ttu-id="d3d96-292">Otevřít *Courses.aspx* stránce a proveďte následující změny:</span><span class="sxs-lookup"><span data-stu-id="d3d96-292">Open the *Courses.aspx* page and make the following changes:</span></span>

- <span data-ttu-id="d3d96-293">V `CoursesEntityDataSource` řídit, přidejte `EnableUpdate="true"` a `EnableDelete="true"` atributy.</span><span class="sxs-lookup"><span data-stu-id="d3d96-293">In the `CoursesEntityDataSource` control, add `EnableUpdate="true"` and `EnableDelete="true"` attributes.</span></span> <span data-ttu-id="d3d96-294">Počáteční značka pro tento ovládací prvek teď vypadá podobně jako v následujícím příkladu:</span><span class="sxs-lookup"><span data-stu-id="d3d96-294">The opening tag for that control now resembles the following example:</span></span>

    [!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample16.aspx)]
- <span data-ttu-id="d3d96-295">V `CoursesGridView` řídit, změnit `DataKeyNames` atribut hodnotu `"CourseID,Title,Credits,DepartmentID"`.</span><span class="sxs-lookup"><span data-stu-id="d3d96-295">In the `CoursesGridView` control, change the `DataKeyNames` attribute value to `"CourseID,Title,Credits,DepartmentID"`.</span></span> <span data-ttu-id="d3d96-296">Pak přidejte `CommandField` element `Columns` element, který ukazuje **upravit** a **odstranit** tlačítka (`<asp:CommandField ShowEditButton="True" ShowDeleteButton="True" />`).</span><span class="sxs-lookup"><span data-stu-id="d3d96-296">Then add a `CommandField` element to the `Columns` element that shows **Edit** and **Delete** buttons (`<asp:CommandField ShowEditButton="True" ShowDeleteButton="True" />`).</span></span> <span data-ttu-id="d3d96-297">`GridView` Ovládací prvek teď vypadá podobně jako v následujícím příkladu:</span><span class="sxs-lookup"><span data-stu-id="d3d96-297">The `GridView` control now resembles the following example:</span></span>

    [!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample17.aspx)]

<span data-ttu-id="d3d96-298">Spuštění stránky a vytvořte konflikt situaci jako předtím na stránce oddělení.</span><span class="sxs-lookup"><span data-stu-id="d3d96-298">Run the page and create a conflict situation as you did before in the Departments page.</span></span> <span data-ttu-id="d3d96-299">Spuštění stránky v dvě okna prohlížeče, klikněte na tlačítko **upravit** ve stejném řádku v každé okno a různých změnu provést v každém z nich.</span><span class="sxs-lookup"><span data-stu-id="d3d96-299">Run the page in two browser windows, click **Edit** in the same line in each window, and make a different change in each one.</span></span> <span data-ttu-id="d3d96-300">Klikněte na tlačítko **aktualizace** v jednom okně a pak klikněte na tlačítko **aktualizace** v druhém okně.</span><span class="sxs-lookup"><span data-stu-id="d3d96-300">Click **Update** in one window and then click **Update** in the other window.</span></span> <span data-ttu-id="d3d96-301">Po kliknutí na **aktualizace** podruhé, zobrazit chybovou stránku, která je výsledkem výjimka neošetřená souběžnosti.</span><span class="sxs-lookup"><span data-stu-id="d3d96-301">When you click **Update** the second time, you see the error page that results from an unhandled concurrency exception.</span></span>

<span data-ttu-id="d3d96-302">[![Image22](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image44.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image43.png)</span><span class="sxs-lookup"><span data-stu-id="d3d96-302">[![Image22](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image44.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image43.png)</span></span>

<span data-ttu-id="d3d96-303">Zpracovat tuto chybu způsobem, který je velmi podobný způsob pro zpracování `ObjectDataSource` ovládacího prvku.</span><span class="sxs-lookup"><span data-stu-id="d3d96-303">You handle this error in a manner very similar to how you handled it for the `ObjectDataSource` control.</span></span> <span data-ttu-id="d3d96-304">Otevřít *Courses.aspx* stránky a `CoursesEntityDataSource` ovládacího prvku, určují obslužné rutiny pro `Deleted` a `Updated` události.</span><span class="sxs-lookup"><span data-stu-id="d3d96-304">Open the *Courses.aspx* page, and in the `CoursesEntityDataSource` control, specify handlers for the `Deleted` and `Updated` events.</span></span> <span data-ttu-id="d3d96-305">Počáteční značka ovládacího prvku teď vypadá podobně jako v následujícím příkladu:</span><span class="sxs-lookup"><span data-stu-id="d3d96-305">The opening tag of the control now resembles the following example:</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample18.aspx)]

<span data-ttu-id="d3d96-306">Před `CoursesGridView` řídit, přidejte následující `ValidationSummary` ovládacího prvku:</span><span class="sxs-lookup"><span data-stu-id="d3d96-306">Before the `CoursesGridView` control, add the following `ValidationSummary` control:</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample19.aspx)]

<span data-ttu-id="d3d96-307">V *Courses.aspx.cs*, přidejte `using` příkaz pro `System.Data` obor názvů, přidejte metodu, která kontroluje výjimky souběžnosti a přidejte obslužné rutiny pro `EntityDataSource` ovládacího prvku `Updated` a `Deleted`obslužné rutiny.</span><span class="sxs-lookup"><span data-stu-id="d3d96-307">In *Courses.aspx.cs*, add a `using` statement for the `System.Data` namespace, add a method that checks for concurrency exceptions, and add handlers for the `EntityDataSource` control's `Updated` and `Deleted` handlers.</span></span> <span data-ttu-id="d3d96-308">Kód bude vypadat nějak takto:</span><span class="sxs-lookup"><span data-stu-id="d3d96-308">The code will look like the following:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample20.cs)]

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample21.cs)]

<span data-ttu-id="d3d96-309">Jediným rozdílem mezi tímto kódem a jaké kroky jste provedli `ObjectDataSource` ovládací prvek je, že v tomto případě výjimky souběžnosti v `Exception` vlastnost objektu argumenty události, nikoli v tuto výjimku `InnerException` vlastnost.</span><span class="sxs-lookup"><span data-stu-id="d3d96-309">The only difference between this code and what you did for the `ObjectDataSource` control is that in this case the concurrency exception is in the `Exception` property of the event arguments object rather than in that exception's `InnerException` property.</span></span>

<span data-ttu-id="d3d96-310">Spuštění stránky a znovu vytvořit ke konfliktu souběžnosti.</span><span class="sxs-lookup"><span data-stu-id="d3d96-310">Run the page and create a concurrency conflict again.</span></span> <span data-ttu-id="d3d96-311">Tentokrát se zobrazí chybová zpráva:</span><span class="sxs-lookup"><span data-stu-id="d3d96-311">This time you see an error message:</span></span>

<span data-ttu-id="d3d96-312">[![Image23](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image46.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image45.png)</span><span class="sxs-lookup"><span data-stu-id="d3d96-312">[![Image23](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image46.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image45.png)</span></span>

<span data-ttu-id="d3d96-313">Dokončení tohoto postupu Úvod ke zpracování konfliktů souběžnosti.</span><span class="sxs-lookup"><span data-stu-id="d3d96-313">This completes the introduction to handling concurrency conflicts.</span></span> <span data-ttu-id="d3d96-314">V dalším kurzu najdete pokyny k vylepšení výkonu ve webové aplikaci, která používá Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="d3d96-314">The next tutorial will provide guidance on how to improve performance in a web application that uses the Entity Framework.</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="d3d96-315">[Předchozí](using-the-entity-framework-and-the-objectdatasource-control-part-3-sorting-and-filtering.md)
> [další](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application.md)</span><span class="sxs-lookup"><span data-stu-id="d3d96-315">[Previous](using-the-entity-framework-and-the-objectdatasource-control-part-3-sorting-and-filtering.md)
[Next](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application.md)</span></span>
