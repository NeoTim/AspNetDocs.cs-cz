---
uid: web-forms/overview/older-versions-getting-started/continuing-with-ef/handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application
title: Zpracování souběžnosti s Entity Framework 4,0 ve webové aplikaci ASP.NET 4 | Microsoft Docs
author: tdykstra
description: Tato řada kurzů se sestavuje na webové aplikaci Contoso University, která je vytvořená Začínáme pomocí řady kurzů Entity Framework 4,0. I...
ms.author: riande
ms.date: 01/26/2011
ms.assetid: a5aa22a6-fb7f-4f41-9c7f-addda151940b
msc.legacyurl: /web-forms/overview/older-versions-getting-started/continuing-with-ef/handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application
msc.type: authoredcontent
ms.openlocfilehash: 3df5f7d9c8fb22e1ea34fe16560bdb9a1309bb56
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: cs-CZ
ms.lasthandoff: 03/06/2020
ms.locfileid: "78632585"
---
# <a name="handling-concurrency-with-the-entity-framework-40-in-an-aspnet-4-web-application"></a><span data-ttu-id="8efa9-104">Zpracování souběžnosti s Entity Framework 4,0 ve webové aplikaci ASP.NET 4</span><span class="sxs-lookup"><span data-stu-id="8efa9-104">Handling Concurrency with the Entity Framework 4.0 in an ASP.NET 4 Web Application</span></span>

<span data-ttu-id="8efa9-105">tím, že [Dykstra](https://github.com/tdykstra)</span><span class="sxs-lookup"><span data-stu-id="8efa9-105">by [Tom Dykstra](https://github.com/tdykstra)</span></span>

> <span data-ttu-id="8efa9-106">Tato řada kurzů se sestavuje na webové aplikaci Contoso University, která je vytvořená [Začínáme pomocí řady kurzů Entity Framework 4,0](https://asp.net/entity-framework/tutorials#Getting%20Started) .</span><span class="sxs-lookup"><span data-stu-id="8efa9-106">This tutorial series builds on the Contoso University web application that is created by the [Getting Started with the Entity Framework 4.0](https://asp.net/entity-framework/tutorials#Getting%20Started) tutorial series.</span></span> <span data-ttu-id="8efa9-107">Pokud jste nedokončili předchozí kurzy, jako výchozí bod tohoto kurzu si můžete aplikaci, kterou jste vytvořili, [Stáhnout](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) .</span><span class="sxs-lookup"><span data-stu-id="8efa9-107">If you didn't complete the earlier tutorials, as a starting point for this tutorial you can [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) that you would have created.</span></span> <span data-ttu-id="8efa9-108">Můžete si také [Stáhnout aplikaci](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) , která je vytvořená úplnou řadou kurzů.</span><span class="sxs-lookup"><span data-stu-id="8efa9-108">You can also [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) that is created by the complete tutorial series.</span></span> <span data-ttu-id="8efa9-109">Pokud máte dotazy k kurzům, můžete je publikovat na [fórum ASP.NET Entity Framework](https://forums.asp.net/1227.aspx).</span><span class="sxs-lookup"><span data-stu-id="8efa9-109">If you have questions about the tutorials, you can post them to the [ASP.NET Entity Framework forum](https://forums.asp.net/1227.aspx).</span></span>

<span data-ttu-id="8efa9-110">V předchozím kurzu jste zjistili, jak řadit a filtrovat data pomocí ovládacího prvku `ObjectDataSource` a Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="8efa9-110">In the previous tutorial you learned how to sort and filter data using the `ObjectDataSource` control and the Entity Framework.</span></span> <span data-ttu-id="8efa9-111">V tomto kurzu se dozvíte o možnostech zpracování souběžnosti ve webové aplikaci v ASP.NET, která používá Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="8efa9-111">This tutorial shows options for handling concurrency in an ASP.NET web application that uses the Entity Framework.</span></span> <span data-ttu-id="8efa9-112">Vytvoří se nová webová stránka, která je vyhrazená pro aktualizaci přiřazení instruktor kanceláře.</span><span class="sxs-lookup"><span data-stu-id="8efa9-112">You will create a new web page that's dedicated to updating instructor office assignments.</span></span> <span data-ttu-id="8efa9-113">Budete zpracovávat problémy souběžnosti na této stránce a na stránce oddělení, kterou jste vytvořili dříve.</span><span class="sxs-lookup"><span data-stu-id="8efa9-113">You'll handle concurrency issues in that page and in the Departments page that you created earlier.</span></span>

<span data-ttu-id="8efa9-114">[![Image06](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image2.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="8efa9-114">[![Image06](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image2.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image1.png)</span></span>

<span data-ttu-id="8efa9-115">[![Image01](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image4.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="8efa9-115">[![Image01](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image4.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image3.png)</span></span>

## <a name="concurrency-conflicts"></a><span data-ttu-id="8efa9-116">Konflikty souběžnosti</span><span class="sxs-lookup"><span data-stu-id="8efa9-116">Concurrency Conflicts</span></span>

<span data-ttu-id="8efa9-117">Ke konfliktu souběžnosti dojde, když jeden uživatel upraví záznam a jiný uživatel upraví stejný záznam předtím, než se do databáze zapíše Změna prvního uživatele.</span><span class="sxs-lookup"><span data-stu-id="8efa9-117">A concurrency conflict occurs when one user edits a record and another user edits the same record before the first user's change is written to the database.</span></span> <span data-ttu-id="8efa9-118">Pokud nenastavíte Entity Framework k detekci takových konfliktů, při aktualizaci databáze poslední přepíše změny provedené ostatními uživateli.</span><span class="sxs-lookup"><span data-stu-id="8efa9-118">If you don't set up the Entity Framework to detect such conflicts, whoever updates the database last overwrites the other user's changes.</span></span> <span data-ttu-id="8efa9-119">V mnoha aplikacích je toto riziko přijatelné a vy nemusíte konfigurovat aplikaci tak, aby zpracovávala možné konflikty souběžnosti.</span><span class="sxs-lookup"><span data-stu-id="8efa9-119">In many applications, this risk is acceptable, and you don't have to configure the application to handle possible concurrency conflicts.</span></span> <span data-ttu-id="8efa9-120">(Pokud je k dispozici málo uživatelů nebo málo aktualizací, nebo pokud není důležité, pokud jsou nějaké změny přepsány, náklady na programování pro souběžnost můžou převážit výhody.) Pokud se nemusíte starat o konflikty souběžnosti, můžete tento kurz přeskočit; zbývající dva kurzy v řadě nejsou závislé na nic, co v tomto případě sestavíte.</span><span class="sxs-lookup"><span data-stu-id="8efa9-120">(If there are few users, or few updates, or if isn't really critical if some changes are overwritten, the cost of programming for concurrency might outweigh the benefit.) If you don't need to worry about concurrency conflicts, you can skip this tutorial; the remaining two tutorials in the series don't depend on anything you build in this one.</span></span>

### <a name="pessimistic-concurrency-locking"></a><span data-ttu-id="8efa9-121">Pesimistická souběžnost (uzamykání)</span><span class="sxs-lookup"><span data-stu-id="8efa9-121">Pessimistic Concurrency (Locking)</span></span>

<span data-ttu-id="8efa9-122">Pokud vaše aplikace potřebuje zabránit náhodné ztrátě dat ve scénářích souběžnosti, stačí jeden způsob, jak to provést, pomocí zámků databáze.</span><span class="sxs-lookup"><span data-stu-id="8efa9-122">If your application does need to prevent accidental data loss in concurrency scenarios, one way to do that is to use database locks.</span></span> <span data-ttu-id="8efa9-123">Tato metoda se nazývá *pesimistická souběžnost*.</span><span class="sxs-lookup"><span data-stu-id="8efa9-123">This is called *pessimistic concurrency*.</span></span> <span data-ttu-id="8efa9-124">Například před čtením řádku z databáze si vyžádáte zámek jen pro čtení nebo pro přístup k aktualizacím.</span><span class="sxs-lookup"><span data-stu-id="8efa9-124">For example, before you read a row from a database, you request a lock for read-only or for update access.</span></span> <span data-ttu-id="8efa9-125">Pokud zamknete řádek pro přístup k aktualizacím, žádní jiní uživatelé nemůžou Uzamknout řádek buď pro čtení, nebo pro přístup k aktualizacím, protože by získali kopii dat, která se v procesu mění.</span><span class="sxs-lookup"><span data-stu-id="8efa9-125">If you lock a row for update access, no other users are allowed to lock the row either for read-only or update access, because they would get a copy of data that's in the process of being changed.</span></span> <span data-ttu-id="8efa9-126">Pokud zamknete řádek pro přístup jen pro čtení, můžou ho jiní uživatelé taky uzamknout pro přístup jen pro čtení, ale ne pro aktualizace.</span><span class="sxs-lookup"><span data-stu-id="8efa9-126">If you lock a row for read-only access, others can also lock it for read-only access but not for update.</span></span>

<span data-ttu-id="8efa9-127">Správa zámků má některé nevýhody.</span><span class="sxs-lookup"><span data-stu-id="8efa9-127">Managing locks has some disadvantages.</span></span> <span data-ttu-id="8efa9-128">Může být komplexní pro program.</span><span class="sxs-lookup"><span data-stu-id="8efa9-128">It can be complex to program.</span></span> <span data-ttu-id="8efa9-129">Vyžaduje významné prostředky správy databáze a může způsobit problémy s výkonem, protože se zvyšuje počet uživatelů aplikace (to znamená, že se nedokáže správně škálovat).</span><span class="sxs-lookup"><span data-stu-id="8efa9-129">It requires significant database management resources, and it can cause performance problems as the number of users of an application increases (that is, it doesn't scale well).</span></span> <span data-ttu-id="8efa9-130">Z těchto důvodů ne všechny systémy správy databáze podporují pesimistickou souběžnost.</span><span class="sxs-lookup"><span data-stu-id="8efa9-130">For these reasons, not all database management systems support pessimistic concurrency.</span></span> <span data-ttu-id="8efa9-131">Entity Framework pro něj neposkytuje žádnou integrovanou podporu a v tomto kurzu se vám nezobrazí, jak ho implementovat.</span><span class="sxs-lookup"><span data-stu-id="8efa9-131">The Entity Framework provides no built-in support for it, and this tutorial doesn't show you how to implement it.</span></span>

### <a name="optimistic-concurrency"></a><span data-ttu-id="8efa9-132">Optimistická metoda souběžného zpracování</span><span class="sxs-lookup"><span data-stu-id="8efa9-132">Optimistic Concurrency</span></span>

<span data-ttu-id="8efa9-133">Alternativou k pesimistické souběžnosti je *Optimistická souběžnost*.</span><span class="sxs-lookup"><span data-stu-id="8efa9-133">The alternative to pessimistic concurrency is *optimistic concurrency*.</span></span> <span data-ttu-id="8efa9-134">Optimistická souběžnost znamená, že může dojít ke konfliktům souběžnosti a v případě, že je funguje správně.</span><span class="sxs-lookup"><span data-stu-id="8efa9-134">Optimistic concurrency means allowing concurrency conflicts to happen, and then reacting appropriately if they do.</span></span> <span data-ttu-id="8efa9-135">Například Jan spustí stránku *oddělení. aspx* , klikne na odkaz **Upravit** pro oddělení historie a sníží částku **rozpočtu** z $1 000 000,00 na $125 000,00.</span><span class="sxs-lookup"><span data-stu-id="8efa9-135">For example, John runs the *Department.aspx* page, clicks the **Edit** link for the History department, and reduces the **Budget** amount from $1,000,000.00 to $125,000.00.</span></span> <span data-ttu-id="8efa9-136">(Jan spravuje konkurenční oddělení a chce zdarma uvolnit peníze pro vlastní oddělení.)</span><span class="sxs-lookup"><span data-stu-id="8efa9-136">(John administers a competing department and wants to free up money for his own department.)</span></span>

<span data-ttu-id="8efa9-137">[![Image07](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image6.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="8efa9-137">[![Image07](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image6.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image5.png)</span></span>

<span data-ttu-id="8efa9-138">Když Jan klikne na **aktualizovat**, spustí Jana stejnou stránku, klikne na odkaz **Upravit** pro oddělení historie a pak změní pole **počáteční datum** z 1/10/2011 na 1/1/1999.</span><span class="sxs-lookup"><span data-stu-id="8efa9-138">Before John clicks **Update**, Jane runs the same page, clicks the **Edit** link for the History department, and then changes the **Start Date** field from 1/10/2011 to 1/1/1999.</span></span> <span data-ttu-id="8efa9-139">(Jana spravuje oddělení historie a chce dát mu větší služební věk.)</span><span class="sxs-lookup"><span data-stu-id="8efa9-139">(Jane administers the History department and wants to give it more seniority.)</span></span>

<span data-ttu-id="8efa9-140">[![Image08](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image8.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="8efa9-140">[![Image08](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image8.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image7.png)</span></span>

<span data-ttu-id="8efa9-141">Jan klikne na **aktualizovat** jako první a pak Jana klikne na **aktualizovat**.</span><span class="sxs-lookup"><span data-stu-id="8efa9-141">John clicks **Update** first, then Jane clicks **Update**.</span></span> <span data-ttu-id="8efa9-142">V prohlížeči Jana se nyní zobrazí hodnota **rozpočtu** jako $1 000 000,00, ale to není správné, protože se změnila hodnota od jan do $125 000,00.</span><span class="sxs-lookup"><span data-stu-id="8efa9-142">Jane's browser now lists the **Budget** amount as $1,000,000.00, but this is incorrect because the amount has been changed by John to $125,000.00.</span></span>

<span data-ttu-id="8efa9-143">V tomto scénáři můžete použít následující akce:</span><span class="sxs-lookup"><span data-stu-id="8efa9-143">Some of the actions you can take in this scenario include the following:</span></span>

- <span data-ttu-id="8efa9-144">Můžete sledovat, kterou vlastnost uživatel změnil, a aktualizovat pouze odpovídající sloupce v databázi.</span><span class="sxs-lookup"><span data-stu-id="8efa9-144">You can keep track of which property a user has modified and update only the corresponding columns in the database.</span></span> <span data-ttu-id="8efa9-145">V ukázkovém scénáři by se neztratila žádná data, protože dva uživatelé aktualizovali různé vlastnosti.</span><span class="sxs-lookup"><span data-stu-id="8efa9-145">In the example scenario, no data would be lost, because different properties were updated by the two users.</span></span> <span data-ttu-id="8efa9-146">Když někdo příště prochází oddělení historie, uvidí 1/1/1999 a $125 000,00.</span><span class="sxs-lookup"><span data-stu-id="8efa9-146">The next time someone browses the History department, they will see 1/1/1999 and $125,000.00.</span></span> 

    <span data-ttu-id="8efa9-147">Toto je výchozí chování Entity Framework a může podstatně snížit počet konfliktů, které by mohly vést ke ztrátě dat.</span><span class="sxs-lookup"><span data-stu-id="8efa9-147">This is the default behavior in the Entity Framework, and it can substantially reduce the number of conflicts that could result in data loss.</span></span> <span data-ttu-id="8efa9-148">Toto chování však nebrání ztrátě dat, pokud jsou v rámci stejné vlastnosti entity provedeny konkurenční změny.</span><span class="sxs-lookup"><span data-stu-id="8efa9-148">However, this behavior doesn't avoid data loss if competing changes are made to the same property of an entity.</span></span> <span data-ttu-id="8efa9-149">Kromě toho toto chování není vždy možné; Když namapujete uložené procedury na typ entity, aktualizují se všechny vlastnosti entity, když se v databázi provedou jakékoli změny entity.</span><span class="sxs-lookup"><span data-stu-id="8efa9-149">In addition, this behavior isn't always possible; when you map stored procedures to an entity type, all of an entity's properties are updated when any changes to the entity are made in the database.</span></span>
- <span data-ttu-id="8efa9-150">Můžete nechat změnu přepsat Jan.</span><span class="sxs-lookup"><span data-stu-id="8efa9-150">You can let Jane's change overwrite John's change.</span></span> <span data-ttu-id="8efa9-151">Jakmile Jana klikne na **aktualizovat**, částka **rozpočtu** se vrátí do $1 000 000,00.</span><span class="sxs-lookup"><span data-stu-id="8efa9-151">After Jane clicks **Update**, the **Budget** amount goes back to $1,000,000.00.</span></span> <span data-ttu-id="8efa9-152">To se označuje jako *klient WINS* nebo *Poslední ve scénáři WINS* .</span><span class="sxs-lookup"><span data-stu-id="8efa9-152">This is called a *Client Wins* or *Last in Wins* scenario.</span></span> <span data-ttu-id="8efa9-153">(Hodnoty klienta mají přednost před tím, co je v úložišti dat.)</span><span class="sxs-lookup"><span data-stu-id="8efa9-153">(The client's values take precedence over what's in the data store.)</span></span>
- <span data-ttu-id="8efa9-154">Můžete zabránit tomu, aby se změna v databázi nástroje Jana aktualizovala.</span><span class="sxs-lookup"><span data-stu-id="8efa9-154">You can prevent Jane's change from being updated in the database.</span></span> <span data-ttu-id="8efa9-155">Obvykle byste zobrazili chybovou zprávu, zobrazila její aktuální stav dat a umožní jí znovu zadat změny, pokud je stále chce udělat.</span><span class="sxs-lookup"><span data-stu-id="8efa9-155">Typically, you would display an error message, show her the current state of the data, and allow her to reenter her changes if she still wants to make them.</span></span> <span data-ttu-id="8efa9-156">Proces můžete dále automatizovat uložením jeho vstupu a tím, že ho budete moct znovu použít, aniž byste ho museli znovu zadávat.</span><span class="sxs-lookup"><span data-stu-id="8efa9-156">You could further automate the process by saving her input and giving her an opportunity to reapply it without having to reenter it.</span></span> <span data-ttu-id="8efa9-157">To se označuje jako scénář *služby WINS pro Store* .</span><span class="sxs-lookup"><span data-stu-id="8efa9-157">This is called a *Store Wins* scenario.</span></span> <span data-ttu-id="8efa9-158">(Hodnoty úložiště dat přednost hodnoty odeslány klientem.)</span><span class="sxs-lookup"><span data-stu-id="8efa9-158">(The data-store values take precedence over the values submitted by the client.)</span></span>

### <a name="detecting-concurrency-conflicts"></a><span data-ttu-id="8efa9-159">Zjišťování konfliktů souběžnosti</span><span class="sxs-lookup"><span data-stu-id="8efa9-159">Detecting Concurrency Conflicts</span></span>

<span data-ttu-id="8efa9-160">V Entity Framework můžete vyřešit konflikty zpracováním `OptimisticConcurrencyException` výjimek, které Entity Framework vyvolá.</span><span class="sxs-lookup"><span data-stu-id="8efa9-160">In the Entity Framework, you can resolve conflicts by handling `OptimisticConcurrencyException` exceptions that the Entity Framework throws.</span></span> <span data-ttu-id="8efa9-161">Chcete-li zjistit, kdy vyvolat tyto výjimky, Entity Framework musí být schopna detekovat konflikty.</span><span class="sxs-lookup"><span data-stu-id="8efa9-161">In order to know when to throw these exceptions, the Entity Framework must be able to detect conflicts.</span></span> <span data-ttu-id="8efa9-162">Proto je nutné správně nakonfigurovat databázi a datový model.</span><span class="sxs-lookup"><span data-stu-id="8efa9-162">Therefore, you must configure the database and the data model appropriately.</span></span> <span data-ttu-id="8efa9-163">Mezi možnosti pro povolení detekce konfliktů patří následující:</span><span class="sxs-lookup"><span data-stu-id="8efa9-163">Some options for enabling conflict detection include the following:</span></span>

- <span data-ttu-id="8efa9-164">V databázi zahrňte sloupec tabulky, který se dá použít k určení, kdy došlo ke změně řádku.</span><span class="sxs-lookup"><span data-stu-id="8efa9-164">In the database, include a table column that can be used to determine when a row has been changed.</span></span> <span data-ttu-id="8efa9-165">Pak můžete nakonfigurovat Entity Framework pro zahrnutí tohoto sloupce do klauzule `Where` příkazů SQL `Update` nebo `Delete`.</span><span class="sxs-lookup"><span data-stu-id="8efa9-165">You can then configure the Entity Framework to include that column in the `Where` clause of SQL `Update` or `Delete` commands.</span></span>

    <span data-ttu-id="8efa9-166">To je účel sloupce `Timestamp` v tabulce `OfficeAssignment`.</span><span class="sxs-lookup"><span data-stu-id="8efa9-166">That's the purpose of the `Timestamp` column in the `OfficeAssignment` table.</span></span>

    <span data-ttu-id="8efa9-167">[![Image09](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image10.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="8efa9-167">[![Image09](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image10.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image9.png)</span></span>

    <span data-ttu-id="8efa9-168">Datový typ sloupce `Timestamp` se také označuje jako `Timestamp`.</span><span class="sxs-lookup"><span data-stu-id="8efa9-168">The data type of the `Timestamp` column is also called `Timestamp`.</span></span> <span data-ttu-id="8efa9-169">Sloupec ale ve skutečnosti neobsahuje hodnotu data nebo času.</span><span class="sxs-lookup"><span data-stu-id="8efa9-169">However, the column doesn't actually contain a date or time value.</span></span> <span data-ttu-id="8efa9-170">Místo toho je hodnota sekvenční číslo, které se zvýší pokaždé, když se řádek aktualizuje.</span><span class="sxs-lookup"><span data-stu-id="8efa9-170">Instead, the value is a sequential number that's incremented each time the row is updated.</span></span> <span data-ttu-id="8efa9-171">V příkazu `Update` nebo `Delete` zahrnuje klauzule `Where` původní `Timestamp` hodnotu.</span><span class="sxs-lookup"><span data-stu-id="8efa9-171">In an `Update` or `Delete` command, the `Where` clause includes the original `Timestamp` value.</span></span> <span data-ttu-id="8efa9-172">Pokud byl aktualizovaný řádek změněn jiným uživatelem, hodnota v `Timestamp` se liší od původní hodnoty, takže klauzule `Where` nevrátí žádný řádek, který se má aktualizovat.</span><span class="sxs-lookup"><span data-stu-id="8efa9-172">If the row being updated has been changed by another user, the value in `Timestamp` is different than the original value, so the `Where` clause returns no row to update.</span></span> <span data-ttu-id="8efa9-173">Pokud Entity Framework zjistí, že aktuální `Update` nebo `Delete` příkaz neaktualizoval žádné řádky (tj. Pokud je počet ovlivněných řádků nula), interpretuje to jako konflikt souběžnosti.</span><span class="sxs-lookup"><span data-stu-id="8efa9-173">When the Entity Framework finds that no rows have been updated by the current `Update` or `Delete` command (that is, when the number of affected rows is zero), it interprets that as a concurrency conflict.</span></span>
- <span data-ttu-id="8efa9-174">Nakonfigurujte Entity Framework tak, aby zahrnoval původní hodnoty všech sloupců v tabulce v klauzuli `Where` příkazů `Update` a `Delete`.</span><span class="sxs-lookup"><span data-stu-id="8efa9-174">Configure the Entity Framework to include the original values of every column in the table in the `Where` clause of `Update` and `Delete` commands.</span></span>

    <span data-ttu-id="8efa9-175">Stejně jako v první možnosti, pokud se cokoli na řádku od prvního načtení řádku změnilo, klauzule `Where` nevrátí řádek, který se má aktualizovat, což Entity Framework interpretuje jako konflikt souběžnosti.</span><span class="sxs-lookup"><span data-stu-id="8efa9-175">As in the first option, if anything in the row has changed since the row was first read, the `Where` clause won't return a row to update, which the Entity Framework interprets as a concurrency conflict.</span></span> <span data-ttu-id="8efa9-176">Tato metoda je platná jako při použití pole `Timestamp`, ale může být neefektivní.</span><span class="sxs-lookup"><span data-stu-id="8efa9-176">This method is as effective as using a `Timestamp` field, but can be inefficient.</span></span> <span data-ttu-id="8efa9-177">U databázových tabulek, které mají mnoho sloupců, může být výsledkem velmi velkých `Where` klauzulí a ve webové aplikaci může vyžadovat, abyste zachovali velké množství stavu.</span><span class="sxs-lookup"><span data-stu-id="8efa9-177">For database tables that have many columns, it can result in very large `Where` clauses, and in a web application it can require that you maintain large amounts of state.</span></span> <span data-ttu-id="8efa9-178">Udržování velkých objemů stavu může ovlivnit výkon aplikace, protože buď vyžaduje prostředky serveru (například stav relace), nebo musí být součástí samotné webové stránky (například stav zobrazení).</span><span class="sxs-lookup"><span data-stu-id="8efa9-178">Maintaining large amounts of state can affect application performance because it either requires server resources (for example, session state) or must be included in the web page itself (for example, view state).</span></span>

<span data-ttu-id="8efa9-179">V tomto kurzu přidáte zpracování chyb pro konflikty optimistického souběžnosti pro entitu, která nemá vlastnost sledování (`Department` entitu), a pro entitu, která má vlastnost sledování (`OfficeAssignment` entita).</span><span class="sxs-lookup"><span data-stu-id="8efa9-179">In this tutorial you will add error handling for optimistic concurrency conflicts for an entity that doesn't have a tracking property (the `Department` entity) and for an entity that does have a tracking property (the `OfficeAssignment` entity).</span></span>

## <a name="handling-optimistic-concurrency-without-a-tracking-property"></a><span data-ttu-id="8efa9-180">Zpracovává se Optimistická souběžnost bez vlastnosti sledování.</span><span class="sxs-lookup"><span data-stu-id="8efa9-180">Handling Optimistic Concurrency Without a Tracking Property</span></span>

<span data-ttu-id="8efa9-181">K implementaci optimistického řízení souběžnosti pro entitu `Department`, která nemá vlastnost sledování (`Timestamp`), dokončíte následující úlohy:</span><span class="sxs-lookup"><span data-stu-id="8efa9-181">To implement optimistic concurrency for the `Department` entity, which doesn't have a tracking (`Timestamp`) property, you will complete the following tasks:</span></span>

- <span data-ttu-id="8efa9-182">Změňte datový model tak, aby povoloval sledování souběžnosti pro `Department` entit.</span><span class="sxs-lookup"><span data-stu-id="8efa9-182">Change the data model to enable concurrency tracking for `Department` entities.</span></span>
- <span data-ttu-id="8efa9-183">Ve třídě `SchoolRepository` zpracujte výjimky souběžnosti v metodě `SaveChanges`.</span><span class="sxs-lookup"><span data-stu-id="8efa9-183">In the `SchoolRepository` class, handle concurrency exceptions in the `SaveChanges` method.</span></span>
- <span data-ttu-id="8efa9-184">Na stránce *oddělení. aspx* můžete zpracovat výjimky souběžnosti tím, že se uživateli zobrazí zpráva s upozorněním, že se provedené změny nezdařily.</span><span class="sxs-lookup"><span data-stu-id="8efa9-184">In the *Departments.aspx* page, handle concurrency exceptions by displaying a message to the user warning that the attempted changes were unsuccessful.</span></span> <span data-ttu-id="8efa9-185">Uživatel pak může zobrazit aktuální hodnoty a opakovat změny, pokud jsou stále potřeba.</span><span class="sxs-lookup"><span data-stu-id="8efa9-185">The user can then see the current values and retry the changes if they are still needed.</span></span>

### <a name="enabling-concurrency-tracking-in-the-data-model"></a><span data-ttu-id="8efa9-186">Povolení sledování souběžnosti v datovém modelu</span><span class="sxs-lookup"><span data-stu-id="8efa9-186">Enabling Concurrency Tracking in the Data Model</span></span>

<span data-ttu-id="8efa9-187">V sadě Visual Studio otevřete webovou aplikaci Contoso University, se kterou jste pracovali v předchozím kurzu této série.</span><span class="sxs-lookup"><span data-stu-id="8efa9-187">In Visual Studio, open the Contoso University web application that you were working with in the previous tutorial in this series.</span></span>

<span data-ttu-id="8efa9-188">Otevřete *SchoolModel. edmx*a v návrháři datového modelu klikněte pravým tlačítkem na vlastnost `Name` v entitě `Department` a pak klikněte na **vlastnosti**.</span><span class="sxs-lookup"><span data-stu-id="8efa9-188">Open *SchoolModel.edmx*, and in the data model designer, right-click the `Name` property in the `Department` entity and then click **Properties**.</span></span> <span data-ttu-id="8efa9-189">V okně **vlastnosti** změňte vlastnost `ConcurrencyMode` na hodnotu `Fixed`.</span><span class="sxs-lookup"><span data-stu-id="8efa9-189">In the **Properties** window, change the `ConcurrencyMode` property to `Fixed`.</span></span>

<span data-ttu-id="8efa9-190">[![Image16](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image12.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="8efa9-190">[![Image16](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image12.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image11.png)</span></span>

<span data-ttu-id="8efa9-191">Totéž udělejte u ostatních skalárních vlastností, které nejsou primárním klíčem (`Budget`, `StartDate`a `Administrator`.) (To nejde udělat pro navigační vlastnosti.) To určuje, že pokaždé, když Entity Framework generuje příkaz jazyka SQL `Update` nebo `Delete`, který aktualizuje entitu `Department` v databázi, musí být v klauzuli `Where` zahrnuté tyto sloupce (s původními hodnotami).</span><span class="sxs-lookup"><span data-stu-id="8efa9-191">Do the same for the other non-primary-key scalar properties (`Budget`, `StartDate`, and `Administrator`.) (You can't do this for navigation properties.) This specifies that whenever the Entity Framework generates a `Update` or `Delete` SQL command to update the `Department` entity in the database, these columns (with original values) must be included in the `Where` clause.</span></span> <span data-ttu-id="8efa9-192">Pokud není nalezen žádný řádek při spuštění příkazu `Update` nebo `Delete`, Entity Framework vyvolá výjimku optimistického zpracování.</span><span class="sxs-lookup"><span data-stu-id="8efa9-192">If no row is found when the `Update` or `Delete` command executes, the Entity Framework will throw an optimistic-concurrency exception.</span></span>

<span data-ttu-id="8efa9-193">Uložte a zavřete datový model.</span><span class="sxs-lookup"><span data-stu-id="8efa9-193">Save and close the data model.</span></span>

### <a name="handling-concurrency-exceptions-in-the-dal"></a><span data-ttu-id="8efa9-194">Zpracování výjimek souběžnosti v DAL</span><span class="sxs-lookup"><span data-stu-id="8efa9-194">Handling Concurrency Exceptions in the DAL</span></span>

<span data-ttu-id="8efa9-195">Otevřete *SchoolRepository.cs* a přidejte následující příkaz `using` pro obor názvů `System.Data`:</span><span class="sxs-lookup"><span data-stu-id="8efa9-195">Open *SchoolRepository.cs* and add the following `using` statement for the `System.Data` namespace:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample1.cs)]

<span data-ttu-id="8efa9-196">Přidejte následující novou `SaveChanges` metodu, která zpracovává optimistické výjimky souběžnosti:</span><span class="sxs-lookup"><span data-stu-id="8efa9-196">Add the following new `SaveChanges` method, which handles optimistic concurrency exceptions:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample2.cs)]

<span data-ttu-id="8efa9-197">Pokud při volání této metody dojde k chybě souběžnosti, hodnoty vlastností entity v paměti jsou nahrazeny hodnotami, které jsou aktuálně v databázi.</span><span class="sxs-lookup"><span data-stu-id="8efa9-197">If a concurrency error occurs when this method is called, the property values of the entity in memory are replaced with the values currently in the database.</span></span> <span data-ttu-id="8efa9-198">Výjimka souběžnosti je znovu vyvolána, aby ji webová stránka mohla zpracovat.</span><span class="sxs-lookup"><span data-stu-id="8efa9-198">The concurrency exception is rethrown so that the web page can handle it.</span></span>

<span data-ttu-id="8efa9-199">V metodách `DeleteDepartment` a `UpdateDepartment` nahraďte existující volání `context.SaveChanges()` voláním `SaveChanges()`, aby bylo možné vyvolat novou metodu.</span><span class="sxs-lookup"><span data-stu-id="8efa9-199">In the `DeleteDepartment` and `UpdateDepartment` methods, replace the existing call to `context.SaveChanges()` with a call to `SaveChanges()` in order to invoke the new method.</span></span>

### <a name="handling-concurrency-exceptions-in-the-presentation-layer"></a><span data-ttu-id="8efa9-200">Zpracování výjimek souběžnosti v prezentační vrstvě</span><span class="sxs-lookup"><span data-stu-id="8efa9-200">Handling Concurrency Exceptions in the Presentation Layer</span></span>

<span data-ttu-id="8efa9-201">Otevřete panel *oddělení. aspx* a přidejte `OnDeleted="DepartmentsObjectDataSource_Deleted"` atribut pro ovládací prvek `DepartmentsObjectDataSource`.</span><span class="sxs-lookup"><span data-stu-id="8efa9-201">Open *Departments.aspx* and add an `OnDeleted="DepartmentsObjectDataSource_Deleted"` attribute to the `DepartmentsObjectDataSource` control.</span></span> <span data-ttu-id="8efa9-202">Otevírací značka ovládacího prvku bude nyní vypadat podobně jako v následujícím příkladu.</span><span class="sxs-lookup"><span data-stu-id="8efa9-202">The opening tag for the control will now resemble the following example.</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample3.aspx)]

<span data-ttu-id="8efa9-203">V ovládacím prvku `DepartmentsGridView` zadejte všechny sloupce tabulky v atributu `DataKeyNames`, jak je znázorněno v následujícím příkladu.</span><span class="sxs-lookup"><span data-stu-id="8efa9-203">In the `DepartmentsGridView` control, specify all of the table columns in the `DataKeyNames` attribute, as shown in the following example.</span></span> <span data-ttu-id="8efa9-204">Všimněte si, že se tím vytvoří velmi rozsáhlá pole stavu zobrazení, což je jeden z důvodů, proč použití sledovacího pole obvykle představuje preferovaný způsob, jak sledovat konflikty souběžnosti.</span><span class="sxs-lookup"><span data-stu-id="8efa9-204">Note that this will create very large view state fields, which is one reason why using a tracking field is generally the preferred way to track concurrency conflicts.</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample4.aspx)]

<span data-ttu-id="8efa9-205">Otevřete *departments.aspx.cs* a přidejte následující příkaz `using` pro obor názvů `System.Data`:</span><span class="sxs-lookup"><span data-stu-id="8efa9-205">Open *Departments.aspx.cs* and add the following `using` statement for the `System.Data` namespace:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample5.cs)]

<span data-ttu-id="8efa9-206">Přidejte následující novou metodu, kterou budete volat z `Updated` a obslužné rutiny události `Deleted` ovládacího prvku zdroje dat pro zpracování výjimek souběžnosti:</span><span class="sxs-lookup"><span data-stu-id="8efa9-206">Add the following new method, which you will call from the data source control's `Updated` and `Deleted` event handlers for handling concurrency exceptions:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample6.cs)]

<span data-ttu-id="8efa9-207">Tento kód kontroluje typ výjimky, a pokud se jedná o výjimku souběžnosti, kód dynamicky vytvoří ovládací prvek `CustomValidator`, který zase zobrazí zprávu v ovládacím prvku `ValidationSummary`.</span><span class="sxs-lookup"><span data-stu-id="8efa9-207">This code checks the exception type, and if it's a concurrency exception, the code dynamically creates a `CustomValidator` control that in turn displays a message in the `ValidationSummary` control.</span></span>

<span data-ttu-id="8efa9-208">Zavolejte novou metodu z obslužné rutiny události `Updated`, kterou jste přidali dříve.</span><span class="sxs-lookup"><span data-stu-id="8efa9-208">Call the new method from the `Updated` event handler that you added earlier.</span></span> <span data-ttu-id="8efa9-209">Kromě toho vytvořte novou `Deleted` obslužnou rutinu události, která volá stejnou metodu (ale neprovede žádnou jinou):</span><span class="sxs-lookup"><span data-stu-id="8efa9-209">In addition, create a new `Deleted` event handler that calls the same method (but doesn't do anything else):</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample7.cs)]

### <a name="testing-optimistic-concurrency-in-the-departments-page"></a><span data-ttu-id="8efa9-210">Testování optimistické souběžnosti na stránce oddělení</span><span class="sxs-lookup"><span data-stu-id="8efa9-210">Testing Optimistic Concurrency in the Departments Page</span></span>

<span data-ttu-id="8efa9-211">Spusťte stránku *oddělení. aspx* .</span><span class="sxs-lookup"><span data-stu-id="8efa9-211">Run the *Departments.aspx* page.</span></span>

<span data-ttu-id="8efa9-212">[![Image17](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image14.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="8efa9-212">[![Image17](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image14.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image13.png)</span></span>

<span data-ttu-id="8efa9-213">V řádku klikněte na **Upravit** a změňte hodnotu ve sloupci **rozpočet** .</span><span class="sxs-lookup"><span data-stu-id="8efa9-213">Click **Edit** in a row and change the value in the **Budget** column.</span></span> <span data-ttu-id="8efa9-214">(Nezapomeňte, že můžete upravovat jenom záznamy, které jste pro tento kurz vytvořili, protože existující záznamy `School` databáze obsahují neplatná data.</span><span class="sxs-lookup"><span data-stu-id="8efa9-214">(Remember that you can only edit records that you've created for this tutorial, because the existing `School` database records contain some invalid data.</span></span> <span data-ttu-id="8efa9-215">Záznam pro ekonomické oddělení je bezpečný pro experimentování s.)</span><span class="sxs-lookup"><span data-stu-id="8efa9-215">The record for the Economics department is a safe one to experiment with.)</span></span>

<span data-ttu-id="8efa9-216">[![Image18](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image16.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="8efa9-216">[![Image18](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image16.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image15.png)</span></span>

<span data-ttu-id="8efa9-217">Otevřete nové okno prohlížeče a znovu spusťte stránku (zkopírujte adresu URL z pole adresa prvního okna prohlížeče do druhého okna prohlížeče).</span><span class="sxs-lookup"><span data-stu-id="8efa9-217">Open a new browser window and run the page again (copy the URL from the first browser window's address box to the second browser window).</span></span>

<span data-ttu-id="8efa9-218">[![Image17](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image18.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image17.png)</span><span class="sxs-lookup"><span data-stu-id="8efa9-218">[![Image17](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image18.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image17.png)</span></span>

<span data-ttu-id="8efa9-219">Klikněte na **Upravit** ve stejném řádku, který jste upravovali dříve, a změňte hodnotu **rozpočtu** na jinou.</span><span class="sxs-lookup"><span data-stu-id="8efa9-219">Click **Edit** in the same row you edited earlier and change the **Budget** value to something different.</span></span>

<span data-ttu-id="8efa9-220">[![Image19](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image20.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="8efa9-220">[![Image19](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image20.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image19.png)</span></span>

<span data-ttu-id="8efa9-221">V druhém okně prohlížeče klikněte na **aktualizovat**.</span><span class="sxs-lookup"><span data-stu-id="8efa9-221">In the second browser window, click **Update**.</span></span> <span data-ttu-id="8efa9-222">Částka **rozpočtu** se úspěšně změnila na tuto novou hodnotu.</span><span class="sxs-lookup"><span data-stu-id="8efa9-222">The **Budget** amount is successfully changed to this new value.</span></span>

<span data-ttu-id="8efa9-223">[![Image20](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image22.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image21.png)</span><span class="sxs-lookup"><span data-stu-id="8efa9-223">[![Image20](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image22.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image21.png)</span></span>

<span data-ttu-id="8efa9-224">V prvním okně prohlížeče klikněte na **aktualizovat**.</span><span class="sxs-lookup"><span data-stu-id="8efa9-224">In the first browser window, click **Update**.</span></span> <span data-ttu-id="8efa9-225">Aktualizace se nezdařila.</span><span class="sxs-lookup"><span data-stu-id="8efa9-225">The update fails.</span></span> <span data-ttu-id="8efa9-226">Částka **rozpočtu** se znovu zobrazí pomocí hodnoty, kterou jste nastavili v druhém okně prohlížeče, a zobrazí se chybová zpráva.</span><span class="sxs-lookup"><span data-stu-id="8efa9-226">The **Budget** amount is redisplayed using the value you set in the second browser window, and you see an error message.</span></span>

<span data-ttu-id="8efa9-227">[![Image21](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image24.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image23.png)</span><span class="sxs-lookup"><span data-stu-id="8efa9-227">[![Image21](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image24.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image23.png)</span></span>

## <a name="handling-optimistic-concurrency-using-a-tracking-property"></a><span data-ttu-id="8efa9-228">Zpracování optimistického řízení souběžnosti pomocí vlastnosti sledování</span><span class="sxs-lookup"><span data-stu-id="8efa9-228">Handling Optimistic Concurrency Using a Tracking Property</span></span>

<span data-ttu-id="8efa9-229">Chcete-li zpracovat optimistickou souběžnost pro entitu, která má vlastnost sledování, proveďte následující úlohy:</span><span class="sxs-lookup"><span data-stu-id="8efa9-229">To handle optimistic concurrency for an entity that has a tracking property, you will complete the following tasks:</span></span>

- <span data-ttu-id="8efa9-230">Přidejte uložené procedury do datového modelu pro správu `OfficeAssignment` entit.</span><span class="sxs-lookup"><span data-stu-id="8efa9-230">Add stored procedures to the data model to manage `OfficeAssignment` entities.</span></span> <span data-ttu-id="8efa9-231">(Vlastnosti sledování a uložené procedury nemusejí být používány dohromady. jsou zde pouze seskupeny na ilustraci.)</span><span class="sxs-lookup"><span data-stu-id="8efa9-231">(Tracking properties and stored procedures don't have to be used together; they're just grouped together here for illustration.)</span></span>
- <span data-ttu-id="8efa9-232">Přidejte metody CRUD do DAL a knihoven BLL pro `OfficeAssignment` entit, včetně kódu pro zpracování optimistických výjimek souběžnosti v DAL.</span><span class="sxs-lookup"><span data-stu-id="8efa9-232">Add CRUD methods to the DAL and the BLL for `OfficeAssignment` entities, including code to handle optimistic concurrency exceptions in the DAL.</span></span>
- <span data-ttu-id="8efa9-233">Vytvoří webovou stránku přiřazení Office.</span><span class="sxs-lookup"><span data-stu-id="8efa9-233">Create an office-assignments web page.</span></span>
- <span data-ttu-id="8efa9-234">Otestujte optimistickou souběžnost na nové webové stránce.</span><span class="sxs-lookup"><span data-stu-id="8efa9-234">Test optimistic concurrency in the new web page.</span></span>

### <a name="adding-officeassignment-stored-procedures-to-the-data-model"></a><span data-ttu-id="8efa9-235">Přidání uložených procedur OfficeAssignment do datového modelu</span><span class="sxs-lookup"><span data-stu-id="8efa9-235">Adding OfficeAssignment Stored Procedures to the Data Model</span></span>

<span data-ttu-id="8efa9-236">Otevřete soubor *SchoolModel. edmx* v Návrháři modelů, klikněte pravým tlačítkem myši na návrhovou plochu a klikněte na příkaz **aktualizovat model z databáze**.</span><span class="sxs-lookup"><span data-stu-id="8efa9-236">Open the *SchoolModel.edmx* file in the model designer, right-click the design surface, and click **Update Model from Database**.</span></span> <span data-ttu-id="8efa9-237">Na kartě **Přidat** dialogového okna **zvolit objekty databáze** rozbalte **uložené procedury** a vyberte tři `OfficeAssignment` uložené procedury (viz následující snímek obrazovky) a pak klikněte na **Dokončit**.</span><span class="sxs-lookup"><span data-stu-id="8efa9-237">In the **Add** tab of the **Choose Your Database Objects** dialog box, expand **Stored Procedures** and select the three `OfficeAssignment` stored procedures (see the following screenshot), and then click **Finish**.</span></span> <span data-ttu-id="8efa9-238">(Tyto uložené procedury byly již v databázi v době, kdy jste je stáhli nebo vytvořili pomocí skriptu.)</span><span class="sxs-lookup"><span data-stu-id="8efa9-238">(These stored procedures were already in the database when you downloaded or created it using a script.)</span></span>

<span data-ttu-id="8efa9-239">[![Image02](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image26.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image25.png)</span><span class="sxs-lookup"><span data-stu-id="8efa9-239">[![Image02](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image26.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image25.png)</span></span>

<span data-ttu-id="8efa9-240">Klikněte pravým tlačítkem na entitu `OfficeAssignment` a vyberte **mapování uložených procedur**.</span><span class="sxs-lookup"><span data-stu-id="8efa9-240">Right-click the `OfficeAssignment` entity and select **Stored Procedure Mapping**.</span></span>

<span data-ttu-id="8efa9-241">[![Image03](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image28.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image27.png)</span><span class="sxs-lookup"><span data-stu-id="8efa9-241">[![Image03](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image28.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image27.png)</span></span>

<span data-ttu-id="8efa9-242">Nastavte funkce **INSERT**, **Update**a **Delete** tak, aby používaly odpovídající uložené procedury.</span><span class="sxs-lookup"><span data-stu-id="8efa9-242">Set the **Insert**, **Update**, and **Delete** functions to use their corresponding stored procedures.</span></span> <span data-ttu-id="8efa9-243">Pro parametr `OrigTimestamp` funkce `Update` nastavte **vlastnost** na hodnotu `Timestamp` a vyberte možnost **použít původní hodnotu** .</span><span class="sxs-lookup"><span data-stu-id="8efa9-243">For the `OrigTimestamp` parameter of the `Update` function, set the **Property** to `Timestamp` and select the **Use Original Value** option.</span></span>

<span data-ttu-id="8efa9-244">[![Image04](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image30.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image29.png)</span><span class="sxs-lookup"><span data-stu-id="8efa9-244">[![Image04](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image30.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image29.png)</span></span>

<span data-ttu-id="8efa9-245">Když Entity Framework volá uloženou proceduru `UpdateOfficeAssignment`, předáte původní hodnotu sloupce `Timestamp` v parametru `OrigTimestamp`.</span><span class="sxs-lookup"><span data-stu-id="8efa9-245">When the Entity Framework calls the `UpdateOfficeAssignment` stored procedure, it will pass the original value of the `Timestamp` column in the `OrigTimestamp` parameter.</span></span> <span data-ttu-id="8efa9-246">Uložená procedura používá tento parametr v klauzuli `Where`:</span><span class="sxs-lookup"><span data-stu-id="8efa9-246">The stored procedure uses this parameter in its `Where` clause:</span></span>

[!code-sql[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample8.sql)]

<span data-ttu-id="8efa9-247">Uložená procedura také vybere novou hodnotu sloupce `Timestamp` po aktualizaci tak, aby Entity Framework mohl ponechat entitu `OfficeAssignment`, která je v paměti, synchronizována s odpovídajícím řádkem databáze.</span><span class="sxs-lookup"><span data-stu-id="8efa9-247">The stored procedure also selects the new value of the `Timestamp` column after the update so that the Entity Framework can keep the `OfficeAssignment` entity that's in memory in sync with the corresponding database row.</span></span>

<span data-ttu-id="8efa9-248">(Všimněte si, že úložná procedura pro odstranění přiřazení kanceláře neobsahuje parametr `OrigTimestamp`.</span><span class="sxs-lookup"><span data-stu-id="8efa9-248">(Note that the stored procedure for deleting an office assignment doesn't have an `OrigTimestamp` parameter.</span></span> <span data-ttu-id="8efa9-249">Z tohoto důvodu Entity Framework nemůže před odstraněním ověřit, zda je entita beze změny.)</span><span class="sxs-lookup"><span data-stu-id="8efa9-249">Because of this, the Entity Framework can't verify that an entity is unchanged before deleting it.)</span></span>

<span data-ttu-id="8efa9-250">Uložte a zavřete datový model.</span><span class="sxs-lookup"><span data-stu-id="8efa9-250">Save and close the data model.</span></span>

### <a name="adding-officeassignment-methods-to-the-dal"></a><span data-ttu-id="8efa9-251">Přidání metod OfficeAssignment do DAL</span><span class="sxs-lookup"><span data-stu-id="8efa9-251">Adding OfficeAssignment Methods to the DAL</span></span>

<span data-ttu-id="8efa9-252">Otevřete *ISchoolRepository.cs* a přidejte následující metody CRUD pro sadu entit `OfficeAssignment`:</span><span class="sxs-lookup"><span data-stu-id="8efa9-252">Open *ISchoolRepository.cs* and add the following CRUD methods for the `OfficeAssignment` entity set:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample9.cs)]

<span data-ttu-id="8efa9-253">Do *SchoolRepository.cs*přidejte následující nové metody.</span><span class="sxs-lookup"><span data-stu-id="8efa9-253">Add the following new methods to *SchoolRepository.cs*.</span></span> <span data-ttu-id="8efa9-254">V metodě `UpdateOfficeAssignment` zavoláte místní metodu `SaveChanges` namísto `context.SaveChanges`.</span><span class="sxs-lookup"><span data-stu-id="8efa9-254">In the `UpdateOfficeAssignment` method, you call the local `SaveChanges` method instead of `context.SaveChanges`.</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample10.cs)]

<span data-ttu-id="8efa9-255">V projektu testu otevřete *MockSchoolRepository.cs* a přidejte do něj následující kolekce `OfficeAssignment` a metody CRUD.</span><span class="sxs-lookup"><span data-stu-id="8efa9-255">In the test project, open *MockSchoolRepository.cs* and add the following `OfficeAssignment` collection and CRUD methods to it.</span></span> <span data-ttu-id="8efa9-256">(Maketa úložiště musí implementovat rozhraní úložiště, jinak se řešení nezkompiluje.)</span><span class="sxs-lookup"><span data-stu-id="8efa9-256">(The mock repository must implement the repository interface, or the solution won't compile.)</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample11.cs)]

### <a name="adding-officeassignment-methods-to-the-bll"></a><span data-ttu-id="8efa9-257">Přidání metod OfficeAssignment do knihoven BLL</span><span class="sxs-lookup"><span data-stu-id="8efa9-257">Adding OfficeAssignment Methods to the BLL</span></span>

<span data-ttu-id="8efa9-258">V hlavním projektu otevřete *SchoolBL.cs* a přidejte následující metody CRUD pro `OfficeAssignment` sadu entit:</span><span class="sxs-lookup"><span data-stu-id="8efa9-258">In the main project, open *SchoolBL.cs* and add the following CRUD methods for the `OfficeAssignment` entity set to it:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample12.cs)]

## <a name="creating-an-officeassignments-web-page"></a><span data-ttu-id="8efa9-259">Vytvoření webové stránky OfficeAssignments</span><span class="sxs-lookup"><span data-stu-id="8efa9-259">Creating an OfficeAssignments Web Page</span></span>

<span data-ttu-id="8efa9-260">Vytvořte novou webovou stránku, která používá hlavní stránku *Web. Master* a pojmenujte ji *OfficeAssignments. aspx*.</span><span class="sxs-lookup"><span data-stu-id="8efa9-260">Create a new web page that uses the *Site.Master* master page and name it *OfficeAssignments.aspx*.</span></span> <span data-ttu-id="8efa9-261">Přidejte následující značku do ovládacího prvku `Content` s názvem `Content2`:</span><span class="sxs-lookup"><span data-stu-id="8efa9-261">Add the following markup to the `Content` control named `Content2`:</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample13.aspx)]

<span data-ttu-id="8efa9-262">Všimněte si, že v atributu `DataKeyNames` značka určuje vlastnost `Timestamp` a také klíč záznamu (`InstructorID`).</span><span class="sxs-lookup"><span data-stu-id="8efa9-262">Notice that in the `DataKeyNames` attribute, the markup specifies the `Timestamp` property as well as the record key (`InstructorID`).</span></span> <span data-ttu-id="8efa9-263">Určení vlastností v atributu `DataKeyNames` způsobí, že ovládací prvek je uloží do stavu ovládacího prvku (což je podobně jako stav zobrazení), takže původní hodnoty jsou k dispozici během zpracování zpětného volání.</span><span class="sxs-lookup"><span data-stu-id="8efa9-263">Specifying properties in the `DataKeyNames` attribute causes the control to save them in control state (which is similar to view state) so that the original values are available during postback processing.</span></span>

<span data-ttu-id="8efa9-264">Pokud jste hodnotu `Timestamp` neuložili, Entity Framework by ji neobsahovala pro klauzuli `Where` příkazu SQL `Update`.</span><span class="sxs-lookup"><span data-stu-id="8efa9-264">If you didn't save the `Timestamp` value, the Entity Framework would not have it for the `Where` clause of the SQL `Update` command.</span></span> <span data-ttu-id="8efa9-265">V důsledku toho by se nenašly žádné aktualizace.</span><span class="sxs-lookup"><span data-stu-id="8efa9-265">Consequently nothing would be found to update.</span></span> <span data-ttu-id="8efa9-266">V důsledku toho Entity Framework vyvolat výjimku optimistické souběžnosti pokaždé, když se aktualizuje entita `OfficeAssignment`.</span><span class="sxs-lookup"><span data-stu-id="8efa9-266">As a result, the Entity Framework would throw an optimistic concurrency exception every time an `OfficeAssignment` entity is updated.</span></span>

<span data-ttu-id="8efa9-267">Otevřete *OfficeAssignments.aspx.cs* a přidejte následující příkaz `using` pro vrstvu přístupu k datům:</span><span class="sxs-lookup"><span data-stu-id="8efa9-267">Open *OfficeAssignments.aspx.cs* and add the following `using` statement for the data access layer:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample14.cs)]

<span data-ttu-id="8efa9-268">Přidejte následující metodu `Page_Init`, která umožňuje funkci dynamického data.</span><span class="sxs-lookup"><span data-stu-id="8efa9-268">Add the following `Page_Init` method, which enables Dynamic Data functionality.</span></span> <span data-ttu-id="8efa9-269">Přidejte také následující obslužnou rutinu pro událost `Updated` ovládacího prvku `ObjectDataSource`, aby bylo možné zjistit chyby souběžnosti:</span><span class="sxs-lookup"><span data-stu-id="8efa9-269">Also add the following handler for the `ObjectDataSource` control's `Updated` event in order to check for concurrency errors:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample15.cs)]

### <a name="testing-optimistic-concurrency-in-the-officeassignments-page"></a><span data-ttu-id="8efa9-270">Testování optimistické souběžnosti na stránce OfficeAssignments</span><span class="sxs-lookup"><span data-stu-id="8efa9-270">Testing Optimistic Concurrency in the OfficeAssignments Page</span></span>

<span data-ttu-id="8efa9-271">Spusťte stránku *OfficeAssignments. aspx* .</span><span class="sxs-lookup"><span data-stu-id="8efa9-271">Run the *OfficeAssignments.aspx* page.</span></span>

<span data-ttu-id="8efa9-272">[![Image10](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image32.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image31.png)</span><span class="sxs-lookup"><span data-stu-id="8efa9-272">[![Image10](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image32.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image31.png)</span></span>

<span data-ttu-id="8efa9-273">V řádku klikněte na **Upravit** a změňte hodnotu ve sloupci **umístění** .</span><span class="sxs-lookup"><span data-stu-id="8efa9-273">Click **Edit** in a row and change the value in the **Location** column.</span></span>

<span data-ttu-id="8efa9-274">[![Image11](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image34.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image33.png)</span><span class="sxs-lookup"><span data-stu-id="8efa9-274">[![Image11](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image34.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image33.png)</span></span>

<span data-ttu-id="8efa9-275">Otevřete nové okno prohlížeče a znovu spusťte stránku (zkopírujte adresu URL z prvního okna prohlížeče do druhého okna prohlížeče).</span><span class="sxs-lookup"><span data-stu-id="8efa9-275">Open a new browser window and run the page again (copy the URL from the first browser window to the second browser window).</span></span>

<span data-ttu-id="8efa9-276">[![Image10](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image36.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image35.png)</span><span class="sxs-lookup"><span data-stu-id="8efa9-276">[![Image10](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image36.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image35.png)</span></span>

<span data-ttu-id="8efa9-277">Klikněte na **Upravit** ve stejném řádku, který jste upravovali dříve, a změňte hodnotu **umístění** na jinou.</span><span class="sxs-lookup"><span data-stu-id="8efa9-277">Click **Edit** in the same row you edited earlier and change the **Location** value to something different.</span></span>

<span data-ttu-id="8efa9-278">[![Image12](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image38.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image37.png)</span><span class="sxs-lookup"><span data-stu-id="8efa9-278">[![Image12](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image38.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image37.png)</span></span>

<span data-ttu-id="8efa9-279">V druhém okně prohlížeče klikněte na **aktualizovat**.</span><span class="sxs-lookup"><span data-stu-id="8efa9-279">In the second browser window, click **Update**.</span></span>

<span data-ttu-id="8efa9-280">[![Image13](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image40.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image39.png)</span><span class="sxs-lookup"><span data-stu-id="8efa9-280">[![Image13](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image40.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image39.png)</span></span>

<span data-ttu-id="8efa9-281">Přepněte do prvního okna prohlížeče a klikněte na **aktualizovat**.</span><span class="sxs-lookup"><span data-stu-id="8efa9-281">Switch to the first browser window and click **Update**.</span></span>

<span data-ttu-id="8efa9-282">[![Image15](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image42.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image41.png)</span><span class="sxs-lookup"><span data-stu-id="8efa9-282">[![Image15](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image42.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image41.png)</span></span>

<span data-ttu-id="8efa9-283">Zobrazí se chybová zpráva a hodnota **umístění** byla aktualizována, aby se zobrazila hodnota, na kterou jste změnili v druhém okně prohlížeče.</span><span class="sxs-lookup"><span data-stu-id="8efa9-283">You see an error message and the **Location** value has been updated to show the value you changed it to in the second browser window.</span></span>

## <a name="handling-concurrency-with-the-entitydatasource-control"></a><span data-ttu-id="8efa9-284">Zpracování souběžnosti s ovládacím prvkem EntityDataSource</span><span class="sxs-lookup"><span data-stu-id="8efa9-284">Handling Concurrency with the EntityDataSource Control</span></span>

<span data-ttu-id="8efa9-285">Ovládací prvek `EntityDataSource` obsahuje vestavěnou logiku, která rozpoznává nastavení souběžnosti v datovém modelu a zpracovává odpovídající operace aktualizace a odstranění.</span><span class="sxs-lookup"><span data-stu-id="8efa9-285">The `EntityDataSource` control includes built-in logic that recognizes the concurrency settings in the data model and handles update and delete operations accordingly.</span></span> <span data-ttu-id="8efa9-286">Stejně jako u všech výjimek je však nutné zpracovat výjimky `OptimisticConcurrencyException` sami, aby bylo možné zadat uživatelsky přívětivou chybovou zprávu.</span><span class="sxs-lookup"><span data-stu-id="8efa9-286">However, as with all exceptions, you must handle `OptimisticConcurrencyException` exceptions yourself in order to provide a user-friendly error message.</span></span>

<span data-ttu-id="8efa9-287">Dále nakonfigurujete stránku *kurzy. aspx* (která používá ovládací prvek `EntityDataSource`) k povolení operací aktualizace a odstranění a k zobrazení chybové zprávy, pokud dojde ke konfliktu souběžnosti.</span><span class="sxs-lookup"><span data-stu-id="8efa9-287">Next, you will configure the *Courses.aspx* page (which uses an `EntityDataSource` control) to allow update and delete operations and to display an error message if a concurrency conflict occurs.</span></span> <span data-ttu-id="8efa9-288">Entita `Course` nemá sloupec sledování souběžnosti, takže budete používat stejnou metodu, kterou jste provedli s entitou `Department`: Sledujte hodnoty všech neklíčových vlastností.</span><span class="sxs-lookup"><span data-stu-id="8efa9-288">The `Course` entity doesn't have a concurrency tracking column, so you will use the same method that you did with the `Department` entity: track the values of all non-key properties.</span></span>

<span data-ttu-id="8efa9-289">Otevřete soubor *SchoolModel. edmx* .</span><span class="sxs-lookup"><span data-stu-id="8efa9-289">Open the *SchoolModel.edmx* file.</span></span> <span data-ttu-id="8efa9-290">Pro neklíčové vlastnosti entity `Course` (`Title`, `Credits`a `DepartmentID`) nastavte vlastnost **režim souběžnosti** na `Fixed`.</span><span class="sxs-lookup"><span data-stu-id="8efa9-290">For the non-key properties of the `Course` entity (`Title`, `Credits`, and `DepartmentID`), set the **Concurrency Mode** property to `Fixed`.</span></span> <span data-ttu-id="8efa9-291">Pak datový model uložte a zavřete.</span><span class="sxs-lookup"><span data-stu-id="8efa9-291">Then save and close the data model.</span></span>

<span data-ttu-id="8efa9-292">Otevřete stránku *kurzy. aspx* a proveďte následující změny:</span><span class="sxs-lookup"><span data-stu-id="8efa9-292">Open the *Courses.aspx* page and make the following changes:</span></span>

- <span data-ttu-id="8efa9-293">V ovládacím prvku `CoursesEntityDataSource` přidejte atributy `EnableUpdate="true"` a `EnableDelete="true"`.</span><span class="sxs-lookup"><span data-stu-id="8efa9-293">In the `CoursesEntityDataSource` control, add `EnableUpdate="true"` and `EnableDelete="true"` attributes.</span></span> <span data-ttu-id="8efa9-294">Otevírací značka pro tento ovládací prvek teď vypadá podobně jako v následujícím příkladu:</span><span class="sxs-lookup"><span data-stu-id="8efa9-294">The opening tag for that control now resembles the following example:</span></span>

    [!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample16.aspx)]
- <span data-ttu-id="8efa9-295">V ovládacím prvku `CoursesGridView` změňte hodnotu atributu `DataKeyNames` na `"CourseID,Title,Credits,DepartmentID"`.</span><span class="sxs-lookup"><span data-stu-id="8efa9-295">In the `CoursesGridView` control, change the `DataKeyNames` attribute value to `"CourseID,Title,Credits,DepartmentID"`.</span></span> <span data-ttu-id="8efa9-296">Pak přidejte `CommandField` element do prvku `Columns`, který zobrazuje tlačítka **Upravit** a **Odstranit** (`<asp:CommandField ShowEditButton="True" ShowDeleteButton="True" />`).</span><span class="sxs-lookup"><span data-stu-id="8efa9-296">Then add a `CommandField` element to the `Columns` element that shows **Edit** and **Delete** buttons (`<asp:CommandField ShowEditButton="True" ShowDeleteButton="True" />`).</span></span> <span data-ttu-id="8efa9-297">Ovládací prvek `GridView` se teď podobá následujícímu příkladu:</span><span class="sxs-lookup"><span data-stu-id="8efa9-297">The `GridView` control now resembles the following example:</span></span>

    [!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample17.aspx)]

<span data-ttu-id="8efa9-298">Spusťte stránku a na stránce oddělení vytvořte situaci, ve které došlo ke konfliktu.</span><span class="sxs-lookup"><span data-stu-id="8efa9-298">Run the page and create a conflict situation as you did before in the Departments page.</span></span> <span data-ttu-id="8efa9-299">Spusťte stránku ve dvou oknech prohlížeče, v každém okně klikněte na **Upravit** na stejném řádku a udělejte v každém z nich jinou změnu.</span><span class="sxs-lookup"><span data-stu-id="8efa9-299">Run the page in two browser windows, click **Edit** in the same line in each window, and make a different change in each one.</span></span> <span data-ttu-id="8efa9-300">V jednom okně klikněte na **aktualizovat** a potom v druhém okně klikněte na **aktualizovat** .</span><span class="sxs-lookup"><span data-stu-id="8efa9-300">Click **Update** in one window and then click **Update** in the other window.</span></span> <span data-ttu-id="8efa9-301">Když kliknete na **aktualizovat** podruhé, zobrazí se chybová stránka, která bude mít za následek neošetřenou výjimku souběžnosti.</span><span class="sxs-lookup"><span data-stu-id="8efa9-301">When you click **Update** the second time, you see the error page that results from an unhandled concurrency exception.</span></span>

<span data-ttu-id="8efa9-302">[![Image22](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image44.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image43.png)</span><span class="sxs-lookup"><span data-stu-id="8efa9-302">[![Image22](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image44.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image43.png)</span></span>

<span data-ttu-id="8efa9-303">Tato chyba se zpracovává způsobem velmi podobným způsobu, jakým jste ji zpracovali pro ovládací prvek `ObjectDataSource`.</span><span class="sxs-lookup"><span data-stu-id="8efa9-303">You handle this error in a manner very similar to how you handled it for the `ObjectDataSource` control.</span></span> <span data-ttu-id="8efa9-304">Otevřete stránku *kurzy. aspx* a v ovládacím prvku `CoursesEntityDataSource` určete obslužné rutiny pro události `Deleted` a `Updated`.</span><span class="sxs-lookup"><span data-stu-id="8efa9-304">Open the *Courses.aspx* page, and in the `CoursesEntityDataSource` control, specify handlers for the `Deleted` and `Updated` events.</span></span> <span data-ttu-id="8efa9-305">Otevírací značka ovládacího prvku teď vypadá podobně jako v následujícím příkladu:</span><span class="sxs-lookup"><span data-stu-id="8efa9-305">The opening tag of the control now resembles the following example:</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample18.aspx)]

<span data-ttu-id="8efa9-306">Před ovládacím prvkem `CoursesGridView` přidejte následující ovládací prvek `ValidationSummary`:</span><span class="sxs-lookup"><span data-stu-id="8efa9-306">Before the `CoursesGridView` control, add the following `ValidationSummary` control:</span></span>

[!code-aspx[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample19.aspx)]

<span data-ttu-id="8efa9-307">V *courses.aspx.cs*přidejte příkaz `using` pro `System.Data` oboru názvů, přidejte metodu, která kontroluje výjimky souběžnosti, a přidejte obslužné rutiny pro `Updated` a `Deleted` obslužné rutiny ovládacího prvku `EntityDataSource`.</span><span class="sxs-lookup"><span data-stu-id="8efa9-307">In *Courses.aspx.cs*, add a `using` statement for the `System.Data` namespace, add a method that checks for concurrency exceptions, and add handlers for the `EntityDataSource` control's `Updated` and `Deleted` handlers.</span></span> <span data-ttu-id="8efa9-308">Kód bude vypadat jako následující:</span><span class="sxs-lookup"><span data-stu-id="8efa9-308">The code will look like the following:</span></span>

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample20.cs)]

[!code-csharp[Main](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/samples/sample21.cs)]

<span data-ttu-id="8efa9-309">Jediný rozdíl mezi tímto kódem a to, co jste použili pro ovládací prvek `ObjectDataSource` je, že v tomto případě je výjimka souběžnosti ve vlastnosti `Exception` objektu argumenty události, nikoli v této vlastnosti `InnerException` této výjimky.</span><span class="sxs-lookup"><span data-stu-id="8efa9-309">The only difference between this code and what you did for the `ObjectDataSource` control is that in this case the concurrency exception is in the `Exception` property of the event arguments object rather than in that exception's `InnerException` property.</span></span>

<span data-ttu-id="8efa9-310">Spusťte stránku a vytvořte konflikt souběžnosti znovu.</span><span class="sxs-lookup"><span data-stu-id="8efa9-310">Run the page and create a concurrency conflict again.</span></span> <span data-ttu-id="8efa9-311">Tentokrát se zobrazí chybová zpráva:</span><span class="sxs-lookup"><span data-stu-id="8efa9-311">This time you see an error message:</span></span>

<span data-ttu-id="8efa9-312">[![Image23](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image46.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image45.png)</span><span class="sxs-lookup"><span data-stu-id="8efa9-312">[![Image23](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image46.png)](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application/_static/image45.png)</span></span>

<span data-ttu-id="8efa9-313">Tím se dokončí Úvod ke zpracování konfliktů souběžnosti.</span><span class="sxs-lookup"><span data-stu-id="8efa9-313">This completes the introduction to handling concurrency conflicts.</span></span> <span data-ttu-id="8efa9-314">V dalším kurzu se dozvíte, jak zvýšit výkon webové aplikace, která používá Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="8efa9-314">The next tutorial will provide guidance on how to improve performance in a web application that uses the Entity Framework.</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="8efa9-315">[Předchozí](using-the-entity-framework-and-the-objectdatasource-control-part-3-sorting-and-filtering.md)
> [Další](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application.md)</span><span class="sxs-lookup"><span data-stu-id="8efa9-315">[Previous](using-the-entity-framework-and-the-objectdatasource-control-part-3-sorting-and-filtering.md)
[Next](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application.md)</span></span>
