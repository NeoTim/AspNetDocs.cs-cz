---
uid: web-forms/overview/older-versions-getting-started/continuing-with-ef/using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests
title: 'Použití Entity Framework 4,0 a ovládacího prvku ObjectDataSource, část 2: Přidání vrstvy obchodní logiky a testování částí | Microsoft Docs'
author: tdykstra
description: Tato řada kurzů se sestavuje na webové aplikaci Contoso University, která je vytvořená Začínáme pomocí řady kurzů Entity Framework 4,0. I...
ms.author: riande
ms.date: 01/26/2011
ms.assetid: efb0e677-10b8-48dc-93d3-9ba3902dd807
msc.legacyurl: /web-forms/overview/older-versions-getting-started/continuing-with-ef/using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests
msc.type: authoredcontent
ms.openlocfilehash: 24344cc33d7c26d7c408db26c0530ef2c708a7d3
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: cs-CZ
ms.lasthandoff: 03/06/2020
ms.locfileid: "78546765"
---
# <a name="using-the-entity-framework-40-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests"></a><span data-ttu-id="ca1ab-104">Použití Entity Framework 4,0 a ovládacího prvku ObjectDataSource, část 2: Přidání vrstvy obchodní logiky a testování částí</span><span class="sxs-lookup"><span data-stu-id="ca1ab-104">Using the Entity Framework 4.0 and the ObjectDataSource Control, Part 2: Adding a Business Logic Layer and Unit Tests</span></span>

<span data-ttu-id="ca1ab-105">tím, že [Dykstra](https://github.com/tdykstra)</span><span class="sxs-lookup"><span data-stu-id="ca1ab-105">by [Tom Dykstra](https://github.com/tdykstra)</span></span>

> <span data-ttu-id="ca1ab-106">Tato řada kurzů se sestavuje na webové aplikaci Contoso University, která je vytvořená [Začínáme pomocí řady kurzů Entity Framework 4,0](https://asp.net/entity-framework/tutorials#Getting%20Started) .</span><span class="sxs-lookup"><span data-stu-id="ca1ab-106">This tutorial series builds on the Contoso University web application that is created by the [Getting Started with the Entity Framework 4.0](https://asp.net/entity-framework/tutorials#Getting%20Started) tutorial series.</span></span> <span data-ttu-id="ca1ab-107">Pokud jste nedokončili předchozí kurzy, jako výchozí bod tohoto kurzu si můžete aplikaci, kterou jste vytvořili, [Stáhnout](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) .</span><span class="sxs-lookup"><span data-stu-id="ca1ab-107">If you didn't complete the earlier tutorials, as a starting point for this tutorial you can [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) that you would have created.</span></span> <span data-ttu-id="ca1ab-108">Můžete si také [Stáhnout aplikaci](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) , která je vytvořená úplnou řadou kurzů.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-108">You can also [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) that is created by the complete tutorial series.</span></span> <span data-ttu-id="ca1ab-109">Pokud máte dotazy k kurzům, můžete je publikovat na [fórum ASP.NET Entity Framework](https://forums.asp.net/1227.aspx).</span><span class="sxs-lookup"><span data-stu-id="ca1ab-109">If you have questions about the tutorials, you can post them to the [ASP.NET Entity Framework forum](https://forums.asp.net/1227.aspx).</span></span>

<span data-ttu-id="ca1ab-110">V předchozím kurzu jste vytvořili n-vrstvou webovou aplikaci pomocí Entity Framework a ovládacího prvku `ObjectDataSource`.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-110">In the previous tutorial you created an n-tier web application using the Entity Framework and the `ObjectDataSource` control.</span></span> <span data-ttu-id="ca1ab-111">V tomto kurzu se dozvíte, jak přidat obchodní logiku při zachování vrstvy knihoven BLL (Business-Logic Layer) a vrstvy přístupu k datům (DAL) odděleně a ukazuje, jak vytvořit automatizované testy jednotek pro knihoven BLL.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-111">This tutorial shows how to add business logic while keeping the business-logic layer (BLL) and the data-access layer (DAL) separate, and it shows how to create automated unit tests for the BLL.</span></span>

<span data-ttu-id="ca1ab-112">V tomto kurzu provedete následující úlohy:</span><span class="sxs-lookup"><span data-stu-id="ca1ab-112">In this tutorial you'll complete the following tasks:</span></span>

- <span data-ttu-id="ca1ab-113">Vytvořte rozhraní úložiště, které deklaruje metody přístupu k datům, které potřebujete.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-113">Create a repository interface that declares the data-access methods you need.</span></span>
- <span data-ttu-id="ca1ab-114">Implementujte rozhraní úložiště ve třídě úložiště.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-114">Implement the repository interface in the repository class.</span></span>
- <span data-ttu-id="ca1ab-115">Vytvořte třídu obchodní logiky, která volá třídu úložiště pro provádění funkcí přístupu k datům.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-115">Create a business-logic class that calls the repository class to perform data-access functions.</span></span>
- <span data-ttu-id="ca1ab-116">Připojte ovládací prvek `ObjectDataSource` k třídě Business-Logic místo do třídy úložiště.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-116">Connect the `ObjectDataSource` control to the business-logic class instead of to the repository class.</span></span>
- <span data-ttu-id="ca1ab-117">Vytvořte projekt jednotky a testování a třídu úložiště, která pro své úložiště dat používá kolekce v paměti.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-117">Create a unit-test project and a repository class that uses in-memory collections for its data store.</span></span>
- <span data-ttu-id="ca1ab-118">Vytvořte test jednotek pro obchodní logiku, který chcete přidat do třídy obchodní logiky, a potom spusťte test a podívejte se, že se nedaří.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-118">Create a unit test for business logic that you want to add to the business-logic class, then run the test and see it fail.</span></span>
- <span data-ttu-id="ca1ab-119">Implementujte obchodní logiku do třídy Business-Logic a pak znovu spusťte test jednotky a podívejte se, jak je úspěch.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-119">Implement the business logic in the business-logic class, then re-run the unit test and see it pass.</span></span>

<span data-ttu-id="ca1ab-120">Budete pracovat se stránkami *oddělení. aspx* a *DepartmentsAdd. aspx* , které jste vytvořili v předchozím kurzu.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-120">You'll work with the *Departments.aspx* and *DepartmentsAdd.aspx* pages that you created in the previous tutorial.</span></span>

## <a name="creating-a-repository-interface"></a><span data-ttu-id="ca1ab-121">Vytvoření rozhraní úložiště</span><span class="sxs-lookup"><span data-stu-id="ca1ab-121">Creating a Repository Interface</span></span>

<span data-ttu-id="ca1ab-122">Začnete vytvořením rozhraní úložiště.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-122">You'll begin by creating the repository interface.</span></span>

<span data-ttu-id="ca1ab-123">[![Image08](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image2.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="ca1ab-123">[![Image08](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image2.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image1.png)</span></span>

<span data-ttu-id="ca1ab-124">Ve složce *dal* vytvořte nový soubor třídy, pojmenujte ho *ISchoolRepository.cs*a stávající kód nahraďte následujícím kódem:</span><span class="sxs-lookup"><span data-stu-id="ca1ab-124">In the *DAL* folder, create a new class file, name it *ISchoolRepository.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample1.cs)]

<span data-ttu-id="ca1ab-125">Rozhraní definuje jednu metodu pro každou metodu CRUD (Create, Read, Update, DELETE), kterou jste vytvořili ve třídě úložiště.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-125">The interface defines one method for each of the CRUD (create, read, update, delete) methods that you created in the repository class.</span></span>

<span data-ttu-id="ca1ab-126">Ve třídě `SchoolRepository` v *SchoolRepository.cs*označte, že tato třída implementuje rozhraní `ISchoolRepository`:</span><span class="sxs-lookup"><span data-stu-id="ca1ab-126">In the `SchoolRepository` class in *SchoolRepository.cs*, indicate that this class implements the `ISchoolRepository` interface:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample2.cs)]

## <a name="creating-a-business-logic-class"></a><span data-ttu-id="ca1ab-127">Vytvoření třídy Business-Logic</span><span class="sxs-lookup"><span data-stu-id="ca1ab-127">Creating a Business-Logic Class</span></span>

<span data-ttu-id="ca1ab-128">V dalším kroku vytvoříte třídu Business-Logic.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-128">Next, you'll create the business-logic class.</span></span> <span data-ttu-id="ca1ab-129">Provedete to tak, abyste mohli přidat obchodní logiku, která bude spuštěna ovládacím prvkem `ObjectDataSource`, i když to ještě neuděláte.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-129">You do this so that you can add business logic that will be executed by the `ObjectDataSource` control, although you will not do that yet.</span></span> <span data-ttu-id="ca1ab-130">Nyní bude nová třída Business-Logic provádět pouze stejné operace CRUD jako úložiště.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-130">For now, the new business-logic class will only perform the same CRUD operations that the repository does.</span></span>

<span data-ttu-id="ca1ab-131">[![Image09](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image4.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="ca1ab-131">[![Image09](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image4.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image3.png)</span></span>

<span data-ttu-id="ca1ab-132">Vytvořte novou složku a pojmenujte ji *knihoven BLL*.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-132">Create a new folder and name it *BLL*.</span></span> <span data-ttu-id="ca1ab-133">(V reálné aplikaci by byla vrstva Business-Logic obvykle implementována jako knihovna tříd – samostatný projekt, ale pokud chcete tento kurz uchovávat snadno, třídy knihoven BLL budou uloženy ve složce projektu.)</span><span class="sxs-lookup"><span data-stu-id="ca1ab-133">(In a real-world application, the business-logic layer would typically be implemented as a class library — a separate project — but to keep this tutorial simple, BLL classes will be kept in a project folder.)</span></span>

<span data-ttu-id="ca1ab-134">Ve složce *knihoven BLL* vytvořte nový soubor třídy, pojmenujte ho *SchoolBL.cs*a nahraďte existující kód následujícím kódem:</span><span class="sxs-lookup"><span data-stu-id="ca1ab-134">In the *BLL* folder, create a new class file, name it *SchoolBL.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample3.cs)]

<span data-ttu-id="ca1ab-135">Tento kód vytvoří stejné metody CRUD, jaké jste viděli dříve ve třídě úložiště, ale místo toho, aby přístup k metodám Entity Framework přímo, volá metody třídy úložiště.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-135">This code creates the same CRUD methods you saw earlier in the repository class, but instead of accessing the Entity Framework methods directly, it calls the repository class methods.</span></span>

<span data-ttu-id="ca1ab-136">Proměnná třídy, která obsahuje odkaz na třídu úložiště, je definována jako typ rozhraní a kód, který vytváří instanci třídy úložiště, je obsažen ve dvou konstruktorech.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-136">The class variable that holds a reference to the repository class is defined as an interface type, and the code that instantiates the repository class is contained in two constructors.</span></span> <span data-ttu-id="ca1ab-137">Konstruktor bez parametrů bude použit ovládacím prvkem `ObjectDataSource`.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-137">The parameterless constructor will be used by the `ObjectDataSource` control.</span></span> <span data-ttu-id="ca1ab-138">Vytvoří instanci třídy `SchoolRepository`, kterou jste vytvořili dříve.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-138">It creates an instance of the `SchoolRepository` class that you created earlier.</span></span> <span data-ttu-id="ca1ab-139">Druhý konstruktor umožňuje jakýkoli kód, který vytvoří instanci třídy Business-Logic k předání do libovolného objektu, který implementuje rozhraní úložiště.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-139">The other constructor allows whatever code that instantiates the business-logic class to pass in any object that implements the repository interface.</span></span>

<span data-ttu-id="ca1ab-140">Metody CRUD, které volají třídu úložiště a dva konstruktory, umožňují použít třídu Business-Logic s libovolným úložištěm back-endové databáze, kterou zvolíte.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-140">The CRUD methods that call the repository class and the two constructors make it possible to use the business-logic class with whatever back-end data store you choose.</span></span> <span data-ttu-id="ca1ab-141">Třída Business-Logic není nutná vědět, jak třída, kterou volá, přechovává data.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-141">The business-logic class does not need to be aware of how the class that it's calling persists the data.</span></span> <span data-ttu-id="ca1ab-142">(To se často označuje jako *ignorování perzistence*.) To usnadňuje testování částí, protože je možné připojit třídu Business-Logic k implementaci úložiště, která používá něco jednoduchého jako kolekce `List` v paměti pro ukládání dat.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-142">(This is often called *persistence ignorance*.) This facilitates unit testing, because you can connect the business-logic class to a repository implementation that uses something as simple as in-memory `List` collections to store data.</span></span>

> [!NOTE]
> <span data-ttu-id="ca1ab-143">Technicky jsou objekty entit stále nestálé – ignorují se, protože jsou vytvořeny z tříd, které dědí z `EntityObject` třídy Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-143">Technically, the entity objects are still not persistence-ignorant, because they're instantiated from classes that inherit from the Entity Framework's `EntityObject` class.</span></span> <span data-ttu-id="ca1ab-144">Pro trvalé ignorování trvalosti můžete použít *prosté staré objekty CLR*nebo *POCOs*namísto objektů, které dědí z třídy `EntityObject`.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-144">For complete persistence ignorance, you can use *plain old CLR objects*, or *POCOs*, in place of objects that inherit from the `EntityObject` class.</span></span> <span data-ttu-id="ca1ab-145">Používání POCOs překračuje rámec tohoto kurzu.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-145">Using POCOs is beyond the scope of this tutorial.</span></span> <span data-ttu-id="ca1ab-146">Další informace najdete v tématu [testování a Entity Framework 4,0](https://msdn.microsoft.com/library/ff714955.aspx) na webu MSDN.)</span><span class="sxs-lookup"><span data-stu-id="ca1ab-146">For more information, see [Testability and Entity Framework 4.0](https://msdn.microsoft.com/library/ff714955.aspx) on the MSDN website.)</span></span>

<span data-ttu-id="ca1ab-147">Nyní můžete propojit ovládací prvky `ObjectDataSource` k třídě Business-Logic místo do úložiště a ověřit, že vše funguje stejně jako dříve.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-147">Now you can connect the `ObjectDataSource` controls to the business-logic class instead of to the repository and verify that everything works as it did before.</span></span>

<span data-ttu-id="ca1ab-148">V *odděleních. aspx* a *DepartmentsAdd. aspx*změňte všechny výskyty `TypeName="ContosoUniversity.DAL.SchoolRepository"` na `TypeName="ContosoUniversity.BLL.SchoolBL`".</span><span class="sxs-lookup"><span data-stu-id="ca1ab-148">In *Departments.aspx* and *DepartmentsAdd.aspx*, change each occurrence of `TypeName="ContosoUniversity.DAL.SchoolRepository"` to `TypeName="ContosoUniversity.BLL.SchoolBL`".</span></span> <span data-ttu-id="ca1ab-149">(Všechny jsou ve všech čtyřech instancích.)</span><span class="sxs-lookup"><span data-stu-id="ca1ab-149">(There are four instances in all.)</span></span>

<span data-ttu-id="ca1ab-150">Spusťte stránky *oddělení. aspx* a *DepartmentsAdd. aspx* a ověřte, zda stále fungují stejně jako dříve.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-150">Run the *Departments.aspx* and *DepartmentsAdd.aspx* pages to verify that they still work as they did before.</span></span>

<span data-ttu-id="ca1ab-151">[![Image01](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image6.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="ca1ab-151">[![Image01](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image6.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image5.png)</span></span>

<span data-ttu-id="ca1ab-152">[![Image02](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image8.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="ca1ab-152">[![Image02](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image8.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image7.png)</span></span>

## <a name="creating-a-unit-test-project-and-repository-implementation"></a><span data-ttu-id="ca1ab-153">Vytvoření projektu jednotky a testování a implementace úložiště</span><span class="sxs-lookup"><span data-stu-id="ca1ab-153">Creating a Unit-Test Project and Repository Implementation</span></span>

<span data-ttu-id="ca1ab-154">Přidejte do řešení nový projekt pomocí šablony **testovacího projektu** a pojmenujte ho `ContosoUniversity.Tests`.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-154">Add a new project to the solution using the **Test Project** template, and name it `ContosoUniversity.Tests`.</span></span>

<span data-ttu-id="ca1ab-155">V testovacím projektu přidejte odkaz na `System.Data.Entity` a přidejte odkaz na projekt do projektu `ContosoUniversity`.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-155">In the test project, add a reference to `System.Data.Entity` and add a project reference to the `ContosoUniversity` project.</span></span>

<span data-ttu-id="ca1ab-156">Nyní můžete vytvořit třídu úložiště, kterou budete používat s testováním částí.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-156">You can now create the repository class that you'll use with unit tests.</span></span> <span data-ttu-id="ca1ab-157">Úložiště dat pro toto úložiště bude v rámci třídy.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-157">The data store for this repository will be within the class.</span></span>

<span data-ttu-id="ca1ab-158">[![Image12](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image10.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="ca1ab-158">[![Image12](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image10.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image9.png)</span></span>

<span data-ttu-id="ca1ab-159">V testovacím projektu vytvořte nový soubor třídy, pojmenujte jej *MockSchoolRepository.cs*a stávající kód nahraďte následujícím kódem:</span><span class="sxs-lookup"><span data-stu-id="ca1ab-159">In the test project, create a new class file, name it *MockSchoolRepository.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample4.cs)]

<span data-ttu-id="ca1ab-160">Tato třída úložiště má stejné metody CRUD jako ta, která přistupuje k Entity Framework přímo, ale spolupracuje s kolekcemi `List` v paměti místo databáze.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-160">This repository class has the same CRUD methods as the one that accesses the Entity Framework directly, but they work with `List` collections in memory instead of with a database.</span></span> <span data-ttu-id="ca1ab-161">To usnadňuje, aby testovací třída nastavila a ověřovala testy jednotek pro třídu obchodní logiky.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-161">This makes it easier for a test class to set up and validate unit tests for the business-logic class.</span></span>

## <a name="creating-unit-tests"></a><span data-ttu-id="ca1ab-162">Vytváření testů jednotek</span><span class="sxs-lookup"><span data-stu-id="ca1ab-162">Creating Unit Tests</span></span>

<span data-ttu-id="ca1ab-163">Šablona projektu **testu** vytvořila třídu pro testování jednotek se zástupnými procedurami a vaším dalším úkolem je upravit tuto třídu přidáním metod testování částí do IT pro obchodní logiku, kterou chcete přidat do třídy Business-Logic.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-163">The **Test** project template created a stub unit test class for you, and your next task is to modify this class by adding unit test methods to it for business logic that you want to add to the business-logic class.</span></span>

<span data-ttu-id="ca1ab-164">[![Image13](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image12.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="ca1ab-164">[![Image13](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image12.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image11.png)</span></span>

<span data-ttu-id="ca1ab-165">Ve společnosti Contoso University může být každý jednotlivý instruktor správcem jediného oddělení a Vy musíte přidat obchodní logiku, abyste toto pravidlo vynutili.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-165">At Contoso University, any individual instructor can only be the administrator of a single department, and you need to add business logic to enforce this rule.</span></span> <span data-ttu-id="ca1ab-166">Začnete tak, že přidáte testy a spustíte testy, abyste je viděli neúspěšná.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-166">You will start by adding tests and running the tests to see them fail.</span></span> <span data-ttu-id="ca1ab-167">Pak přidáte kód a znovu spustíte testy, očekává se, že se zobrazí.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-167">You'll then add the code and rerun the tests, expecting to see them pass.</span></span>

<span data-ttu-id="ca1ab-168">Otevřete soubor *UnitTest1.cs* a přidejte `using` příkazy pro obchodní logiku a vrstvy přístupu k datům, které jste vytvořili v projektu ContosoUniversity:</span><span class="sxs-lookup"><span data-stu-id="ca1ab-168">Open the *UnitTest1.cs* file and add `using` statements for the business logic and data-access layers that you created in the ContosoUniversity project:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample5.cs)]

<span data-ttu-id="ca1ab-169">Metodu `TestMethod1` nahraďte následujícími metodami:</span><span class="sxs-lookup"><span data-stu-id="ca1ab-169">Replace the `TestMethod1` method with the following methods:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample6.cs)]

<span data-ttu-id="ca1ab-170">Metoda `CreateSchoolBL` vytvoří instanci třídy úložiště, kterou jste vytvořili pro projekt testování částí, který pak předá do nové instance třídy Business-Logic.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-170">The `CreateSchoolBL` method creates an instance of the repository class that you created for the unit test project, which it then passes to a new instance of the business-logic class.</span></span> <span data-ttu-id="ca1ab-171">Metoda pak pomocí třídy Business-Logic vloží tři oddělení, která můžete použít v testovacích metodách.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-171">The method then uses the business-logic class to insert three departments that you can use in test methods.</span></span>

<span data-ttu-id="ca1ab-172">Testovací metody ověřují, zda třída Business-Logic vyvolá výjimku, pokud se někdo pokusí vložit nové oddělení se stejným správcem, jako má stávající oddělení, nebo pokud se někdo pokusí aktualizovat Správce oddělení jeho nastavením na ID osoby. Kdo je již správcem jiného oddělení.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-172">The test methods verify that the business-logic class throws an exception if someone tries to insert a new department with the same administrator as an existing department, or if someone tries to update a department's administrator by setting it to the ID of a person who is already the administrator of another department.</span></span>

<span data-ttu-id="ca1ab-173">Třídu výjimek jste ještě nevytvořili, takže tento kód se nezkompiluje.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-173">You haven't created the exception class yet, so this code will not compile.</span></span> <span data-ttu-id="ca1ab-174">Pokud ho chcete zkompilovat, klikněte pravým tlačítkem na `DuplicateAdministratorException` a vyberte **Generovat**a pak **Třída**.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-174">To get it to compile, right-click `DuplicateAdministratorException` and select **Generate**, and then **Class**.</span></span>

<span data-ttu-id="ca1ab-175">[![Image14](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image14.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="ca1ab-175">[![Image14](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image14.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image13.png)</span></span>

<span data-ttu-id="ca1ab-176">Tím se vytvoří třída v testovacím projektu, kterou můžete odstranit po vytvoření třídy Exception v hlavním projektu.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-176">This creates a class in the test project which you can delete after you've created the exception class in the main project.</span></span> <span data-ttu-id="ca1ab-177">a implementovali obchodní logiku.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-177">and implemented the business logic.</span></span>

<span data-ttu-id="ca1ab-178">Spusťte projekt testů.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-178">Run the test project.</span></span> <span data-ttu-id="ca1ab-179">Jak bylo očekáváno, testy selžou.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-179">As expected, the tests fail.</span></span>

<span data-ttu-id="ca1ab-180">[![Image03](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image16.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="ca1ab-180">[![Image03](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image16.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image15.png)</span></span>

## <a name="adding-business-logic-to-make-a-test-pass"></a><span data-ttu-id="ca1ab-181">Přidání obchodní logiky, která provede test Pass</span><span class="sxs-lookup"><span data-stu-id="ca1ab-181">Adding Business Logic to Make a Test Pass</span></span>

<span data-ttu-id="ca1ab-182">V dalším kroku implementujete obchodní logiku, která znemožňuje nastavit jako správce oddělení někoho, kdo už je správcem jiného oddělení.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-182">Next, you'll implement the business logic that makes it impossible to set as the administrator of a department someone who is already administrator of another department.</span></span> <span data-ttu-id="ca1ab-183">Vyvoláte výjimku z vrstvy obchodní logiky a pak ji zachytíte do prezentační vrstvy, pokud uživatel upraví oddělení a klikne na tlačítko **aktualizovat** po výběru uživatele, který je již správcem.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-183">You'll throw an exception from the business-logic layer, and then catch it in the presentation layer if a user edits a department and clicks **Update** after selecting someone who is already an administrator.</span></span> <span data-ttu-id="ca1ab-184">(Můžete také odebrat instruktory z rozevíracího seznamu, kteří jsou již správci, než stránku vykreslíte, ale účelem tohoto postupu je práce s vrstvou obchodní logiky.)</span><span class="sxs-lookup"><span data-stu-id="ca1ab-184">(You could also remove instructors from the drop-down list who are already administrators before you render the page, but the purpose here is to work with the business-logic layer.)</span></span>

<span data-ttu-id="ca1ab-185">Začněte tím, že vytvoříte třídu výjimek, kterou vyvoláte, když se uživatel pokusí vytvořit instruktora o více než jednom oddělení.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-185">Start by creating the exception class that you'll throw when a user tries to make an instructor the administrator of more than one department.</span></span> <span data-ttu-id="ca1ab-186">V hlavním projektu vytvořte nový soubor třídy ve složce *knihoven BLL* , pojmenujte ho *DuplicateAdministratorException.cs*a nahraďte existující kód následujícím kódem:</span><span class="sxs-lookup"><span data-stu-id="ca1ab-186">In the main project, create a new class file in the *BLL* folder, name it *DuplicateAdministratorException.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample7.cs)]

<span data-ttu-id="ca1ab-187">Nyní odstraňte dočasný soubor *DuplicateAdministratorException.cs* , který jste předtím vytvořili v testovacím projektu, aby bylo možné kompilovat.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-187">Now delete the temporary *DuplicateAdministratorException.cs* file that you created in the test project earlier in order to be able to compile.</span></span>

<span data-ttu-id="ca1ab-188">V hlavním projektu otevřete soubor *SchoolBL.cs* a přidejte následující metodu, která obsahuje logiku ověřování.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-188">In the main project, open the *SchoolBL.cs* file and add the following method that contains the validation logic.</span></span> <span data-ttu-id="ca1ab-189">(Kód odkazuje na metodu, kterou vytvoříte později.)</span><span class="sxs-lookup"><span data-stu-id="ca1ab-189">(The code refers to a method that you'll create later.)</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample8.cs)]

<span data-ttu-id="ca1ab-190">Tuto metodu zavoláte při vkládání nebo aktualizaci entit `Department`, abyste zkontrolovali, jestli jiné oddělení už má stejného správce.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-190">You'll call this method when you're inserting or updating `Department` entities in order to check whether another department already has the same administrator.</span></span>

<span data-ttu-id="ca1ab-191">Kód volá metodu pro hledání `Department` entitu, která má stejnou hodnotu `Administrator` vlastností jako entita, která je vložena nebo aktualizována.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-191">The code calls a method to search the database for a `Department` entity that has the same `Administrator` property value as the entity being inserted or updated.</span></span> <span data-ttu-id="ca1ab-192">Pokud je jeden nalezen, kód vyvolá výjimku.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-192">If one is found, the code throws an exception.</span></span> <span data-ttu-id="ca1ab-193">Pokud vložená nebo aktualizovaná entita neobsahuje žádnou `Administrator` hodnotu, není vyžadována žádná kontrola ověřování, a pokud je metoda volána během aktualizace, není vyvolána žádná výjimka, a `Department` nalezenou entitou `Department`, která je v aktualizované entitě shodná.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-193">No validation check is required if the entity being inserted or updated has no `Administrator` value, and no exception is thrown if the method is called during an update and the `Department` entity found matches the `Department` entity being updated.</span></span>

<span data-ttu-id="ca1ab-194">Zavolejte novou metodu z `Insert` a `Update`ch metod:</span><span class="sxs-lookup"><span data-stu-id="ca1ab-194">Call the new method from the `Insert` and `Update` methods:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample9.cs)]

<span data-ttu-id="ca1ab-195">Do *ISchoolRepository.cs*přidejte následující deklaraci pro novou metodu přístupu k datům:</span><span class="sxs-lookup"><span data-stu-id="ca1ab-195">In *ISchoolRepository.cs*, add the following declaration for the new data-access method:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample10.cs)]

<span data-ttu-id="ca1ab-196">Do *SchoolRepository.cs*přidejte následující příkaz `using`:</span><span class="sxs-lookup"><span data-stu-id="ca1ab-196">In *SchoolRepository.cs*, add the following `using` statement:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample11.cs)]

<span data-ttu-id="ca1ab-197">Do *SchoolRepository.cs*přidejte následující novou metodu přístupu k datům:</span><span class="sxs-lookup"><span data-stu-id="ca1ab-197">In *SchoolRepository.cs*, add the following new data-access method:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample12.cs)]

<span data-ttu-id="ca1ab-198">Tento kód načte `Department` entity, které mají zadaného správce.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-198">This code retrieves `Department` entities that have a specified administrator.</span></span> <span data-ttu-id="ca1ab-199">Mělo by být nalezeno pouze jedno oddělení (pokud existuje).</span><span class="sxs-lookup"><span data-stu-id="ca1ab-199">Only one department should be found (if any).</span></span> <span data-ttu-id="ca1ab-200">Vzhledem k tomu, že do databáze není integrováno žádné omezení, je návratový typ kolekce v případě, že je nalezeno více oddělení.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-200">However, because no constraint is built into the database, the return type is a collection in case multiple departments are found.</span></span>

<span data-ttu-id="ca1ab-201">Ve výchozím nastavení, když kontext objektu načítá entity z databáze, uchovává jejich sledování ve Správci stavu objektu.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-201">By default, when the object context retrieves entities from the database, it keeps track of them in its object state manager.</span></span> <span data-ttu-id="ca1ab-202">Parametr `MergeOption.NoTracking` určuje, že toto sledování nebude pro tento dotaz provedeno.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-202">The `MergeOption.NoTracking` parameter specifies that this tracking will not be done for this query.</span></span> <span data-ttu-id="ca1ab-203">To je nezbytné, protože dotaz může vracet přesně entitu, kterou se pokoušíte aktualizovat, a pak tuto entitu nemůžete připojit.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-203">This is necessary because the query might return the exact entity that you're trying to update, and then you would not be able to attach that entity.</span></span> <span data-ttu-id="ca1ab-204">Pokud například upravíte oddělení historie na stránce *oddělení. aspx* a necháte správce beze změny, bude tento dotaz vracet oddělení historie.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-204">For example, if you edit the History department in the *Departments.aspx* page and leave the administrator unchanged, this query will return the History department.</span></span> <span data-ttu-id="ca1ab-205">Pokud není nastavena `NoTracking`, kontext objektu již má entitu oddělení historie ve Správci stavu objektu.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-205">If `NoTracking` is not set, the object context would already have the History department entity in its object state manager.</span></span> <span data-ttu-id="ca1ab-206">Poté, co připojíte entitu historie oddělení, která je znovu vytvořena ze stavu zobrazení, vyvolá kontext objektu výjimku, která říká `"An object with the same key already exists in the ObjectStateManager. The ObjectStateManager cannot track multiple objects with the same key"`.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-206">Then when you attach the History department entity that's re-created from view state, the object context would throw an exception that says `"An object with the same key already exists in the ObjectStateManager. The ObjectStateManager cannot track multiple objects with the same key"`.</span></span>

<span data-ttu-id="ca1ab-207">(Jako alternativu k určení `MergeOption.NoTracking`můžete vytvořit nový kontext objektu pouze pro tento dotaz.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-207">(As an alternative to specifying `MergeOption.NoTracking`, you could create a new object context just for this query.</span></span> <span data-ttu-id="ca1ab-208">Vzhledem k tomu, že by měl kontext nového objektu svůj vlastní Správce stavu objektu, by při volání metody `Attach` nedocházelo k žádnému konfliktu.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-208">Because the new object context would have its own object state manager, there would be no conflict when you call the `Attach` method.</span></span> <span data-ttu-id="ca1ab-209">Kontext nového objektu by sdílel metadata a připojení k databázi s původním kontextem objektu, takže snížení výkonu tohoto alternativního přístupu bude minimální.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-209">The new object context would share metadata and database connection with the original object context, so the performance penalty of this alternate approach would be minimal.</span></span> <span data-ttu-id="ca1ab-210">Zde uvedený postup však zavádí možnost `NoTracking`, kterou najdete v jiných kontextech, které jsou užitečné.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-210">The approach shown here, however, introduces the `NoTracking` option, which you'll find useful in other contexts.</span></span> <span data-ttu-id="ca1ab-211">Možnost `NoTracking` je podrobněji popsána v pozdějším kurzu této série.)</span><span class="sxs-lookup"><span data-stu-id="ca1ab-211">The `NoTracking` option is discussed further in a later tutorial in this series.)</span></span>

<span data-ttu-id="ca1ab-212">V testovacím projektu přidejte novou metodu přístupu k datům do *MockSchoolRepository.cs*:</span><span class="sxs-lookup"><span data-stu-id="ca1ab-212">In the test project, add the new data-access method to *MockSchoolRepository.cs*:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample13.cs)]

<span data-ttu-id="ca1ab-213">Tento kód používá LINQ k provedení stejného výběru dat, který `ContosoUniversity` úložiště projektu používá LINQ to Entities pro.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-213">This code uses LINQ to perform the same data selection that the `ContosoUniversity` project repository uses LINQ to Entities for.</span></span>

<span data-ttu-id="ca1ab-214">Spusťte test projektu znovu.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-214">Run the test project again.</span></span> <span data-ttu-id="ca1ab-215">Tentokrát testy proběhnou.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-215">This time the tests pass.</span></span>

<span data-ttu-id="ca1ab-216">[![Image04](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image18.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image17.png)</span><span class="sxs-lookup"><span data-stu-id="ca1ab-216">[![Image04](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image18.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image17.png)</span></span>

## <a name="handling-objectdatasource-exceptions"></a><span data-ttu-id="ca1ab-217">Zpracování výjimek ObjectDataSource</span><span class="sxs-lookup"><span data-stu-id="ca1ab-217">Handling ObjectDataSource Exceptions</span></span>

<span data-ttu-id="ca1ab-218">V projektu `ContosoUniversity` spusťte stránku *oddělení. aspx* a zkuste změnit správce oddělení na někoho, kdo už je správcem pro jiné oddělení.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-218">In the `ContosoUniversity` project, run the *Departments.aspx* page and try to change the administrator for a department to someone who is already administrator for another department.</span></span> <span data-ttu-id="ca1ab-219">(Mějte na paměti, že můžete upravovat jenom oddělení, která jste přidali během tohoto kurzu, protože se databáze nachází předem s neplatnými daty.) Zobrazí se následující chybová stránka serveru:</span><span class="sxs-lookup"><span data-stu-id="ca1ab-219">(Remember that you can only edit departments that you added during this tutorial, because the database comes preloaded with invalid data.) You get the following server error page:</span></span>

<span data-ttu-id="ca1ab-220">[![Image05](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image20.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="ca1ab-220">[![Image05](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image20.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image19.png)</span></span>

<span data-ttu-id="ca1ab-221">Nechcete, aby uživatelé viděli tento druh chybové stránky, takže potřebujete přidat kód pro zpracování chyb.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-221">You don't want users to see this kind of error page, so you need to add error-handling code.</span></span> <span data-ttu-id="ca1ab-222">Otevřete panel *oddělení. aspx* a určete obslužnou rutinu pro událost `OnUpdated` `DepartmentsObjectDataSource`.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-222">Open *Departments.aspx* and specify a handler for the `OnUpdated` event of the `DepartmentsObjectDataSource`.</span></span> <span data-ttu-id="ca1ab-223">Počáteční značka `ObjectDataSource` nyní vypadá podobně jako v následujícím příkladu.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-223">The `ObjectDataSource` opening tag now resembles the following example.</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample14.aspx)]

<span data-ttu-id="ca1ab-224">Do *departments.aspx.cs*přidejte následující příkaz `using`:</span><span class="sxs-lookup"><span data-stu-id="ca1ab-224">In *Departments.aspx.cs*, add the following `using` statement:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample15.cs)]

<span data-ttu-id="ca1ab-225">Přidejte následující obslužnou rutinu pro událost `Updated`:</span><span class="sxs-lookup"><span data-stu-id="ca1ab-225">Add the following handler for the `Updated` event:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample16.cs)]

<span data-ttu-id="ca1ab-226">Pokud ovládací prvek `ObjectDataSource` zachytí výjimku při pokusu o provedení aktualizace, předá výjimku v argumentu události (`e`) do této obslužné rutiny.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-226">If the `ObjectDataSource` control catches an exception when it tries to perform the update, it passes the exception in the event argument (`e`) to this handler.</span></span> <span data-ttu-id="ca1ab-227">Kód v obslužné rutině kontroluje, zda je výjimkou duplicitní výjimka správce.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-227">The code in the handler checks to see if the exception is the duplicate administrator exception.</span></span> <span data-ttu-id="ca1ab-228">Pokud je, kód vytvoří ovládací prvek validátor, který obsahuje chybovou zprávu pro zobrazení ovládacího prvku `ValidationSummary`.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-228">If it is, the code creates a validator control that contains an error message for the `ValidationSummary` control to display.</span></span>

<span data-ttu-id="ca1ab-229">Spusťte stránku a pokuste se znovu nastavit někoho jako správce dvou oddělení.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-229">Run the page and attempt to make someone the administrator of two departments again.</span></span> <span data-ttu-id="ca1ab-230">Tentokrát `ValidationSummary` ovládací prvek zobrazuje chybovou zprávu.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-230">This time the `ValidationSummary` control displays an error message.</span></span>

<span data-ttu-id="ca1ab-231">[![Image06](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image22.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image21.png)</span><span class="sxs-lookup"><span data-stu-id="ca1ab-231">[![Image06](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image22.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image21.png)</span></span>

<span data-ttu-id="ca1ab-232">Udělejte podobné změny na stránce *DepartmentsAdd. aspx* .</span><span class="sxs-lookup"><span data-stu-id="ca1ab-232">Make similar changes to the *DepartmentsAdd.aspx* page.</span></span> <span data-ttu-id="ca1ab-233">V *DepartmentsAdd. aspx*zadejte obslužnou rutinu pro událost `OnInserted` `DepartmentsObjectDataSource`.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-233">In *DepartmentsAdd.aspx*, specify a handler for the `OnInserted` event of the `DepartmentsObjectDataSource`.</span></span> <span data-ttu-id="ca1ab-234">Výsledný kód bude vypadat podobně jako v následujícím příkladu.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-234">The resulting markup will resemble the following example.</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample17.aspx)]

<span data-ttu-id="ca1ab-235">Do *DepartmentsAdd.aspx.cs*přidejte stejný příkaz `using`:</span><span class="sxs-lookup"><span data-stu-id="ca1ab-235">In *DepartmentsAdd.aspx.cs*, add the same `using` statement:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample18.cs)]

<span data-ttu-id="ca1ab-236">Přidejte následující obslužnou rutinu události:</span><span class="sxs-lookup"><span data-stu-id="ca1ab-236">Add the following event handler:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample19.cs)]

<span data-ttu-id="ca1ab-237">Teď můžete otestovat stránku *DepartmentsAdd.aspx.cs* a ověřit tak, že se také správně zpracovávají pokusy, aby jedna osoba mohla udělat správce více než jednoho oddělení.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-237">You can now test the *DepartmentsAdd.aspx.cs* page to verify that it also correctly handles attempts to make one person the administrator of more than one department.</span></span>

<span data-ttu-id="ca1ab-238">Tím se dokončí Úvod do implementace vzoru úložiště pro použití ovládacího prvku `ObjectDataSource` s Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-238">This completes the introduction to implementing the repository pattern for using the `ObjectDataSource` control with the Entity Framework.</span></span> <span data-ttu-id="ca1ab-239">Další informace o vzorcích a testování úložiště najdete v tématu testování dokumentů na webu MSDN [a Entity Framework 4,0](https://msdn.microsoft.com/library/ff714955.aspx).</span><span class="sxs-lookup"><span data-stu-id="ca1ab-239">For more information about the repository pattern and testability, see the MSDN whitepaper [Testability and Entity Framework 4.0](https://msdn.microsoft.com/library/ff714955.aspx).</span></span>

<span data-ttu-id="ca1ab-240">V následujícím kurzu se dozvíte, jak do aplikace přidat funkce řazení a filtrování.</span><span class="sxs-lookup"><span data-stu-id="ca1ab-240">In the following tutorial you'll see how to add sorting and filtering functionality to the application.</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="ca1ab-241">[Předchozí](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started.md)
> [Další](using-the-entity-framework-and-the-objectdatasource-control-part-3-sorting-and-filtering.md)</span><span class="sxs-lookup"><span data-stu-id="ca1ab-241">[Previous](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started.md)
[Next](using-the-entity-framework-and-the-objectdatasource-control-part-3-sorting-and-filtering.md)</span></span>
