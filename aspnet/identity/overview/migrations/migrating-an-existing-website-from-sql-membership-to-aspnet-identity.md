---
uid: identity/overview/migrations/migrating-an-existing-website-from-sql-membership-to-aspnet-identity
title: Migrace stávajícího webu z členství SQL na ASP.NET Identity – ASP.NET 4.x
author: Rick-Anderson
description: Tento kurz ukazuje kroky při migraci stávající webovou aplikaci s uživateli a data role vytvořené pomocí členství SQL na nový ASP.NET Identity s...
ms.author: riande
ms.date: 12/19/2014
ms.custom: seoapril2019
ms.assetid: 220d3d75-16b2-4240-beae-a5b534f06419
msc.legacyurl: /identity/overview/migrations/migrating-an-existing-website-from-sql-membership-to-aspnet-identity
msc.type: authoredcontent
ms.openlocfilehash: f205dfd8692bc946ca2124655bf8bcefbdbd1779
ms.sourcegitcommit: 0f1119340e4464720cfd16d0ff15764746ea1fea
ms.translationtype: MT
ms.contentlocale: cs-CZ
ms.lasthandoff: 04/17/2019
ms.locfileid: "59394523"
---
# <a name="migrating-an-existing-website-from-sql-membership-to-aspnet-identity"></a><span data-ttu-id="4aaa0-103">Migrace stávajícího webu z členství SQL na ASP.NET Identity</span><span class="sxs-lookup"><span data-stu-id="4aaa0-103">Migrating an Existing Website from SQL Membership to ASP.NET Identity</span></span>

<span data-ttu-id="4aaa0-104">podle [Rick Anderson]((https://twitter.com/RickAndMSFT)), [Suhas Joshi](https://github.com/suhasj)</span><span class="sxs-lookup"><span data-stu-id="4aaa0-104">by [Rick Anderson]((https://twitter.com/RickAndMSFT)), [Suhas Joshi](https://github.com/suhasj)</span></span>

> <span data-ttu-id="4aaa0-105">Tento kurz ukazuje kroky při migraci stávající webovou aplikaci s uživateli a data role vytvořené pomocí členství SQL na nový systém ASP.NET Identity.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-105">This tutorial illustrates the steps to migrate an existing web application with user and role data created using SQL Membership to the new ASP.NET Identity system.</span></span> <span data-ttu-id="4aaa0-106">Tento postup zahrnuje změnu existující schéma databáze do jednoho, který je potřeba pro ASP.NET Identity a volání v staré a nové třídy do ní.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-106">This approach involves changing the existing database schema to the one needed by the ASP.NET Identity and hook in the old/new classes to it.</span></span> <span data-ttu-id="4aaa0-107">Jakmile použijete tento přístup, až provedete migraci vaší databáze, se zpracuje bez námahy budoucí aktualizace Identity.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-107">After you adopt this approach, once your database is migrated, future updates to Identity will be handled effortlessly.</span></span>

<span data-ttu-id="4aaa0-108">Pro účely tohoto kurzu my podnikneme šablony webové aplikace (webové formuláře) vytvořené pomocí sady Visual Studio 2010 uživatele a roli data vytváří.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-108">For this tutorial, we will take a web application template (Web Forms) created using Visual Studio 2010 to create user and role data.</span></span> <span data-ttu-id="4aaa0-109">Skripty SQL použije pak migrovat existující databázi do tabulky, které jsou potřebné pro systém Identity.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-109">We will then use SQL scripts to migrate the existing database to tables needed by the Identity system.</span></span> <span data-ttu-id="4aaa0-110">V další části nainstalují potřebné balíčky NuGet a přidat nové stránky správy účtu, které používají systém identit pro správu členství.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-110">Next we'll install the necessary NuGet packages and add new account management pages which use the Identity system for membership management.</span></span> <span data-ttu-id="4aaa0-111">Jako test migrace uživatelé vytvořené pomocí členství SQL by měli být schopni se přihlásit a noví uživatelé by se moci zaregistrovat.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-111">As a test of migration, users created using SQL membership should be able to log in and new users should be able to register.</span></span> <span data-ttu-id="4aaa0-112">Úplnou ukázku najdete [tady](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SQLMembership-Identity-OWIN/).</span><span class="sxs-lookup"><span data-stu-id="4aaa0-112">You can find the complete sample [here](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SQLMembership-Identity-OWIN/).</span></span> <span data-ttu-id="4aaa0-113">Viz také [migrace z členství technologie ASP.NET na ASP.NET Identity](http://travis.io/blog/2015/03/24/migrate-from-aspnet-membership-to-aspnet-identity.html).</span><span class="sxs-lookup"><span data-stu-id="4aaa0-113">See also [Migrating from ASP.NET Membership to ASP.NET Identity](http://travis.io/blog/2015/03/24/migrate-from-aspnet-membership-to-aspnet-identity.html).</span></span>

## <a name="getting-started"></a><span data-ttu-id="4aaa0-114">Začínáme</span><span class="sxs-lookup"><span data-stu-id="4aaa0-114">Getting started</span></span>

### <a name="creating-an-application-with-sql-membership"></a><span data-ttu-id="4aaa0-115">Vytvoření aplikace s členství SQL</span><span class="sxs-lookup"><span data-stu-id="4aaa0-115">Creating an application with SQL Membership</span></span>

1. <span data-ttu-id="4aaa0-116">Musíme začít s existující aplikaci, která používá SQL členství a obsahuje data uživatelů a rolí.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-116">We need to start with an existing application that uses SQL membership and has user and role data.</span></span> <span data-ttu-id="4aaa0-117">Pro účely tohoto článku Pojďme vytvořit webovou aplikaci v sadě Visual Studio 2010.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-117">For the purpose of this article, let's create a web application in Visual Studio 2010.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image1.jpg)
2. <span data-ttu-id="4aaa0-118">Pomocí nástroje Konfigurace technologie ASP.NET vytvořit uživatele 2: **oldAdminUser** a **oldUser.**</span><span class="sxs-lookup"><span data-stu-id="4aaa0-118">Using the ASP.NET Configuration tool, create 2 users: **oldAdminUser** and **oldUser.**</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image1.png)

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image2.jpg)
3. <span data-ttu-id="4aaa0-119">Umožňuje vytvořit roli s názvem správce a přidejte "oldAdminUser" jako uživatel v této roli.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-119">Create a role named Admin and add 'oldAdminUser' as a user in that role.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image2.png)
4. <span data-ttu-id="4aaa0-120">Vytvořte oddíl správce serveru se Default.aspx.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-120">Create an Admin section of the site with a Default.aspx.</span></span> <span data-ttu-id="4aaa0-121">Nastavte značku autorizace v souboru web.config pro povolení přístupu jenom na uživatele ve správcovských rolích.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-121">Set the authorization tag in the web.config file to enable access only to users in Admin roles.</span></span> <span data-ttu-id="4aaa0-122">Další informace najdete tady [https://www.asp.net/web-forms/tutorials/security/roles/role-based-authorization-cs](../../../web-forms/overview/older-versions-security/roles/role-based-authorization-cs.md)</span><span class="sxs-lookup"><span data-stu-id="4aaa0-122">More information can be found here [https://www.asp.net/web-forms/tutorials/security/roles/role-based-authorization-cs](../../../web-forms/overview/older-versions-security/roles/role-based-authorization-cs.md)</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image3.png)
5. <span data-ttu-id="4aaa0-123">Zobrazí se databáze v Průzkumníku serveru pochopit tabulky vytvořené v systému členství SQL.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-123">View the database in Server Explorer to understand the tables created by the SQL membership system.</span></span> <span data-ttu-id="4aaa0-124">Data přihlášení uživatele je uložená v aspnet\_uživatelů a aspnet\_tabulky členství, zatímco role data se ukládají do aspnet\_role tabulky.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-124">The user login data is stored in the aspnet\_Users and aspnet\_Membership tables, while role data is stored in the aspnet\_Roles table.</span></span> <span data-ttu-id="4aaa0-125">Informace o tom, které jsou uživatelé, v jaké role je uložena v aspnet\_UsersInRoles tabulky.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-125">Information about which users are in which roles is stored in the aspnet\_UsersInRoles table.</span></span> <span data-ttu-id="4aaa0-126">Pro správu základní členství je dostačující k portu informace ve výše uvedené tabulky pro systém identit technologie ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-126">For basic membership management it is sufficient to port the information in the above tables to the ASP.NET Identity system.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image4.png)

### <a name="migrating-to-visual-studio-2013"></a><span data-ttu-id="4aaa0-127">Migrace na Visual Studio 2013</span><span class="sxs-lookup"><span data-stu-id="4aaa0-127">Migrating to Visual Studio 2013</span></span>

1. <span data-ttu-id="4aaa0-128">Nainstalovat Visual Studio Express 2013 for Web nebo Visual Studio 2013 spolu s [nejnovější aktualizace](https://www.microsoft.com/download/details.aspx?id=44921).</span><span class="sxs-lookup"><span data-stu-id="4aaa0-128">Install Visual Studio Express 2013 for Web or Visual Studio 2013 along with the [latest updates](https://www.microsoft.com/download/details.aspx?id=44921).</span></span>
2. <span data-ttu-id="4aaa0-129">Otevřete výše uvedené projekt ve vaší nainstalované verzi sady Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-129">Open the above project in your installed version of Visual Studio.</span></span> <span data-ttu-id="4aaa0-130">Pokud na počítači není nainstalován systém SQL Server Express, zobrazí se výzva při otevření projektu, protože používá připojovací řetězec SQL Express.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-130">If SQL Server Express is not installed on the machine, a prompt is displayed when you open the project, since the connection string uses SQL Express.</span></span> <span data-ttu-id="4aaa0-131">Můžete buď jako obejít změnit připojovací řetězec na instanci LocalDb nebo nainstalovat SQL Express.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-131">You can either choose to install SQL Express or as work around change the connection string to LocalDb.</span></span> <span data-ttu-id="4aaa0-132">Pro účely tohoto článku Změníme ji na instanci LocalDb.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-132">For this article we'll change it to LocalDb.</span></span>
3. <span data-ttu-id="4aaa0-133">Otevřete soubor web.config a změňte připojovací řetězec z. SQLExpress na v11.0 (LocalDb).</span><span class="sxs-lookup"><span data-stu-id="4aaa0-133">Open web.config and change the connection string from .SQLExpress to (LocalDb)v11.0.</span></span> <span data-ttu-id="4aaa0-134">Odebrat "User Instance = true" z připojovacího řetězce.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-134">Remove 'User Instance=true' from the connection string.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image3.jpg)
4. <span data-ttu-id="4aaa0-135">Otevřete Průzkumníka serveru a ověřte, že může být dodržen schéma tabulky a data.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-135">Open Server Explorer and verify that the table schema and data can be observed.</span></span>
5. <span data-ttu-id="4aaa0-136">Systém identit technologie ASP.NET pracuje s verze 4.5 nebo novější rozhraní Framework.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-136">The ASP.NET Identity system works with version 4.5 or higher of the framework.</span></span> <span data-ttu-id="4aaa0-137">Změnit cílení aplikace na 4.5 nebo vyšší.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-137">Retarget the application to 4.5 or higher.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image5.png)

    <span data-ttu-id="4aaa0-138">Sestavte projekt a ověřte, že neexistují žádné chyby.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-138">Build the project to verify that there are no errors.</span></span>

### <a name="installing-the-nuget-packages"></a><span data-ttu-id="4aaa0-139">Instalace balíčků Nuget</span><span class="sxs-lookup"><span data-stu-id="4aaa0-139">Installing the Nuget packages</span></span>

1. <span data-ttu-id="4aaa0-140">V Průzkumníku řešení klikněte pravým tlačítkem na projekt &gt; **spravovat balíčky NuGet**.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-140">In Solution Explorer, right-click the project &gt; **Manage NuGet Packages**.</span></span> <span data-ttu-id="4aaa0-141">Do vyhledávacího pole zadejte "Asp.net Identity".</span><span class="sxs-lookup"><span data-stu-id="4aaa0-141">In the search box, enter "Asp.net Identity".</span></span> <span data-ttu-id="4aaa0-142">Vyberte balíček, v seznamu výsledků a klikněte na nainstalovat.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-142">Select the package in the list of results and click install.</span></span> <span data-ttu-id="4aaa0-143">Přijměte licenční smlouvu po kliknutí na tlačítko "Souhlasím".</span><span class="sxs-lookup"><span data-stu-id="4aaa0-143">Accept the license agreement by clicking on "I Accept" button.</span></span> <span data-ttu-id="4aaa0-144">Všimněte si, že tento balíček nainstaluje balíčky závislostí: EntityFramework a identitu Microsoft ASP.NET Core.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-144">Note that this package will install the dependency packages: EntityFramework and Microsoft ASP.NET Identity Core.</span></span> <span data-ttu-id="4aaa0-145">Podobně nainstalujte následující balíčky (Přeskočit poslední 4 balíčky OWIN, pokud nechcete povolit přihlášení OAuth):</span><span class="sxs-lookup"><span data-stu-id="4aaa0-145">Similarly install the following packages (skip the last 4 OWIN packages if you don't want to enable OAuth log-in):</span></span>

   - <span data-ttu-id="4aaa0-146">Microsoft.AspNet.Identity.Owin</span><span class="sxs-lookup"><span data-stu-id="4aaa0-146">Microsoft.AspNet.Identity.Owin</span></span>
   - <span data-ttu-id="4aaa0-147">Microsoft.Owin.Host.SystemWeb</span><span class="sxs-lookup"><span data-stu-id="4aaa0-147">Microsoft.Owin.Host.SystemWeb</span></span>
   - <span data-ttu-id="4aaa0-148">Microsoft.Owin.Security.Facebook</span><span class="sxs-lookup"><span data-stu-id="4aaa0-148">Microsoft.Owin.Security.Facebook</span></span>
   - <span data-ttu-id="4aaa0-149">Microsoft.Owin.Security.Google</span><span class="sxs-lookup"><span data-stu-id="4aaa0-149">Microsoft.Owin.Security.Google</span></span>
   - <span data-ttu-id="4aaa0-150">Microsoft.Owin.Security.MicrosoftAccount</span><span class="sxs-lookup"><span data-stu-id="4aaa0-150">Microsoft.Owin.Security.MicrosoftAccount</span></span>
   - <span data-ttu-id="4aaa0-151">Microsoft.Owin.Security.Twitter</span><span class="sxs-lookup"><span data-stu-id="4aaa0-151">Microsoft.Owin.Security.Twitter</span></span>

     ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image6.png)

### <a name="migrate-database-to-the-new-identity-system"></a><span data-ttu-id="4aaa0-152">Migrace databáze do nového systému Identity</span><span class="sxs-lookup"><span data-stu-id="4aaa0-152">Migrate database to the new Identity system</span></span>

<span data-ttu-id="4aaa0-153">Dalším krokem je migrovat existující databázi do schématu vyžadují systém identit technologie ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-153">The next step is to migrate the existing database to a schema required by the ASP.NET Identity system.</span></span> <span data-ttu-id="4aaa0-154">K dosažení to spustíme SQL skriptu obsahující sadu příkazů pro vytvoření nových tabulek a migrovat stávající informace o uživateli do nové tabulky.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-154">To achieve this we run a SQL script which has a set of commands to create new tables and migrate existing user information to the new tables.</span></span> <span data-ttu-id="4aaa0-155">Soubor skriptu najdete [tady](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SQLMembership-Identity-OWIN/Migrations.sql).</span><span class="sxs-lookup"><span data-stu-id="4aaa0-155">The script file can be found [here](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SQLMembership-Identity-OWIN/Migrations.sql).</span></span>

<span data-ttu-id="4aaa0-156">Tento soubor skriptu je specifické pro tuto ukázku.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-156">This script file is specific to this sample.</span></span> <span data-ttu-id="4aaa0-157">Pokud schéma pro tabulky vytvořené pomocí členství SQL je přizpůsobit nebo skripty potřeba změnit odpovídajícím způsobem upravit.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-157">If the schema for the tables created using SQL membership is customized or modified the scripts need to be changed accordingly.</span></span>

### <a name="how-to-generate-the-sql-script-for-schema-migration"></a><span data-ttu-id="4aaa0-158">Jak vygenerovat skript SQL pro migrace schématu</span><span class="sxs-lookup"><span data-stu-id="4aaa0-158">How to generate the SQL script for schema migration</span></span>

<span data-ttu-id="4aaa0-159">ASP.NET Identity třídy fungovat ihned s daty ze stávajících uživatelů musíme migraci schématu databáze na ten vyžadované ASP.NET Identity.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-159">For ASP.NET Identity classes to work out of the box with the data of existing users, we need to migrate the database schema to the one needed by ASP.NET Identity.</span></span> <span data-ttu-id="4aaa0-160">Můžeme to udělat přidáním nové tabulky a kopírování stávající informace o těchto tabulkách.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-160">We can do this by adding new tables and copying the existing information to those tables.</span></span> <span data-ttu-id="4aaa0-161">Ve výchozím nastavení používá ASP.NET Identity objektu EntityFramework k mapování tříd modelu Identity zpět do databáze se uloží nebo načtou informace.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-161">By default ASP.NET Identity uses EntityFramework to map the Identity model classes back to the database to store/retrieve information.</span></span> <span data-ttu-id="4aaa0-162">Tyto třídy modelu implementovat rozhraní core Identity, definování uživatele a objekty role.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-162">These model classes implement the core Identity interfaces defining user and role objects.</span></span> <span data-ttu-id="4aaa0-163">Tabulky a sloupce v databázi jsou založeny na tyto třídy modelu.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-163">The tables and the columns in the database are based on these model classes.</span></span> <span data-ttu-id="4aaa0-164">Třídy modelu objektu EntityFramework Identity v2.1.0 a jejich vlastnosti jsou definované níže</span><span class="sxs-lookup"><span data-stu-id="4aaa0-164">The EntityFramework model classes in Identity v2.1.0 and their properties are as defined below</span></span>

| <span data-ttu-id="4aaa0-165">**IdentityUser**</span><span class="sxs-lookup"><span data-stu-id="4aaa0-165">**IdentityUser**</span></span> | <span data-ttu-id="4aaa0-166">**Typ**</span><span class="sxs-lookup"><span data-stu-id="4aaa0-166">**Type**</span></span> | <span data-ttu-id="4aaa0-167">**IdentityRole**</span><span class="sxs-lookup"><span data-stu-id="4aaa0-167">**IdentityRole**</span></span> | <span data-ttu-id="4aaa0-168">**IdentityUserRole**</span><span class="sxs-lookup"><span data-stu-id="4aaa0-168">**IdentityUserRole**</span></span> | <span data-ttu-id="4aaa0-169">**IdentityUserLogin**</span><span class="sxs-lookup"><span data-stu-id="4aaa0-169">**IdentityUserLogin**</span></span> | <span data-ttu-id="4aaa0-170">**IdentityUserClaim**</span><span class="sxs-lookup"><span data-stu-id="4aaa0-170">**IdentityUserClaim**</span></span> |
| --- | --- | --- | --- | --- | --- |
| <span data-ttu-id="4aaa0-171">ID</span><span class="sxs-lookup"><span data-stu-id="4aaa0-171">Id</span></span> | <span data-ttu-id="4aaa0-172">odkazy řetězců</span><span class="sxs-lookup"><span data-stu-id="4aaa0-172">string</span></span> | <span data-ttu-id="4aaa0-173">ID</span><span class="sxs-lookup"><span data-stu-id="4aaa0-173">Id</span></span> | <span data-ttu-id="4aaa0-174">RoleId</span><span class="sxs-lookup"><span data-stu-id="4aaa0-174">RoleId</span></span> | <span data-ttu-id="4aaa0-175">ProviderKey</span><span class="sxs-lookup"><span data-stu-id="4aaa0-175">ProviderKey</span></span> | <span data-ttu-id="4aaa0-176">ID</span><span class="sxs-lookup"><span data-stu-id="4aaa0-176">Id</span></span> |
| <span data-ttu-id="4aaa0-177">Uživatelské jméno</span><span class="sxs-lookup"><span data-stu-id="4aaa0-177">Username</span></span> | <span data-ttu-id="4aaa0-178">odkazy řetězců</span><span class="sxs-lookup"><span data-stu-id="4aaa0-178">string</span></span> | <span data-ttu-id="4aaa0-179">Name</span><span class="sxs-lookup"><span data-stu-id="4aaa0-179">Name</span></span> | <span data-ttu-id="4aaa0-180">UserId</span><span class="sxs-lookup"><span data-stu-id="4aaa0-180">UserId</span></span> | <span data-ttu-id="4aaa0-181">UserId</span><span class="sxs-lookup"><span data-stu-id="4aaa0-181">UserId</span></span> | <span data-ttu-id="4aaa0-182">ClaimType</span><span class="sxs-lookup"><span data-stu-id="4aaa0-182">ClaimType</span></span> |
| <span data-ttu-id="4aaa0-183">PasswordHash (Hodnota hash hesla)</span><span class="sxs-lookup"><span data-stu-id="4aaa0-183">PasswordHash</span></span> | <span data-ttu-id="4aaa0-184">odkazy řetězců</span><span class="sxs-lookup"><span data-stu-id="4aaa0-184">string</span></span> |  |  | <span data-ttu-id="4aaa0-185">LoginProvider</span><span class="sxs-lookup"><span data-stu-id="4aaa0-185">LoginProvider</span></span> | <span data-ttu-id="4aaa0-186">ClaimValue</span><span class="sxs-lookup"><span data-stu-id="4aaa0-186">ClaimValue</span></span> |
| <span data-ttu-id="4aaa0-187">SecurityStamp</span><span class="sxs-lookup"><span data-stu-id="4aaa0-187">SecurityStamp</span></span> | <span data-ttu-id="4aaa0-188">odkazy řetězců</span><span class="sxs-lookup"><span data-stu-id="4aaa0-188">string</span></span> |  |  |  | <span data-ttu-id="4aaa0-189">Uživatel\_Id</span><span class="sxs-lookup"><span data-stu-id="4aaa0-189">User\_Id</span></span> |
| <span data-ttu-id="4aaa0-190">E-mail</span><span class="sxs-lookup"><span data-stu-id="4aaa0-190">Email</span></span> | <span data-ttu-id="4aaa0-191">odkazy řetězců</span><span class="sxs-lookup"><span data-stu-id="4aaa0-191">string</span></span> |  |  |  |  |
| <span data-ttu-id="4aaa0-192">EmailConfirmed</span><span class="sxs-lookup"><span data-stu-id="4aaa0-192">EmailConfirmed</span></span> | <span data-ttu-id="4aaa0-193">bool</span><span class="sxs-lookup"><span data-stu-id="4aaa0-193">bool</span></span> |  |  |  |  |
| <span data-ttu-id="4aaa0-194">PhoneNumber</span><span class="sxs-lookup"><span data-stu-id="4aaa0-194">PhoneNumber</span></span> | <span data-ttu-id="4aaa0-195">odkazy řetězců</span><span class="sxs-lookup"><span data-stu-id="4aaa0-195">string</span></span> |  |  |  |  |
| <span data-ttu-id="4aaa0-196">PhoneNumberConfirmed</span><span class="sxs-lookup"><span data-stu-id="4aaa0-196">PhoneNumberConfirmed</span></span> | <span data-ttu-id="4aaa0-197">bool</span><span class="sxs-lookup"><span data-stu-id="4aaa0-197">bool</span></span> |  |  |  |  |
| <span data-ttu-id="4aaa0-198">LockoutEnabled</span><span class="sxs-lookup"><span data-stu-id="4aaa0-198">LockoutEnabled</span></span> | <span data-ttu-id="4aaa0-199">bool</span><span class="sxs-lookup"><span data-stu-id="4aaa0-199">bool</span></span> |  |  |  |  |
| <span data-ttu-id="4aaa0-200">LockoutEndDate</span><span class="sxs-lookup"><span data-stu-id="4aaa0-200">LockoutEndDate</span></span> | <span data-ttu-id="4aaa0-201">DateTime</span><span class="sxs-lookup"><span data-stu-id="4aaa0-201">DateTime</span></span> |  |  |  |  |
| <span data-ttu-id="4aaa0-202">AccessFailedCount</span><span class="sxs-lookup"><span data-stu-id="4aaa0-202">AccessFailedCount</span></span> | <span data-ttu-id="4aaa0-203">int</span><span class="sxs-lookup"><span data-stu-id="4aaa0-203">int</span></span> |  |  |  |  |

<span data-ttu-id="4aaa0-204">Potřebujeme mít tabulky se sloupci odpovídající vlastnosti pro každou z těchto modelů.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-204">We need to have tables for each of these models with columns corresponding to the properties.</span></span> <span data-ttu-id="4aaa0-205">Mapování mezi třídami a tabulky je definován v `OnModelCreating` metodu `IdentityDBContext`.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-205">The mapping between classes and tables is defined in the `OnModelCreating` method of the `IdentityDBContext`.</span></span> <span data-ttu-id="4aaa0-206">To se označuje jako metodu rozhraní API fluent konfigurace a další informace lze nalézt [tady](https://msdn.microsoft.com/data/jj591617.aspx).</span><span class="sxs-lookup"><span data-stu-id="4aaa0-206">This is known as the fluent API method of configuration and more information can be found [here](https://msdn.microsoft.com/data/jj591617.aspx).</span></span> <span data-ttu-id="4aaa0-207">Konfigurace pro třídy je, jak je uvedeno níže</span><span class="sxs-lookup"><span data-stu-id="4aaa0-207">The configuration for the classes is as mentioned below</span></span>

| <span data-ttu-id="4aaa0-208">**Třída**</span><span class="sxs-lookup"><span data-stu-id="4aaa0-208">**Class**</span></span> | <span data-ttu-id="4aaa0-209">**Tabulka**</span><span class="sxs-lookup"><span data-stu-id="4aaa0-209">**Table**</span></span> | <span data-ttu-id="4aaa0-210">**Primární klíč**</span><span class="sxs-lookup"><span data-stu-id="4aaa0-210">**Primary key**</span></span> | <span data-ttu-id="4aaa0-211">**Cizí klíč**</span><span class="sxs-lookup"><span data-stu-id="4aaa0-211">**Foreign key**</span></span> |
| --- | --- | --- | --- |
| <span data-ttu-id="4aaa0-212">IdentityUser</span><span class="sxs-lookup"><span data-stu-id="4aaa0-212">IdentityUser</span></span> | <span data-ttu-id="4aaa0-213">AspnetUsers</span><span class="sxs-lookup"><span data-stu-id="4aaa0-213">AspnetUsers</span></span> | <span data-ttu-id="4aaa0-214">ID</span><span class="sxs-lookup"><span data-stu-id="4aaa0-214">Id</span></span> |  |
| <span data-ttu-id="4aaa0-215">IdentityRole</span><span class="sxs-lookup"><span data-stu-id="4aaa0-215">IdentityRole</span></span> | <span data-ttu-id="4aaa0-216">AspnetRoles</span><span class="sxs-lookup"><span data-stu-id="4aaa0-216">AspnetRoles</span></span> | <span data-ttu-id="4aaa0-217">ID</span><span class="sxs-lookup"><span data-stu-id="4aaa0-217">Id</span></span> |  |
| <span data-ttu-id="4aaa0-218">IdentityUserRole</span><span class="sxs-lookup"><span data-stu-id="4aaa0-218">IdentityUserRole</span></span> | <span data-ttu-id="4aaa0-219">AspnetUserRole</span><span class="sxs-lookup"><span data-stu-id="4aaa0-219">AspnetUserRole</span></span> | <span data-ttu-id="4aaa0-220">ID uživatele a RoleId</span><span class="sxs-lookup"><span data-stu-id="4aaa0-220">UserId + RoleId</span></span> | <span data-ttu-id="4aaa0-221">User\_Id-&gt;AspnetUsers RoleId-&gt;AspnetRoles</span><span class="sxs-lookup"><span data-stu-id="4aaa0-221">User\_Id-&gt;AspnetUsers RoleId-&gt;AspnetRoles</span></span> |
| <span data-ttu-id="4aaa0-222">IdentityUserLogin</span><span class="sxs-lookup"><span data-stu-id="4aaa0-222">IdentityUserLogin</span></span> | <span data-ttu-id="4aaa0-223">AspnetUserLogins</span><span class="sxs-lookup"><span data-stu-id="4aaa0-223">AspnetUserLogins</span></span> | <span data-ttu-id="4aaa0-224">ProviderKey + UserId + LoginProvider</span><span class="sxs-lookup"><span data-stu-id="4aaa0-224">ProviderKey+UserId + LoginProvider</span></span> | <span data-ttu-id="4aaa0-225">UserId-&gt;AspnetUsers</span><span class="sxs-lookup"><span data-stu-id="4aaa0-225">UserId-&gt;AspnetUsers</span></span> |
| <span data-ttu-id="4aaa0-226">IdentityUserClaim</span><span class="sxs-lookup"><span data-stu-id="4aaa0-226">IdentityUserClaim</span></span> | <span data-ttu-id="4aaa0-227">AspnetUserClaims</span><span class="sxs-lookup"><span data-stu-id="4aaa0-227">AspnetUserClaims</span></span> | <span data-ttu-id="4aaa0-228">ID</span><span class="sxs-lookup"><span data-stu-id="4aaa0-228">Id</span></span> | <span data-ttu-id="4aaa0-229">User\_Id-&gt;AspnetUsers</span><span class="sxs-lookup"><span data-stu-id="4aaa0-229">User\_Id-&gt;AspnetUsers</span></span> |

<span data-ttu-id="4aaa0-230">Pomocí těchto informací můžeme vytvořit příkazy SQL k vytvoření nových tabulek.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-230">With this information we can create SQL statements to create new tables.</span></span> <span data-ttu-id="4aaa0-231">Můžeme zápisu každý příkaz samostatně nebo generovat celý skript pomocí příkazů Powershellu objektu EntityFramework, které jsme pak můžete upravit podle potřeby.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-231">We can either write each statement individually or generate the entire script using EntityFramework PowerShell commands which we can then edit as required.</span></span> <span data-ttu-id="4aaa0-232">K tomu ve VS otevřít **Konzola správce balíčků** z **zobrazení** nebo **nástroje** nabídky</span><span class="sxs-lookup"><span data-stu-id="4aaa0-232">To do this, in VS open the **Package Manager Console** from the **View** or **Tools** menu</span></span>

- <span data-ttu-id="4aaa0-233">Spuštěním příkazu "Enable-migrace" povolení migrace objektu EntityFramework.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-233">Run command "Enable-Migrations" to enable EntityFramework migrations.</span></span>
- <span data-ttu-id="4aaa0-234">Spusťte příkaz "Přidat migrace počáteční", které vytvoří počáteční nastavení kód k vytvoření databáze v jazyce C# / VB.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-234">Run command "Add-migration initial" which creates the initial setup code to create the database in C#/VB.</span></span>
- <span data-ttu-id="4aaa0-235">Posledním krokem je spuštění "aktualizace databáze – skriptu" u tříd modelu na základě příkazu, který generuje skript SQL.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-235">The final step is to run "Update-Database –Script" command that generates the SQL script based on the model classes.</span></span>

[!INCLUDE[](../../../includes/identity/alter-command-exception.md)]

<span data-ttu-id="4aaa0-236">Tento skript generování databáze může sloužit jako start, kde jsme budete provádět další změny přidávat nové sloupce a zkopírovat data.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-236">This database generation script can be used as a start where we'll be making additional changes to add new columns and copy data.</span></span> <span data-ttu-id="4aaa0-237">Výhodou je, že se vygeneruje `_MigrationHistory` tabulku, která používají EntityFramework k úpravě databázového schématu při změna v budoucích verzích Identity verze třídy modelu.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-237">The advantage of this is that we generate the `_MigrationHistory` table which is used by EntityFramework to modify the database schema when the model classes change for future versions of Identity releases.</span></span>

<span data-ttu-id="4aaa0-238">Informace o členství uživatele SQL má jiné vlastnosti společně s těmi v třídě modelu uživatelského Identity totiž e-mailu, pokusů o zadání hesla, datum posledního přihlášení, datum posledního uzamčení atd. To je užitečné informace, a rádi bychom to být přeneseny do systému identit.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-238">The SQL membership user information had other properties in addition to the ones in the Identity user model class namely email, password attempts, last login date, last lock-out date etc. This is useful information and we would like it to be carried over to the Identity system.</span></span> <span data-ttu-id="4aaa0-239">To lze provést přidáním dalších vlastností do uživatelského modelu a mapování zpět na sloupce tabulky v databázi.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-239">This can be done by adding additional properties to the user model and mapping them back to the table columns in the database.</span></span> <span data-ttu-id="4aaa0-240">Můžeme to udělat tak, že přidáte třídu, která je podtřídou `IdentityUser` modelu.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-240">We can do this by adding a class that subclasses the `IdentityUser` model.</span></span> <span data-ttu-id="4aaa0-241">Můžete do této vlastní třídy přidat vlastnosti a upravte skript SQL pro přidání odpovídající sloupce, při vytváření tabulky.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-241">We can add the properties to this custom class and edit the SQL script to add the corresponding columns when creating the table.</span></span> <span data-ttu-id="4aaa0-242">Kód pro tuto třídu je popsáno dále v tomto článku.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-242">The code for this class is described further in the article.</span></span> <span data-ttu-id="4aaa0-243">Skript SQL pro vytvoření `AspnetUsers` tabulky po přidání nových vlastností by</span><span class="sxs-lookup"><span data-stu-id="4aaa0-243">The SQL script for creating the `AspnetUsers` table after adding the new properties would be</span></span>

[!code-sql[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample1.sql)]

<span data-ttu-id="4aaa0-244">Dále jsme muset zkopírovat stávající informace o ze služby SQL database členství nově přidané tabulky pro identitu.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-244">Next we need to copy the existing information from the SQL membership database to the newly added tables for Identity.</span></span> <span data-ttu-id="4aaa0-245">To můžete udělat prostřednictvím SQL tak, že zkopírujete data přímo z jedné tabulky do druhé.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-245">This can be done through SQL by copying data directly from one table to another.</span></span> <span data-ttu-id="4aaa0-246">K přidání dat do řádky tabulky, použijeme `INSERT INTO [Table]` vytvořit.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-246">To add data into the rows of table, we use the `INSERT INTO [Table]` construct.</span></span> <span data-ttu-id="4aaa0-247">Zkopírujte z jiné tabulky, můžeme použít `INSERT INTO` příkaz spolu s `SELECT` příkazu.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-247">To copy from another table we can use the `INSERT INTO` statement along with the `SELECT` statement.</span></span> <span data-ttu-id="4aaa0-248">Chcete-li získat všechny informace o uživateli budeme muset dotázat *aspnet\_uživatelé* a *aspnet\_členství* tabulky a zkopírovat data do *AspNetUsers*tabulky.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-248">To get all the user information we need to query the *aspnet\_Users* and *aspnet\_Membership* tables and copy the data to the *AspNetUsers* table.</span></span> <span data-ttu-id="4aaa0-249">Používáme `INSERT INTO` a `SELECT` spolu s `JOIN` a `LEFT OUTER JOIN` příkazy.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-249">We use the `INSERT INTO` and `SELECT` along with `JOIN` and `LEFT OUTER JOIN` statements.</span></span> <span data-ttu-id="4aaa0-250">Další informace o dotazování a kopírování dat mezi tabulkami [to](https://technet.microsoft.com/library/ms190750%28v=sql.105%29.aspx) odkaz.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-250">For more information about querying and copying data between tables, refer to [this](https://technet.microsoft.com/library/ms190750%28v=sql.105%29.aspx) link.</span></span> <span data-ttu-id="4aaa0-251">Kromě AspnetUserLogins a AspnetUserClaims tabulky jsou prázdné začneme od nejsou k dispozici žádné informace v členství SQL, který se mapuje na to ve výchozím nastavení.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-251">Additionally the AspnetUserLogins and AspnetUserClaims tables are empty to begin with since there is no information in SQL membership that maps to this by default.</span></span> <span data-ttu-id="4aaa0-252">Jediná informace, zkopírovat je pro uživatele a role.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-252">The only information copied is for users and roles.</span></span> <span data-ttu-id="4aaa0-253">Pro projekt vytvořený v předchozích kroků by byl dotaz SQL pro kopírování informací do tabulky uživatelů</span><span class="sxs-lookup"><span data-stu-id="4aaa0-253">For the project created in the previous steps, the SQL query to copy information to the users table would be</span></span>

[!code-sql[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample2.sql)]

<span data-ttu-id="4aaa0-254">U výše uvedeného příkazu jazyka SQL, informace o jednotlivých uživatelů z *aspnet\_uživatelé* a *aspnet\_členství* tabulek zkopírována do sloupce  *AspnetUsers* tabulky.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-254">In the above SQL statement, information about each user from the *aspnet\_Users* and *aspnet\_Membership* tables is copied into the columns of the *AspnetUsers* table.</span></span> <span data-ttu-id="4aaa0-255">Pouze změny na jednom místě se při kopírování heslo.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-255">The only modification done here is when we copy the password.</span></span> <span data-ttu-id="4aaa0-256">Vzhledem k tomu použije algoritmus šifrování hesel v členství SQL "PasswordSalt" a "PasswordFormat", kopírování, která příliš spolu s hodnoty hash hesla tak, aby ho můžete použít k dešifrování hesla podle Identity.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-256">Since the encryption algorithm for passwords in SQL membership used 'PasswordSalt' and 'PasswordFormat', we copy that too along with the hashed password so that it can be used to decrypt the password by Identity.</span></span> <span data-ttu-id="4aaa0-257">To je vysvětleno dále v tomto článku při zapojování hasher vlastní heslo.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-257">This is explained further in the article when hooking up a custom password hasher.</span></span>

<span data-ttu-id="4aaa0-258">Tento soubor skriptu je specifické pro tuto ukázku.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-258">This script file is specific to this sample.</span></span> <span data-ttu-id="4aaa0-259">Pro aplikace, které mají další tabulky vývojáři postup podobný přístup se přidat další vlastnosti ve třídě model uživatele a jejich namapování na sloupce v tabulce AspnetUsers.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-259">For applications which have additional tables, developers can follow a similar approach to add additional properties on the user model class and map them to columns in the AspnetUsers table.</span></span> <span data-ttu-id="4aaa0-260">Ke spuštění skriptu</span><span class="sxs-lookup"><span data-stu-id="4aaa0-260">To run the script,</span></span>

1. <span data-ttu-id="4aaa0-261">Otevřete Průzkumníka serveru.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-261">Open Server Explorer.</span></span> <span data-ttu-id="4aaa0-262">Rozbalte "ApplicationServices" připojení k zobrazení tabulek.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-262">Expand the 'ApplicationServices' connection to display the tables.</span></span> <span data-ttu-id="4aaa0-263">Klikněte pravým tlačítkem na uzel tabulky a vyberte možnost "nový dotaz.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-263">Right click on the Tables node and select the 'New Query' option</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image7.png)
2. <span data-ttu-id="4aaa0-264">V okně dotazu zkopírujte a vložte celý skript SQL ze souboru Migrations.sql.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-264">In the query window, copy and paste the entire SQL script from the Migrations.sql file.</span></span> <span data-ttu-id="4aaa0-265">Spuštění souboru skriptu tím, že kliknete na tlačítko se šipkou "Spustit".</span><span class="sxs-lookup"><span data-stu-id="4aaa0-265">Run the script file by hitting the 'Execute' arrow button.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image4.jpg)

    <span data-ttu-id="4aaa0-266">Aktualizujte okno Průzkumníka serveru.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-266">Refresh the Server Explorer window.</span></span> <span data-ttu-id="4aaa0-267">Pět nových tabulek jsou vytvořeny v databázi.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-267">Five new tables are created in the database.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image8.png)

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image9.png)

    <span data-ttu-id="4aaa0-268">Níže je zpřístupněných informace v tabulce členství SQL na nový systém identit.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-268">Below is how the information in the SQL membership tables are mapped to the new Identity system.</span></span>

    <span data-ttu-id="4aaa0-269">ASPNET\_rolí –&gt; AspNetRoles</span><span class="sxs-lookup"><span data-stu-id="4aaa0-269">aspnet\_Roles --&gt; AspNetRoles</span></span>

    <span data-ttu-id="4aaa0-270">ASP\_netUsers a asp\_netMembership--&gt; AspNetUsers</span><span class="sxs-lookup"><span data-stu-id="4aaa0-270">asp\_netUsers and asp\_netMembership --&gt; AspNetUsers</span></span>

    <span data-ttu-id="4aaa0-271">aspnet\_UserInRoles --&gt; AspNetUserRoles</span><span class="sxs-lookup"><span data-stu-id="4aaa0-271">aspnet\_UserInRoles --&gt; AspNetUserRoles</span></span>

    <span data-ttu-id="4aaa0-272">Jak jsme vysvětlili výše v části, jsou prázdné tabulky AspNetUserClaims a AspNetUserLogins.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-272">As explained in the above section, the AspNetUserClaims and AspNetUserLogins tables are empty.</span></span> <span data-ttu-id="4aaa0-273">Pole 'Diskriminátor' v tabulce AspNetUser by měl odpovídat názvu třídy modelu, který je definován jako další krok.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-273">The 'Discriminator' field in the AspNetUser table should match the model class name which is defined as a next step.</span></span> <span data-ttu-id="4aaa0-274">Také PasswordHash sloupec je ve formě "šifrované heslo | hodnotu salt hesla | formát hesla".</span><span class="sxs-lookup"><span data-stu-id="4aaa0-274">Also the PasswordHash column is in the form 'encrypted password |password salt|password format'.</span></span> <span data-ttu-id="4aaa0-275">To umožňuje použít zvláštní logiku kryptografických členství SQL, takže můžete znovu použít staré heslo.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-275">This enables you to use special SQL membership crypto logic so that you can reuse old passwords.</span></span> <span data-ttu-id="4aaa0-276">V, který je vysvětlen později v tomto článku.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-276">That is explained in later in the article.</span></span>

### <a name="creating-models-and-membership-pages"></a><span data-ttu-id="4aaa0-277">Vytváření modelů a stránky členství</span><span class="sxs-lookup"><span data-stu-id="4aaa0-277">Creating models and membership pages</span></span>

<span data-ttu-id="4aaa0-278">Jak už bylo zmíněno dříve, funkce Identity používá Entity Framework komunikovat s databází pro ukládání informací o účtu ve výchozím nastavení.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-278">As mentioned earlier, the Identity feature uses Entity Framework to talk to the database for storing account information by default.</span></span> <span data-ttu-id="4aaa0-279">Pro práci s existujícími daty v tabulce, potřebujeme vytvořit model tříd, které mapují zpět do tabulek a připojení je v systému identit.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-279">To work with existing data in the table, we need to create model classes which map back to the tables and hook them up in the Identity system.</span></span> <span data-ttu-id="4aaa0-280">Jako součást smlouvy Identity tříd modelu by měla být buď implementovat rozhraní definované v knihovně dll Identity.Core nebo můžete rozšířit stávající implementaci těchto rozhraní, které jsou k dispozici v Microsoft.AspNet.Identity.EntityFramework.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-280">As part of the Identity contract, the model classes should either implement the interfaces defined in the Identity.Core dll or can extend the existing implementation of these interfaces available in Microsoft.AspNet.Identity.EntityFramework.</span></span>

<span data-ttu-id="4aaa0-281">V naší ukázce AspNetRoles, AspNetUserClaims, AspNetLogins a AspNetUserRole tabulky obsahují sloupce, které jsou podobné stávající implementaci systému identit.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-281">In our sample, the AspNetRoles, AspNetUserClaims, AspNetLogins and AspNetUserRole tables have columns that are similar to the existing implementation of the Identity system.</span></span> <span data-ttu-id="4aaa0-282">Proto jsme můžete znovu použít existující třídy pro mapování na těchto tabulkách.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-282">Hence we can reuse the existing classes to map to these tables.</span></span> <span data-ttu-id="4aaa0-283">Tabulka AspNetUser má některé další sloupce, které se používají k ukládání dalších informací z tabulky členství SQL.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-283">The AspNetUser table has some additional columns which are used to store additional information from the SQL membership tables.</span></span> <span data-ttu-id="4aaa0-284">To lze mapovat tak, že vytvoříte třídu modelu, který rozšířit stávající implementaci "IdentityUser" a přidejte další vlastnosti.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-284">This can be mapped by creating a model class that extend the existing implementation of 'IdentityUser' and add the additional properties.</span></span>

1. <span data-ttu-id="4aaa0-285">Vytvořte složku modely v projektu a přidejte třídu uživatele.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-285">Create a Models folder in the project and add a class User.</span></span> <span data-ttu-id="4aaa0-286">Název třídy by měl odpovídat data přidaná ve sloupci 'Diskriminátor' tabulky "AspnetUsers".</span><span class="sxs-lookup"><span data-stu-id="4aaa0-286">The name of the class should match the data added in the 'Discriminator' column of 'AspnetUsers' table.</span></span>

    ![](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/_static/image10.png)

    <span data-ttu-id="4aaa0-287">Třídu uživatelů by měl rozšířit třídu IdentityUser součástí *Microsoft.AspNet.Identity.EntityFramework* knihovny dll.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-287">The User class should extend the IdentityUser class found in the *Microsoft.AspNet.Identity.EntityFramework* dll.</span></span> <span data-ttu-id="4aaa0-288">Deklarace vlastnosti ve třídě, které mapují AspNetUser sloupce.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-288">Declare the properties in class that map back to the AspNetUser columns.</span></span> <span data-ttu-id="4aaa0-289">Vlastnosti ID, uživatelské jméno, PasswordHash a SecurityStamp jsou definovány v IdentityUser a proto jsou vynechány.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-289">The properties ID, Username, PasswordHash and SecurityStamp are defined in the IdentityUser and so are omitted.</span></span> <span data-ttu-id="4aaa0-290">Níže je kód pro třídu uživatelů, který má všechny vlastnosti</span><span class="sxs-lookup"><span data-stu-id="4aaa0-290">Below is the code for the User class that has all the properties</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample3.cs)]
2. <span data-ttu-id="4aaa0-291">Třídu DbContext v Entity Framework je nutná k uchování dat v modelech zpět do tabulek a načtěte data z tabulek k naplnění modely.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-291">An Entity Framework DbContext class is required in order to persist data in models back to tables and retrieve data from tables to populate the models.</span></span> <span data-ttu-id="4aaa0-292">*Microsoft.AspNet.Identity.EntityFramework* knihovny dll definuje třídu IdentityDbContext, která komunikuje s tabulkami Identity k získávání a ukládání informací.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-292">*Microsoft.AspNet.Identity.EntityFramework* dll defines the IdentityDbContext class which interacts with the Identity tables to retrieve and store information.</span></span> <span data-ttu-id="4aaa0-293">IdentityDbContext&lt;tuser&gt; trvá "TUser" třídu, která může být libovolná třída, která rozšiřuje třídu IdentityUser.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-293">The IdentityDbContext&lt;tuser&gt; takes a 'TUser' class which can be any class that extends the IdentityUser class.</span></span>

    <span data-ttu-id="4aaa0-294">Vytvořte novou třídu ApplicationDBContext, která rozšiřuje IdentityDbContext ve složce "Modely" předávání ve třídě 'Uživatele' vytvořili v kroku 1</span><span class="sxs-lookup"><span data-stu-id="4aaa0-294">Create a new class ApplicationDBContext that extends IdentityDbContext under the 'Models' folder, passing in the 'User' class created in step 1</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample4.cs)]
3. <span data-ttu-id="4aaa0-295">Správa uživatelů v novém systému identit se provádí pomocí objektu UserManager.&lt;tuser&gt; třídy definované v *Microsoft.AspNet.Identity.EntityFramework* knihovny dll.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-295">User management in the new Identity system is done using the UserManager&lt;tuser&gt; class defined in the *Microsoft.AspNet.Identity.EntityFramework* dll.</span></span> <span data-ttu-id="4aaa0-296">Potřebujeme vytvořit vlastní třídu, která rozšiřuje objektu UserManager, předávání ve třídě 'Uživatele' vytvořili v kroku 1.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-296">We need to create a custom class that extends UserManager, passing in the 'User' class created in step 1.</span></span>

    <span data-ttu-id="4aaa0-297">Ve složce modely vytvořte novou třídu objektu UserManager, která rozšiřuje objektu UserManager&lt;uživatele&gt;</span><span class="sxs-lookup"><span data-stu-id="4aaa0-297">In the Models folder create a new class UserManager that extends UserManager&lt;user&gt;</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample5.cs)]
4. <span data-ttu-id="4aaa0-298">Hesla uživatelů aplikace jsou zašifrované a uložené v databázi.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-298">The passwords of the users of the application are encrypted and stored in the database.</span></span> <span data-ttu-id="4aaa0-299">Šifrovací algoritmus použitý v členství SQL je odlišné od těch v novém systému identit.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-299">The crypto algorithm used in SQL membership is different from the one in the new Identity system.</span></span> <span data-ttu-id="4aaa0-300">Chcete-li znovu použít staré heslo potřebujeme selektivně dešifrování hesla staré uživatelům přihlášení pomocí algoritmu členství SQL při použití šifrovacího algoritmu pro nové uživatele v identitě.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-300">To reuse old passwords we need to selectively decrypt passwords when old users log in using the SQL memberships algorithm while using the crypto algorithm in Identity for the new users.</span></span>

    <span data-ttu-id="4aaa0-301">Třída objektu UserManager. má vlastnost 'PasswordHasher", která ukládá instance třídy, která implementuje rozhraní 'ipasswordhasher.'.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-301">The UserManager class has a property 'PasswordHasher' which stores an instance of a class that implements the 'IPasswordHasher' interface.</span></span> <span data-ttu-id="4aaa0-302">Slouží k šifrování/dešifrování hesla během uživatelské transakce v ověřování.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-302">This is used to encrypt/decrypt passwords during user authentication transactions.</span></span> <span data-ttu-id="4aaa0-303">Ve třídě objektu UserManager definovaný v kroku 3, vytvořte novou třídu SQLPasswordHasher a zkopírujte níže uvedeného kódu.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-303">In the UserManager class defined in step 3, create a new class SQLPasswordHasher and copy the below code.</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample6.cs)]

    <span data-ttu-id="4aaa0-304">Import oborech názvů System.Text slouží a System.Security.Cryptography vyřešte chyby kompilace.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-304">Resolve the compilation errors by importing the System.Text and System.Security.Cryptography namespaces.</span></span>

    <span data-ttu-id="4aaa0-305">Metoda EncodePassword šifruje heslo podle implementace kryptografických členství SQL výchozí.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-305">The EncodePassword method encrypts the password according to the default SQL membership crypto implementation.</span></span> <span data-ttu-id="4aaa0-306">To je převzata z knihovny dll System.Web.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-306">This is taken from the System.Web dll.</span></span> <span data-ttu-id="4aaa0-307">Pokud původní aplikace používali vlastní implementaci by měl být projeví tady.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-307">If the old app used a custom implementation then it should be reflected here.</span></span> <span data-ttu-id="4aaa0-308">Budeme muset definovat dvě další metody *HashPassword* a *VerifyHashedPassword* , které používají *EncodePassword* metoda hash dané heslo nebo ověřit prostý text heslo s jednu existující v databázi.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-308">We need to define two other methods *HashPassword* and *VerifyHashedPassword* that use the *EncodePassword* method to hash a given password or verify a plain text password with the one existing in the database.</span></span>

    <span data-ttu-id="4aaa0-309">Systém členství SQL použít PasswordHash, PasswordSalt a PasswordFormat hodnoty hash hesla uživatele zadané při registraci nebo změnit své heslo.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-309">The SQL membership system used PasswordHash, PasswordSalt and PasswordFormat to hash the password entered by users when they register or change their password.</span></span> <span data-ttu-id="4aaa0-310">Během migrace jsou tři pole jsou uloženy v PasswordHash sloupec v tabulce AspNetUser oddělené "|" znak.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-310">During the migration all the three fields are stored in the PasswordHash column in the AspNetUser table separated by the '|' character.</span></span> <span data-ttu-id="4aaa0-311">Při přihlášení uživatele a heslo má tato pole, můžeme pomocí crypto členství SQL Zkontrolujte heslo. v opačném případě používáme výchozí crypto systém identit Ověřte heslo.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-311">When a user logs in and the password has these fields, we use the SQL membership crypto to check the password; otherwise we use the Identity system's default crypto to verify the password.</span></span> <span data-ttu-id="4aaa0-312">Tímto způsobem staré uživatele nemusí ke změně hesla po migraci oznámení o aplikaci.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-312">This way old users would not have to change their passwords once the app is migrated.</span></span>
5. <span data-ttu-id="4aaa0-313">Deklarujte konstruktor pro třídu objektu UserManager a předat ji jako SQLPasswordHasher vlastnosti v konstruktoru.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-313">Declare the constructor for the UserManager class and pass this as the SQLPasswordHasher to the property in the constructor.</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample7.cs)]

### <a name="create-new-account-management-pages"></a><span data-ttu-id="4aaa0-314">Vytvořit nový účet management stránky</span><span class="sxs-lookup"><span data-stu-id="4aaa0-314">Create new account management pages</span></span>

<span data-ttu-id="4aaa0-315">Dalším krokem při migraci je přidat účet správu stránky, které vám umožní uživateli zaregistrovat a přihlaste se.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-315">The next step in the migration is to add account management pages that will let a user register and log in.</span></span> <span data-ttu-id="4aaa0-316">Starý účet stránky z členství SQL používat ovládací prvky, které nefungují s novým systémem identit.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-316">The old account pages from SQL membership use controls that don't work with the new Identity system.</span></span> <span data-ttu-id="4aaa0-317">Přidání nového uživatele správu stránky, postupujte podle kurzu na tento odkaz [ https://www.asp.net/identity/overview/getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project ](../getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project.md) od kroku 'Přidat webové formuláře pro registrace uživatelů do vaší aplikace' protože jsme už vytvořili projektu a přidání balíčku NuGet balíčky.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-317">To add the new user management pages follow the tutorial at this link [https://www.asp.net/identity/overview/getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project](../getting-started/adding-aspnet-identity-to-an-empty-or-existing-web-forms-project.md) starting from the step 'Adding Web Forms for registering users to your application' since we have already created the project and added the NuGet packages.</span></span>

<span data-ttu-id="4aaa0-318">Potřebujeme udělat nějaké změny ukázka fungovala s projektem, který máme k dispozici zde.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-318">We need to make some changes for the sample to work with the project we have here.</span></span>

- <span data-ttu-id="4aaa0-319">Register.aspx.cs a Login.aspx.cs kód za použití třídy `UserManager` z balíčků identit k vytvoření uživatele.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-319">The Register.aspx.cs and Login.aspx.cs code behind classes use the `UserManager` from the Identity packages to create a User.</span></span> <span data-ttu-id="4aaa0-320">V tomto příkladu pomocí objektu UserManager přidáno ve složce modelů pomocí kroků uvedených výše.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-320">For this example use the UserManager added in the Models folder by following the steps mentioned earlier.</span></span>
- <span data-ttu-id="4aaa0-321">Použití třídy uživatel vytvořil, a nikoli IdentityUser v Register.aspx.cs a Login.aspx.cs kódu na pozadí třídy.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-321">Use the User class created instead of the IdentityUser in Register.aspx.cs and Login.aspx.cs code behind classes.</span></span> <span data-ttu-id="4aaa0-322">To zavěšení ve třídě naše vlastní uživatelské do systému identit.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-322">This hooks in our custom user class into the Identity system.</span></span>
- <span data-ttu-id="4aaa0-323">Část k vytvoření databáze mohly být přeskočeny.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-323">The part to create the database can be skipped.</span></span>
- <span data-ttu-id="4aaa0-324">Vývojář musí nastavit ApplicationId pro nového uživatele tak, aby odpovídaly aktuálním ID aplikace.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-324">The developer needs to set the ApplicationId for the new user to match the current application ID.</span></span> <span data-ttu-id="4aaa0-325">To můžete udělat předtím, než je vytvořen objekt uživatele ve třídě Register.aspx.cs dotazování ApplicationId pro tuto aplikaci a nastavíte ho před vytvořením uživatele.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-325">This can be done by querying the ApplicationId for this application before a user object is created in the Register.aspx.cs class and setting it before creating user.</span></span>

    <span data-ttu-id="4aaa0-326">Příklad:</span><span class="sxs-lookup"><span data-stu-id="4aaa0-326">Example:</span></span>

    <span data-ttu-id="4aaa0-327">Definování metody ve stránce Register.aspx.cs k dotazování aspnet\_aplikace tabulky a získání Id aplikace podle názvu aplikace</span><span class="sxs-lookup"><span data-stu-id="4aaa0-327">Define a method in Register.aspx.cs page to query the aspnet\_Applications table and get the application Id according to application name</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample8.cs)]

    <span data-ttu-id="4aaa0-328">Teď získáte nastavením této hodnoty na objekt uživatele</span><span class="sxs-lookup"><span data-stu-id="4aaa0-328">Now get set this on the user object</span></span>

    [!code-csharp[Main](migrating-an-existing-website-from-sql-membership-to-aspnet-identity/samples/sample9.cs)]

<span data-ttu-id="4aaa0-329">Pomocí staré uživatelské jméno a heslo k přihlášení stávajícího uživatele.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-329">Use the old username and password to login an existing user.</span></span> <span data-ttu-id="4aaa0-330">Na stránce registrace k vytvoření nového uživatele.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-330">Use the Register page to create a new user.</span></span> <span data-ttu-id="4aaa0-331">Dál ověřte, že uživatelé jsou v rolích podle očekávání.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-331">Also verify that the users are in roles as expected.</span></span>

<span data-ttu-id="4aaa0-332">Přenos aplikací do systému identit pomáhá uživateli přidat do aplikace Open Authentication (OAuth).</span><span class="sxs-lookup"><span data-stu-id="4aaa0-332">Porting to the Identity system helps the user add Open Authentication (OAuth) to the application.</span></span> <span data-ttu-id="4aaa0-333">Najdete ukázky [tady](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SQLMembership-Identity-OWIN/) který má povolené ověřování OAuth.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-333">Please refer to the sample [here](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SQLMembership-Identity-OWIN/) which has OAuth enabled.</span></span>

## <a name="next-steps"></a><span data-ttu-id="4aaa0-334">Další kroky</span><span class="sxs-lookup"><span data-stu-id="4aaa0-334">Next Steps</span></span>

<span data-ttu-id="4aaa0-335">V tomto kurzu jsme vám ukázali jak přenést uživatele z členství SQL na ASP.NET Identity, ale neměli jsme port data profilu.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-335">In this tutorial we showed how to port users from SQL membership to ASP.NET Identity, but we didn't port Profile data.</span></span> <span data-ttu-id="4aaa0-336">V dalším kurzu se podíváme na přenos dat profilu z členství SQL na nový systém identit.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-336">In the next tutorial we'll look into porting Profile data from SQL membership to the new Identity system.</span></span>

<span data-ttu-id="4aaa0-337">Zpětná vazba v dolní části tohoto článku můžete nechat.</span><span class="sxs-lookup"><span data-stu-id="4aaa0-337">You can leave feedback at the bottom of this article.</span></span>

<span data-ttu-id="4aaa0-338">*Děkujeme, že Tomáš Dykstra a Rick Anderson revize článku.*</span><span class="sxs-lookup"><span data-stu-id="4aaa0-338">*Thanks to Tom Dykstra and Rick Anderson for reviewing the article.*</span></span>
