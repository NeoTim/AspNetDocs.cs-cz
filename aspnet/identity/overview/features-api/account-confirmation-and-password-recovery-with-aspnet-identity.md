---
uid: identity/overview/features-api/account-confirmation-and-password-recovery-with-aspnet-identity
title: Potvrzení účtu & obnovení hesla-ASP.NET Identity (C#)-ASP.NET 4. x
author: HaoK
description: Před provedením tohoto kurzu byste měli nejdřív dokončit vytvoření zabezpečené webové aplikace ASP.NET MVC 5 s přihlášením, potvrzením e-mailu a resetováním hesla. Tento kurz...
ms.author: riande
ms.date: 01/23/2019
ms.assetid: 8d54180d-f826-4df7-b503-7debf5ed9fb3
ms.custom: seoapril2019
msc.legacyurl: /identity/overview/features-api/account-confirmation-and-password-recovery-with-aspnet-identity
msc.type: authoredcontent
ms.openlocfilehash: 4b2c88280df39aa81d60f9508910e8fe5d6db6b8
ms.sourcegitcommit: 88fc80e3f65aebdf61ec9414810ddbc31c543f04
ms.translationtype: MT
ms.contentlocale: cs-CZ
ms.lasthandoff: 01/22/2020
ms.locfileid: "76519112"
---
# <a name="account-confirmation-and-password-recovery-with-aspnet-identity-c"></a><span data-ttu-id="7fab5-104">Potvrzení účtu a obnovení hesla pomocí ASP.NET Identity (C#)</span><span class="sxs-lookup"><span data-stu-id="7fab5-104">Account confirmation and password recovery with ASP.NET Identity (C#)</span></span>

> <span data-ttu-id="7fab5-105">Před provedením tohoto kurzu byste měli nejdřív dokončit [Vytvoření zabezpečené webové aplikace ASP.NET MVC 5 s přihlášením, potvrzením e-mailu a resetováním hesla](../../../mvc/overview/security/create-an-aspnet-mvc-5-web-app-with-email-confirmation-and-password-reset.md).</span><span class="sxs-lookup"><span data-stu-id="7fab5-105">Before doing this tutorial you should first complete [Create a secure ASP.NET MVC 5 web app with log in, email confirmation and password reset](../../../mvc/overview/security/create-an-aspnet-mvc-5-web-app-with-email-confirmation-and-password-reset.md).</span></span> <span data-ttu-id="7fab5-106">Tento kurz obsahuje další podrobnosti a ukáže vám, jak nastavit e-mail pro potvrzení místního účtu a umožní uživatelům resetovat zapomenuté heslo v ASP.NET Identity.</span><span class="sxs-lookup"><span data-stu-id="7fab5-106">This tutorial contains more details and will show you how to set up email for local account confirmation and allow users to reset their forgotten password in ASP.NET Identity.</span></span>

<span data-ttu-id="7fab5-107">Místní uživatelský účet vyžaduje, aby uživatel vytvořil heslo pro účet a toto heslo bylo uloženo (bezpečně) ve webové aplikaci.</span><span class="sxs-lookup"><span data-stu-id="7fab5-107">A local user account requires the user to create a password for the account, and that password is stored (securely) in the web app.</span></span> <span data-ttu-id="7fab5-108">ASP.NET Identity také podporuje účty sociálních sítí, které nevyžadují, aby uživatel pro aplikaci vytvořil heslo.</span><span class="sxs-lookup"><span data-stu-id="7fab5-108">ASP.NET Identity also supports social accounts, which don't require the user to create a password for the app.</span></span> <span data-ttu-id="7fab5-109">[Účty sociálních sítí](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) používají k ověřování uživatelů třetí stranu (například Google, Twitter, Facebook nebo Microsoft).</span><span class="sxs-lookup"><span data-stu-id="7fab5-109">[Social accounts](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) use a third party (such as Google, Twitter, Facebook, or Microsoft) to authenticate users.</span></span> <span data-ttu-id="7fab5-110">Toto téma obsahuje následující témata:</span><span class="sxs-lookup"><span data-stu-id="7fab5-110">This topic covers the following:</span></span>

- <span data-ttu-id="7fab5-111">[Vytvořte aplikaci ASP.NET MVC](#createMvc) a prozkoumejte funkce ASP.NET identity.</span><span class="sxs-lookup"><span data-stu-id="7fab5-111">[Create an ASP.NET MVC app](#createMvc) and explore ASP.NET Identity features.</span></span>
- [<span data-ttu-id="7fab5-112">Sestavení ukázky identity</span><span class="sxs-lookup"><span data-stu-id="7fab5-112">Build the Identity sample</span></span>](#build)
- [<span data-ttu-id="7fab5-113">Nastavení potvrzení e-mailu</span><span class="sxs-lookup"><span data-stu-id="7fab5-113">Set up email confirmation</span></span>](#email)

<span data-ttu-id="7fab5-114">Noví uživatelé registrují svůj e-mailový alias, který vytvoří místní účet.</span><span class="sxs-lookup"><span data-stu-id="7fab5-114">New users register their email alias, which creates a local account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image1.png)

<span data-ttu-id="7fab5-115">Po výběru tlačítka zaregistrovat se na svou e-mailovou adresu pošle potvrzovací e-mail s ověřovacím tokenem.</span><span class="sxs-lookup"><span data-stu-id="7fab5-115">Selecting the Register button sends a confirmation email containing a validation token to their email address.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image2.png)

<span data-ttu-id="7fab5-116">Uživateli se pošle e-mail s potvrzovacím tokenem pro svůj účet.</span><span class="sxs-lookup"><span data-stu-id="7fab5-116">The user is sent an email with a confirmation token for their account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image3.png)

<span data-ttu-id="7fab5-117">Po výběru tohoto odkazu se účet potvrdí.</span><span class="sxs-lookup"><span data-stu-id="7fab5-117">Selecting the link confirms the account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image4.png)

<a id="passwordReset"></a>

## <a name="password-recoveryreset"></a><span data-ttu-id="7fab5-118">Obnovení a resetování hesla</span><span class="sxs-lookup"><span data-stu-id="7fab5-118">Password recovery/reset</span></span>

<span data-ttu-id="7fab5-119">Místní uživatelé, kteří si zapomene heslo, můžou mít token zabezpečení odeslaný na svůj e-mailový účet, který jim umožňuje resetovat heslo.</span><span class="sxs-lookup"><span data-stu-id="7fab5-119">Local users who forget their password can have a security token sent to their email account, enabling them to reset their password.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image5.png)  
  
<span data-ttu-id="7fab5-120">Uživatel brzy získá e-mail s odkazem, který jim umožňuje resetovat heslo.</span><span class="sxs-lookup"><span data-stu-id="7fab5-120">The user will soon get an email with a link allowing them to reset their password.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image6.png)  
<span data-ttu-id="7fab5-121">Výběr odkazu se převezme na stránku resetovat.</span><span class="sxs-lookup"><span data-stu-id="7fab5-121">Selecting the link will take them to the Reset page.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image7.png)  
  
<span data-ttu-id="7fab5-122">Kliknutím na tlačítko **obnovit** potvrďte, že se heslo resetoval.</span><span class="sxs-lookup"><span data-stu-id="7fab5-122">Selecting the **Reset** button will confirm the password has been reset.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image8.png)

<a id="createMvc"></a>

## <a name="create-an-aspnet-web-app"></a><span data-ttu-id="7fab5-123">Vytvoření webové aplikace ASP.NET</span><span class="sxs-lookup"><span data-stu-id="7fab5-123">Create an ASP.NET web app</span></span>

<span data-ttu-id="7fab5-124">Začněte instalací a spuštěním sady [Visual Studio 2017](https://visualstudio.microsoft.com/).</span><span class="sxs-lookup"><span data-stu-id="7fab5-124">Start by installing and running [Visual Studio 2017](https://visualstudio.microsoft.com/).</span></span>

1. <span data-ttu-id="7fab5-125">Vytvořte nový webový projekt v ASP.NET a vyberte šablonu MVC.</span><span class="sxs-lookup"><span data-stu-id="7fab5-125">Create a new ASP.NET Web project and select the MVC template.</span></span> <span data-ttu-id="7fab5-126">Webové formuláře také podporují ASP.NET Identity, takže můžete postupovat podle podobných kroků v aplikaci webových formulářů.</span><span class="sxs-lookup"><span data-stu-id="7fab5-126">Web Forms also support ASP.NET Identity, so you could follow similar steps in a web forms app.</span></span>
2. <span data-ttu-id="7fab5-127">Změňte ověřování na **jednotlivé uživatelské účty**.</span><span class="sxs-lookup"><span data-stu-id="7fab5-127">Change the authentication to **Individual User Accounts**.</span></span>
3. <span data-ttu-id="7fab5-128">Spusťte aplikaci, vyberte odkaz **zaregistrovat** a zaregistrujte uživatele.</span><span class="sxs-lookup"><span data-stu-id="7fab5-128">Run the app, select the **Register** link and register a user.</span></span> <span data-ttu-id="7fab5-129">V tomto okamžiku je jediným ověřením e-mailu atribut [[EmailAddress]](https://msdn.microsoft.com/library/system.componentmodel.dataannotations.emailaddressattribute(v=vs.110).aspx) .</span><span class="sxs-lookup"><span data-stu-id="7fab5-129">At this point, the only validation on the email is with the [[EmailAddress]](https://msdn.microsoft.com/library/system.componentmodel.dataannotations.emailaddressattribute(v=vs.110).aspx) attribute.</span></span>
4. <span data-ttu-id="7fab5-130">V Průzkumník serveru přejděte na **Connections\DefaultConnection\Tables\AspNetUsers dat**, klikněte pravým tlačítkem myši a vyberte **Otevřít definici tabulky**.</span><span class="sxs-lookup"><span data-stu-id="7fab5-130">In Server Explorer, navigate to **Data Connections\DefaultConnection\Tables\AspNetUsers**, right-click and select **Open table definition**.</span></span>

    <span data-ttu-id="7fab5-131">Následující obrázek ukazuje `AspNetUsers` schéma:</span><span class="sxs-lookup"><span data-stu-id="7fab5-131">The following image shows the `AspNetUsers` schema:</span></span>

    ![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image9.png)
5. <span data-ttu-id="7fab5-132">Klikněte pravým tlačítkem myši na tabulku **AspNetUsers** a vyberte možnost **Zobrazit data tabulky**.</span><span class="sxs-lookup"><span data-stu-id="7fab5-132">Right-click on the **AspNetUsers** table and select **Show Table Data**.</span></span>  
  
    ![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image10.png)  
  
   <span data-ttu-id="7fab5-133">V tomto okamžiku nebyl e-mail potvrzen.</span><span class="sxs-lookup"><span data-stu-id="7fab5-133">At this point the email has not been confirmed.</span></span>

<span data-ttu-id="7fab5-134">Výchozí úložiště dat pro ASP.NET Identity je Entity Framework, ale můžete ho nakonfigurovat tak, aby používalo jiné úložiště dat, a přidat další pole.</span><span class="sxs-lookup"><span data-stu-id="7fab5-134">The default data store for ASP.NET Identity is Entity Framework, but you can configure it to use other data stores and to add additional fields.</span></span> <span data-ttu-id="7fab5-135">Další informace najdete v části [Další materiály](#addRes) na konci tohoto kurzu.</span><span class="sxs-lookup"><span data-stu-id="7fab5-135">See [Additional Resources](#addRes) section at the end of this tutorial.</span></span>

<span data-ttu-id="7fab5-136">[Třída Owin Startup](../../../aspnet/overview/owin-and-katana/owin-startup-class-detection.md) ( *Startup.cs* ) se volá při spuštění aplikace a vyvolá metodu `ConfigureAuth` v *App\_START\STARTUP.auth.cs*, která konfiguruje kanál Owin a inicializuje ASP.NET identity.</span><span class="sxs-lookup"><span data-stu-id="7fab5-136">The [OWIN startup class](../../../aspnet/overview/owin-and-katana/owin-startup-class-detection.md) ( *Startup.cs* ) is called when the app starts and invokes the `ConfigureAuth` method in *App\_Start\Startup.Auth.cs*, which configures the OWIN pipeline and initializes ASP.NET Identity.</span></span> <span data-ttu-id="7fab5-137">Zkontrolujte `ConfigureAuth` metody.</span><span class="sxs-lookup"><span data-stu-id="7fab5-137">Examine the `ConfigureAuth` method.</span></span> <span data-ttu-id="7fab5-138">Každé volání `CreatePerOwinContext` zaregistruje zpětné volání (uložené v `OwinContext`), které se bude volat jednou za požadavek na vytvoření instance zadaného typu.</span><span class="sxs-lookup"><span data-stu-id="7fab5-138">Each `CreatePerOwinContext` call registers a callback (saved in the `OwinContext`) that will be called once per request to create an instance of the specified type.</span></span> <span data-ttu-id="7fab5-139">Můžete nastavit bod přerušení v konstruktoru a metodu `Create` každého typu (`ApplicationDbContext, ApplicationUserManager`) a ověřit, že jsou volány na každém požadavku.</span><span class="sxs-lookup"><span data-stu-id="7fab5-139">You can set a break point in the constructor and `Create` method of each type (`ApplicationDbContext, ApplicationUserManager`) and verify they are called on each request.</span></span> <span data-ttu-id="7fab5-140">Instance `ApplicationDbContext` a `ApplicationUserManager` je uložena v kontextu OWIN, který lze použít v celé aplikaci.</span><span class="sxs-lookup"><span data-stu-id="7fab5-140">A instance of `ApplicationDbContext` and `ApplicationUserManager` is stored in the OWIN context, which can be accessed throughout the application.</span></span> <span data-ttu-id="7fab5-141">ASP.NET Identity do kanálu OWIN prostřednictvím middleware souboru cookie.</span><span class="sxs-lookup"><span data-stu-id="7fab5-141">ASP.NET Identity hooks into the OWIN pipeline through cookie middleware.</span></span> <span data-ttu-id="7fab5-142">Další informace najdete v tématu [Správa životního cyklu požadavků pro třídu UserManager v ASP.NET identity](https://blogs.msdn.com/b/webdev/archive/2014/02/12/per-request-lifetime-management-for-usermanager-class-in-asp-net-identity.aspx).</span><span class="sxs-lookup"><span data-stu-id="7fab5-142">For more information, see [Per request lifetime management for UserManager class in ASP.NET Identity](https://blogs.msdn.com/b/webdev/archive/2014/02/12/per-request-lifetime-management-for-usermanager-class-in-asp-net-identity.aspx).</span></span>

<span data-ttu-id="7fab5-143">Když změníte profil zabezpečení, vygeneruje se nové bezpečnostní razítko, které se uloží do pole `SecurityStamp` tabulky *AspNetUsers* .</span><span class="sxs-lookup"><span data-stu-id="7fab5-143">When you change your security profile, a new security stamp is generated and stored in the `SecurityStamp` field of the *AspNetUsers* table.</span></span> <span data-ttu-id="7fab5-144">Poznámka: pole `SecurityStamp` se liší od souboru cookie zabezpečení.</span><span class="sxs-lookup"><span data-stu-id="7fab5-144">Note, the `SecurityStamp` field is different from the security cookie.</span></span> <span data-ttu-id="7fab5-145">Soubor cookie zabezpečení není uložený v `AspNetUsers` tabulce (nebo nikde jinde v databázi identity).</span><span class="sxs-lookup"><span data-stu-id="7fab5-145">The security cookie is not stored in the `AspNetUsers` table (or anywhere else in the Identity DB).</span></span> <span data-ttu-id="7fab5-146">Token cookie zabezpečení je podepsaný svým držitelem pomocí [DPAPI](https://msdn.microsoft.com/library/system.security.cryptography.protecteddata.aspx) a vytvoří se s informacemi o `UserId, SecurityStamp` a času vypršení platnosti.</span><span class="sxs-lookup"><span data-stu-id="7fab5-146">The security cookie token is self-signed using [DPAPI](https://msdn.microsoft.com/library/system.security.cryptography.protecteddata.aspx) and is created with the `UserId, SecurityStamp` and expiration time information.</span></span>

<span data-ttu-id="7fab5-147">Middleware souboru cookie kontroluje soubory cookie u jednotlivých požadavků.</span><span class="sxs-lookup"><span data-stu-id="7fab5-147">The cookie middleware checks the cookie on each request.</span></span> <span data-ttu-id="7fab5-148">Metoda `SecurityStampValidator` ve třídě `Startup` narazí na databázi a pravidelně kontroluje razítko zabezpečení, jak je uvedeno v `validateInterval`.</span><span class="sxs-lookup"><span data-stu-id="7fab5-148">The `SecurityStampValidator` method in the `Startup` class hits the DB and checks security stamp periodically, as specified with the `validateInterval`.</span></span> <span data-ttu-id="7fab5-149">K této situaci dochází pouze každých 30 minut (v naší ukázce), pokud neměníte profil zabezpečení.</span><span class="sxs-lookup"><span data-stu-id="7fab5-149">This only happens every 30 minutes (in our sample) unless you change your security profile.</span></span> <span data-ttu-id="7fab5-150">Interval 30 minut byl zvolen pro minimalizaci cest k databázi.</span><span class="sxs-lookup"><span data-stu-id="7fab5-150">The 30 minute interval was chosen to minimize trips to the database.</span></span> <span data-ttu-id="7fab5-151">Další podrobnosti najdete v tomto [kurzu pro dvoustupňové ověřování](index.md) .</span><span class="sxs-lookup"><span data-stu-id="7fab5-151">See my [two-factor authentication tutorial](index.md) for more details.</span></span>

<span data-ttu-id="7fab5-152">Pro komentáře v kódu `UseCookieAuthentication` metoda podporuje ověřování souborem cookie.</span><span class="sxs-lookup"><span data-stu-id="7fab5-152">Per the comments in the code, the `UseCookieAuthentication` method supports cookie authentication.</span></span> <span data-ttu-id="7fab5-153">Pole `SecurityStamp` a související kód poskytují do aplikace další vrstvu zabezpečení, při změně hesla se odhlásíte z prohlížeče, ve kterém jste se přihlásili.</span><span class="sxs-lookup"><span data-stu-id="7fab5-153">The `SecurityStamp` field and associated code provides an extra layer of security to your app, when you change your password, you will be logged out of the browser you logged in with.</span></span> <span data-ttu-id="7fab5-154">Metoda `SecurityStampValidator.OnValidateIdentity` umožňuje aplikaci ověřit token zabezpečení při přihlášení uživatele, který se používá při změně hesla nebo použití externího přihlášení.</span><span class="sxs-lookup"><span data-stu-id="7fab5-154">The `SecurityStampValidator.OnValidateIdentity` method enables the app to validate the security token when the user logs in, which is used when you change a password or use the external login.</span></span> <span data-ttu-id="7fab5-155">To je nutné k tomu, aby bylo zajištěno, že všechny tokeny (soubory cookie) vygenerované se starým heslem jsou neověřené.</span><span class="sxs-lookup"><span data-stu-id="7fab5-155">This is needed to ensure that any tokens (cookies) generated with the old password are invalidated.</span></span> <span data-ttu-id="7fab5-156">Pokud v ukázkovém projektu změníte heslo uživatele, bude pro uživatele vygenerován nový token, všechny předchozí tokeny jsou neověřeny a pole `SecurityStamp` bude aktualizováno.</span><span class="sxs-lookup"><span data-stu-id="7fab5-156">In the sample project, if you change the users password then a new token is generated for the user, any previous tokens are invalidated and the `SecurityStamp` field is updated.</span></span>

<span data-ttu-id="7fab5-157">Systém identit vám umožní nakonfigurovat aplikaci, takže když se změní profil zabezpečení uživatelů (například když uživatel změní heslo nebo se změní přidružené přihlašovací údaje (například z Facebooku, Google, účet Microsoft atd.), uživatel se odhlásí ze všech. instance prohlížeče.</span><span class="sxs-lookup"><span data-stu-id="7fab5-157">The Identity system allow you to configure your app so when the users security profile changes (for example, when the user changes their password or changes associated login (such as from Facebook, Google, Microsoft account, etc.), the user is logged out of all browser instances.</span></span> <span data-ttu-id="7fab5-158">Následující obrázek ukazuje například [ukázkovou aplikaci jednotného přihlašování](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SingleSignOutSample) , která umožňuje uživateli odhlásit se ze všech instancí prohlížeče (v tomto případě IE, Firefox a Chrome) tím, že vybere jedno tlačítko.</span><span class="sxs-lookup"><span data-stu-id="7fab5-158">For example, the image below shows the [Single signout sample](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SingleSignOutSample) app, which allows the user to sign out of all browser instances (in this case, IE, Firefox and Chrome) by selecting one button.</span></span> <span data-ttu-id="7fab5-159">Alternativně vám ukázka umožňuje odhlásit se z konkrétní instance prohlížeče.</span><span class="sxs-lookup"><span data-stu-id="7fab5-159">Alternatively, the sample allows you to only log out of a specific browser instance.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image11.png)

<span data-ttu-id="7fab5-160">[Ukázková aplikace jednotného přihlašování](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SingleSignOutSample) ukazuje, jak ASP.NET identity umožňuje znovu vygenerovat token zabezpečení.</span><span class="sxs-lookup"><span data-stu-id="7fab5-160">The [Single signout sample](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/SingleSignOutSample) app shows how ASP.NET Identity allows you to regenerate the security token.</span></span> <span data-ttu-id="7fab5-161">To je nutné k tomu, aby bylo zajištěno, že všechny tokeny (soubory cookie) vygenerované se starým heslem jsou neověřené.</span><span class="sxs-lookup"><span data-stu-id="7fab5-161">This is needed to ensure that any tokens (cookies) generated with the old password are invalidated.</span></span> <span data-ttu-id="7fab5-162">Tato funkce poskytuje další vrstvu zabezpečení pro vaši aplikaci. Když změníte heslo, budete odhlášeni, kam jste se přihlásili k této aplikaci.</span><span class="sxs-lookup"><span data-stu-id="7fab5-162">This feature provides an extra layer of security to your application; when you change your password, you will be logged out where you have logged into this application.</span></span>

<span data-ttu-id="7fab5-163">Soubor *App\_Start\IdentityConfig.cs* obsahuje třídy `ApplicationUserManager`, `EmailService` a `SmsService`.</span><span class="sxs-lookup"><span data-stu-id="7fab5-163">The *App\_Start\IdentityConfig.cs* file contains the `ApplicationUserManager`, `EmailService` and `SmsService` classes.</span></span> <span data-ttu-id="7fab5-164">Třídy `EmailService` a `SmsService` implementují rozhraní `IIdentityMessageService`, takže máte v každé třídě k dispozici společné metody konfigurace e-mailu a SMS.</span><span class="sxs-lookup"><span data-stu-id="7fab5-164">The `EmailService` and `SmsService` classes each implement the `IIdentityMessageService` interface, so you have common methods in each class to configure email and SMS.</span></span> <span data-ttu-id="7fab5-165">I když tento kurz ukazuje, jak přidat e-mailové oznámení prostřednictvím [SendGrid](http://sendgrid.com/), můžete posílat e-maily pomocí protokolu SMTP a dalších mechanismů.</span><span class="sxs-lookup"><span data-stu-id="7fab5-165">Although this tutorial only shows how to add email notification through [SendGrid](http://sendgrid.com/), you can send email using SMTP and other mechanisms.</span></span>

<span data-ttu-id="7fab5-166">Třída `Startup` také obsahuje kotlovou desku pro přidání sociálních přihlášení (Facebook, Twitter atd.). Další informace najdete v tématu můj kurz [MVC 5 s aplikací Facebook, Twitter, LinkedIn a Google OAuth2](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) .</span><span class="sxs-lookup"><span data-stu-id="7fab5-166">The `Startup` class also contains boiler plate to add social logins (Facebook, Twitter, etc.), see my tutorial [MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) for more info.</span></span>

<span data-ttu-id="7fab5-167">Projděte si třídu `ApplicationUserManager`, která obsahuje informace o identitě uživatelů, a nakonfiguruje následující funkce:</span><span class="sxs-lookup"><span data-stu-id="7fab5-167">Examine the `ApplicationUserManager` class, which contains the users identity information and configures the following features:</span></span>

- <span data-ttu-id="7fab5-168">Požadavky na sílu hesla.</span><span class="sxs-lookup"><span data-stu-id="7fab5-168">Password strength requirements.</span></span>
- <span data-ttu-id="7fab5-169">Uzamčení uživatele (počet pokusů a čas).</span><span class="sxs-lookup"><span data-stu-id="7fab5-169">User lock out (attempts and time).</span></span>
- <span data-ttu-id="7fab5-170">Dvojúrovňové ověřování (2FA).</span><span class="sxs-lookup"><span data-stu-id="7fab5-170">Two-factor authentication (2FA).</span></span> <span data-ttu-id="7fab5-171">Projdeme 2FA a SMS v jiném kurzu.</span><span class="sxs-lookup"><span data-stu-id="7fab5-171">I'll cover 2FA and SMS in another tutorial.</span></span>
- <span data-ttu-id="7fab5-172">Zapojení e-mailu a služeb SMS.</span><span class="sxs-lookup"><span data-stu-id="7fab5-172">Hooking up the email and SMS services.</span></span> <span data-ttu-id="7fab5-173">(SMS se zobrazí v jiném kurzu).</span><span class="sxs-lookup"><span data-stu-id="7fab5-173">(I'll cover SMS in another tutorial).</span></span>

<span data-ttu-id="7fab5-174">Třída `ApplicationUserManager` je odvozena z obecné `UserManager<ApplicationUser>` třídy.</span><span class="sxs-lookup"><span data-stu-id="7fab5-174">The `ApplicationUserManager` class derives from the generic `UserManager<ApplicationUser>` class.</span></span> <span data-ttu-id="7fab5-175">`ApplicationUser` jsou odvozeny z [IdentityUser](https://msdn.microsoft.com/library/microsoft.aspnet.identity.entityframework.identityuser.aspx).</span><span class="sxs-lookup"><span data-stu-id="7fab5-175">`ApplicationUser` derives from [IdentityUser](https://msdn.microsoft.com/library/microsoft.aspnet.identity.entityframework.identityuser.aspx).</span></span> <span data-ttu-id="7fab5-176">`IdentityUser` je odvozen z obecné `IdentityUser` třídy:</span><span class="sxs-lookup"><span data-stu-id="7fab5-176">`IdentityUser` derives from the generic `IdentityUser` class:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample1.cs)]

<span data-ttu-id="7fab5-177">Výše uvedené vlastnosti se shodují s vlastnostmi v tabulce `AspNetUsers`, která je uvedená výše.</span><span class="sxs-lookup"><span data-stu-id="7fab5-177">The properties above coincide with the properties in the `AspNetUsers` table, shown above.</span></span>

<span data-ttu-id="7fab5-178">Obecné argumenty na `IUser` umožňují odvození třídy pomocí různých typů pro primární klíč.</span><span class="sxs-lookup"><span data-stu-id="7fab5-178">Generic arguments on `IUser` enable you to derive a class using different types for the primary key.</span></span> <span data-ttu-id="7fab5-179">Podívejte se na ukázku [ChangePK](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/ChangePK) , která ukazuje, jak změnit primární klíč z řetězce na int nebo GUID.</span><span class="sxs-lookup"><span data-stu-id="7fab5-179">See the [ChangePK](https://github.com/aspnet/samples/tree/master/samples/aspnet/Identity/ChangePK) sample which shows how to change the primary key from string to int or GUID.</span></span>

### <a name="applicationuser"></a><span data-ttu-id="7fab5-180">ApplicationUser</span><span class="sxs-lookup"><span data-stu-id="7fab5-180">ApplicationUser</span></span>

<span data-ttu-id="7fab5-181">`ApplicationUser` (`public class ApplicationUserManager : UserManager<ApplicationUser>`) je definována v *Models\IdentityModels.cs* jako:</span><span class="sxs-lookup"><span data-stu-id="7fab5-181">`ApplicationUser` (`public class ApplicationUserManager : UserManager<ApplicationUser>`) is defined in *Models\IdentityModels.cs* as:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample2.cs?highlight=8-9)]

<span data-ttu-id="7fab5-182">Zvýrazněný kód výše generuje [hodnota ClaimsIdentity](https://msdn.microsoft.com/library/system.security.claims.claimsidentity.aspx).</span><span class="sxs-lookup"><span data-stu-id="7fab5-182">The highlighted code above generates a [ClaimsIdentity](https://msdn.microsoft.com/library/system.security.claims.claimsidentity.aspx).</span></span> <span data-ttu-id="7fab5-183">Ověřování souborů cookie ASP.NET Identity a OWIN jsou založené na deklaracích, proto rozhraní vyžaduje, aby aplikace vygenerovala `ClaimsIdentity` pro uživatele.</span><span class="sxs-lookup"><span data-stu-id="7fab5-183">ASP.NET Identity and OWIN Cookie Authentication are claims-based, therefore the framework requires the app to generate a `ClaimsIdentity` for the user.</span></span> <span data-ttu-id="7fab5-184">`ClaimsIdentity` obsahuje informace o všech deklaracích uživatele, jako je jméno uživatele, věk a jaké role uživatel patří.</span><span class="sxs-lookup"><span data-stu-id="7fab5-184">`ClaimsIdentity` has information about all the claims for the user, such as the user's name, age and what roles the user belongs to.</span></span> <span data-ttu-id="7fab5-185">V této fázi můžete také přidat další deklarace identity pro uživatele.</span><span class="sxs-lookup"><span data-stu-id="7fab5-185">You can also add more claims for the user at this stage.</span></span>

<span data-ttu-id="7fab5-186">Metoda OWIN `AuthenticationManager.SignIn` projde do `ClaimsIdentity` a přihlásí uživatele:</span><span class="sxs-lookup"><span data-stu-id="7fab5-186">The OWIN `AuthenticationManager.SignIn` method passes in the `ClaimsIdentity` and signs in the user:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample3.cs?highlight=4-6)]

<span data-ttu-id="7fab5-187">[Aplikace MVC 5 s přihlašováním na Facebooku, Twitter, LinkedIn a Google OAuth2](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) ukazuje, jak můžete přidat další vlastnosti do třídy `ApplicationUser`.</span><span class="sxs-lookup"><span data-stu-id="7fab5-187">[MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) shows how you can add additional properties to the `ApplicationUser` class.</span></span>

## <a name="email-confirmation"></a><span data-ttu-id="7fab5-188">Potvrzení e-mailu</span><span class="sxs-lookup"><span data-stu-id="7fab5-188">Email confirmation</span></span>

<span data-ttu-id="7fab5-189">Je vhodné potvrdit e-mailem novou registraci uživatele s cílem ověřit, že nezosobňuje někoho jiného (tj. není zaregistrován v e-mailu někoho jiného).</span><span class="sxs-lookup"><span data-stu-id="7fab5-189">It's a good idea to confirm the email a new user register with to verify they are not impersonating someone else (that is, they haven't registered with someone else's email).</span></span> <span data-ttu-id="7fab5-190">Předpokládejme, že máte diskuzní fórum, chcete zabránit `"bob@example.com"` registraci jako `"joe@contoso.com"`.</span><span class="sxs-lookup"><span data-stu-id="7fab5-190">Suppose you had a discussion forum, you would want to prevent `"bob@example.com"` from registering as `"joe@contoso.com"`.</span></span> <span data-ttu-id="7fab5-191">Bez potvrzení e-mailu `"joe@contoso.com"` možné z vaší aplikace získat nechtěný e-mail.</span><span class="sxs-lookup"><span data-stu-id="7fab5-191">Without email confirmation, `"joe@contoso.com"` could get unwanted email from your app.</span></span> <span data-ttu-id="7fab5-192">Předpokládejme, že se Bob omylem zaregistrovali jako `"bib@example.com"` a jste si ho všimli, takže by nebylo možné použít obnovení hesla, protože aplikace nemá správný e-mail.</span><span class="sxs-lookup"><span data-stu-id="7fab5-192">Suppose Bob accidentally registered as `"bib@example.com"` and hadn't noticed it, he wouldn't be able to use password recover because the app doesn't have his correct email.</span></span> <span data-ttu-id="7fab5-193">Potvrzení e-mailu poskytuje jenom omezené zabezpečení z roboty a neposkytuje ochranu proti stanoveným odesilatelům nevyžádané pošty. má spoustu pracovních e-mailových aliasů, které můžou použít k registraci. V níže uvedené ukázce nebude uživatel moci změnit heslo, dokud nebude potvrzen jejich účet (při výběru potvrzovacího odkazu přijatého na e-mailovém účtu, ve kterém se zaregistrovali). Tento pracovní postup můžete použít i na jiné scénáře, například odeslat odkaz pro potvrzení a resetování hesla u nových účtů vytvořených správcem a odeslání uživatele e-mailem, když změnil svůj profil a tak dále.</span><span class="sxs-lookup"><span data-stu-id="7fab5-193">Email confirmation provides only limited protection from bots and doesn't provide protection from determined spammers, they have many working email aliases they can use to register.In the sample below, the user won't be able to change their password until their account has been confirmed (by them selecting a confirmation link received on the email account they registered with.) You can apply this work flow to other scenarios, for example sending a link to confirm and reset the password on new accounts created by the administrator, sending the user an email when they have changed their profile and so on.</span></span> <span data-ttu-id="7fab5-194">Obecně je vhodné zabránit novým uživatelům v posílání dat na web před potvrzením e-mailu, textové zprávy SMS nebo jiného mechanismu.</span><span class="sxs-lookup"><span data-stu-id="7fab5-194">You generally want to prevent new users from posting any data to your web site before they have been confirmed by email, a SMS text message or another mechanism.</span></span> <a id="build"></a>

## <a name="build-a-more-complete-sample"></a><span data-ttu-id="7fab5-195">Sestavení ucelenější ukázky</span><span class="sxs-lookup"><span data-stu-id="7fab5-195">Build a more complete sample</span></span>

<span data-ttu-id="7fab5-196">V této části použijete NuGet ke stažení ucelené ukázky, se kterou budeme pracovat.</span><span class="sxs-lookup"><span data-stu-id="7fab5-196">In this section, you'll use NuGet to download a more complete sample we will work with.</span></span>

1. <span data-ttu-id="7fab5-197">Vytvořte nový ***prázdný*** webový projekt v ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="7fab5-197">Create a new ***empty*** ASP.NET Web project.</span></span>
2. <span data-ttu-id="7fab5-198">V konzole správce balíčků zadejte následující příkazy:</span><span class="sxs-lookup"><span data-stu-id="7fab5-198">In the Package Manager Console, enter the following commands:</span></span> 

    [!code-console[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample4.cmd)]

   <span data-ttu-id="7fab5-199">V tomto kurzu použijeme [SendGrid](http://sendgrid.com/) k odeslání e-mailu.</span><span class="sxs-lookup"><span data-stu-id="7fab5-199">In this tutorial, we'll use [SendGrid](http://sendgrid.com/) to send email.</span></span> <span data-ttu-id="7fab5-200">Balíček `Identity.Samples` nainstaluje kód, se kterým budeme pracovat.</span><span class="sxs-lookup"><span data-stu-id="7fab5-200">The `Identity.Samples` package installs the code we will be working with.</span></span>
3. <span data-ttu-id="7fab5-201">Nastavte [projekt na použití SSL](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md).</span><span class="sxs-lookup"><span data-stu-id="7fab5-201">Set the [project to use SSL](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md).</span></span>
4. <span data-ttu-id="7fab5-202">Otestujte vytváření místních účtů spuštěním aplikace, výběrem odkazu **registrace** a odesláním registračního formuláře.</span><span class="sxs-lookup"><span data-stu-id="7fab5-202">Test local account creation by running the app, selecting the **Register** link, and posting the registration form.</span></span>
5. <span data-ttu-id="7fab5-203">Vyberte ukázkový emailový odkaz, který simuluje e-mailové potvrzení.</span><span class="sxs-lookup"><span data-stu-id="7fab5-203">Select the demo email link, which simulates email confirmation.</span></span>
6. <span data-ttu-id="7fab5-204">Z ukázky odeberte potvrzovací kód e-mailového odkazu (kód `ViewBag.Link` v řadiči účtů.</span><span class="sxs-lookup"><span data-stu-id="7fab5-204">Remove the demo email link confirmation code from the sample (The `ViewBag.Link` code in the account controller.</span></span> <span data-ttu-id="7fab5-205">Podívejte se na metody akcí `DisplayEmail` a `ForgotPasswordConfirmation` a zobrazení Razor).</span><span class="sxs-lookup"><span data-stu-id="7fab5-205">See the `DisplayEmail` and `ForgotPasswordConfirmation` action methods and razor views ).</span></span>

> [!WARNING]
> <span data-ttu-id="7fab5-206">Pokud změníte kterékoli nastavení zabezpečení v této ukázce, budou se v aplikacích výroby muset projít auditem zabezpečení, který explicitně volá provedené změny.</span><span class="sxs-lookup"><span data-stu-id="7fab5-206">If you change any of the security settings in this sample, productions apps will need to undergo a security audit that explicitly calls the changes made.</span></span>

## <a name="examine-the-code-in-app_startidentityconfigcs"></a><span data-ttu-id="7fab5-207">Projděte si kód v App\_Start\IdentityConfig.cs</span><span class="sxs-lookup"><span data-stu-id="7fab5-207">Examine the code in App\_Start\IdentityConfig.cs</span></span>

<span data-ttu-id="7fab5-208">Ukázka ukazuje, jak vytvořit účet a přidat ho do role *správce* .</span><span class="sxs-lookup"><span data-stu-id="7fab5-208">The sample shows how to create an account and add it to the *Admin* role.</span></span> <span data-ttu-id="7fab5-209">E-mail v ukázce byste měli nahradit e-mailem, který budete používat pro účet správce.</span><span class="sxs-lookup"><span data-stu-id="7fab5-209">You should replace the email in the sample with the email you will be using for the admin account.</span></span> <span data-ttu-id="7fab5-210">Nejjednodušší způsob, jak teď vytvořit účet správce, je programově v metodě `Seed`.</span><span class="sxs-lookup"><span data-stu-id="7fab5-210">The easiest way right now to create an administrator account is programmatically in the `Seed` method.</span></span> <span data-ttu-id="7fab5-211">Doufáme, že budete mít nástroj v budoucnu, který vám umožní vytvářet a spravovat uživatele a role.</span><span class="sxs-lookup"><span data-stu-id="7fab5-211">We hope to have a tool in the future that will allow you to create and administer users and roles.</span></span> <span data-ttu-id="7fab5-212">Vzorový kód vám umožní vytvářet a spravovat uživatele a role, ale musíte nejdřív mít účet správce, aby bylo možné spouštět role a stránky pro správu uživatelů.</span><span class="sxs-lookup"><span data-stu-id="7fab5-212">The sample code does let you create and manage users and roles, but you must first have an administrators account to run the roles and user admin pages.</span></span> <span data-ttu-id="7fab5-213">V této ukázce se při osazení databáze vytvoří účet správce.</span><span class="sxs-lookup"><span data-stu-id="7fab5-213">In this sample, the admin account is created when the DB is seeded.</span></span>

<span data-ttu-id="7fab5-214">Změňte heslo a změňte název na účet, na který můžete dostávat e-mailová oznámení.</span><span class="sxs-lookup"><span data-stu-id="7fab5-214">Change the password and change the name to an account where you can receive email notifications.</span></span>

> [!WARNING]
> <span data-ttu-id="7fab5-215">Zabezpečení – nikdy neukládejte citlivá data ve zdrojovém kódu.</span><span class="sxs-lookup"><span data-stu-id="7fab5-215">Security - Never store sensitive data in your source code.</span></span>

<span data-ttu-id="7fab5-216">Jak bylo zmíněno dříve, `app.CreatePerOwinContext` volání ve spouštěcí třídě přidává zpětná volání do metody `Create` třídy App DB Content, User Manager a správce rolí.</span><span class="sxs-lookup"><span data-stu-id="7fab5-216">As mentioned previously, the `app.CreatePerOwinContext` call in the startup class adds callbacks to the `Create` method of the app DB content, user manager and role manger classes.</span></span> <span data-ttu-id="7fab5-217">Kanál OWIN volá metodu `Create` na těchto třídách pro každý požadavek a ukládá kontext pro každou třídu.</span><span class="sxs-lookup"><span data-stu-id="7fab5-217">The OWIN pipeline calls the `Create` method on these classes for each request and stores the context for each class.</span></span> <span data-ttu-id="7fab5-218">Řadič účtu zpřístupňuje Správce uživatelů z kontextu HTTP (který obsahuje kontext OWIN):</span><span class="sxs-lookup"><span data-stu-id="7fab5-218">The account controller exposes the user manager from the HTTP context (which contains the OWIN context):</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample5.cs)]

<span data-ttu-id="7fab5-219">Když uživatel zaregistruje místní účet, zavolá se `HTTP Post Register` metoda:</span><span class="sxs-lookup"><span data-stu-id="7fab5-219">When a user registers a local account, the `HTTP Post Register` method is called:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample6.cs)]

<span data-ttu-id="7fab5-220">Výše uvedený kód používá modelová data k vytvoření nového uživatelského účtu pomocí zadaného e-mailu a hesla.</span><span class="sxs-lookup"><span data-stu-id="7fab5-220">The code above uses the model data to create a new user account using the email and password entered.</span></span> <span data-ttu-id="7fab5-221">Pokud je e-mailový alias v úložišti dat, vytvoření účtu se nezdařilo a formulář se zobrazí znovu.</span><span class="sxs-lookup"><span data-stu-id="7fab5-221">If the email alias is in the data store, account creation fails and the form is displayed again.</span></span> <span data-ttu-id="7fab5-222">Metoda `GenerateEmailConfirmationTokenAsync` vytvoří zabezpečený potvrzovací token a uloží ho do úložiště dat ASP.NET Identity.</span><span class="sxs-lookup"><span data-stu-id="7fab5-222">The `GenerateEmailConfirmationTokenAsync` method creates a secure confirmation token and stores it in the ASP.NET Identity data store.</span></span> <span data-ttu-id="7fab5-223">Metoda [URL. Action](https://msdn.microsoft.com/library/dd505232(v=vs.118).aspx) vytvoří odkaz obsahující `UserId` a potvrzovací token.</span><span class="sxs-lookup"><span data-stu-id="7fab5-223">The [Url.Action](https://msdn.microsoft.com/library/dd505232(v=vs.118).aspx) method creates a link containing the `UserId` and confirmation token.</span></span> <span data-ttu-id="7fab5-224">Tento odkaz se pak odešle e-mailem uživateli, uživatel může vybrat odkaz v e-mailové aplikaci a potvrdit jeho účet.</span><span class="sxs-lookup"><span data-stu-id="7fab5-224">This link is then emailed to the user, the user can select on the link in their email app to confirm their account.</span></span>

<a id="email"></a>

## <a name="set-up-email-confirmation"></a><span data-ttu-id="7fab5-225">Nastavení potvrzení e-mailu</span><span class="sxs-lookup"><span data-stu-id="7fab5-225">Set up email confirmation</span></span>

<span data-ttu-id="7fab5-226">Přejdete na [stránku registrace Azure SendGrid](https://azure.microsoft.com/gallery/store/sendgrid/sendgrid-azure/) a zaregistrujete si bezplatný účet.</span><span class="sxs-lookup"><span data-stu-id="7fab5-226">Go to the [Azure SendGrid sign up page](https://azure.microsoft.com/gallery/store/sendgrid/sendgrid-azure/) and register for free account.</span></span> <span data-ttu-id="7fab5-227">Pro konfiguraci SendGrid přidejte kód podobný následujícímu:</span><span class="sxs-lookup"><span data-stu-id="7fab5-227">Add code similar to the following to configure SendGrid:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample7.cs?highlight=5)]

> [!NOTE]
> <span data-ttu-id="7fab5-228">E-mailové klienty často akceptují jenom textové zprávy (žádný HTML).</span><span class="sxs-lookup"><span data-stu-id="7fab5-228">Email clients frequently accept only text messages (no HTML).</span></span> <span data-ttu-id="7fab5-229">Tuto zprávu byste měli zadat v textu a ve formátu HTML.</span><span class="sxs-lookup"><span data-stu-id="7fab5-229">You should provide the message in text and HTML.</span></span> <span data-ttu-id="7fab5-230">V ukázce SendGrid se to provádí pomocí `myMessage.Text` a `myMessage.Html`ho kódu uvedeného výše.</span><span class="sxs-lookup"><span data-stu-id="7fab5-230">In the SendGrid sample above, this is done with the `myMessage.Text` and `myMessage.Html` code shown above.</span></span>

<span data-ttu-id="7fab5-231">Následující kód ukazuje, jak odeslat e-mail pomocí třídy [MailMessage](https://msdn.microsoft.com/library/system.net.mail.mailmessage.aspx) , kde `message.Body` vrátí pouze odkaz.</span><span class="sxs-lookup"><span data-stu-id="7fab5-231">The following code shows how to send email using the [MailMessage](https://msdn.microsoft.com/library/system.net.mail.mailmessage.aspx) class where `message.Body` returns only the link.</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample8.cs)]

> [!WARNING]
> <span data-ttu-id="7fab5-232">Zabezpečení – nikdy neukládejte citlivá data ve zdrojovém kódu.</span><span class="sxs-lookup"><span data-stu-id="7fab5-232">Security - Never store sensitive data in your source code.</span></span> <span data-ttu-id="7fab5-233">Účet a přihlašovací údaje jsou uložené v appSetting.</span><span class="sxs-lookup"><span data-stu-id="7fab5-233">The account and credentials are stored in the appSetting.</span></span> <span data-ttu-id="7fab5-234">V Azure můžete tyto hodnoty bezpečně uložit na kartě **[Konfigurace](https://blogs.msdn.com/b/webdev/archive/2014/06/04/queuebackgroundworkitem-to-reliably-schedule-and-run-long-background-process-in-asp-net.aspx)** v Azure Portal.</span><span class="sxs-lookup"><span data-stu-id="7fab5-234">On Azure, you can securely store these values on the **[Configure](https://blogs.msdn.com/b/webdev/archive/2014/06/04/queuebackgroundworkitem-to-reliably-schedule-and-run-long-background-process-in-asp-net.aspx)** tab in the Azure portal.</span></span> <span data-ttu-id="7fab5-235">Podívejte [se na osvědčené postupy pro nasazení hesel a dalších citlivých dat do ASP.NET a Azure](best-practices-for-deploying-passwords-and-other-sensitive-data-to-aspnet-and-azure.md).</span><span class="sxs-lookup"><span data-stu-id="7fab5-235">See [Best practices for deploying passwords and other sensitive data to ASP.NET and Azure](best-practices-for-deploying-passwords-and-other-sensitive-data-to-aspnet-and-azure.md).</span></span>

<span data-ttu-id="7fab5-236">Zadejte svoje přihlašovací údaje pro SendGrid, spusťte aplikaci, zaregistrujte si e-mailový alias. můžete vybrat odkaz potvrdit v e-mailu.</span><span class="sxs-lookup"><span data-stu-id="7fab5-236">Enter your SendGrid credentials, run the app, register with an email alias can select the confirm link in your email.</span></span> <span data-ttu-id="7fab5-237">Pokud se chcete podívat, jak to provést pomocí e-mailového účtu [Outlook.com](http://outlook.com) , přečtěte si téma [ C# konfigurace protokolu SMTP pro Outlook.com hostitele SMTP](http://typecastexception.com/post/2013/12/20/C-SMTP-Configuration-for-OutlookCom-SMTP-Host.aspx) a jeho[ASP.NET identity 2,0: nastavení ověření účtu a příspěvků se dvěma faktory autorizace](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) .</span><span class="sxs-lookup"><span data-stu-id="7fab5-237">To see how to do this with your [Outlook.com](http://outlook.com) email account, see John Atten's [C# SMTP Configuration for Outlook.Com SMTP Host](http://typecastexception.com/post/2013/12/20/C-SMTP-Configuration-for-OutlookCom-SMTP-Host.aspx) and his[ASP.NET Identity 2.0: Setting Up Account Validation and Two-Factor Authorization](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) posts.</span></span>

<span data-ttu-id="7fab5-238">Jakmile uživatel vybere tlačítko **zaregistrovat** , pošle se na svou e-mailovou adresu potvrzovací e-mail obsahující ověřovací token.</span><span class="sxs-lookup"><span data-stu-id="7fab5-238">Once a user selects the **Register** button a confirmation email containing a validation token is sent to their email address.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image12.png)

<span data-ttu-id="7fab5-239">Uživateli se pošle e-mail s potvrzovacím tokenem pro svůj účet.</span><span class="sxs-lookup"><span data-stu-id="7fab5-239">The user is sent an email with a confirmation token for their account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image13.png)

## <a name="examine-the-code"></a><span data-ttu-id="7fab5-240">Kontrola kódu</span><span class="sxs-lookup"><span data-stu-id="7fab5-240">Examine the code</span></span>

<span data-ttu-id="7fab5-241">Následující kód ukazuje metodu `POST ForgotPassword`.</span><span class="sxs-lookup"><span data-stu-id="7fab5-241">The following code shows the `POST ForgotPassword` method.</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample9.cs)]

<span data-ttu-id="7fab5-242">Metoda se nezdařila v tichém režimu, pokud nebyl potvrzen e-mail uživatele.</span><span class="sxs-lookup"><span data-stu-id="7fab5-242">The method fails silently if the user email has not been confirmed.</span></span> <span data-ttu-id="7fab5-243">Pokud byla chyba publikována pro neplatnou e-mailovou adresu, mohou uživatelé se zlými úmysly pomocí těchto informací najít platné ID uživatele (e-mailové aliasy),</span><span class="sxs-lookup"><span data-stu-id="7fab5-243">If an error was posted for an invalid email address, malicious users could use that information to find valid userId (email aliases) to attack.</span></span>

<span data-ttu-id="7fab5-244">Následující kód ukazuje metodu `ConfirmEmail` v řadiči účtu, který se volá, když uživatel vybere odkaz na potvrzení v e-mailu, který jim byl odeslán:</span><span class="sxs-lookup"><span data-stu-id="7fab5-244">The following code shows the `ConfirmEmail` method in the account controller that is called when the user selects the confirmation link in the email sent to them:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample10.cs)]

<span data-ttu-id="7fab5-245">Po použití zapomenutého tokenu hesla se zruší jeho platnost.</span><span class="sxs-lookup"><span data-stu-id="7fab5-245">Once a forgotten password token has been used, it's invalidated.</span></span> <span data-ttu-id="7fab5-246">Následující změna kódu v metodě `Create` (v souboru *App\_Start\IdentityConfig.cs* ) nastaví vypršení platnosti tokenů za 3 hodiny.</span><span class="sxs-lookup"><span data-stu-id="7fab5-246">The following code change in the `Create` method (in the *App\_Start\IdentityConfig.cs* file) sets the tokens to expire in 3 hours.</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample11.cs?highlight=6-8)]

<span data-ttu-id="7fab5-247">S výše uvedeným kódem vyprší platnost zapomenutého hesla a potvrzovacích tokenů pro e-mail za 3 hodiny.</span><span class="sxs-lookup"><span data-stu-id="7fab5-247">With the code above, the forgotten password and the email confirmation tokens will expire in 3 hours.</span></span> <span data-ttu-id="7fab5-248">Výchozí `TokenLifespan` je jeden den.</span><span class="sxs-lookup"><span data-stu-id="7fab5-248">The default `TokenLifespan` is one day.</span></span>

<span data-ttu-id="7fab5-249">Následující kód ukazuje metodu potvrzení e-mailu:</span><span class="sxs-lookup"><span data-stu-id="7fab5-249">The following code shows the email confirmation method:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample12.cs)]

 <span data-ttu-id="7fab5-250">Aby byla aplikace bezpečnější, ASP.NET Identity podporuje dvojúrovňové ověřování (2FA).</span><span class="sxs-lookup"><span data-stu-id="7fab5-250">To make your app more secure, ASP.NET Identity supports Two-Factor authentication (2FA).</span></span> <span data-ttu-id="7fab5-251">Viz [ASP.NET Identity 2,0: nastavení ověřování účtu a dvojúrovňové autorizace](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) pomocí Jan atten.</span><span class="sxs-lookup"><span data-stu-id="7fab5-251">See [ASP.NET Identity 2.0: Setting Up Account Validation and Two-Factor Authorization](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) by John Atten.</span></span> <span data-ttu-id="7fab5-252">I když můžete nastavit uzamčení účtu při neúspěchu při pokusu o přihlášení k přihlašovacím údajům, bude se vaše přihlášení nahlížet na uzamčení [systému DOS](http://en.wikipedia.org/wiki/Denial-of-service_attack) .</span><span class="sxs-lookup"><span data-stu-id="7fab5-252">Although you can set account lockout on login password attempt failures, that approach makes your login susceptible to [DOS](http://en.wikipedia.org/wiki/Denial-of-service_attack) lockouts.</span></span> <span data-ttu-id="7fab5-253">Uzamčení účtu doporučujeme používat jenom s 2FA.</span><span class="sxs-lookup"><span data-stu-id="7fab5-253">We recommend you use account lockout only with 2FA.</span></span>  
<a id="addRes"></a>

## <a name="additional-resources"></a><span data-ttu-id="7fab5-254">Další materiály a zdroje informací</span><span class="sxs-lookup"><span data-stu-id="7fab5-254">Additional resources</span></span>

- [<span data-ttu-id="7fab5-255">Přehled poskytovatelů vlastního úložiště pro ASP.NET Identity</span><span class="sxs-lookup"><span data-stu-id="7fab5-255">Overview of Custom Storage Providers for ASP.NET Identity</span></span>](../extensibility/overview-of-custom-storage-providers-for-aspnet-identity.md)
- <span data-ttu-id="7fab5-256">[Aplikace MVC 5 s přihlašováním na Facebooku, Twitter, LinkedIn a Google OAuth2](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) také ukazuje, jak přidat informace o profilu do tabulky uživatelů.</span><span class="sxs-lookup"><span data-stu-id="7fab5-256">[MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) also shows how to add profile information to the users table.</span></span>
- <span data-ttu-id="7fab5-257">[ASP.NET MVC a identita 2,0: Seznámení se základy](http://typecastexception.com/post/2014/04/20/ASPNET-MVC-and-Identity-20-Understanding-the-Basics.aspx) pomocí Jan atten.</span><span class="sxs-lookup"><span data-stu-id="7fab5-257">[ASP.NET MVC and Identity 2.0: Understanding the Basics](http://typecastexception.com/post/2014/04/20/ASPNET-MVC-and-Identity-20-Understanding-the-Basics.aspx) by John Atten.</span></span>
- [<span data-ttu-id="7fab5-258">Úvod do ASP.NET Identity</span><span class="sxs-lookup"><span data-stu-id="7fab5-258">Introduction to ASP.NET Identity</span></span>](../getting-started/introduction-to-aspnet-identity.md)
- <span data-ttu-id="7fab5-259">[Oznamujeme RTM ASP.NET identity 2.0.0](https://blogs.msdn.com/b/webdev/archive/2014/03/20/test-announcing-rtm-of-asp-net-identity-2-0-0.aspx) podle Pranav Rastogi předvádí.</span><span class="sxs-lookup"><span data-stu-id="7fab5-259">[Announcing RTM of ASP.NET Identity 2.0.0](https://blogs.msdn.com/b/webdev/archive/2014/03/20/test-announcing-rtm-of-asp-net-identity-2-0-0.aspx) by Pranav Rastogi.</span></span>
