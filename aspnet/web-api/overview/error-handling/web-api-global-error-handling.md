---
uid: web-api/overview/error-handling/web-api-global-error-handling
title: Globální zpracování chyb v ASP.NET webového rozhraní API 2 – ASP.NET 4. x
author: davidmatson
description: Přehled globálních zpracování chyb v ASP.NET Web API 2 pro ASP.NET 4. x.
ms.author: riande
ms.date: 02/03/2014
ms.custom: seoapril2019
ms.assetid: bffd7863-f63b-4b23-a13c-372b5492e9fb
msc.legacyurl: /web-api/overview/error-handling/web-api-global-error-handling
msc.type: authoredcontent
ms.openlocfilehash: 94f2d6d31d0b37f9bb0077e6258c70a2dfb1918d
ms.sourcegitcommit: e7e91932a6e91a63e2e46417626f39d6b244a3ab
ms.translationtype: MT
ms.contentlocale: cs-CZ
ms.lasthandoff: 03/06/2020
ms.locfileid: "78557279"
---
# <a name="global-error-handling-in-aspnet-web-api-2"></a><span data-ttu-id="8e1ff-103">Globální zpracování chyb v ASP.NET webového rozhraní API 2</span><span class="sxs-lookup"><span data-stu-id="8e1ff-103">Global Error Handling in ASP.NET Web API 2</span></span>

<span data-ttu-id="8e1ff-104">autorem [David Matson](https://github.com/davidmatson), [Rick Anderson](https://twitter.com/RickAndMSFT)</span><span class="sxs-lookup"><span data-stu-id="8e1ff-104">by [David Matson](https://github.com/davidmatson), [Rick Anderson](https://twitter.com/RickAndMSFT)</span></span>

<span data-ttu-id="8e1ff-105">V tomto tématu najdete přehled globálních zpracování chyb v ASP.NET Web API 2 pro ASP.NET 4. x.</span><span class="sxs-lookup"><span data-stu-id="8e1ff-105">This topic provides an overview of global error handling in ASP.NET Web API 2 for ASP.NET 4.x.</span></span> <span data-ttu-id="8e1ff-106">Dnes ve webovém rozhraní API neexistuje jednoduchý způsob, jak protokolovat nebo nakládat chyby globálně.</span><span class="sxs-lookup"><span data-stu-id="8e1ff-106">Today there's no easy way in Web API to log or handle errors globally.</span></span> <span data-ttu-id="8e1ff-107">Některé neošetřené výjimky lze zpracovat prostřednictvím [filtrů výjimek](exception-handling.md), ale existuje několik případů, kdy filtry výjimek nemůžou zpracovat.</span><span class="sxs-lookup"><span data-stu-id="8e1ff-107">Some unhandled exceptions can be processed via [exception filters](exception-handling.md), but there are a number of cases that exception filters can't handle.</span></span> <span data-ttu-id="8e1ff-108">Příklad:</span><span class="sxs-lookup"><span data-stu-id="8e1ff-108">For example:</span></span>

1. <span data-ttu-id="8e1ff-109">Výjimky vyvolané z konstruktorů kontroleru.</span><span class="sxs-lookup"><span data-stu-id="8e1ff-109">Exceptions thrown from controller constructors.</span></span>
2. <span data-ttu-id="8e1ff-110">Výjimky vyvolané z obslužných rutin zpráv</span><span class="sxs-lookup"><span data-stu-id="8e1ff-110">Exceptions thrown from message handlers.</span></span>
3. <span data-ttu-id="8e1ff-111">Během směrování byly vyvolány výjimky.</span><span class="sxs-lookup"><span data-stu-id="8e1ff-111">Exceptions thrown during routing.</span></span>
4. <span data-ttu-id="8e1ff-112">Výjimky vyvolané při serializaci obsahu odpovědi</span><span class="sxs-lookup"><span data-stu-id="8e1ff-112">Exceptions thrown during response content serialization .</span></span>

<span data-ttu-id="8e1ff-113">Chceme poskytnout jednoduchý a konzistentní způsob, jak protokolovat a zpracovávat (kde je to možné) tyto výjimky.</span><span class="sxs-lookup"><span data-stu-id="8e1ff-113">We want to provide a simple, consistent way to log and handle (where possible) these exceptions.</span></span> 

<span data-ttu-id="8e1ff-114">Existují dva hlavní případy pro zpracování výjimek, případ, kdy je možné odeslat chybovou odpověď, a případ, kdy můžeme udělat výjimku, se zaznamená výjimka.</span><span class="sxs-lookup"><span data-stu-id="8e1ff-114">There are two major cases for handling exceptions, the case where we are able to send an error response and the case where all we can do is log the exception.</span></span> <span data-ttu-id="8e1ff-115">Příkladem pro druhý případ je výjimka, která je vyvolána ve středu obsahu odpovědi streamování; v takovém případě je příliš pozdě poslat novou zprávu s odpovědí, protože stavový kód, hlavičky a částečný obsah už jsou v rámci sítě, takže jsme připojení jednoduše přerušili.</span><span class="sxs-lookup"><span data-stu-id="8e1ff-115">An example for the latter case is when an exception is thrown in the middle of streaming response content; in that case it is too late to send a new response message since the status code, headers, and partial content have already gone across the wire, so we simply abort the connection.</span></span> <span data-ttu-id="8e1ff-116">I když výjimku nejde zpracovat, aby vytvořila novou zprávu odpovědi, pořád podporuje protokolování výjimky.</span><span class="sxs-lookup"><span data-stu-id="8e1ff-116">Even though the exception can't be handled to produce a new response message, we still support logging the exception.</span></span> <span data-ttu-id="8e1ff-117">V případech, kdy můžeme zjistit chybu, můžeme vrátit příslušnou chybovou odpověď, jak je znázorněno v následujícím příkladu:</span><span class="sxs-lookup"><span data-stu-id="8e1ff-117">In cases where we can detect an error, we can return an appropriate error response as shown in the following:</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample1.cs?highlight=6)]

### <a name="existing-options"></a><span data-ttu-id="8e1ff-118">Existující možnosti</span><span class="sxs-lookup"><span data-stu-id="8e1ff-118">Existing Options</span></span>

<span data-ttu-id="8e1ff-119">Kromě [filtrů výjimek](exception-handling.md)se teď dají [obslužné rutiny zpráv](../advanced/http-message-handlers.md) používat dnes ke sledování všech odpovědí na úrovni 500, ale na těchto odpovědích jsou obtížné, protože nemají kontext o původní chybě.</span><span class="sxs-lookup"><span data-stu-id="8e1ff-119">In addition to [exception filters](exception-handling.md), [message handlers](../advanced/http-message-handlers.md) can be used today to observe all 500-level responses, but acting on those responses is difficult, as they lack context about the original error.</span></span> <span data-ttu-id="8e1ff-120">Obslužné rutiny zpráv mají také některá z stejných omezení jako filtry výjimek týkajících se případů, které mohou zpracovat. Webové rozhraní API sice má infrastrukturu trasování, která zachycuje chybové stavy. Tato trasovací infrastruktura je určená pro účely diagnostiky a není navržená ani vhodná pro provoz v produkčních prostředích.</span><span class="sxs-lookup"><span data-stu-id="8e1ff-120">Message handlers also have some of the same limitations as exception filters regarding the cases they can handle.While Web API does have tracing infrastructure that captures error conditions the tracing infrastructure is for diagnostics purposes and is not designed or suited for running in production environments.</span></span> <span data-ttu-id="8e1ff-121">Globální zpracování výjimek a protokolování by mělo být služby, které mohou běžet během výroby a musí být zapojeny do stávajících řešení monitorování (například [knihovny elmah](https://code.google.com/p/elmah/) ).</span><span class="sxs-lookup"><span data-stu-id="8e1ff-121">Global exception handling and logging should be services that can run during production and be plugged into existing monitoring solutions (for example, [ELMAH](https://code.google.com/p/elmah/) ).</span></span>

### <a name="solution-overview"></a><span data-ttu-id="8e1ff-122">Přehled řešení</span><span class="sxs-lookup"><span data-stu-id="8e1ff-122">Solution Overview</span></span>

 <span data-ttu-id="8e1ff-123">Poskytujeme dvě nové uživatelsky nahraditelné služby, [IExceptionLogger](../releases/whats-new-in-aspnet-web-api-21.md) a IExceptionHandler pro protokolování a zpracování neošetřených výjimek.</span><span class="sxs-lookup"><span data-stu-id="8e1ff-123">We provide two new user-replaceable services, [IExceptionLogger](../releases/whats-new-in-aspnet-web-api-21.md) and IExceptionHandler, to log and handle unhandled exceptions.</span></span> <span data-ttu-id="8e1ff-124">Služby jsou velmi podobné a mají dvě hlavní rozdíly:</span><span class="sxs-lookup"><span data-stu-id="8e1ff-124">The services are very similar, with two main differences:</span></span>

1. <span data-ttu-id="8e1ff-125">Podporujeme registraci více protokolovacích protokolovacích nástrojů, ale jenom jednu obslužnou rutinu výjimky.</span><span class="sxs-lookup"><span data-stu-id="8e1ff-125">We support registering multiple exception loggers but only a single exception handler.</span></span>
2. <span data-ttu-id="8e1ff-126">Protokolovací nástroje výjimky se vždy zavolají, i když se chystáme připojení přerušit.</span><span class="sxs-lookup"><span data-stu-id="8e1ff-126">Exception loggers always get called, even if we're about to abort the connection.</span></span> <span data-ttu-id="8e1ff-127">Obslužné rutiny výjimek se volají pouze v případě, že stále dokážeme zvolit, která odpověď se má odeslat.</span><span class="sxs-lookup"><span data-stu-id="8e1ff-127">Exception handlers only get called when we're still able to choose which response message to send.</span></span>

<span data-ttu-id="8e1ff-128">Obě služby poskytují přístup ke kontextu výjimek, který obsahuje relevantní informace z místa, kde byla výjimka zjištěna, zejména [zprávy HttpRequestMessage](https://msdn.microsoft.com/library/system.net.http.httprequestmessage(v=vs.110).aspx), [HttpRequestContext](https://msdn.microsoft.com/library/system.web.http.controllers.httprequestcontext(v=vs.118).aspx), vyvolaná výjimka a zdroj výjimky (podrobnosti níže).</span><span class="sxs-lookup"><span data-stu-id="8e1ff-128">Both services provide access to an exception context containing relevant information from the point where the exception was detected, particularly the [HttpRequestMessage](https://msdn.microsoft.com/library/system.net.http.httprequestmessage(v=vs.110).aspx), the [HttpRequestContext](https://msdn.microsoft.com/library/system.web.http.controllers.httprequestcontext(v=vs.118).aspx), the thrown exception and the exception source (details below).</span></span>

### <a name="design-principles"></a><span data-ttu-id="8e1ff-129">Principy návrhu</span><span class="sxs-lookup"><span data-stu-id="8e1ff-129">Design Principles</span></span>

1. <span data-ttu-id="8e1ff-130">**Žádné neprůlomové změny** Vzhledem k tomu, že se tato funkce přidává v dílčí verzi, jedno důležité omezení, které ovlivňuje řešení, znamená, že nedochází k žádným nepodstatným změnám, a to ani k typu kontraktů nebo chování.</span><span class="sxs-lookup"><span data-stu-id="8e1ff-130">**No breaking changes** Because this functionality is being added in a minor release, one important constraint impacting the solution is that there be no breaking changes, either to type contracts or to behavior.</span></span> <span data-ttu-id="8e1ff-131">Toto omezení vyvolalo nějaké vyčištění, které bychom chtěli udělat v souvislosti s existujícími bloky catch, které zapíná výjimky na 500 odpovědí.</span><span class="sxs-lookup"><span data-stu-id="8e1ff-131">This constraint ruled out some cleanup we would like to have done in terms of existing catch blocks turning exceptions into 500 responses.</span></span> <span data-ttu-id="8e1ff-132">Toto dodatečné vyčištění je možné zvážit pro další hlavní vydání.</span><span class="sxs-lookup"><span data-stu-id="8e1ff-132">This additional cleanup is something we might consider for a subsequent major release.</span></span> <span data-ttu-id="8e1ff-133">Pokud je to pro vás důležité, můžete na něj hlasovat na [uživatelském hlasu ASP.NET webového rozhraní API](http://aspnet.uservoice.com/forums/147201-asp-net-web-api/suggestions/5451321-add-flag-to-enable-iexceptionlogger-and-iexception).</span><span class="sxs-lookup"><span data-stu-id="8e1ff-133">If this is important to you please vote on it at [ASP.NET Web API user voice](http://aspnet.uservoice.com/forums/147201-asp-net-web-api/suggestions/5451321-add-flag-to-enable-iexceptionlogger-and-iexception).</span></span>
2. <span data-ttu-id="8e1ff-134">**Zachování konzistence pomocí konstrukcí webového rozhraní API** Kanál filtru webového rozhraní API je skvělým způsobem, jak zpracovávat problémy zaměřené na průřez a flexibilitu při použití logiky v oboru specifickém pro konkrétní akci, na konkrétního řadiče nebo na globálním rozsahu.</span><span class="sxs-lookup"><span data-stu-id="8e1ff-134">**Maintaining consistency with Web API constructs** Web API's filter pipeline is a great way to handle cross-cutting concerns with the flexibility of applying the logic at an action-specific, controller-specific or global scope.</span></span> <span data-ttu-id="8e1ff-135">Filtry, včetně filtrů výjimek, vždy mají kontexty Action a Controller i v případě, že jsou registrovány v globálním oboru.</span><span class="sxs-lookup"><span data-stu-id="8e1ff-135">Filters, including exception filters, always have action and controller contexts, even when registered at the global scope.</span></span> <span data-ttu-id="8e1ff-136">Tato smlouva dává smysl pro filtry, ale znamená, že filtry výjimek, dokonce i globálně vymezené, nejsou vhodné pro některé případy zpracování výjimek, jako jsou výjimky z obslužných rutin zpráv, kde neexistuje žádná akce nebo kontext kontroleru.</span><span class="sxs-lookup"><span data-stu-id="8e1ff-136">That contract makes sense for filters, but it means that exception filters, even globally scoped ones, aren't a good fit for some exception handling cases, such as exceptions from message handlers, where no action or controller context exists.</span></span> <span data-ttu-id="8e1ff-137">Pokud chceme použít flexibilní rozsah poskytovaný filtry pro zpracování výjimek, pořád potřebujeme filtry výjimek.</span><span class="sxs-lookup"><span data-stu-id="8e1ff-137">If we want to use the flexible scoping afforded by filters for exception handling, we still need exception filters.</span></span> <span data-ttu-id="8e1ff-138">Pokud ale potřebujeme zpracovat výjimku mimo kontext kontroleru, potřebujeme také samostatnou konstrukci pro úplné zpracování globálních chyb (něco bez kontextu kontroleru a omezení kontextu akce).</span><span class="sxs-lookup"><span data-stu-id="8e1ff-138">But if we need to handle exception outside of a controller context, we also need a separate construct for full global error handling (something without the controller context and action context constraints).</span></span>

### <a name="when-to-use"></a><span data-ttu-id="8e1ff-139">Kdy použít</span><span class="sxs-lookup"><span data-stu-id="8e1ff-139">When to Use</span></span>

- <span data-ttu-id="8e1ff-140">Protokolovací nástroje jsou řešením pro zobrazení všech neošetřených výjimek zachycených webovým rozhraním API.</span><span class="sxs-lookup"><span data-stu-id="8e1ff-140">Exception loggers are the solution to seeing all unhandled exception caught by Web API.</span></span>
- <span data-ttu-id="8e1ff-141">Obslužné rutiny výjimek představují řešení pro přizpůsobení všech možných odpovědí na neošetřené výjimky zachycené webovým rozhraním API.</span><span class="sxs-lookup"><span data-stu-id="8e1ff-141">Exception handlers are the solution for customizing all possible responses to unhandled exceptions caught by Web API.</span></span>
- <span data-ttu-id="8e1ff-142">Filtry výjimek jsou nejjednodušší řešení pro zpracování podmnožiny neošetřených výjimek týkajících se konkrétní akce nebo kontroleru.</span><span class="sxs-lookup"><span data-stu-id="8e1ff-142">Exception filters are the easiest solution for processing the subset unhandled exceptions related to a specific action or controller.</span></span>

### <a name="service-details"></a><span data-ttu-id="8e1ff-143">Podrobnosti služby</span><span class="sxs-lookup"><span data-stu-id="8e1ff-143">Service Details</span></span>

 <span data-ttu-id="8e1ff-144">Protokolovací nástroj výjimky a rozhraní obslužných rutin jsou jednoduché asynchronní metody, které přebírají příslušné kontexty:</span><span class="sxs-lookup"><span data-stu-id="8e1ff-144">The exception logger and handler service interfaces are simple async methods taking the respective contexts:</span></span> 

[!code-csharp[Main](web-api-global-error-handling/samples/sample2.cs)]

 <span data-ttu-id="8e1ff-145">Poskytujeme také základní třídy pro obě tato rozhraní.</span><span class="sxs-lookup"><span data-stu-id="8e1ff-145">We also provide base classes for both of these interfaces.</span></span> <span data-ttu-id="8e1ff-146">Přepsání základních (synchronizovaných nebo asynchronních) metod se vyžaduje pro protokolování a zpracování v doporučených časech.</span><span class="sxs-lookup"><span data-stu-id="8e1ff-146">Overriding the core (sync or async) methods is all that is required to log or handle at the recommended times.</span></span> <span data-ttu-id="8e1ff-147">Pro protokolování `ExceptionLogger` základní třída zaručí, že základní metoda protokolování je volána pouze jednou pro každou výjimku (i v případě, že je později šíří do dalšího zásobníku volání a je znovu zachycena).</span><span class="sxs-lookup"><span data-stu-id="8e1ff-147">For logging, the `ExceptionLogger` base class will ensure that the core logging method is only called once for each exception (even if it later propagates further up the call stack and is caught again).</span></span> <span data-ttu-id="8e1ff-148">Základní třída `ExceptionHandler` zavolá metodu zpracování jádra pouze pro výjimky v horní části zásobníku volání a ignoruje staré vnořené bloky catch.</span><span class="sxs-lookup"><span data-stu-id="8e1ff-148">The `ExceptionHandler` base class will call the core handling method only for exceptions at the top of the call stack, ignoring legacy nested catch blocks.</span></span> <span data-ttu-id="8e1ff-149">(Zjednodušené verze těchto základních tříd jsou uvedené v příloze níže.) `IExceptionLogger` i `IExceptionHandler` přijímají informace o výjimce prostřednictvím `ExceptionContext`.</span><span class="sxs-lookup"><span data-stu-id="8e1ff-149">(Simplified versions of these base classes are in the appendix below.) Both `IExceptionLogger` and `IExceptionHandler` receive information about the exception via an `ExceptionContext`.</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample3.cs)]

<span data-ttu-id="8e1ff-150">Když rozhraní volá protokolovací nástroj výjimky nebo obslužnou rutinu výjimky, vždy poskytne `Exception` a `Request`.</span><span class="sxs-lookup"><span data-stu-id="8e1ff-150">When the framework calls an exception logger or an exception handler, it will always provide an `Exception` and a `Request`.</span></span> <span data-ttu-id="8e1ff-151">S výjimkou testování částí také vždy poskytne `RequestContext`.</span><span class="sxs-lookup"><span data-stu-id="8e1ff-151">Except for unit testing, it will also always provide a `RequestContext`.</span></span> <span data-ttu-id="8e1ff-152">V takovém případě se neposkytne `ControllerContext` a `ActionContext` (pouze při volání z bloku catch pro filtry výjimek).</span><span class="sxs-lookup"><span data-stu-id="8e1ff-152">It will rarely provide a `ControllerContext` and `ActionContext` (only when calling from the catch block for exception filters).</span></span> <span data-ttu-id="8e1ff-153">Při pokusu o zápis odpovědi bude velmi zřídka poskytovat `Response`(pouze v některých případech služby IIS).</span><span class="sxs-lookup"><span data-stu-id="8e1ff-153">It will very rarely provide a `Response`(only in certain IIS cases when in the middle of trying to write the response).</span></span> <span data-ttu-id="8e1ff-154">Vzhledem k tomu, že některé z těchto vlastností mohou být `null` je až příjemce, aby před přístupem ke členům třídy Exception kontroloval `null`.`CatchBlock`</span><span class="sxs-lookup"><span data-stu-id="8e1ff-154">Note that because some of these properties may be `null` it is up to the consumer to check for `null` before accessing members of the exception class.`CatchBlock`</span></span> <span data-ttu-id="8e1ff-155">je řetězec, který označuje, který blok catch viděli výjimku.</span><span class="sxs-lookup"><span data-stu-id="8e1ff-155">is a string indicating which catch block saw the exception.</span></span> <span data-ttu-id="8e1ff-156">Řetězce bloku catch jsou následující:</span><span class="sxs-lookup"><span data-stu-id="8e1ff-156">The catch block strings are as follows:</span></span>

- <span data-ttu-id="8e1ff-157">HttpServer (metoda SendAsync)</span><span class="sxs-lookup"><span data-stu-id="8e1ff-157">HttpServer (SendAsync method)</span></span>
- <span data-ttu-id="8e1ff-158">HttpControllerDispatcher (metoda SendAsync)</span><span class="sxs-lookup"><span data-stu-id="8e1ff-158">HttpControllerDispatcher (SendAsync method)</span></span>
- <span data-ttu-id="8e1ff-159">HttpBatchHandler (metoda SendAsync)</span><span class="sxs-lookup"><span data-stu-id="8e1ff-159">HttpBatchHandler (SendAsync method)</span></span>
- <span data-ttu-id="8e1ff-160">IExceptionFilter (zpracování kanálu filtru výjimek v metody ExecuteAsync) (ApiController)</span><span class="sxs-lookup"><span data-stu-id="8e1ff-160">IExceptionFilter (ApiController's processing of the exception filter pipeline in ExecuteAsync)</span></span>
- <span data-ttu-id="8e1ff-161">OWIN hostitel:</span><span class="sxs-lookup"><span data-stu-id="8e1ff-161">OWIN host:</span></span>

    - <span data-ttu-id="8e1ff-162">HttpMessageHandlerAdapter. BufferResponseContentAsync (pro výstup do vyrovnávací paměti)</span><span class="sxs-lookup"><span data-stu-id="8e1ff-162">HttpMessageHandlerAdapter.BufferResponseContentAsync (for buffering output)</span></span>
    - <span data-ttu-id="8e1ff-163">HttpMessageHandlerAdapter. CopyResponseContentAsync (pro výstup streamování)</span><span class="sxs-lookup"><span data-stu-id="8e1ff-163">HttpMessageHandlerAdapter.CopyResponseContentAsync (for streaming output)</span></span>
- <span data-ttu-id="8e1ff-164">Webový hostitel:</span><span class="sxs-lookup"><span data-stu-id="8e1ff-164">Web host:</span></span>

    - <span data-ttu-id="8e1ff-165">HttpControllerHandler. WriteBufferedResponseContentAsync (pro výstup do vyrovnávací paměti)</span><span class="sxs-lookup"><span data-stu-id="8e1ff-165">HttpControllerHandler.WriteBufferedResponseContentAsync (for buffering output)</span></span>
    - <span data-ttu-id="8e1ff-166">HttpControllerHandler. WriteStreamedResponseContentAsync (pro výstup streamování)</span><span class="sxs-lookup"><span data-stu-id="8e1ff-166">HttpControllerHandler.WriteStreamedResponseContentAsync (for streaming output)</span></span>
    - <span data-ttu-id="8e1ff-167">HttpControllerHandler. WriteErrorResponseContentAsync (selhání při zotavení po chybě v režimu výstupu do vyrovnávací paměti)</span><span class="sxs-lookup"><span data-stu-id="8e1ff-167">HttpControllerHandler.WriteErrorResponseContentAsync (for failures in error recovery under buffered output mode)</span></span>

<span data-ttu-id="8e1ff-168">Seznam řetězců bloku catch je také k dispozici prostřednictvím statických vlastností jen pro čtení.</span><span class="sxs-lookup"><span data-stu-id="8e1ff-168">The list of catch block strings is also available via static readonly properties.</span></span> <span data-ttu-id="8e1ff-169">(Základní řetězec bloku catch je na statickém ExceptionCatchBlocks; zbytek se zobrazí na jedné statické třídě pro OWIN a webový hostitel).`IsTopLevelCatchBlock`</span><span class="sxs-lookup"><span data-stu-id="8e1ff-169">(The core catch block string are on the static ExceptionCatchBlocks; the remainder appear on one static class each for OWIN and web host).`IsTopLevelCatchBlock`</span></span> <span data-ttu-id="8e1ff-170">je vhodný pro následující vzor zpracování výjimek pouze v horní části zásobníku volání.</span><span class="sxs-lookup"><span data-stu-id="8e1ff-170">is helpful for following the recommended pattern of handling exceptions only at the top of the call stack.</span></span> <span data-ttu-id="8e1ff-171">Namísto zapínání výjimek na 500 odpovědí kdekoli dojde k vnořenému bloku catch, obslužná rutina výjimky může umožnit šíření výjimek, dokud nebudou na hostiteli vidět.</span><span class="sxs-lookup"><span data-stu-id="8e1ff-171">Rather than turning exceptions into 500 responses anywhere a nested catch block occurs, an exception handler can let exceptions propagate until they are about to be seen by the host.</span></span>

<span data-ttu-id="8e1ff-172">Kromě `ExceptionContext`načítá protokolovací nástroj Další informace prostřednictvím úplné `ExceptionLoggerContext`:</span><span class="sxs-lookup"><span data-stu-id="8e1ff-172">In addition to the `ExceptionContext`, a logger gets one more piece of information via the full `ExceptionLoggerContext`:</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample4.cs)]

<span data-ttu-id="8e1ff-173">Druhá vlastnost, `CanBeHandled`, umožňuje protokolovacímu nástroje identifikovat výjimku, kterou nelze zpracovat.</span><span class="sxs-lookup"><span data-stu-id="8e1ff-173">The second property, `CanBeHandled`, allows a logger to identify an exception that cannot be handled.</span></span> <span data-ttu-id="8e1ff-174">Když bude připojení přerušeno a nebude možné odeslat žádnou novou zprávu odpovědi, budou volány protokolovací nástroje, ale obslužná rutina ***nebude volána*** a protokolovací nástroje mohou tento scénář identifikovat z této vlastnosti.</span><span class="sxs-lookup"><span data-stu-id="8e1ff-174">When the connection is about to be aborted and no new response message can be sent, the loggers will be called but the handler will ***not*** be called, and the loggers can identify this scenario from this property.</span></span>

<span data-ttu-id="8e1ff-175">Vedle `ExceptionContext`obslužná rutina získá jednu vlastnost, která může být nastavena na plný `ExceptionHandlerContext` pro zpracování výjimky:</span><span class="sxs-lookup"><span data-stu-id="8e1ff-175">In additional to the `ExceptionContext`, a handler gets one more property it can set on the full `ExceptionHandlerContext` to handle the exception:</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample5.cs)]

<span data-ttu-id="8e1ff-176">Obslužná rutina výjimky označuje, že byla zpracována výjimka nastavením vlastnosti `Result` na výsledek akce (například [ExceptionResult](https://msdn.microsoft.com/library/system.web.http.results.exceptionresult(v=vs.118).aspx), [InternalServerErrorResult](https://msdn.microsoft.com/library/system.web.http.results.internalservererrorresult(v=vs.118).aspx), [StatusCodeResult](https://msdn.microsoft.com/library/system.web.http.results.statuscoderesult(v=vs.118).aspx)nebo vlastní výsledek).</span><span class="sxs-lookup"><span data-stu-id="8e1ff-176">An exception handler indicates that it has handled an exception by setting the `Result` property to an action result (for example, an [ExceptionResult](https://msdn.microsoft.com/library/system.web.http.results.exceptionresult(v=vs.118).aspx), [InternalServerErrorResult](https://msdn.microsoft.com/library/system.web.http.results.internalservererrorresult(v=vs.118).aspx), [StatusCodeResult](https://msdn.microsoft.com/library/system.web.http.results.statuscoderesult(v=vs.118).aspx), or a custom result).</span></span> <span data-ttu-id="8e1ff-177">Pokud má vlastnost `Result` hodnotu null, výjimka je neošetřená a původní výjimka bude znovu vyvolána.</span><span class="sxs-lookup"><span data-stu-id="8e1ff-177">If the `Result` property is null, the exception is unhandled and the original exception will be re-thrown.</span></span>

<span data-ttu-id="8e1ff-178">Pro výjimky v horní části zásobníku volání jsme zavedli dodatečný krok, který zaručí, že odpověď je vhodná pro volající rozhraní API.</span><span class="sxs-lookup"><span data-stu-id="8e1ff-178">For exceptions at the top of the call stack, we took an extra step to ensure the response is appropriate for API callers.</span></span> <span data-ttu-id="8e1ff-179">Pokud se výjimka rozšíří až na hostitele, volající by uvidí žlutou obrazovku smrti nebo jiné reakce na hostitele, což je obvykle HTML a ne obvykle vhodná odpověď na chybu rozhraní API.</span><span class="sxs-lookup"><span data-stu-id="8e1ff-179">If the exception propagates up to the host, the caller would see the yellow screen of death or some other host provided response which is typically HTML and not usually an appropriate API error response.</span></span> <span data-ttu-id="8e1ff-180">V těchto případech výsledek začíná mimo null a pouze v případě, že vlastní obslužná rutina výjimky ji nastaví zpět na `null` (neošetřený), bude výjimka rozšířena na hostitele.</span><span class="sxs-lookup"><span data-stu-id="8e1ff-180">In these cases, the Result starts out non-null, and only if a custom exception handler explicitly sets it back to `null` (unhandled) will the exception propagate to the host.</span></span> <span data-ttu-id="8e1ff-181">Nastavení `Result` `null` v takových případech může být užitečné pro dva scénáře:</span><span class="sxs-lookup"><span data-stu-id="8e1ff-181">Setting `Result` to `null` in such cases can be useful for two scenarios:</span></span>

1. <span data-ttu-id="8e1ff-182">OWIN hostované webové rozhraní API s vlastními zpracováním výjimek registrovanými před nebo mimo webové rozhraní API.</span><span class="sxs-lookup"><span data-stu-id="8e1ff-182">OWIN hosted Web API with custom exception handling middleware registered before/outside Web API.</span></span>
2. <span data-ttu-id="8e1ff-183">Místní ladění prostřednictvím prohlížeče, kde žlutá obrazovka smrti je vlastně užitečnou odezvou na neošetřenou výjimku.</span><span class="sxs-lookup"><span data-stu-id="8e1ff-183">Local debugging via a browser, where the yellow screen of death is actually a helpful response for an unhandled exception.</span></span>

<span data-ttu-id="8e1ff-184">V případě protokolovacích nástrojů výjimek a obslužných rutin výjimek neuděláme nic k obnovení, pokud obslužná rutina nebo obslužná rutina sám vyvolá výjimku.</span><span class="sxs-lookup"><span data-stu-id="8e1ff-184">For both exception loggers and exception handlers, we don't do anything to recover if the logger or handler itself throws an exception.</span></span> <span data-ttu-id="8e1ff-185">(Jiné než umožnění šíření výjimky, pokud máte lepší přístup, zachovejte zpětnou vazbu na konci této stránky.) Kontrakt pro protokolovací nástroje a obslužné rutiny výjimek je, že by neměly umožnit šíření výjimek do jejich volajících; v opačném případě se výjimka rozšíří jenom na hostitele, což by vedlo k chybě HTML (jako je ASP. Žlutá obrazovka netto), která se odesílá zpátky klientovi (což obvykle není upřednostňovanou možností pro volající rozhraní API, které očekávají JSON nebo XML).</span><span class="sxs-lookup"><span data-stu-id="8e1ff-185">(Other than letting the exception propagate, leave feedback at the bottom of this page if you have a better approach.) The contract for exception loggers and handlers is that they should not let exceptions propagate up to their callers; otherwise, the exception will just propagate, often all the way to the host resulting in an HTML error (like the ASP.NET's yellow screen) being sent back to the client (which usually isn't the preferred option for API callers that expect JSON or XML).</span></span>

## <a name="examples"></a><span data-ttu-id="8e1ff-186">Příklady</span><span class="sxs-lookup"><span data-stu-id="8e1ff-186">Examples</span></span>

### <a name="tracing-exception-logger"></a><span data-ttu-id="8e1ff-187">Protokolovací nástroj pro trasování výjimek</span><span class="sxs-lookup"><span data-stu-id="8e1ff-187">Tracing Exception Logger</span></span>

<span data-ttu-id="8e1ff-188">Protokolovací nástroj výjimky níže odesílá data výjimky do konfigurovaných zdrojů trasování (včetně okna výstup ladění v aplikaci Visual Studio).</span><span class="sxs-lookup"><span data-stu-id="8e1ff-188">The exception logger below send exception data to configured Trace sources (including the Debug output window in Visual Studio).</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample6.cs)]

### <a name="custom-error-message-exception-handler"></a><span data-ttu-id="8e1ff-189">Obslužná rutina výjimky vlastní chybové zprávy</span><span class="sxs-lookup"><span data-stu-id="8e1ff-189">Custom Error Message Exception Handler</span></span>

<span data-ttu-id="8e1ff-190">Následující obrázek vytvoří vlastní chybovou odpověď pro klienty, včetně e-mailové adresy pro kontaktování podpory.</span><span class="sxs-lookup"><span data-stu-id="8e1ff-190">The following below produces a custom error response to clients, including an email address for contacting support.</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample7.cs)]

## <a name="registering-exception-filters"></a><span data-ttu-id="8e1ff-191">Registrace filtrů výjimek</span><span class="sxs-lookup"><span data-stu-id="8e1ff-191">Registering Exception Filters</span></span>

<span data-ttu-id="8e1ff-192">Pokud k vytvoření projektu použijete šablonu projektu webová aplikace ASP.NET MVC 4, vložte svůj konfigurační kód webového rozhraní API do třídy `WebApiConfig` ve složce *App/_Start* :</span><span class="sxs-lookup"><span data-stu-id="8e1ff-192">If you use the "ASP.NET MVC 4 Web Application" project template to create your project, put your Web API configuration code inside the `WebApiConfig` class, in the *App/_Start* folder:</span></span>

[!code-csharp[Main](exception-handling/samples/sample7.cs?highlight=5)]

## <a name="appendix-base-class-details"></a><span data-ttu-id="8e1ff-193">Příloha: podrobnosti základní třídy</span><span class="sxs-lookup"><span data-stu-id="8e1ff-193">Appendix: Base Class Details</span></span>

[!code-csharp[Main](web-api-global-error-handling/samples/sample8.cs)]
