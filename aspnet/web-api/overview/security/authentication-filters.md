---
uid: web-api/overview/security/authentication-filters
title: Filtry ověřování v ASP.NET webovém rozhraní API 2 | Microsoft Docs
author: MikeWasson
description: Filtr ověřování je komponenta, která ověřuje požadavek HTTP. Webové rozhraní API 2 a MVC 5 podporují ověřovací filtry, ale mírně se liší...
ms.author: riande
ms.date: 09/25/2014
ms.assetid: b9882e53-b3ca-4def-89b0-322846973ccb
msc.legacyurl: /web-api/overview/security/authentication-filters
msc.type: authoredcontent
ms.openlocfilehash: 2ef9e62a6c634237e920b6d7aba2127b835f959d
ms.sourcegitcommit: e365196c75ce93cd8967412b1cfdc27121816110
ms.translationtype: MT
ms.contentlocale: cs-CZ
ms.lasthandoff: 02/07/2020
ms.locfileid: "77075070"
---
# <a name="authentication-filters-in-aspnet-web-api-2"></a><span data-ttu-id="4fc3f-104">Filtry ověřování v ASP.NET webovém rozhraní API 2</span><span class="sxs-lookup"><span data-stu-id="4fc3f-104">Authentication Filters in ASP.NET Web API 2</span></span>

<span data-ttu-id="4fc3f-105">o [Jan Wasson](https://github.com/MikeWasson)</span><span class="sxs-lookup"><span data-stu-id="4fc3f-105">by [Mike Wasson](https://github.com/MikeWasson)</span></span>

> <span data-ttu-id="4fc3f-106">Filtr ověřování je komponenta, která ověřuje požadavek HTTP.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-106">An authentication filter is a component that authenticates an HTTP request.</span></span> <span data-ttu-id="4fc3f-107">Webové rozhraní API 2 a MVC 5 podporují ověřovací filtry, ale mírně se liší většinou v zásadách vytváření názvů pro rozhraní filtru.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-107">Web API 2 and MVC 5 both support authentication filters, but they differ slightly, mostly in the naming conventions for the filter interface.</span></span> <span data-ttu-id="4fc3f-108">Toto téma popisuje filtry ověřování webového rozhraní API.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-108">This topic describes Web API authentication filters.</span></span>

<span data-ttu-id="4fc3f-109">Filtry ověřování umožňují nastavit schéma ověřování pro jednotlivé řadiče nebo akce.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-109">Authentication filters let you set an authentication scheme for individual controllers or actions.</span></span> <span data-ttu-id="4fc3f-110">V takovém případě vaše aplikace může podporovat různé mechanismy ověřování pro různé prostředky HTTP.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-110">That way, your app can support different authentication mechanisms for different HTTP resources.</span></span>

<span data-ttu-id="4fc3f-111">V tomto článku se zobrazí kód ze vzorového [ověřování Basic](https://github.com/aspnet/samples/tree/master/samples/aspnet/WebApi/BasicAuthentication) na [https://github.com/aspnet/samples](https://github.com/aspnet/samples).</span><span class="sxs-lookup"><span data-stu-id="4fc3f-111">In this article, I'll show code from the [Basic Authentication](https://github.com/aspnet/samples/tree/master/samples/aspnet/WebApi/BasicAuthentication) sample on [https://github.com/aspnet/samples](https://github.com/aspnet/samples).</span></span> <span data-ttu-id="4fc3f-112">Ukázka zobrazuje filtr ověřování, který implementuje schéma ověření přístupu Basic protokolu HTTP (RFC 2617).</span><span class="sxs-lookup"><span data-stu-id="4fc3f-112">The sample shows an authentication filter that implements the HTTP Basic Access Authentication scheme (RFC 2617).</span></span> <span data-ttu-id="4fc3f-113">Filtr je implementován ve třídě s názvem `IdentityBasicAuthenticationAttribute`.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-113">The filter is implemented in a class named `IdentityBasicAuthenticationAttribute`.</span></span> <span data-ttu-id="4fc3f-114">Nezobrazuje se v ukázce celý kód, jenom části, které ukazují, jak napsat filtr ověřování.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-114">I won't show all of the code from the sample, just the parts that illustrate how to write an authentication filter.</span></span>

## <a name="setting-an-authentication-filter"></a><span data-ttu-id="4fc3f-115">Nastavení filtru ověřování</span><span class="sxs-lookup"><span data-stu-id="4fc3f-115">Setting an Authentication Filter</span></span>

<span data-ttu-id="4fc3f-116">Podobně jako jiné filtry lze ověřovací filtry použít pro každý kontroler, pro akci nebo globálně na všechny řadiče webového rozhraní API.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-116">Like other filters, authentication filters can be applied per-controller, per-action, or globally to all Web API controllers.</span></span>

<span data-ttu-id="4fc3f-117">Chcete-li použít filtr ověřování na kontroler, sestavte třídu kontroleru pomocí atributu Filter.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-117">To apply an authentication filter to a controller, decorate the controller class with the filter attribute.</span></span> <span data-ttu-id="4fc3f-118">Následující kód nastaví filtr `[IdentityBasicAuthentication]` pro třídu Controller, která umožňuje základní ověřování všech akcí kontroleru.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-118">The following code sets the `[IdentityBasicAuthentication]` filter on a controller class, which enables Basic Authentication for all of the controller's actions.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample1.cs)]

<span data-ttu-id="4fc3f-119">Chcete-li použít filtr na jednu akci, seupravte akci filtrem.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-119">To apply the filter to one action, decorate the action with the filter.</span></span> <span data-ttu-id="4fc3f-120">Následující kód nastaví filtr `[IdentityBasicAuthentication]` v metodě `Post` kontroleru.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-120">The following code sets the `[IdentityBasicAuthentication]` filter on the controller's `Post` method.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample2.cs)]

<span data-ttu-id="4fc3f-121">Pokud chcete filtr použít na všechny řadiče webového rozhraní API, přidejte ho do **GlobalConfiguration. filters**.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-121">To apply the filter to all Web API controllers, add it to **GlobalConfiguration.Filters**.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample3.cs)]

## <a name="implementing-a-web-api-authentication-filter"></a><span data-ttu-id="4fc3f-122">Implementace filtru ověřování webového rozhraní API</span><span class="sxs-lookup"><span data-stu-id="4fc3f-122">Implementing a Web API Authentication Filter</span></span>

<span data-ttu-id="4fc3f-123">Ověřovací filtry ve webovém rozhraní API implementují rozhraní [System. Web. http. filters. IAuthenticationFilter](https://msdn.microsoft.com/library/system.web.http.filters.iauthenticationfilter.aspx) .</span><span class="sxs-lookup"><span data-stu-id="4fc3f-123">In Web API, authentication filters implement the [System.Web.Http.Filters.IAuthenticationFilter](https://msdn.microsoft.com/library/system.web.http.filters.iauthenticationfilter.aspx) interface.</span></span> <span data-ttu-id="4fc3f-124">Měly by také dědit z **atributu System. Attribute**, aby je bylo možné použít jako atributy.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-124">They should also inherit from **System.Attribute**, in order to be applied as attributes.</span></span>

<span data-ttu-id="4fc3f-125">Rozhraní **IAuthenticationFilter** má dvě metody:</span><span class="sxs-lookup"><span data-stu-id="4fc3f-125">The **IAuthenticationFilter** interface has two methods:</span></span>

- <span data-ttu-id="4fc3f-126">**AuthenticateAsync** ověří požadavek pomocí ověření přihlašovacích údajů v žádosti, pokud je k dispozici.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-126">**AuthenticateAsync** authenticates the request by validating credentials in the request, if present.</span></span>
- <span data-ttu-id="4fc3f-127">**ChallengeAsync** v případě potřeby přidá do odpovědi HTTP výzvu ověřování.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-127">**ChallengeAsync** adds an authentication challenge to the HTTP response, if needed.</span></span>

<span data-ttu-id="4fc3f-128">Tyto metody odpovídají toku ověřování definovanému v [dokumentu rfc 2612](http://tools.ietf.org/html/rfc2616) a [RFC 2617](http://tools.ietf.org/html/rfc2617):</span><span class="sxs-lookup"><span data-stu-id="4fc3f-128">These methods correspond to the authentication flow defined in [RFC 2612](http://tools.ietf.org/html/rfc2616) and [RFC 2617](http://tools.ietf.org/html/rfc2617):</span></span>

1. <span data-ttu-id="4fc3f-129">Klient odesílá pověření do autorizační hlavičky.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-129">The client sends credentials in the Authorization header.</span></span> <span data-ttu-id="4fc3f-130">K tomu obvykle dochází poté, co klient obdrží od serveru odpověď 401 (Neautorizovaná).</span><span class="sxs-lookup"><span data-stu-id="4fc3f-130">This typically happens after the client receives a 401 (Unauthorized) response from the server.</span></span> <span data-ttu-id="4fc3f-131">Klient ale může odesílat přihlašovací údaje s libovolným požadavkem, a ne hned po získání 401.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-131">However, a client can send credentials with any request, not just after getting a 401.</span></span>
2. <span data-ttu-id="4fc3f-132">Pokud server přihlašovací údaje nepřijme, vrátí odpověď 401 (Neautorizovaná).</span><span class="sxs-lookup"><span data-stu-id="4fc3f-132">If the server does not accept the credentials, it returns a 401 (Unauthorized) response.</span></span> <span data-ttu-id="4fc3f-133">Odpověď obsahuje hlavičku WWW-Authenticate, která obsahuje jeden nebo více výzev.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-133">The response includes a Www-Authenticate header that contains one or more challenges.</span></span> <span data-ttu-id="4fc3f-134">Každá výzva Určuje schéma ověřování rozpoznané serverem.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-134">Each challenge specifies an authentication scheme recognized by the server.</span></span>

<span data-ttu-id="4fc3f-135">Server může také vrátit 401 z anonymního požadavku.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-135">The server can also return 401 from an anonymous request.</span></span> <span data-ttu-id="4fc3f-136">Ve skutečnosti to obvykle způsob, jakým je proces ověřování inicializovaný:</span><span class="sxs-lookup"><span data-stu-id="4fc3f-136">In fact, that's typically how the authentication process is initiated:</span></span>

1. <span data-ttu-id="4fc3f-137">Klient pošle anonymní požadavek.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-137">The client sends an anonymous request.</span></span>
2. <span data-ttu-id="4fc3f-138">Server vrátí 401.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-138">The server returns 401.</span></span>
3. <span data-ttu-id="4fc3f-139">Klienti znovu odesílají požadavek s přihlašovacími údaji.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-139">The clients resends the request with credentials.</span></span>

<span data-ttu-id="4fc3f-140">Tento tok zahrnuje jak *ověřování* , tak *autorizační* postup.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-140">This flow includes both *authentication* and *authorization* steps.</span></span>

- <span data-ttu-id="4fc3f-141">Ověřování prokáže identitu klienta.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-141">Authentication proves the identity of the client.</span></span>
- <span data-ttu-id="4fc3f-142">Autorizace určuje, jestli klient může získat přístup k určitému prostředku.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-142">Authorization determines whether the client can access a particular resource.</span></span>

<span data-ttu-id="4fc3f-143">Ve webovém rozhraní API ověřovací filtry zpracovávají ověřování, ale ne autorizaci.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-143">In Web API, authentication filters handle authentication, but not authorization.</span></span> <span data-ttu-id="4fc3f-144">Autorizace by se měla provádět pomocí autorizačního filtru nebo uvnitř akce kontroleru.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-144">Authorization should be done by an authorization filter or inside the controller action.</span></span>

<span data-ttu-id="4fc3f-145">Toto je tok v kanálu webového rozhraní API 2:</span><span class="sxs-lookup"><span data-stu-id="4fc3f-145">Here is the flow in the Web API 2 pipeline:</span></span>

1. <span data-ttu-id="4fc3f-146">Před vyvoláním akce vytvoří webové rozhraní API seznam ověřovacích filtrů pro tuto akci.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-146">Before invoking an action, Web API creates a list of the authentication filters for that action.</span></span> <span data-ttu-id="4fc3f-147">To zahrnuje filtry s rozsahem akcí, oborem kontroléru a globálním rozsahem.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-147">This includes filters with action scope, controller scope, and global scope.</span></span>
2. <span data-ttu-id="4fc3f-148">Webové rozhraní API volá **AuthenticateAsync** u každého filtru v seznamu.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-148">Web API calls **AuthenticateAsync** on every filter in the list.</span></span> <span data-ttu-id="4fc3f-149">Každý filtr může v žádosti ověřit přihlašovací údaje.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-149">Each filter can validate credentials in the request.</span></span> <span data-ttu-id="4fc3f-150">Pokud některý filtr úspěšně ověří přihlašovací údaje, vytvoří filtr **IPrincipal** a připojí ho k žádosti.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-150">If any filter successfully validates credentials, the filter creates an **IPrincipal** and attaches it to the request.</span></span> <span data-ttu-id="4fc3f-151">Filtr může také v tomto okamžiku aktivovat chybu.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-151">A filter can also trigger an error at this point.</span></span> <span data-ttu-id="4fc3f-152">V takovém případě se zbytek kanálu nespustí.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-152">If so, the rest of the pipeline does not run.</span></span>
3. <span data-ttu-id="4fc3f-153">V případě, že není k dispozici žádná chyba, požadavek natéká přes zbytek kanálu.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-153">Assuming there is no error, the request flows through the rest of the pipeline.</span></span>
4. <span data-ttu-id="4fc3f-154">Webové rozhraní API potom volá metodu **ChallengeAsync** každého filtru ověřování.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-154">Finally, Web API calls every authentication filter's **ChallengeAsync** method.</span></span> <span data-ttu-id="4fc3f-155">Filtry používají tuto metodu k přidání výzvy k odpovědi, pokud je to potřeba.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-155">Filters use this method to add a challenge to the response, if needed.</span></span> <span data-ttu-id="4fc3f-156">Obvykle (ale ne vždy), k nimž by došlo v reakci na chybu 401.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-156">Typically (but not always) that would happen in response to a 401 error.</span></span>

<span data-ttu-id="4fc3f-157">Následující diagramy znázorňují dva možné případy.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-157">The following diagrams show two possible cases.</span></span> <span data-ttu-id="4fc3f-158">V prvním případě filtr ověřování úspěšně ověří požadavek, autorizační filtr autorizací žádosti a akce kontroleru vrátí 200 (OK).</span><span class="sxs-lookup"><span data-stu-id="4fc3f-158">In the first, the authentication filter successfully authenticates the request, an authorization filter authorizes the request, and the controller action returns 200 (OK).</span></span>

![](authentication-filters/_static/image1.png)

<span data-ttu-id="4fc3f-159">Ve druhém příkladu ověřovací filtr ověří požadavek, ale autorizační Filtr vrátí 401 (Neautorizováno).</span><span class="sxs-lookup"><span data-stu-id="4fc3f-159">In the second example, the authentication filter authenticates the request, but the authorization filter returns 401 (Unauthorized).</span></span> <span data-ttu-id="4fc3f-160">V takovém případě není vyvolána akce kontroleru.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-160">In this case, the controller action is not invoked.</span></span> <span data-ttu-id="4fc3f-161">Filtr ověřování přidá hlavičku WWW-Authenticate do odpovědi.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-161">The authentication filter adds a Www-Authenticate header to the response.</span></span>

![](authentication-filters/_static/image2.png)

<span data-ttu-id="4fc3f-162">K dispozici jsou další kombinace&mdash;například, pokud akce kontroleru povoluje anonymní požadavky, je možné, že máte filtr ověřování, ale nemáte autorizaci.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-162">Other combinations are possible&mdash;for example, if the controller action allows anonymous requests, you might have an authentication filter but no authorization.</span></span>

## <a name="implementing-the-authenticateasync-method"></a><span data-ttu-id="4fc3f-163">Implementace metody AuthenticateAsync</span><span class="sxs-lookup"><span data-stu-id="4fc3f-163">Implementing the AuthenticateAsync Method</span></span>

<span data-ttu-id="4fc3f-164">Metoda **AuthenticateAsync** se pokusí ověřit požadavek.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-164">The **AuthenticateAsync** method tries to authenticate the request.</span></span> <span data-ttu-id="4fc3f-165">Tady je podpis této metody:</span><span class="sxs-lookup"><span data-stu-id="4fc3f-165">Here is the method signature:</span></span>

[!code-csharp[Main](authentication-filters/samples/sample4.cs)]

<span data-ttu-id="4fc3f-166">Metoda **AuthenticateAsync** musí provést jednu z následujících akcí:</span><span class="sxs-lookup"><span data-stu-id="4fc3f-166">The **AuthenticateAsync** method must do one of the following:</span></span>

1. <span data-ttu-id="4fc3f-167">Nic (No-OP).</span><span class="sxs-lookup"><span data-stu-id="4fc3f-167">Nothing (no-op).</span></span>
2. <span data-ttu-id="4fc3f-168">Vytvořte **IPrincipal** a nastavte ji na žádost.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-168">Create an **IPrincipal** and set it on the request.</span></span>
3. <span data-ttu-id="4fc3f-169">Nastavte výsledek chyby.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-169">Set an error result.</span></span>

<span data-ttu-id="4fc3f-170">Option (1) znamená, že požadavek nemá žádné přihlašovací údaje, které tento filtr zná.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-170">Option (1) means the request did not have any credentials that the filter understands.</span></span> <span data-ttu-id="4fc3f-171">Option (2) znamená, že filtr úspěšně ověřil požadavek.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-171">Option (2) means the filter successfully authenticated the request.</span></span> <span data-ttu-id="4fc3f-172">Možnost (3) znamená, že žádost obsahovala neplatné přihlašovací údaje (například nesprávné heslo), která aktivuje chybovou odpověď.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-172">Option (3) means the request had invalid credentials (like the wrong password), which triggers an error response.</span></span>

<span data-ttu-id="4fc3f-173">Tady je obecná osnova pro implementaci **AuthenticateAsync**.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-173">Here is a general outline for implementing **AuthenticateAsync**.</span></span>

1. <span data-ttu-id="4fc3f-174">Vyhledejte přihlašovací údaje v žádosti.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-174">Look for credentials in the request.</span></span>
2. <span data-ttu-id="4fc3f-175">Pokud nejsou k dispozici žádná pověření, neprovádějte žádnou akci a vraťte (No-OP).</span><span class="sxs-lookup"><span data-stu-id="4fc3f-175">If there are no credentials, do nothing and return (no-op).</span></span>
3. <span data-ttu-id="4fc3f-176">Pokud jsou k dispozici přihlašovací údaje, ale filtr nerozpozná schéma ověřování, neprovádějte nic a vraťte se (No-OP).</span><span class="sxs-lookup"><span data-stu-id="4fc3f-176">If there are credentials but the filter does not recognize the authentication scheme, do nothing and return (no-op).</span></span> <span data-ttu-id="4fc3f-177">Schéma může pochopit jiný filtr v kanálu.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-177">Another filter in the pipeline might understand the scheme.</span></span>
4. <span data-ttu-id="4fc3f-178">Pokud jsou k dispozici přihlašovací údaje, které filtr zná, zkuste je ověřit.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-178">If there are credentials that the filter understands, try to authenticate them.</span></span>
5. <span data-ttu-id="4fc3f-179">Pokud jsou přihlašovací údaje chybné, vraťte 401 nastavením `context.ErrorResult`.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-179">If the credentials are bad, return 401 by setting `context.ErrorResult`.</span></span>
6. <span data-ttu-id="4fc3f-180">Pokud jsou přihlašovací údaje platné, vytvořte **IPrincipal** a nastavte `context.Principal`.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-180">If the credentials are valid, create an **IPrincipal** and set `context.Principal`.</span></span>

<span data-ttu-id="4fc3f-181">Následující kód ukazuje metodu **AuthenticateAsync** ze vzorového [ověřování Basic](https://github.com/aspnet/samples/tree/master/samples/aspnet/WebApi/BasicAuthentication) .</span><span class="sxs-lookup"><span data-stu-id="4fc3f-181">The follow code shows the **AuthenticateAsync** method from the [Basic Authentication](https://github.com/aspnet/samples/tree/master/samples/aspnet/WebApi/BasicAuthentication) sample.</span></span> <span data-ttu-id="4fc3f-182">Komentáře označují jednotlivé kroky.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-182">The comments indicate each step.</span></span> <span data-ttu-id="4fc3f-183">Kód ukazuje několik typů chyb: autorizační hlavička bez přihlašovacích údajů, poškozené přihlašovací údaje a chybné uživatelské jméno nebo heslo.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-183">The code shows several types of error: An Authorization header with no credentials, malformed credentials, and bad username/password.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample5.cs)]

## <a name="setting-an-error-result"></a><span data-ttu-id="4fc3f-184">Nastavení výsledku chyby</span><span class="sxs-lookup"><span data-stu-id="4fc3f-184">Setting an Error Result</span></span>

<span data-ttu-id="4fc3f-185">Pokud jsou přihlašovací údaje neplatné, musí filtr nastavit `context.ErrorResult` na **IHttpActionResult** , které vytvoří odpověď na chybu.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-185">If the credentials are invalid, the filter must set `context.ErrorResult` to an **IHttpActionResult** that creates an error response.</span></span> <span data-ttu-id="4fc3f-186">Další informace o **IHttpActionResult**najdete v tématu [výsledek akce ve webovém rozhraní API 2](../getting-started-with-aspnet-web-api/action-results.md).</span><span class="sxs-lookup"><span data-stu-id="4fc3f-186">For more information about **IHttpActionResult**, see [Action Results in Web API 2](../getting-started-with-aspnet-web-api/action-results.md).</span></span>

<span data-ttu-id="4fc3f-187">Ukázka základního ověřování obsahuje třídu `AuthenticationFailureResult`, která je vhodná pro tento účel.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-187">The Basic Authentication sample includes an `AuthenticationFailureResult` class that is suitable for this purpose.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample6.cs)]

## <a name="implementing-challengeasync"></a><span data-ttu-id="4fc3f-188">Implementace ChallengeAsync</span><span class="sxs-lookup"><span data-stu-id="4fc3f-188">Implementing ChallengeAsync</span></span>

<span data-ttu-id="4fc3f-189">Účelem metody **ChallengeAsync** je v případě potřeby přidat do odpovědi výzvy ověřování.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-189">The purpose of the **ChallengeAsync** method is to add authentication challenges to the response, if needed.</span></span> <span data-ttu-id="4fc3f-190">Tady je podpis této metody:</span><span class="sxs-lookup"><span data-stu-id="4fc3f-190">Here is the method signature:</span></span>

[!code-csharp[Main](authentication-filters/samples/sample7.cs)]

<span data-ttu-id="4fc3f-191">Metoda je volána u každého filtru ověřování v kanálu požadavků.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-191">The method is called on every authentication filter in the request pipeline.</span></span>

<span data-ttu-id="4fc3f-192">Je důležité pochopit, že **ChallengeAsync** se volá *před* vytvořením odpovědi HTTP a případně i před spuštěním akce kontroleru.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-192">It's important to understand that **ChallengeAsync** is called *before* the HTTP response is created, and possibly even before the controller action runs.</span></span> <span data-ttu-id="4fc3f-193">Když se zavolá **ChallengeAsync** , `context.Result` obsahuje **IHttpActionResult**, který se později použije k vytvoření odpovědi HTTP.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-193">When **ChallengeAsync** is called, `context.Result` contains an **IHttpActionResult**, which is used later to create the HTTP response.</span></span> <span data-ttu-id="4fc3f-194">Takže když se zavolá **ChallengeAsync** , neznáte ještě nic o odpovědi HTTP.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-194">So when **ChallengeAsync** is called, you don't know anything about the HTTP response yet.</span></span> <span data-ttu-id="4fc3f-195">Metoda **ChallengeAsync** by měla nahradit původní hodnotu `context.Result` novým **IHttpActionResult**.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-195">The **ChallengeAsync** method should replace the original value of `context.Result` with a new **IHttpActionResult**.</span></span> <span data-ttu-id="4fc3f-196">Tento **IHttpActionResult** musí zalamovat původní `context.Result`.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-196">This **IHttpActionResult** must wrap the original `context.Result`.</span></span>

![](authentication-filters/_static/image3.png)

<span data-ttu-id="4fc3f-197">Vyvolám původní **IHttpActionResult** *vnitřní výsledek*a nový **IHttpActionResult** *vnějšího výsledku*.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-197">I'll call the original **IHttpActionResult** the *inner result*, and the new **IHttpActionResult** the *outer result*.</span></span> <span data-ttu-id="4fc3f-198">Vnější výsledek musí splňovat následující:</span><span class="sxs-lookup"><span data-stu-id="4fc3f-198">The outer result must do the following:</span></span>

1. <span data-ttu-id="4fc3f-199">Vyvolat vnitřní výsledek pro vytvoření odpovědi HTTP.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-199">Invoke the inner result to create the HTTP response.</span></span>
2. <span data-ttu-id="4fc3f-200">Projděte si odpověď.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-200">Examine the response.</span></span>
3. <span data-ttu-id="4fc3f-201">V případě potřeby přidejte do odpovědi výzvu pro ověřování.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-201">Add an authentication challenge to the response, if needed.</span></span>

<span data-ttu-id="4fc3f-202">Následující příklad je pořízen ze vzorového ověřování Basic.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-202">The following example is taken from the Basic Authentication sample.</span></span> <span data-ttu-id="4fc3f-203">Definuje **IHttpActionResult** pro vnější výsledek.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-203">It defines an **IHttpActionResult** for the outer result.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample8.cs)]

<span data-ttu-id="4fc3f-204">Vlastnost `InnerResult` obsahuje vnitřní **IHttpActionResult**.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-204">The `InnerResult` property holds the inner **IHttpActionResult**.</span></span> <span data-ttu-id="4fc3f-205">Vlastnost `Challenge` představuje hlavičku WWW-Authentication.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-205">The `Challenge` property represents a Www-Authentication header.</span></span> <span data-ttu-id="4fc3f-206">Všimněte si, že **metody ExecuteAsync** nejprve volá `InnerResult.ExecuteAsync` k vytvoření odpovědi HTTP a pak v případě potřeby přidá výzvu.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-206">Notice that **ExecuteAsync** first calls `InnerResult.ExecuteAsync` to create the HTTP response, and then adds the challenge if needed.</span></span>

<span data-ttu-id="4fc3f-207">Před přidáním výzvy si přečtěte kód odpovědi.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-207">Check the response code before adding the challenge.</span></span> <span data-ttu-id="4fc3f-208">Většina schémat ověřování přidávají výzvu pouze v případě, že odpověď je 401, jak je znázorněno zde.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-208">Most authentication schemes only add a challenge if the response is 401, as shown here.</span></span> <span data-ttu-id="4fc3f-209">Některá schémata ověřování však přidávají výzvu k odpovědi na úspěch.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-209">However, some authentication schemes do add a challenge to a success response.</span></span> <span data-ttu-id="4fc3f-210">Příklad najdete v tématu [Negotiate](http://tools.ietf.org/html/rfc4559#section-5) (RFC 4559).</span><span class="sxs-lookup"><span data-stu-id="4fc3f-210">For example, see [Negotiate](http://tools.ietf.org/html/rfc4559#section-5) (RFC 4559).</span></span>

<span data-ttu-id="4fc3f-211">Vzhledem k třídě `AddChallengeOnUnauthorizedResult` je skutečný kód v **ChallengeAsync** jednoduchý.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-211">Given the `AddChallengeOnUnauthorizedResult` class, the actual code in **ChallengeAsync** is simple.</span></span> <span data-ttu-id="4fc3f-212">Stačí jenom vytvořit výsledek a připojit ho k `context.Result`.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-212">You just create the result and attach it to `context.Result`.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample9.cs)]

<span data-ttu-id="4fc3f-213">Poznámka: Ukázka základního ověřování abstrakce tuto logiku a tím, že ji umístí do rozšiřující metody.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-213">Note: The Basic Authentication sample abstracts this logic a bit, by placing it in an extension method.</span></span>

## <a name="combining-authentication-filters-with-host-level-authentication"></a><span data-ttu-id="4fc3f-214">Kombinování ověřovacích filtrů s ověřováním na úrovni hostitele</span><span class="sxs-lookup"><span data-stu-id="4fc3f-214">Combining Authentication Filters with Host-Level Authentication</span></span>

<span data-ttu-id="4fc3f-215">"Ověřování na úrovni hostitele" je ověřování prováděné hostitelem (například IIS), než požadavek dosáhne rozhraní Web API Framework.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-215">"Host-level authentication" is authentication performed by the host (such as IIS), before the request reaches the Web API framework.</span></span>

<span data-ttu-id="4fc3f-216">Často můžete chtít povolit ověřování na úrovni hostitele pro zbývající část aplikace, ale zakázat ji pro vaše řadiče webového rozhraní API.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-216">Often, you may want to enable host-level authentication for the rest of your application, but disable it for your Web API controllers.</span></span> <span data-ttu-id="4fc3f-217">Typickým scénářem je například povolit ověřování pomocí formulářů na úrovni hostitele, ale použít ověřování na základě tokenu pro webové rozhraní API.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-217">For example, a typical scenario is to enable Forms Authentication at the host level, but use token-based authentication for Web API.</span></span>

<span data-ttu-id="4fc3f-218">Pokud chcete zakázat ověřování na úrovni hostitele uvnitř kanálu webového rozhraní API, zavolejte `config.SuppressHostPrincipal()` v konfiguraci.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-218">To disable host-level authentication inside the Web API pipeline, call `config.SuppressHostPrincipal()` in your configuration.</span></span> <span data-ttu-id="4fc3f-219">To způsobí, že webové rozhraní API odebere **IPrincipal** z jakékoli žádosti, která vstoupí do kanálu webového rozhraní API.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-219">This causes Web API to remove the **IPrincipal** from any request that enters the Web API pipeline.</span></span> <span data-ttu-id="4fc3f-220">Efektivně &quot;neověřuje&quot; žádosti.</span><span class="sxs-lookup"><span data-stu-id="4fc3f-220">Effectively, it &quot;un-authenticates&quot; the request.</span></span>

[!code-csharp[Main](authentication-filters/samples/sample10.cs)]

## <a name="additional-resources"></a><span data-ttu-id="4fc3f-221">Další prostředky</span><span class="sxs-lookup"><span data-stu-id="4fc3f-221">Additional Resources</span></span>

<span data-ttu-id="4fc3f-222">[Filtry zabezpečení webového rozhraní API ASP.NET](https://msdn.microsoft.com/magazine/dn781361.aspx) (MSDN Magazine)</span><span class="sxs-lookup"><span data-stu-id="4fc3f-222">[ASP.NET Web API Security Filters](https://msdn.microsoft.com/magazine/dn781361.aspx) (MSDN Magazine)</span></span>
