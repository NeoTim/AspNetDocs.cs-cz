---
title: Správa klíčů ochrany dat a životnosti v ASP.NET Core
author: rick-anderson
description: Další informace o správu klíčů ochranu dat a životnosti v ASP.NET Core.
ms.author: riande
ms.date: 10/14/2016
uid: security/data-protection/configuration/default-settings
ms.openlocfilehash: 2f022a4c7519485fe629ce47c27d214c8c27d5bc
ms.sourcegitcommit: 24b1f6decbb17bb22a45166e5fdb0845c65af498
ms.translationtype: MT
ms.contentlocale: cs-CZ
ms.lasthandoff: 03/01/2019
ms.locfileid: "57069586"
---
# <a name="data-protection-key-management-and-lifetime-in-aspnet-core"></a><span data-ttu-id="2387a-103">Správa klíčů ochrany dat a životnosti v ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="2387a-103">Data Protection key management and lifetime in ASP.NET Core</span></span>

<span data-ttu-id="2387a-104">Podle [Rick Anderson](https://twitter.com/RickAndMSFT)</span><span class="sxs-lookup"><span data-stu-id="2387a-104">By [Rick Anderson](https://twitter.com/RickAndMSFT)</span></span>

## <a name="key-management"></a><span data-ttu-id="2387a-105">Správa klíčů</span><span class="sxs-lookup"><span data-stu-id="2387a-105">Key management</span></span>

<span data-ttu-id="2387a-106">Aplikace se pokusí zjistit jeho provozní prostředí a zpracovávat konfiguraci klíče sama o sobě.</span><span class="sxs-lookup"><span data-stu-id="2387a-106">The app attempts to detect its operational environment and handle key configuration on its own.</span></span>

1. <span data-ttu-id="2387a-107">Pokud je aplikace hostovaná v [Azure Apps](https://azure.microsoft.com/services/app-service/), jsou zachované klíče *%HOME%\ASP.NET\DataProtection-Keys* složky.</span><span class="sxs-lookup"><span data-stu-id="2387a-107">If the app is hosted in [Azure Apps](https://azure.microsoft.com/services/app-service/), keys are persisted to the *%HOME%\ASP.NET\DataProtection-Keys* folder.</span></span> <span data-ttu-id="2387a-108">Tato složka je zajištěná síťového úložiště a synchronizují ve všech počítačích, který je hostitelem aplikace.</span><span class="sxs-lookup"><span data-stu-id="2387a-108">This folder is backed by network storage and is synchronized across all machines hosting the app.</span></span>
   * <span data-ttu-id="2387a-109">Klíče nejsou chráněné v klidovém stavu.</span><span class="sxs-lookup"><span data-stu-id="2387a-109">Keys aren't protected at rest.</span></span>
   * <span data-ttu-id="2387a-110">*DataProtection klíče* složky poskytuje kanál klíč na všechny instance aplikace ve slotu jedno nasazení.</span><span class="sxs-lookup"><span data-stu-id="2387a-110">The *DataProtection-Keys* folder supplies the key ring to all instances of an app in a single deployment slot.</span></span>
   * <span data-ttu-id="2387a-111">Samostatné nasazovacích slotů, jako je například přípravným a produkčním prostředím, Nesdílejte klíč kanál.</span><span class="sxs-lookup"><span data-stu-id="2387a-111">Separate deployment slots, such as Staging and Production, don't share a key ring.</span></span> <span data-ttu-id="2387a-112">Když přepínat mezi sloty nasazení, například pracovní do produkčního prostředí záměna nebo pomocí A / B testování, jakoukoli aplikaci pomocí ochrany dat nebude možné dešifrovat uloženými daty pracujete pomocí aktualizační kanál, který klíč uvnitř předchozí slot.</span><span class="sxs-lookup"><span data-stu-id="2387a-112">When you swap between deployment slots, for example swapping Staging to Production or using A/B testing, any app using Data Protection won't be able to decrypt stored data using the key ring inside the previous slot.</span></span> <span data-ttu-id="2387a-113">To vede k zaprotokolování mimo aplikaci, která využívá standardní ověřování souborů cookie s ASP.NET Core, protože používá ochranu dat k ochraně souborů cookie uživatele.</span><span class="sxs-lookup"><span data-stu-id="2387a-113">This leads to users being logged out of an app that uses the standard ASP.NET Core cookie authentication, as it uses Data Protection to protect its cookies.</span></span> <span data-ttu-id="2387a-114">Pokud vyžadujete, aby okruhy slotu nezávislé na klíč, použití poskytovatele vnější prstenec klíče, jako je Azure Blob Storage, Azure Key Vault, úložišti SQL, nebo z mezipaměti Redis.</span><span class="sxs-lookup"><span data-stu-id="2387a-114">If you desire slot-independent key rings, use an external key ring provider, such as Azure Blob Storage, Azure Key Vault, a SQL store, or Redis cache.</span></span>

1. <span data-ttu-id="2387a-115">Pokud se profil uživatele je k dispozici, jsou zachované klíče *%LOCALAPPDATA%\ASP.NET\DataProtection-Keys* složky.</span><span class="sxs-lookup"><span data-stu-id="2387a-115">If the user profile is available, keys are persisted to the *%LOCALAPPDATA%\ASP.NET\DataProtection-Keys* folder.</span></span> <span data-ttu-id="2387a-116">Pokud je operační systém Windows, že klíče se zašifrují neaktivní uložená data pomocí rozhraní DPAPI.</span><span class="sxs-lookup"><span data-stu-id="2387a-116">If the operating system is Windows, the keys are encrypted at rest using DPAPI.</span></span>

   <span data-ttu-id="2387a-117">Fond aplikací [setProfileEnvironment atribut](/iis/configuration/system.applicationhost/applicationpools/add/processmodel#configuration) také musí být povolené.</span><span class="sxs-lookup"><span data-stu-id="2387a-117">The app pool's [setProfileEnvironment attribute](/iis/configuration/system.applicationhost/applicationpools/add/processmodel#configuration) must also be enabled.</span></span> <span data-ttu-id="2387a-118">Výchozí hodnota `setProfileEnvironment` je `true`.</span><span class="sxs-lookup"><span data-stu-id="2387a-118">The default value of `setProfileEnvironment` is `true`.</span></span> <span data-ttu-id="2387a-119">V některých případech (například Windows operačního systému) `setProfileEnvironment` je nastavena na `false`.</span><span class="sxs-lookup"><span data-stu-id="2387a-119">In some scenarios (for example, Windows OS), `setProfileEnvironment` is set to `false`.</span></span> <span data-ttu-id="2387a-120">Pokud se klíče nejsou uloženy v adresáři profilu uživatele jako očekávání:</span><span class="sxs-lookup"><span data-stu-id="2387a-120">If keys aren't stored in the user profile directory as expected:</span></span>

   1. <span data-ttu-id="2387a-121">Přejděte *%windir%/system32/inetsrv/config* složky.</span><span class="sxs-lookup"><span data-stu-id="2387a-121">Navigate to the *%windir%/system32/inetsrv/config* folder.</span></span>
   1. <span data-ttu-id="2387a-122">Otevřít *applicationHost.config* souboru.</span><span class="sxs-lookup"><span data-stu-id="2387a-122">Open the *applicationHost.config* file.</span></span>
   1. <span data-ttu-id="2387a-123">Vyhledejte element `<system.applicationHost><applicationPools><applicationPoolDefaults><processModel>`.</span><span class="sxs-lookup"><span data-stu-id="2387a-123">Locate the `<system.applicationHost><applicationPools><applicationPoolDefaults><processModel>` element.</span></span>
   1. <span data-ttu-id="2387a-124">Ujistěte se, že `setProfileEnvironment` atribut není k dispozici, která má výchozí hodnotu hodnotu k `true`, nebo explicitně nastavit hodnotu atributu na `true`.</span><span class="sxs-lookup"><span data-stu-id="2387a-124">Confirm that the `setProfileEnvironment` attribute isn't present, which defaults the value to `true`, or explicitly set the attribute's value to `true`.</span></span>

1. <span data-ttu-id="2387a-125">Pokud je aplikace hostovaná ve službě IIS, jsou zachované v klíči registru HKLM ve speciální registru klíč, který je ACLed pouze pro účet pracovního procesu.</span><span class="sxs-lookup"><span data-stu-id="2387a-125">If the app is hosted in IIS, keys are persisted to the HKLM registry in a special registry key that's ACLed only to the worker process account.</span></span> <span data-ttu-id="2387a-126">Klíče se zašifrují neaktivní uložená data pomocí rozhraní DPAPI.</span><span class="sxs-lookup"><span data-stu-id="2387a-126">Keys are encrypted at rest using DPAPI.</span></span>

1. <span data-ttu-id="2387a-127">Pokud neodpovídá žádná z těchto podmínek, nejsou trvalé klíče mimo aktuální proces.</span><span class="sxs-lookup"><span data-stu-id="2387a-127">If none of these conditions match, keys aren't persisted outside of the current process.</span></span> <span data-ttu-id="2387a-128">Když se proces ukončí, všechny vygenerované klíče se ztratí.</span><span class="sxs-lookup"><span data-stu-id="2387a-128">When the process shuts down, all generated keys are lost.</span></span>

<span data-ttu-id="2387a-129">Vývojář je vždy plně pod kontrolou a můžete přepsat, jak a kde jsou uloženy klíče.</span><span class="sxs-lookup"><span data-stu-id="2387a-129">The developer is always in full control and can override how and where keys are stored.</span></span> <span data-ttu-id="2387a-130">První tři možnosti výše by měla poskytnout vhodné výchozí hodnoty pro většinu aplikací tím, jak podobné technologie ASP.NET  **\<machineKey >** automatické generování rutiny pracovali v minulosti.</span><span class="sxs-lookup"><span data-stu-id="2387a-130">The first three options above should provide good defaults for most apps similar to how the ASP.NET **\<machineKey>** auto-generation routines worked in the past.</span></span> <span data-ttu-id="2387a-131">Možnost konečné, použití náhradní lokality je jediným případem, která vyžaduje pro vývojáře k určení [konfigurace](xref:security/data-protection/configuration/overview) předem, pokud chtějí trvalost klíče, ale tento záložní dochází pouze ve výjimečných případech.</span><span class="sxs-lookup"><span data-stu-id="2387a-131">The final, fallback option is the only scenario that requires the developer to specify [configuration](xref:security/data-protection/configuration/overview) upfront if they want key persistence, but this fallback only occurs in rare situations.</span></span>

<span data-ttu-id="2387a-132">Při hostování v kontejneru Dockeru, by měl nastavit jako trvalý klíčů, ve složce, která je svazek Docker (sdíleného svazku nebo svazek připojený hostitel, který potrvá déle než doba platnosti kontejneru) nebo do externího poskytovatele, jako například [Azure Key Vault](https://azure.microsoft.com/services/key-vault/) nebo [Redis](https://redis.io/).</span><span class="sxs-lookup"><span data-stu-id="2387a-132">When hosting in a Docker container, keys should be persisted in a folder that's a Docker volume (a shared volume or a host-mounted volume that persists beyond the container's lifetime) or in an external provider, such as [Azure Key Vault](https://azure.microsoft.com/services/key-vault/) or [Redis](https://redis.io/).</span></span> <span data-ttu-id="2387a-133">Externího poskytovatele je také užitečné ve webových farem aplikací nemůže získat přístup k sdíleného svazku (viz [PersistKeysToFileSystem](xref:security/data-protection/configuration/overview#persistkeystofilesystem) Další informace).</span><span class="sxs-lookup"><span data-stu-id="2387a-133">An external provider is also useful in web farm scenarios if apps can't access a shared network volume (see [PersistKeysToFileSystem](xref:security/data-protection/configuration/overview#persistkeystofilesystem) for more information).</span></span>

> [!WARNING]
> <span data-ttu-id="2387a-134">Pokud vývojář přepsání pravidel uvedených výše a odkazuje systému ochrany dat na konkrétní úložiště klíčů, je zakázané automatické šifrování klíčů v klidovém stavu.</span><span class="sxs-lookup"><span data-stu-id="2387a-134">If the developer overrides the rules outlined above and points the Data Protection system at a specific key repository, automatic encryption of keys at rest is disabled.</span></span> <span data-ttu-id="2387a-135">V klidovém stavu ochrany může být znovu povolena prostřednictvím [konfigurace](xref:security/data-protection/configuration/overview).</span><span class="sxs-lookup"><span data-stu-id="2387a-135">At-rest protection can be re-enabled via [configuration](xref:security/data-protection/configuration/overview).</span></span>

## <a name="key-lifetime"></a><span data-ttu-id="2387a-136">Životnost klíče</span><span class="sxs-lookup"><span data-stu-id="2387a-136">Key lifetime</span></span>

<span data-ttu-id="2387a-137">Klíče mají životnost 90 dní ve výchozím nastavení.</span><span class="sxs-lookup"><span data-stu-id="2387a-137">Keys have a 90-day lifetime by default.</span></span> <span data-ttu-id="2387a-138">Když vyprší platnost klíče, aplikace automaticky vygeneruje nový klíč a nastaví nový klíč jako aktivní klíč.</span><span class="sxs-lookup"><span data-stu-id="2387a-138">When a key expires, the app automatically generates a new key and sets the new key as the active key.</span></span> <span data-ttu-id="2387a-139">Tak dlouho, dokud vyřazeno klíče zůstávají v systému, může vaše aplikace dešifrování jakýchkoli dat chráněné s nimi.</span><span class="sxs-lookup"><span data-stu-id="2387a-139">As long as retired keys remain on the system, your app can decrypt any data protected with them.</span></span> <span data-ttu-id="2387a-140">Zobrazit [Správa klíčů](xref:security/data-protection/implementation/key-management#key-expiration-and-rolling) Další informace.</span><span class="sxs-lookup"><span data-stu-id="2387a-140">See [key management](xref:security/data-protection/implementation/key-management#key-expiration-and-rolling) for more information.</span></span>

## <a name="default-algorithms"></a><span data-ttu-id="2387a-141">Výchozí algoritmy</span><span class="sxs-lookup"><span data-stu-id="2387a-141">Default algorithms</span></span>

<span data-ttu-id="2387a-142">Výchozí datová část ochrany algoritmus používaný je AES-256-CBC důvěrnost a HMACSHA256 pravosti.</span><span class="sxs-lookup"><span data-stu-id="2387a-142">The default payload protection algorithm used is AES-256-CBC for confidentiality and HMACSHA256 for authenticity.</span></span> <span data-ttu-id="2387a-143">512 bitů hlavního klíče, změnit každých 90 dnů, se používá k odvození dvě dílčí klíče používané pro tyto algoritmy na základě na datovou část.</span><span class="sxs-lookup"><span data-stu-id="2387a-143">A 512-bit master key, changed every 90 days, is used to derive the two sub-keys used for these algorithms on a per-payload basis.</span></span> <span data-ttu-id="2387a-144">Zobrazit [podklíče odvození](xref:security/data-protection/implementation/subkeyderivation#additional-authenticated-data-and-subkey-derivation) Další informace.</span><span class="sxs-lookup"><span data-stu-id="2387a-144">See [subkey derivation](xref:security/data-protection/implementation/subkeyderivation#additional-authenticated-data-and-subkey-derivation) for more information.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="2387a-145">Další zdroje</span><span class="sxs-lookup"><span data-stu-id="2387a-145">Additional resources</span></span>

* <xref:security/data-protection/extensibility/key-management>
* <xref:host-and-deploy/web-farm>
